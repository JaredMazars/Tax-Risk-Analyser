generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AdjustmentDocument {
  id               Int            @id @default(autoincrement())
  projectId        Int
  taxAdjustmentId  Int?
  fileName         String
  fileType         String
  fileSize         Int
  filePath         String
  uploadedBy       String?
  extractionStatus String         @default("PENDING")
  extractedData    String?
  extractionError  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  Project          Project        @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  TaxAdjustment    TaxAdjustment? @relation(fields: [taxAdjustmentId], references: [id], onUpdate: NoAction)

  @@index([extractionStatus])
  @@index([extractionStatus, projectId])
  @@index([projectId])
  @@index([taxAdjustmentId])
}

model AITaxReport {
  id                Int      @id @default(autoincrement())
  projectId         Int
  executiveSummary  String   @db.NVarChar(Max)
  risks             String   @db.NVarChar(Max)
  taxSensitiveItems String   @db.NVarChar(Max)
  detailedFindings  String   @db.NVarChar(Max)
  recommendations   String   @db.NVarChar(Max)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Project           Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model Client {
  id                       Int                        @id @default(autoincrement())
  clientCode               String                     @unique @db.NVarChar(10)
  clientNameFull           String?                    @db.NVarChar(255)
  groupCode                String                     @db.NVarChar(10)
  groupDesc                String                     @db.NVarChar(150)
  clientPartner            String                     @db.NVarChar(10)
  clientManager            String                     @db.NVarChar(10)
  clientIncharge           String                     @db.NVarChar(10)
  active                   String                     @db.VarChar(3)
  clientDateOpen           DateTime?
  clientDateTerminate      DateTime?
  industry                 String?                    @db.NVarChar(255)
  sector                   String?                    @db.NVarChar(255)
  forvisMazarsIndustry     String?                    @db.NVarChar(255)
  forvisMazarsSector       String?                    @db.NVarChar(255)
  forvisMazarsSubsector    String?                    @db.NVarChar(255)
  clientOCFlag             Boolean
  clientTaxFlag            Boolean?
  clientSecFlag            Boolean?
  creditor                 Boolean?
  rolePlayer               Boolean
  typeCode                 String                     @db.NVarChar(10)
  typeDesc                 String                     @db.NVarChar(50)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  ClientID                 String                     @ignore @db.UniqueIdentifier
  BDOpportunity            BDOpportunity[]            @relation("BDOpportunityClient")
  ClientAcceptanceResponse ClientAcceptanceResponse[]
  ClientAnalyticsDocument  ClientAnalyticsDocument[]
  ClientCreditRating       ClientCreditRating[]
  Project                  Project[]
  Task                     Task[]

  @@index([clientNameFull])
  @@index([clientCode])
  @@index([groupCode])
  @@index([groupDesc])
  @@index([active])
  @@index([clientTaxFlag])
  @@index([updatedAt(sort: Desc)])
}

model ClientAnalyticsDocument {
  id                    Int                    @id @default(autoincrement())
  clientId              Int
  documentType          String
  fileName              String
  filePath              String
  fileSize              Int
  uploadedBy            String
  uploadedAt            DateTime               @default(now())
  extractedData         String?                @db.NVarChar(Max)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  Client                Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  CreditRatingDocuments CreditRatingDocument[]

  @@index([clientId])
  @@index([documentType])
  @@index([uploadedAt(sort: Desc)])
}

model ClientCreditRating {
  id              Int                    @id @default(autoincrement())
  clientId        Int
  ratingScore     Float
  ratingGrade     String
  ratingDate      DateTime               @default(now())
  analysisReport  String                 @db.NVarChar(Max)
  financialRatios String                 @db.NVarChar(Max)
  confidence      Float
  analyzedBy      String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  Client          Client                 @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  Documents       CreditRatingDocument[]

  @@index([clientId])
  @@index([ratingGrade])
  @@index([ratingDate(sort: Desc)])
  @@index([clientId, ratingDate(sort: Desc)])
}

model CreditRatingDocument {
  id                  Int                     @id @default(autoincrement())
  creditRatingId      Int
  analyticsDocumentId Int
  createdAt           DateTime                @default(now())
  AnalyticsDocument   ClientAnalyticsDocument @relation(fields: [analyticsDocumentId], references: [id], onUpdate: NoAction)
  CreditRating        ClientCreditRating      @relation(fields: [creditRatingId], references: [id], onDelete: Cascade)

  @@unique([creditRatingId, analyticsDocumentId])
  @@index([creditRatingId])
  @@index([analyticsDocumentId])
}

model MappedAccount {
  id               Int      @id @default(autoincrement())
  accountCode      String
  accountName      String
  section          String
  subsection       String
  balance          Float
  priorYearBalance Float    @default(0)
  sarsItem         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  projectId        Int
  Project          Project  @relation(fields: [projectId], references: [id])

  @@index([projectId, accountCode])
  @@index([projectId])
  @@index([projectId, section])
  @@index([projectId, section, subsection])
}

model Project {
  id                          Int                        @id @default(autoincrement())
  name                        String
  description                 String?
  createdAt                   DateTime                   @default(now())
  updatedAt                   DateTime                   @updatedAt
  status                      String                     @default("ACTIVE")
  archived                    Boolean                    @default(false)
  assessmentYear              String?
  clientId                    Int?
  projectType                 String                     @default("TAX_CALCULATION")
  serviceLine                 String                     @default("TAX")
  submissionDeadline          DateTime?
  taxPeriodEnd                DateTime?
  taxPeriodStart              DateTime?
  taxYear                     Int?
  acceptanceApproved          Boolean                    @default(false)
  acceptanceApprovedBy        String?
  acceptanceApprovedAt        DateTime?
  engagementLetterGenerated   Boolean                    @default(false)
  engagementLetterUploaded    Boolean                    @default(false)
  engagementLetterPath        String?
  engagementLetterUploadedBy  String?
  engagementLetterUploadedAt  DateTime?
  engagementLetterContent     String?                    @db.NVarChar(Max)
  engagementLetterGeneratedAt DateTime?
  engagementLetterGeneratedBy String?
  engagementLetterTemplateId  Int?
  AdjustmentDocument          AdjustmentDocument[]
  AdministrationDocument      AdministrationDocument[]
  AITaxReport                 AITaxReport[]
  ClientAcceptanceResponse    ClientAcceptanceResponse[]
  ComplianceChecklist         ComplianceChecklist[]
  FilingStatus                FilingStatus[]
  InAppNotification           InAppNotification[]
  LegalPrecedent              LegalPrecedent[]
  MappedAccount               MappedAccount[]
  NotificationPreference      NotificationPreference[]
  OpinionDraft                OpinionDraft[]
  Client                      Client?                    @relation(fields: [clientId], references: [id])
  ProjectUser                 ProjectUser[]
  ResearchNote                ResearchNote[]
  SarsResponse                SarsResponse[]
  TaxAdjustment               TaxAdjustment[]

  @@index([clientId])
  @@index([projectType])
  @@index([status])
  @@index([taxYear])
  @@index([serviceLine])
  @@index([serviceLine, status, archived])
  @@index([clientId, status, archived])
  @@index([projectType, taxYear])
  @@index([createdAt(sort: Desc)])
  @@index([updatedAt(sort: Desc)])
  @@index([serviceLine, updatedAt(sort: Desc)])
  @@index([clientId, updatedAt(sort: Desc)])
}

model ProjectUser {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    String
  role      String   @default("VIEWER")
  createdAt DateTime @default(now())
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([role])
  @@index([projectId, role])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TaxAdjustment {
  id                 Int                  @id @default(autoincrement())
  projectId          Int
  type               String
  description        String
  amount             Float
  status             String               @default("SUGGESTED")
  sourceDocuments    String?
  extractedData      String?
  calculationDetails String?
  notes              String?
  sarsSection        String?
  confidenceScore    Float?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  AdjustmentDocument AdjustmentDocument[]
  Project            Project              @relation(fields: [projectId], references: [id])

  @@index([createdAt])
  @@index([projectId])
  @@index([status])
  @@index([status, projectId])
  @@index([projectId, status, createdAt(sort: Desc)])
}

model User {
  id                     String                   @id
  name                   String?
  email                  String                   @unique
  emailVerified          DateTime?
  image                  String?
  role                   String                   @default("USER")
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  Account                Account[]
  EmailLog               EmailLog[]
  NotificationsSent      InAppNotification[]      @relation("NotificationsSent")
  NotificationsReceived  InAppNotification[]      @relation("NotificationsReceived")
  NotificationPreference NotificationPreference[]
  ProjectUser            ProjectUser[]
  ServiceLineUser        ServiceLineUser[]
  Session                Session[]

  @@index([role])
}

model Permission {
  id               Int              @id @default(autoincrement())
  resourceType     String           @db.NVarChar(20)
  resourceKey      String           @db.NVarChar(100)
  displayName      String           @db.NVarChar(200)
  description      String?          @db.NVarChar(500)
  availableActions String           @db.NVarChar(Max)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  RolePermission   RolePermission[]

  @@unique([resourceType, resourceKey])
  @@index([resourceType])
  @@index([resourceKey])
}

model RolePermission {
  id             Int        @id @default(autoincrement())
  role           String     @db.NVarChar(20)
  permissionId   Int
  allowedActions String     @db.NVarChar(Max)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  Permission     Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
}

model ServiceLineUser {
  id          Int      @id @default(autoincrement())
  userId      String
  serviceLine String
  role        String   @default("USER")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceLine])
  @@index([userId])
  @@index([serviceLine])
}

model OpinionDraft {
  id           Int                  @id @default(autoincrement())
  projectId    Int
  version      Int                  @default(1)
  title        String
  content      String               @db.NVarChar(Max)
  status       String               @default("DRAFT")
  createdBy    String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  chatMessages OpinionChatMessage[]
  documents    OpinionDocument[]
  Project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sections     OpinionSection[]

  @@index([projectId])
  @@index([status])
  @@index([projectId, version])
}

model OpinionDocument {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  fileName       String
  fileType       String
  fileSize       Int
  filePath       String
  category       String
  extractedText  String?      @db.NVarChar(Max)
  vectorized     Boolean      @default(false)
  uploadedBy     String
  createdAt      DateTime     @default(now())
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId])
  @@index([category])
}

model OpinionSection {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  sectionType    String
  title          String
  content        String       @db.NVarChar(Max)
  aiGenerated    Boolean      @default(false)
  reviewed       Boolean      @default(false)
  reviewedBy     String?
  reviewedAt     DateTime?
  order          Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, order])
}

model OpinionChatMessage {
  id                  Int          @id @default(autoincrement())
  opinionDraftId      Int
  role                String
  content             String       @db.NVarChar(Max)
  metadata            String?      @db.NVarChar(Max)
  sectionGenerationId String?
  sectionType         String?
  createdAt           DateTime     @default(now())
  OpinionDraft        OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, createdAt])
  @@index([sectionGenerationId])
}

model ResearchNote {
  id        Int      @id @default(autoincrement())
  projectId Int
  title     String
  content   String   @db.NVarChar(Max)
  tags      String?
  category  String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model LegalPrecedent {
  id        Int      @id @default(autoincrement())
  projectId Int
  caseName  String
  citation  String
  court     String?
  year      Int?
  summary   String   @db.NVarChar(Max)
  relevance String?  @db.NVarChar(Max)
  link      String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([year])
}

model SarsResponse {
  id              Int       @id @default(autoincrement())
  projectId       Int
  referenceNumber String
  subject         String
  content         String    @db.NVarChar(Max)
  status          String    @default("PENDING")
  responseType    String
  deadline        DateTime?
  sentDate        DateTime?
  receivedDate    DateTime?
  documentPath    String?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([deadline])
}

model AdministrationDocument {
  id          Int      @id @default(autoincrement())
  projectId   Int
  fileName    String
  fileType    String
  fileSize    Int
  filePath    String
  category    String
  description String?
  version     Int      @default(1)
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model ComplianceChecklist {
  id          Int       @id @default(autoincrement())
  projectId   Int
  title       String
  description String?   @db.NVarChar(Max)
  dueDate     DateTime?
  priority    String    @default("MEDIUM")
  status      String    @default("PENDING")
  assignedTo  String?
  completedAt DateTime?
  completedBy String?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo])
}

model FilingStatus {
  id              Int       @id @default(autoincrement())
  projectId       Int
  filingType      String
  description     String?
  status          String    @default("PENDING")
  deadline        DateTime?
  submittedDate   DateTime?
  approvedDate    DateTime?
  referenceNumber String?
  notes           String?   @db.NVarChar(Max)
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([deadline])
}

model NotificationPreference {
  id               Int      @id @default(autoincrement())
  userId           String
  projectId        Int?
  notificationType String
  emailEnabled     Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Project          Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId, notificationType])
  @@index([userId])
  @@index([projectId])
}

model EmailLog {
  id              Int       @id @default(autoincrement())
  recipientEmail  String
  recipientUserId String?
  emailType       String
  subject         String
  status          String
  errorMessage    String?
  metadata        String?   @db.NVarChar(Max)
  sentAt          DateTime?
  createdAt       DateTime  @default(now())
  User            User?     @relation(fields: [recipientUserId], references: [id])

  @@index([recipientUserId])
  @@index([emailType])
  @@index([status])
}

model InAppNotification {
  id         Int       @id @default(autoincrement())
  userId     String
  projectId  Int?
  type       String
  title      String
  message    String    @db.NVarChar(Max)
  actionUrl  String?
  isRead     Boolean   @default(false)
  readAt     DateTime?
  metadata   String?   @db.NVarChar(Max)
  fromUserId String?
  createdAt  DateTime  @default(now())
  FromUser   User?     @relation("NotificationsSent", fields: [fromUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Project    Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User       User      @relation("NotificationsReceived", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([fromUserId])
  @@index([projectId])
  @@index([createdAt(sort: Desc)])
}

model Template {
  id          Int               @id @default(autoincrement())
  name        String
  description String?
  type        String
  serviceLine String?
  projectType String?
  content     String            @db.NVarChar(Max)
  active      Boolean           @default(true)
  createdBy   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  sections    TemplateSection[]

  @@index([type])
  @@index([serviceLine])
  @@index([projectType])
  @@index([active])
}

model TemplateSection {
  id                     Int      @id @default(autoincrement())
  templateId             Int
  sectionKey             String
  title                  String
  content                String   @db.NVarChar(Max)
  isRequired             Boolean  @default(true)
  isAiAdaptable          Boolean  @default(false)
  order                  Int
  applicableServiceLines String?  @db.NVarChar(Max)
  applicableProjectTypes String?  @db.NVarChar(Max)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  Template               Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([sectionKey])
}

model ClientAcceptanceResponse {
  id                 Int                  @id(map: "PK__ClientAc__3213E83F94B62F25") @default(autoincrement())
  projectId          Int
  clientId           Int
  questionnaireType  String               @db.NVarChar(50)
  overallRiskScore   Float?
  riskRating         String?              @db.NVarChar(20)
  riskSummary        String?              @db.NVarChar(Max)
  completedAt        DateTime?
  completedBy        String?              @db.NVarChar(200)
  reviewedBy         String?              @db.NVarChar(200)
  reviewedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now()) @updatedAt
  AcceptanceAnswer   AcceptanceAnswer[]
  AcceptanceDocument AcceptanceDocument[]
  Client             Client               @relation(fields: [clientId], references: [id], onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Client")
  Project            Project              @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Project")

  @@index([projectId])
  @@index([clientId])
  @@index([questionnaireType])
  @@index([riskRating])
  @@index([projectId, questionnaireType])
}

model AcceptanceQuestion {
  id                Int                @id(map: "PK__Acceptan__3213E83FB3075BED") @default(autoincrement())
  questionnaireType String             @db.NVarChar(50)
  sectionKey        String             @db.NVarChar(100)
  questionKey       String             @db.NVarChar(100)
  questionText      String             @db.NVarChar(Max)
  description       String?            @db.NVarChar(Max)
  fieldType         String             @db.NVarChar(50)
  options           String?            @db.NVarChar(Max)
  required          Boolean            @default(true)
  order             Int
  riskWeight        Float              @default(1.0)
  highRiskAnswers   String?            @db.NVarChar(500)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now()) @updatedAt
  AcceptanceAnswer  AcceptanceAnswer[]

  @@unique([questionnaireType, questionKey])
  @@index([questionnaireType])
  @@index([questionnaireType, sectionKey])
  @@index([questionnaireType, order])
}

model AcceptanceAnswer {
  id         Int                      @id(map: "PK__Acceptan__3213E83F4AB0FF4B") @default(autoincrement())
  responseId Int
  questionId Int
  answer     String?                  @db.NVarChar(Max)
  comment    String?                  @db.NVarChar(Max)
  createdAt  DateTime                 @default(now())
  updatedAt  DateTime                 @default(now()) @updatedAt
  Question   AcceptanceQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Question")
  Response   ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Response")

  @@unique([responseId, questionId])
  @@index([responseId])
  @@index([questionId])
}

model AcceptanceDocument {
  id           Int                      @id(map: "PK__Acceptan__3213E83FEBEE39E6") @default(autoincrement())
  responseId   Int
  documentType String                   @db.NVarChar(50)
  fileName     String                   @db.NVarChar(255)
  filePath     String                   @db.NVarChar(500)
  fileSize     Int
  uploadedBy   String                   @db.NVarChar(200)
  uploadedAt   DateTime                 @default(now())
  createdAt    DateTime                 @default(now())
  Response     ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceDocument_Response")

  @@index([responseId])
  @@index([documentType])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model BDStage {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  order         Int
  probability   Float
  serviceLine   String?
  isActive      Boolean         @default(true)
  isDefault     Boolean         @default(false)
  color         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDOpportunity BDOpportunity[]

  @@unique([serviceLine, name])
  @@index([serviceLine])
  @@index([order])
  @@index([isActive])
}

model BDContact {
  id            Int             @id @default(autoincrement())
  companyName   String?
  firstName     String
  lastName      String
  email         String?
  phone         String?
  mobile        String?
  jobTitle      String?
  linkedin      String?
  industry      String?
  sector        String?
  website       String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?         @default("South Africa")
  notes         String?         @db.NVarChar(Max)
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDActivity    BDActivity[]
  BDOpportunity BDOpportunity[]

  @@index([companyName])
  @@index([email])
  @@index([createdAt(sort: Desc)])
}

model BDOpportunity {
  id                  Int          @id @default(autoincrement())
  title               String
  description         String?      @db.NVarChar(Max)
  companyName         String?
  contactId           Int?
  serviceLine         String
  stageId             Int
  value               Float?
  probability         Float?
  expectedCloseDate   DateTime?
  source              String?
  status              String       @default("OPEN")
  lostReason          String?
  assignedTo          String
  convertedToClientId Int?
  convertedAt         DateTime?
  createdBy           String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  clientId            Int?
  BDActivity          BDActivity[]
  BDNote              BDNote[]
  Client              Client?      @relation("BDOpportunityClient", fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Contact             BDContact?   @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Stage               BDStage      @relation(fields: [stageId], references: [id], onUpdate: NoAction)
  BDProposal          BDProposal[]

  @@index([serviceLine])
  @@index([stageId])
  @@index([status])
  @@index([assignedTo])
  @@index([clientId])
  @@index([convertedToClientId])
  @@index([expectedCloseDate])
  @@index([serviceLine, status])
  @@index([assignedTo, status])
  @@index([createdAt(sort: Desc)])
  @@index([updatedAt(sort: Desc)])
}

model BDActivity {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  contactId     Int?
  activityType  String
  subject       String
  description   String?       @db.NVarChar(Max)
  status        String        @default("SCHEDULED")
  dueDate       DateTime?
  completedAt   DateTime?
  duration      Int?
  location      String?
  assignedTo    String
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  Contact       BDContact?    @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Opportunity   BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([contactId])
  @@index([activityType])
  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([assignedTo, status, dueDate])
  @@index([opportunityId, createdAt(sort: Desc)])
}

model BDProposal {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  title         String
  description   String?       @db.NVarChar(Max)
  fileName      String
  filePath      String
  fileSize      Int
  proposedValue Float?
  validUntil    DateTime?
  status        String        @default("DRAFT")
  sentAt        DateTime?
  viewedAt      DateTime?
  respondedAt   DateTime?
  version       Int           @default(1)
  uploadedBy    String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  Opportunity   BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([status])
  @@index([sentAt])
  @@index([opportunityId, version])
}

model BDNote {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  content       String        @db.NVarChar(Max)
  isPrivate     Boolean       @default(false)
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  Opportunity   BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([createdAt(sort: Desc)])
}

model Employee {
  id               Int       @id @default(autoincrement())
  EmpCode          String    @db.NVarChar(10)
  EmpName          String    @db.NVarChar(50)
  EmpNameFull      String    @db.NVarChar(63)
  OfficeCode       String    @db.NVarChar(10)
  SLGroup          String    @db.NVarChar(10)
  ServLineCode     String    @db.NVarChar(10)
  ServLineDesc     String    @db.NVarChar(150)
  SubServLineCode  String    @db.NVarChar(10)
  SubServLineDesc  String    @db.NVarChar(50)
  EmpCatCode       String    @db.NVarChar(5)
  EmpCatDesc       String    @db.NVarChar(50)
  EmpCatType       String?   @db.NVarChar(1)
  RateValue        Float     @db.Money
  EmpDateLeft      DateTime?
  Active           String    @db.VarChar(3)
  EmpDateStarted   DateTime?
  Team             String?   @db.NVarChar(100)
  ExternalEmpID    String    @ignore @db.UniqueIdentifier
  WinLogon         String?   @db.NVarChar(100)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([EmpCode])
  @@index([EmpCode])
  @@index([Active])
  @@index([ServLineCode])
  @@index([WinLogon])
  @@index([OfficeCode])
  @@index([SLGroup])
}

model ServiceLine {
  id           Int     @id @default(autoincrement())
  ServLineCode String? @db.NVarChar(10)
  ServLineDesc String? @db.NVarChar(150)
  GLPrefix     String? @db.NVarChar(10)
  SLGroup      String? @db.NVarChar(10)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ServLineCode])
  @@index([SLGroup])
}

model Task {
  id              Int       @id @default(autoincrement())
  ExternalTaskID  String    @ignore @db.UniqueIdentifier
  ClientCode      String    @db.NVarChar(10)
  TaskCode        String    @db.NVarChar(10)
  TaskDesc        String    @db.NVarChar(150)
  TaskPartner     String    @db.NVarChar(10)
  TaskPartnerName String    @db.NVarChar(50)
  TaskManager     String    @db.NVarChar(10)
  TaskManagerName String    @db.NVarChar(50)
  OfficeCode      String    @db.NVarChar(10)
  SLGroup         String    @db.NVarChar(10)
  ServLineCode    String    @db.NVarChar(10)
  ServLineDesc    String    @db.NVarChar(150)
  Active          String    @db.VarChar(3)
  TaskDateOpen    DateTime
  TaskDateTerminate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Client          Client?   @relation(fields: [ClientCode], references: [clientCode], onDelete: NoAction, onUpdate: NoAction)
  WipLTD          WipLTD[]

  @@unique([ClientCode, TaskCode])
  @@index([ClientCode])
  @@index([TaskCode])
  @@index([TaskPartner])
  @@index([TaskManager])
  @@index([Active])
  @@index([ServLineCode])
  @@index([OfficeCode])
  @@index([SLGroup])
}

model WipLTD {
  id                Int       @id @default(autoincrement())
  taskId            Int
  ExternalTaskID    String    @ignore @db.UniqueIdentifier
  ClientCode        String    @db.NVarChar(10)
  TaskCode          String    @db.NVarChar(10)
  OfficeCode        String    @db.NVarChar(10)
  ServLineCode      String    @db.NVarChar(10)
  TaskPartner       String    @db.NVarChar(10)
  LTDTime           Float?    @db.Money
  LTDDisb           Float?    @db.Money
  LTDFeeTime        Float?    @db.Money
  LTDFeeDisb        Float?    @db.Money
  LTDAdjTime        Float?    @db.Money
  LTDAdjDisb        Float?    @db.Money
  LTDCost           Float?    @db.Money
  BalTime           Float?    @db.Money
  BalDisb           Float?    @db.Money
  BalWIP            Float?    @db.Money
  WipProvision      Float?    @db.Money
  LTDPendingTime    Float?    @db.Money
  LTDCostExcludeCP  Float?    @db.Money
  LTDHours          Float?    @db.Money
  EstFeeTime        Float?    @db.Money
  EstFeeDisb        Float?    @db.Money
  EstChgTime        Float?    @db.Money
  EstChgDisb        Float?    @db.Money
  EstChgHours       Float?    @db.Money
  EstAdjTime        Float?    @db.Money
  EstAdjDisb        Float?    @db.Money
  BudStartDate      DateTime?
  BudDueDate        DateTime?
  BudApproveDate    DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  Task              Task      @relation(fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([taskId])
  @@index([ClientCode])
  @@index([TaskCode])
  @@index([TaskPartner])
  @@index([ServLineCode])
  @@index([OfficeCode])
}
