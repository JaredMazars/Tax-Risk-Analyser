generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model AcceptanceAnswer {
  id                       Int                      @id(map: "PK__Acceptan__3213E83F4AB0FF4B") @default(autoincrement())
  responseId               Int
  questionId               Int
  answer                   String?                  @db.NVarChar(Max)
  comment                  String?                  @db.NVarChar(Max)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @default(now()) @updatedAt
  AcceptanceQuestion       AcceptanceQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Question")
  ClientAcceptanceResponse ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Response")

  @@unique([responseId, questionId])
  @@index([questionId])
  @@index([responseId])
}

model AcceptanceDocument {
  id                       Int                      @id(map: "PK__Acceptan__3213E83FEBEE39E6") @default(autoincrement())
  responseId               Int
  documentType             String                   @db.NVarChar(50)
  fileName                 String                   @db.NVarChar(255)
  filePath                 String                   @db.NVarChar(500)
  fileSize                 Int
  uploadedBy               String                   @db.NVarChar(200)
  uploadedAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())
  ClientAcceptanceResponse ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceDocument_Response")

  @@index([documentType])
  @@index([responseId])
}

model AcceptanceQuestion {
  id                Int                @id(map: "PK__Acceptan__3213E83FB3075BED") @default(autoincrement())
  questionnaireType String             @db.NVarChar(50)
  sectionKey        String             @db.NVarChar(100)
  questionKey       String             @db.NVarChar(100)
  questionText      String             @db.NVarChar(Max)
  description       String?            @db.NVarChar(Max)
  fieldType         String             @db.NVarChar(50)
  options           String?            @db.NVarChar(Max)
  required          Boolean            @default(true)
  order             Int
  riskWeight        Float              @default(1.0)
  highRiskAnswers   String?            @db.NVarChar(500)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now()) @updatedAt
  AcceptanceAnswer  AcceptanceAnswer[]

  @@unique([questionnaireType, questionKey])
  @@index([questionnaireType])
  @@index([questionnaireType, order])
  @@index([questionnaireType, sectionKey])
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AdjustmentDocument {
  id               Int            @id @default(autoincrement())
  projectId        Int
  taxAdjustmentId  Int?
  fileName         String
  fileType         String
  fileSize         Int
  filePath         String
  uploadedBy       String?
  extractionStatus String         @default("PENDING")
  extractedData    String?
  extractionError  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  Project          Project        @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  TaxAdjustment    TaxAdjustment? @relation(fields: [taxAdjustmentId], references: [id], onUpdate: NoAction)

  @@index([extractionStatus])
  @@index([extractionStatus, projectId])
  @@index([projectId])
  @@index([taxAdjustmentId])
}

model AdministrationDocument {
  id          Int      @id @default(autoincrement())
  projectId   Int
  fileName    String
  fileType    String
  fileSize    Int
  filePath    String
  category    String
  description String?
  version     Int      @default(1)
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([projectId])
}

model AITaxReport {
  id                Int      @id @default(autoincrement())
  projectId         Int
  executiveSummary  String   @db.NVarChar(Max)
  risks             String   @db.NVarChar(Max)
  taxSensitiveItems String   @db.NVarChar(Max)
  detailedFindings  String   @db.NVarChar(Max)
  recommendations   String   @db.NVarChar(Max)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Project           Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model BDActivity {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  contactId     Int?
  activityType  String
  subject       String
  description   String?       @db.NVarChar(Max)
  status        String        @default("SCHEDULED")
  dueDate       DateTime?
  completedAt   DateTime?
  duration      Int?
  location      String?
  assignedTo    String
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDContact     BDContact?    @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([activityType])
  @@index([assignedTo])
  @@index([assignedTo, status, dueDate])
  @@index([contactId])
  @@index([dueDate])
  @@index([opportunityId, createdAt(sort: Desc)])
  @@index([opportunityId])
  @@index([status])
}

model BDContact {
  id            Int             @id @default(autoincrement())
  companyName   String?
  firstName     String
  lastName      String
  email         String?
  phone         String?
  mobile        String?
  jobTitle      String?
  linkedin      String?
  industry      String?
  sector        String?
  website       String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?         @default("South Africa")
  notes         String?         @db.NVarChar(Max)
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDActivity    BDActivity[]
  BDOpportunity BDOpportunity[]

  @@index([companyName])
  @@index([createdAt(sort: Desc)])
  @@index([email])
}

model BDNote {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  content       String        @db.NVarChar(Max)
  isPrivate     Boolean       @default(false)
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([opportunityId])
}

model BDOpportunity {
  id                  Int          @id @default(autoincrement())
  title               String
  description         String?      @db.NVarChar(Max)
  companyName         String?
  contactId           Int?
  serviceLine         String
  stageId             Int
  value               Float?
  probability         Float?
  expectedCloseDate   DateTime?
  source              String?
  status              String       @default("OPEN")
  lostReason          String?
  assignedTo          String
  convertedToClientId Int?
  convertedAt         DateTime?
  createdBy           String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  clientId            Int?
  BDActivity          BDActivity[]
  BDNote              BDNote[]
  Client              Client?      @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDContact           BDContact?   @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDStage             BDStage      @relation(fields: [stageId], references: [id], onUpdate: NoAction)
  BDProposal          BDProposal[]

  @@index([assignedTo])
  @@index([assignedTo, status])
  @@index([clientId])
  @@index([convertedToClientId])
  @@index([createdAt(sort: Desc)])
  @@index([expectedCloseDate])
  @@index([serviceLine])
  @@index([serviceLine, status])
  @@index([stageId])
  @@index([status])
  @@index([updatedAt(sort: Desc)])
}

model BDProposal {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  title         String
  description   String?       @db.NVarChar(Max)
  fileName      String
  filePath      String
  fileSize      Int
  proposedValue Float?
  validUntil    DateTime?
  status        String        @default("DRAFT")
  sentAt        DateTime?
  viewedAt      DateTime?
  respondedAt   DateTime?
  version       Int           @default(1)
  uploadedBy    String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([opportunityId, version])
  @@index([sentAt])
  @@index([status])
}

model BDStage {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  order         Int
  probability   Float
  serviceLine   String?
  isActive      Boolean         @default(true)
  isDefault     Boolean         @default(false)
  color         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDOpportunity BDOpportunity[]

  @@unique([serviceLine, name])
  @@index([isActive])
  @@index([order])
  @@index([serviceLine])
}

model Client {
  id                       Int                        @id @default(autoincrement())
  clientCode               String                     @unique @db.NVarChar(10)
  clientNameFull           String?                    @db.NVarChar(255)
  groupCode                String                     @db.NVarChar(10)
  groupDesc                String                     @db.NVarChar(150)
  clientPartner            String                     @db.NVarChar(10)
  clientManager            String                     @db.NVarChar(10)
  clientIncharge           String                     @db.NVarChar(10)
  active                   String                     @db.VarChar(3)
  clientDateOpen           DateTime?
  clientDateTerminate      DateTime?
  industry                 String?                    @db.NVarChar(255)
  sector                   String?                    @db.NVarChar(255)
  forvisMazarsIndustry     String?                    @db.NVarChar(255)
  forvisMazarsSector       String?                    @db.NVarChar(255)
  forvisMazarsSubsector    String?                    @db.NVarChar(255)
  clientOCFlag             Boolean
  clientTaxFlag            Boolean?
  clientSecFlag            Boolean?
  creditor                 Boolean?
  rolePlayer               Boolean
  typeCode                 String                     @db.NVarChar(10)
  typeDesc                 String                     @db.NVarChar(50)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  ClientID                 String                     @db.UniqueIdentifier
  BDOpportunity            BDOpportunity[]
  ClientAcceptanceResponse ClientAcceptanceResponse[]
  ClientAnalyticsDocument  ClientAnalyticsDocument[]
  ClientCreditRating       ClientCreditRating[]
  Project                  Project[]
  Task                     Task[]

  @@index([active])
  @@index([clientCode])
  @@index([clientNameFull])
  @@index([clientTaxFlag])
  @@index([groupCode])
  @@index([groupDesc])
  @@index([updatedAt(sort: Desc)])
}

model ClientAcceptanceResponse {
  id                 Int                  @id(map: "PK__ClientAc__3213E83F94B62F25") @default(autoincrement())
  projectId          Int
  clientId           Int
  questionnaireType  String               @db.NVarChar(50)
  overallRiskScore   Float?
  riskRating         String?              @db.NVarChar(20)
  riskSummary        String?              @db.NVarChar(Max)
  completedAt        DateTime?
  completedBy        String?              @db.NVarChar(200)
  reviewedBy         String?              @db.NVarChar(200)
  reviewedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now()) @updatedAt
  AcceptanceAnswer   AcceptanceAnswer[]
  AcceptanceDocument AcceptanceDocument[]
  Client             Client               @relation(fields: [clientId], references: [id], onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Client")
  Project            Project              @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Project")

  @@index([clientId])
  @@index([projectId])
  @@index([projectId, questionnaireType])
  @@index([questionnaireType])
  @@index([riskRating])
}

model ClientAnalyticsDocument {
  id                   Int                    @id @default(autoincrement())
  clientId             Int
  documentType         String
  fileName             String
  filePath             String
  fileSize             Int
  uploadedBy           String
  uploadedAt           DateTime               @default(now())
  extractedData        String?                @db.NVarChar(Max)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Client               Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  CreditRatingDocument CreditRatingDocument[]

  @@index([clientId])
  @@index([documentType])
  @@index([uploadedAt(sort: Desc)])
}

model ClientCreditRating {
  id                   Int                    @id @default(autoincrement())
  clientId             Int
  ratingScore          Float
  ratingGrade          String
  ratingDate           DateTime               @default(now())
  analysisReport       String                 @db.NVarChar(Max)
  financialRatios      String                 @db.NVarChar(Max)
  confidence           Float
  analyzedBy           String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Client               Client                 @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  CreditRatingDocument CreditRatingDocument[]

  @@index([clientId])
  @@index([clientId, ratingDate(sort: Desc)])
  @@index([ratingDate(sort: Desc)])
  @@index([ratingGrade])
}

model ComplianceChecklist {
  id          Int       @id @default(autoincrement())
  projectId   Int
  title       String
  description String?   @db.NVarChar(Max)
  dueDate     DateTime?
  priority    String    @default("MEDIUM")
  status      String    @default("PENDING")
  assignedTo  String?
  completedAt DateTime?
  completedBy String?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([assignedTo])
  @@index([dueDate])
  @@index([projectId])
  @@index([status])
}

model CreditRatingDocument {
  id                      Int                     @id @default(autoincrement())
  creditRatingId          Int
  analyticsDocumentId     Int
  createdAt               DateTime                @default(now())
  ClientAnalyticsDocument ClientAnalyticsDocument @relation(fields: [analyticsDocumentId], references: [id], onUpdate: NoAction)
  ClientCreditRating      ClientCreditRating      @relation(fields: [creditRatingId], references: [id], onDelete: Cascade)

  @@unique([creditRatingId, analyticsDocumentId])
  @@index([analyticsDocumentId])
  @@index([creditRatingId])
}

model EmailLog {
  id              Int       @id @default(autoincrement())
  recipientEmail  String
  recipientUserId String?
  emailType       String
  subject         String
  status          String
  errorMessage    String?
  metadata        String?   @db.NVarChar(Max)
  sentAt          DateTime?
  createdAt       DateTime  @default(now())
  User            User?     @relation(fields: [recipientUserId], references: [id])

  @@index([emailType])
  @@index([recipientUserId])
  @@index([status])
}

model Employee {
  id              Int       @id @default(autoincrement())
  EmpCode         String    @unique @db.NVarChar(10)
  EmpName         String    @db.NVarChar(50)
  EmpNameFull     String    @db.NVarChar(63)
  OfficeCode      String    @db.NVarChar(10)
  SLGroup         String    @db.NVarChar(10)
  ServLineCode    String    @db.NVarChar(10)
  ServLineDesc    String    @db.NVarChar(150)
  SubServLineCode String    @db.NVarChar(10)
  SubServLineDesc String    @db.NVarChar(50)
  EmpCatCode      String    @db.NVarChar(5)
  EmpCatDesc      String    @db.NVarChar(50)
  EmpCatType      String?   @db.NVarChar(1)
  RateValue       Float     @db.Money
  EmpDateLeft     DateTime?
  Active          String    @db.VarChar(3)
  EmpDateStarted  DateTime?
  Team            String?   @db.NVarChar(100)
  ExternalEmpID   String    @db.UniqueIdentifier
  WinLogon        String?   @db.NVarChar(100)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([Active])
  @@index([EmpCode])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([WinLogon])
}

model FilingStatus {
  id              Int       @id @default(autoincrement())
  projectId       Int
  filingType      String
  description     String?
  status          String    @default("PENDING")
  deadline        DateTime?
  submittedDate   DateTime?
  approvedDate    DateTime?
  referenceNumber String?
  notes           String?   @db.NVarChar(Max)
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([projectId])
  @@index([status])
}

model InAppNotification {
  id                                      Int       @id @default(autoincrement())
  userId                                  String
  projectId                               Int?
  type                                    String
  title                                   String
  message                                 String    @db.NVarChar(Max)
  actionUrl                               String?
  isRead                                  Boolean   @default(false)
  readAt                                  DateTime?
  metadata                                String?   @db.NVarChar(Max)
  fromUserId                              String?
  createdAt                               DateTime  @default(now())
  User_InAppNotification_fromUserIdToUser User?     @relation("InAppNotification_fromUserIdToUser", fields: [fromUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Project                                 Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User_InAppNotification_userIdToUser     User      @relation("InAppNotification_userIdToUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([createdAt(sort: Desc)])
  @@index([fromUserId])
  @@index([projectId])
  @@index([userId])
  @@index([userId, isRead])
}

model LegalPrecedent {
  id        Int      @id @default(autoincrement())
  projectId Int
  caseName  String
  citation  String
  court     String?
  year      Int?
  summary   String   @db.NVarChar(Max)
  relevance String?  @db.NVarChar(Max)
  link      String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([year])
}

model MappedAccount {
  id               Int      @id @default(autoincrement())
  accountCode      String
  accountName      String
  section          String
  subsection       String
  balance          Float
  priorYearBalance Float    @default(0)
  sarsItem         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  projectId        Int
  Project          Project  @relation(fields: [projectId], references: [id])

  @@index([projectId, accountCode])
  @@index([projectId])
  @@index([projectId, section])
  @@index([projectId, section, subsection])
}

model NotificationPreference {
  id               Int      @id @default(autoincrement())
  userId           String
  projectId        Int?
  notificationType String
  emailEnabled     Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Project          Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, projectId, notificationType])
  @@index([projectId])
  @@index([userId])
}

model OpinionChatMessage {
  id                  Int          @id @default(autoincrement())
  opinionDraftId      Int
  role                String
  content             String       @db.NVarChar(Max)
  metadata            String?      @db.NVarChar(Max)
  sectionGenerationId String?
  sectionType         String?
  createdAt           DateTime     @default(now())
  OpinionDraft        OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, createdAt])
  @@index([sectionGenerationId])
}

model OpinionDocument {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  fileName       String
  fileType       String
  fileSize       Int
  filePath       String
  category       String
  extractedText  String?      @db.NVarChar(Max)
  vectorized     Boolean      @default(false)
  uploadedBy     String
  createdAt      DateTime     @default(now())
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([opinionDraftId])
}

model OpinionDraft {
  id                 Int                  @id @default(autoincrement())
  projectId          Int
  version            Int                  @default(1)
  title              String
  content            String               @db.NVarChar(Max)
  status             String               @default("DRAFT")
  createdBy          String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  OpinionChatMessage OpinionChatMessage[]
  OpinionDocument    OpinionDocument[]
  Project            Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  OpinionSection     OpinionSection[]

  @@index([projectId])
  @@index([projectId, version])
  @@index([status])
}

model OpinionSection {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  sectionType    String
  title          String
  content        String       @db.NVarChar(Max)
  aiGenerated    Boolean      @default(false)
  reviewed       Boolean      @default(false)
  reviewedBy     String?
  reviewedAt     DateTime?
  order          Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, order])
}

model Permission {
  id               Int              @id @default(autoincrement())
  resourceType     String           @db.NVarChar(20)
  resourceKey      String           @db.NVarChar(100)
  displayName      String           @db.NVarChar(200)
  description      String?          @db.NVarChar(500)
  availableActions String           @db.NVarChar(Max)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  RolePermission   RolePermission[]

  @@unique([resourceType, resourceKey])
  @@index([resourceKey])
  @@index([resourceType])
}

model Project {
  id                          Int                        @id @default(autoincrement())
  name                        String
  description                 String?
  createdAt                   DateTime                   @default(now())
  updatedAt                   DateTime                   @updatedAt
  status                      String                     @default("ACTIVE")
  archived                    Boolean                    @default(false)
  assessmentYear              String?
  clientId                    Int?
  projectType                 String                     @default("TAX_CALCULATION")
  serviceLine                 String                     @default("TAX")
  submissionDeadline          DateTime?
  taxPeriodEnd                DateTime?
  taxPeriodStart              DateTime?
  taxYear                     Int?
  acceptanceApproved          Boolean                    @default(false)
  acceptanceApprovedBy        String?
  acceptanceApprovedAt        DateTime?
  engagementLetterGenerated   Boolean                    @default(false)
  engagementLetterUploaded    Boolean                    @default(false)
  engagementLetterPath        String?
  engagementLetterUploadedBy  String?
  engagementLetterUploadedAt  DateTime?
  engagementLetterContent     String?                    @db.NVarChar(Max)
  engagementLetterGeneratedAt DateTime?
  engagementLetterGeneratedBy String?
  engagementLetterTemplateId  Int?
  createdBy                   String?
  AdjustmentDocument          AdjustmentDocument[]
  AdministrationDocument      AdministrationDocument[]
  AITaxReport                 AITaxReport[]
  ClientAcceptanceResponse    ClientAcceptanceResponse[]
  ComplianceChecklist         ComplianceChecklist[]
  FilingStatus                FilingStatus[]
  InAppNotification           InAppNotification[]
  LegalPrecedent              LegalPrecedent[]
  MappedAccount               MappedAccount[]
  NotificationPreference      NotificationPreference[]
  OpinionDraft                OpinionDraft[]
  Client                      Client?                    @relation(fields: [clientId], references: [id])
  User                        User?                      @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ProjectUser                 ProjectUser[]
  ResearchNote                ResearchNote[]
  SarsResponse                SarsResponse[]
  TaxAdjustment               TaxAdjustment[]

  @@index([clientId])
  @@index([clientId, status, archived])
  @@index([clientId, updatedAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([createdBy])
  @@index([projectType])
  @@index([projectType, taxYear])
  @@index([serviceLine])
  @@index([serviceLine, status, archived])
  @@index([serviceLine, updatedAt(sort: Desc)])
  @@index([status])
  @@index([taxYear])
  @@index([updatedAt(sort: Desc)])
}

model ProjectUser {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    String
  role      String   @default("VIEWER")
  createdAt DateTime @default(now())
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([projectId, role])
  @@index([role])
  @@index([userId])
}

model ResearchNote {
  id        Int      @id @default(autoincrement())
  projectId Int
  title     String
  content   String   @db.NVarChar(Max)
  tags      String?
  category  String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([projectId])
}

model RolePermission {
  id             Int        @id @default(autoincrement())
  role           String     @db.NVarChar(20)
  permissionId   Int
  allowedActions String     @db.NVarChar(Max)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  Permission     Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([permissionId])
  @@index([role])
}

model SarsResponse {
  id              Int       @id @default(autoincrement())
  projectId       Int
  referenceNumber String
  subject         String
  content         String    @db.NVarChar(Max)
  status          String    @default("PENDING")
  responseType    String
  deadline        DateTime?
  sentDate        DateTime?
  receivedDate    DateTime?
  documentPath    String?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([projectId])
  @@index([status])
}

// Master service lines (application level)
model ServiceLineMaster {
  code        String   @id @db.NVarChar(50)
  name        String   @db.NVarChar(200)
  description String?  @db.NVarChar(500)
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
  @@index([sortOrder])
}

// External DB service lines (from external system)
model ServiceLineExternal {
  id           Int      @id @default(autoincrement())
  ServLineCode String?  @db.NVarChar(10)
  ServLineDesc String?  @db.NVarChar(150)
  GLPrefix     String?  @db.NVarChar(10)
  SLGroup      String?  @db.NVarChar(10)
  masterCode   String?  @db.NVarChar(50)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([masterCode])
}

model ServiceLineUser {
  id          Int      @id @default(autoincrement())
  userId      String
  serviceLine String
  role        String   @default("USER")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceLine])
  @@index([serviceLine])
  @@index([userId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Task {
  id                Int       @id @default(autoincrement())
  ExternalTaskID    String    @db.UniqueIdentifier
  ClientCode        String    @db.NVarChar(10)
  TaskCode          String    @db.NVarChar(10)
  TaskDesc          String    @db.NVarChar(150)
  TaskPartner       String    @db.NVarChar(10)
  TaskPartnerName   String    @db.NVarChar(50)
  TaskManager       String    @db.NVarChar(10)
  TaskManagerName   String    @db.NVarChar(50)
  OfficeCode        String    @db.NVarChar(10)
  SLGroup           String    @db.NVarChar(10)
  ServLineCode      String    @db.NVarChar(10)
  ServLineDesc      String    @db.NVarChar(150)
  Active            String    @db.VarChar(3)
  TaskDateOpen      DateTime
  TaskDateTerminate DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  Client            Client?   @relation(fields: [ClientCode], references: [clientCode], onUpdate: NoAction)
  WipLTD            WipLTD[]

  @@unique([ClientCode, TaskCode])
  @@index([Active])
  @@index([ClientCode])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([TaskCode])
  @@index([TaskManager])
  @@index([TaskPartner])
}

model TaxAdjustment {
  id                 Int                  @id @default(autoincrement())
  projectId          Int
  type               String
  description        String
  amount             Float
  status             String               @default("SUGGESTED")
  sourceDocuments    String?
  extractedData      String?
  calculationDetails String?
  notes              String?
  sarsSection        String?
  confidenceScore    Float?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  AdjustmentDocument AdjustmentDocument[]
  Project            Project              @relation(fields: [projectId], references: [id])

  @@index([createdAt])
  @@index([projectId])
  @@index([projectId, status, createdAt(sort: Desc)])
  @@index([status])
  @@index([status, projectId])
}

model Template {
  id              Int               @id @default(autoincrement())
  name            String
  description     String?
  type            String
  serviceLine     String?
  projectType     String?
  content         String            @db.NVarChar(Max)
  active          Boolean           @default(true)
  createdBy       String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  TemplateSection TemplateSection[]

  @@index([active])
  @@index([projectType])
  @@index([serviceLine])
  @@index([type])
}

model TemplateSection {
  id                     Int      @id @default(autoincrement())
  templateId             Int
  sectionKey             String
  title                  String
  content                String   @db.NVarChar(Max)
  isRequired             Boolean  @default(true)
  isAiAdaptable          Boolean  @default(false)
  order                  Int
  applicableServiceLines String?  @db.NVarChar(Max)
  applicableProjectTypes String?  @db.NVarChar(Max)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  Template               Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([sectionKey])
  @@index([templateId])
}

model User {
  id                                                   String                   @id
  name                                                 String?
  email                                                String                   @unique
  emailVerified                                        DateTime?
  image                                                String?
  role                                                 String                   @default("USER")
  createdAt                                            DateTime                 @default(now())
  updatedAt                                            DateTime                 @updatedAt
  Account                                              Account[]
  EmailLog                                             EmailLog[]
  InAppNotification_InAppNotification_fromUserIdToUser InAppNotification[]      @relation("InAppNotification_fromUserIdToUser")
  InAppNotification_InAppNotification_userIdToUser     InAppNotification[]      @relation("InAppNotification_userIdToUser")
  NotificationPreference                               NotificationPreference[]
  Project                                              Project[]
  ProjectUser                                          ProjectUser[]
  ServiceLineUser                                      ServiceLineUser[]
  Session                                              Session[]

  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model WipLTD {
  id               Int       @id @default(autoincrement())
  taskId           Int
  ExternalTaskID   String    @db.UniqueIdentifier
  ClientCode       String    @db.NVarChar(10)
  TaskCode         String    @db.NVarChar(10)
  OfficeCode       String    @db.NVarChar(10)
  ServLineCode     String    @db.NVarChar(10)
  TaskPartner      String    @db.NVarChar(10)
  LTDTime          Float?    @db.Money
  LTDDisb          Float?    @db.Money
  LTDFeeTime       Float?    @db.Money
  LTDFeeDisb       Float?    @db.Money
  LTDAdjTime       Float?    @db.Money
  LTDAdjDisb       Float?    @db.Money
  LTDCost          Float?    @db.Money
  BalTime          Float?    @db.Money
  BalDisb          Float?    @db.Money
  BalWIP           Float?    @db.Money
  WipProvision     Float?    @db.Money
  LTDPendingTime   Float?    @db.Money
  LTDCostExcludeCP Float?    @db.Money
  LTDHours         Float?    @db.Money
  EstFeeTime       Float?    @db.Money
  EstFeeDisb       Float?    @db.Money
  EstChgTime       Float?    @db.Money
  EstChgDisb       Float?    @db.Money
  EstChgHours      Float?    @db.Money
  EstAdjTime       Float?    @db.Money
  EstAdjDisb       Float?    @db.Money
  BudStartDate     DateTime?
  BudDueDate       DateTime?
  BudApproveDate   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  Task             Task      @relation(fields: [taskId], references: [id], onUpdate: NoAction)

  @@index([ClientCode])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([TaskCode])
  @@index([taskId])
  @@index([TaskPartner])
}
