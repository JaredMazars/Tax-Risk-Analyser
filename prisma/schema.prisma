generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "sqlserver"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model AcceptanceAnswer {
  id                       Int                      @id(map: "PK__Acceptan__3213E83F4AB0FF4B") @default(autoincrement())
  responseId               Int
  questionId               Int
  answer                   String?                  @db.NVarChar(Max)
  comment                  String?                  @db.NVarChar(Max)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @default(now()) @updatedAt
  AcceptanceQuestion       AcceptanceQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Question")
  ClientAcceptanceResponse ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceAnswer_Response")

  @@unique([responseId, questionId])
  @@index([questionId])
  @@index([responseId])
}

model AcceptanceDocument {
  id                       Int                      @id(map: "PK__Acceptan__3213E83FEBEE39E6") @default(autoincrement())
  responseId               Int
  documentType             String                   @db.NVarChar(50)
  fileName                 String                   @db.NVarChar(255)
  filePath                 String                   @db.NVarChar(500)
  fileSize                 Int
  uploadedBy               String                   @db.NVarChar(200)
  uploadedAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())
  ClientAcceptanceResponse ClientAcceptanceResponse @relation(fields: [responseId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_AcceptanceDocument_Response")

  @@index([documentType])
  @@index([responseId])
}

model AcceptanceQuestion {
  id                Int                @id(map: "PK__Acceptan__3213E83FB3075BED") @default(autoincrement())
  questionnaireType String             @db.NVarChar(50)
  sectionKey        String             @db.NVarChar(100)
  questionKey       String             @db.NVarChar(100)
  questionText      String             @db.NVarChar(Max)
  description       String?            @db.NVarChar(Max)
  fieldType         String             @db.NVarChar(50)
  options           String?            @db.NVarChar(Max)
  required          Boolean            @default(true)
  order             Int
  riskWeight        Float              @default(1.0)
  highRiskAnswers   String?            @db.NVarChar(500)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now()) @updatedAt
  AcceptanceAnswer  AcceptanceAnswer[]

  @@unique([questionnaireType, questionKey])
  @@index([questionnaireType])
  @@index([questionnaireType, order])
  @@index([questionnaireType, sectionKey])
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AdjustmentDocument {
  id               Int            @id @default(autoincrement())
  taskId           Int
  taxAdjustmentId  Int?
  fileName         String
  fileType         String
  fileSize         Int
  filePath         String
  uploadedBy       String?
  extractionStatus String         @default("PENDING")
  extractedData    String?
  extractionError  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  Task             Task           @relation(fields: [taskId], references: [id], onUpdate: NoAction)
  TaxAdjustment    TaxAdjustment? @relation(fields: [taxAdjustmentId], references: [id], onUpdate: NoAction)

  @@index([extractionStatus])
  @@index([extractionStatus, taskId])
  @@index([taskId])
  @@index([taxAdjustmentId])
}

model AITaxReport {
  id                Int      @id @default(autoincrement())
  taskId            Int
  executiveSummary  String   @db.NVarChar(Max)
  risks             String   @db.NVarChar(Max)
  taxSensitiveItems String   @db.NVarChar(Max)
  detailedFindings  String   @db.NVarChar(Max)
  recommendations   String   @db.NVarChar(Max)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Task              Task     @relation(fields: [taskId], references: [id])

  @@index([taskId])
}

model BDActivity {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  contactId     Int?
  activityType  String
  subject       String
  description   String?       @db.NVarChar(Max)
  status        String        @default("SCHEDULED")
  dueDate       DateTime?
  completedAt   DateTime?
  duration      Int?
  location      String?
  assignedTo    String
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDContact     BDContact?    @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([activityType])
  @@index([assignedTo])
  @@index([assignedTo, status, dueDate])
  @@index([contactId])
  @@index([dueDate])
  @@index([opportunityId, createdAt(sort: Desc)])
  @@index([opportunityId])
  @@index([status])
}

model BDContact {
  id            Int             @id @default(autoincrement())
  companyName   String?
  firstName     String
  lastName      String
  email         String?
  phone         String?
  mobile        String?
  jobTitle      String?
  linkedin      String?
  industry      String?
  sector        String?
  website       String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?         @default("South Africa")
  notes         String?         @db.NVarChar(Max)
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDActivity    BDActivity[]
  BDOpportunity BDOpportunity[]

  @@index([companyName])
  @@index([createdAt(sort: Desc)])
  @@index([email])
}

model BDNote {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  content       String        @db.NVarChar(Max)
  isPrivate     Boolean       @default(false)
  createdBy     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([opportunityId])
}

model BDOpportunity {
  id                  Int          @id @default(autoincrement())
  title               String
  description         String?      @db.NVarChar(Max)
  companyName         String?
  contactId           Int?
  serviceLine         String
  stageId             Int
  value               Float?
  probability         Float?
  expectedCloseDate   DateTime?
  source              String?
  status              String       @default("OPEN")
  lostReason          String?
  assignedTo          String
  convertedToClientId Int?
  convertedAt         DateTime?
  createdBy           String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  clientId            Int?
  BDActivity          BDActivity[]
  BDNote              BDNote[]
  Client              Client?      @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDContact           BDContact?   @relation(fields: [contactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  BDStage             BDStage      @relation(fields: [stageId], references: [id], onUpdate: NoAction)
  BDProposal          BDProposal[]

  @@index([assignedTo])
  @@index([assignedTo, status])
  @@index([clientId])
  @@index([convertedToClientId])
  @@index([createdAt(sort: Desc)])
  @@index([expectedCloseDate])
  @@index([serviceLine])
  @@index([serviceLine, status])
  @@index([stageId])
  @@index([status])
  @@index([updatedAt(sort: Desc)])
}

model BDProposal {
  id            Int           @id @default(autoincrement())
  opportunityId Int
  title         String
  description   String?       @db.NVarChar(Max)
  fileName      String
  filePath      String
  fileSize      Int
  proposedValue Float?
  validUntil    DateTime?
  status        String        @default("DRAFT")
  sentAt        DateTime?
  viewedAt      DateTime?
  respondedAt   DateTime?
  version       Int           @default(1)
  uploadedBy    String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  BDOpportunity BDOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([opportunityId, version])
  @@index([sentAt])
  @@index([status])
}

model BDStage {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  order         Int
  probability   Float
  serviceLine   String?
  isActive      Boolean         @default(true)
  isDefault     Boolean         @default(false)
  color         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  BDOpportunity BDOpportunity[]

  @@unique([serviceLine, name])
  @@index([isActive])
  @@index([order])
  @@index([serviceLine])
}

model Client {
  id                       Int                        @id @default(autoincrement())
  clientCode               String                     @unique @db.NVarChar(10)
  clientNameFull           String?                    @db.NVarChar(255)
  groupCode                String                     @db.NVarChar(10)
  groupDesc                String                     @db.NVarChar(150)
  clientPartner            String                     @db.NVarChar(10)
  clientManager            String                     @db.NVarChar(10)
  clientIncharge           String                     @db.NVarChar(10)
  active                   String                     @db.VarChar(3)
  clientDateOpen           DateTime?
  clientDateTerminate      DateTime?
  industry                 String?                    @db.NVarChar(255)
  sector                   String?                    @db.NVarChar(255)
  forvisMazarsIndustry     String?                    @db.NVarChar(255)
  forvisMazarsSector       String?                    @db.NVarChar(255)
  forvisMazarsSubsector    String?                    @db.NVarChar(255)
  clientOCFlag             Boolean
  clientTaxFlag            Boolean?
  clientSecFlag            Boolean?
  creditor                 Boolean?
  rolePlayer               Boolean
  typeCode                 String                     @db.NVarChar(10)
  typeDesc                 String                     @db.NVarChar(50)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  GSClientID               String                     @unique @db.UniqueIdentifier
  BDOpportunity            BDOpportunity[]
  ClientAcceptanceResponse ClientAcceptanceResponse[]
  ClientAnalyticsDocument  ClientAnalyticsDocument[]
  ClientCreditRating       ClientCreditRating[]
  Debtors                  Debtors[]
  Task                     Task[]
  Wip                      Wip[]
  WIPTransactions          WIPTransactions[]
  DrsTransactions          DrsTransactions[]
  AgedWip                  AgedWip[]

  @@index([active])
  @@index([clientCode])
  @@index([GSClientID])
  @@index([clientNameFull])
  @@index([clientTaxFlag])
  @@index([groupCode])
  @@index([groupDesc])
  @@index([updatedAt(sort: Desc)])
  @@index([groupDesc, clientNameFull])
  @@index([industry])
  @@index([sector])
}

model ClientAcceptanceResponse {
  id                 Int                  @id(map: "PK__ClientAc__3213E83F94B62F25") @default(autoincrement())
  taskId             Int
  clientId           Int
  questionnaireType  String               @db.NVarChar(50)
  overallRiskScore   Float?
  riskRating         String?              @db.NVarChar(20)
  riskSummary        String?              @db.NVarChar(Max)
  completedAt        DateTime?
  completedBy        String?              @db.NVarChar(200)
  reviewedBy         String?              @db.NVarChar(200)
  reviewedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now()) @updatedAt
  AcceptanceAnswer   AcceptanceAnswer[]
  AcceptanceDocument AcceptanceDocument[]
  Client             Client               @relation(fields: [clientId], references: [id], onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Client")
  Task               Task                 @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ClientAcceptanceResponse_Task")

  @@index([clientId])
  @@index([taskId])
  @@index([taskId, questionnaireType])
  @@index([questionnaireType])
  @@index([riskRating])
}

model ClientAnalyticsDocument {
  id                   Int                    @id @default(autoincrement())
  clientId             Int
  documentType         String
  fileName             String
  filePath             String
  fileSize             Int
  uploadedBy           String
  uploadedAt           DateTime               @default(now())
  extractedData        String?                @db.NVarChar(Max)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Client               Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  CreditRatingDocument CreditRatingDocument[]

  @@index([clientId])
  @@index([documentType])
  @@index([uploadedAt(sort: Desc)])
}

model ClientCreditRating {
  id                   Int                    @id @default(autoincrement())
  clientId             Int
  ratingScore          Float
  ratingGrade          String
  ratingDate           DateTime               @default(now())
  analysisReport       String                 @db.NVarChar(Max)
  financialRatios      String                 @db.NVarChar(Max)
  confidence           Float
  analyzedBy           String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Client               Client                 @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  CreditRatingDocument CreditRatingDocument[]

  @@index([clientId])
  @@index([clientId, ratingDate(sort: Desc)])
  @@index([ratingDate(sort: Desc)])
  @@index([ratingGrade])
}

model ComplianceChecklist {
  id          Int       @id @default(autoincrement())
  taskId      Int
  title       String
  description String?   @db.NVarChar(Max)
  dueDate     DateTime?
  priority    String    @default("MEDIUM")
  status      String    @default("PENDING")
  assignedTo  String?
  completedAt DateTime?
  completedBy String?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([assignedTo])
  @@index([dueDate])
  @@index([taskId])
  @@index([status])
}

model CreditRatingDocument {
  id                      Int                     @id @default(autoincrement())
  creditRatingId          Int
  analyticsDocumentId     Int
  createdAt               DateTime                @default(now())
  ClientAnalyticsDocument ClientAnalyticsDocument @relation(fields: [analyticsDocumentId], references: [id], onUpdate: NoAction)
  ClientCreditRating      ClientCreditRating      @relation(fields: [creditRatingId], references: [id], onDelete: Cascade)

  @@unique([creditRatingId, analyticsDocumentId])
  @@index([analyticsDocumentId])
  @@index([creditRatingId])
}

model EmailLog {
  id              Int       @id @default(autoincrement())
  recipientEmail  String
  recipientUserId String?
  emailType       String
  subject         String
  status          String
  errorMessage    String?
  metadata        String?   @db.NVarChar(Max)
  sentAt          DateTime?
  createdAt       DateTime  @default(now())
  User            User?     @relation(fields: [recipientUserId], references: [id])

  @@index([emailType])
  @@index([recipientUserId])
  @@index([status])
}

model Employee {
  id              Int       @id @default(autoincrement())
  GSEmployeeID    String    @unique @db.UniqueIdentifier
  EmpCode         String    @db.NVarChar(10)
  EmpName         String    @db.NVarChar(50)
  EmpNameFull     String    @db.NVarChar(63)
  OfficeCode      String    @db.NVarChar(10)
  SLGroup         String    @db.NVarChar(10)
  ServLineCode    String    @db.NVarChar(10)
  ServLineDesc    String    @db.NVarChar(150)
  SubServLineCode String    @db.NVarChar(10)
  SubServLineDesc String    @db.NVarChar(50)
  EmpCatCode      String    @db.NVarChar(5)
  EmpCatDesc      String    @db.NVarChar(50)
  EmpCatType      String?   @db.NVarChar(1)
  RateValue       Float     @db.Money
  EmpDateLeft     DateTime?
  Active          String    @db.VarChar(3)
  EmpDateStarted  DateTime?
  Team            String?   @db.NVarChar(100)
  WinLogon        String?   @db.NVarChar(100)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([Active])
  @@index([EmpCode])
  @@index([GSEmployeeID])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([WinLogon])
}

model FilingStatus {
  id              Int       @id @default(autoincrement())
  taskId          Int
  filingType      String
  description     String?
  status          String    @default("PENDING")
  deadline        DateTime?
  submittedDate   DateTime?
  approvedDate    DateTime?
  referenceNumber String?
  notes           String?   @db.NVarChar(Max)
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Task            Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([taskId])
  @@index([status])
}

model InAppNotification {
  id                                      Int       @id @default(autoincrement())
  userId                                  String
  taskId                                  Int?
  type                                    String
  title                                   String
  message                                 String    @db.NVarChar(Max)
  actionUrl                               String?
  isRead                                  Boolean   @default(false)
  readAt                                  DateTime?
  metadata                                String?   @db.NVarChar(Max)
  fromUserId                              String?
  createdAt                               DateTime  @default(now())
  User_InAppNotification_fromUserIdToUser User?     @relation("InAppNotification_fromUserIdToUser", fields: [fromUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Task                                    Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User_InAppNotification_userIdToUser     User      @relation("InAppNotification_userIdToUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([createdAt(sort: Desc)])
  @@index([fromUserId])
  @@index([taskId])
  @@index([userId])
  @@index([userId, isRead])
}

model LegalPrecedent {
  id        Int      @id @default(autoincrement())
  taskId    Int
  caseName  String
  citation  String
  court     String?
  year      Int?
  summary   String   @db.NVarChar(Max)
  relevance String?  @db.NVarChar(Max)
  link      String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([year])
}

model MappedAccount {
  id               Int      @id @default(autoincrement())
  accountCode      String
  accountName      String
  section          String
  subsection       String
  balance          Float
  priorYearBalance Float    @default(0)
  sarsItem         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  taskId           Int
  Task             Task     @relation(fields: [taskId], references: [id])

  @@index([taskId, accountCode])
  @@index([taskId])
  @@index([taskId, section])
  @@index([taskId, section, subsection])
}

model NotificationPreference {
  id               Int      @id @default(autoincrement())
  userId           String
  taskId           Int?
  notificationType String
  emailEnabled     Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Task             Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, taskId, notificationType])
  @@index([taskId])
  @@index([userId])
}

model OpinionChatMessage {
  id                  Int          @id @default(autoincrement())
  opinionDraftId      Int
  role                String
  content             String       @db.NVarChar(Max)
  metadata            String?      @db.NVarChar(Max)
  sectionGenerationId String?
  sectionType         String?
  createdAt           DateTime     @default(now())
  OpinionDraft        OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, createdAt])
  @@index([sectionGenerationId])
}

model OpinionDocument {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  fileName       String
  fileType       String
  fileSize       Int
  filePath       String
  category       String
  extractedText  String?      @db.NVarChar(Max)
  vectorized     Boolean      @default(false)
  uploadedBy     String
  createdAt      DateTime     @default(now())
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([opinionDraftId])
}

model OpinionDraft {
  id                 Int                  @id @default(autoincrement())
  taskId             Int
  version            Int                  @default(1)
  title              String
  content            String               @db.NVarChar(Max)
  status             String               @default("DRAFT")
  createdBy          String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  OpinionChatMessage OpinionChatMessage[]
  OpinionDocument    OpinionDocument[]
  Task               Task                 @relation(fields: [taskId], references: [id], onDelete: Cascade)
  OpinionSection     OpinionSection[]

  @@index([taskId])
  @@index([taskId, version])
  @@index([status])
}

model OpinionSection {
  id             Int          @id @default(autoincrement())
  opinionDraftId Int
  sectionType    String
  title          String
  content        String       @db.NVarChar(Max)
  aiGenerated    Boolean      @default(false)
  reviewed       Boolean      @default(false)
  reviewedBy     String?
  reviewedAt     DateTime?
  order          Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  OpinionDraft   OpinionDraft @relation(fields: [opinionDraftId], references: [id], onDelete: Cascade)

  @@index([opinionDraftId, order])
}

model ResearchNote {
  id        Int      @id @default(autoincrement())
  taskId    Int
  title     String
  content   String   @db.NVarChar(Max)
  tags      String?
  category  String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([taskId])
}

model SarsResponse {
  id              Int       @id @default(autoincrement())
  taskId          Int
  referenceNumber String
  subject         String
  content         String    @db.NVarChar(Max)
  status          String    @default("PENDING")
  responseType    String
  deadline        DateTime?
  sentDate        DateTime?
  receivedDate    DateTime?
  documentPath    String?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Task            Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([taskId])
  @@index([status])
}

model ServiceLineMaster {
  code        String   @id @db.NVarChar(50)
  name        String   @db.NVarChar(200)
  description String?  @db.NVarChar(500)
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
  @@index([sortOrder])
}

model ServiceLineExternal {
  id                   Int      @id @default(autoincrement())
  ServLineCode         String?  @db.NVarChar(10)
  ServLineDesc         String?  @db.NVarChar(150)
  GLPrefix             String?  @db.NVarChar(10)
  SLGroup              String?  @db.NVarChar(10)
  masterCode           String?  @db.NVarChar(50)
  SubServlineGroupCode String?  @db.NVarChar(10)
  SubServlineGroupDesc String?  @db.NVarChar(150)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([masterCode])
  @@index([SubServlineGroupCode])
}

model ServiceLineUser {
  id                  Int      @id @default(autoincrement())
  userId              String
  subServiceLineGroup String
  role                String   @default("USER")
  assignmentType      String   @default("SPECIFIC_SUBGROUP")
  parentAssignmentId  Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  User                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subServiceLineGroup])
  @@index([subServiceLineGroup])
  @@index([userId])
  @@index([assignmentType])
  @@index([parentAssignmentId])
  @@index([userId, assignmentType])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Task {
  id                       Int                        @id @default(autoincrement())
  GSTaskID                 String                     @unique @db.UniqueIdentifier
  GSClientID               String?                    @db.UniqueIdentifier
  TaskCode                 String                     @db.NVarChar(10)
  TaskDesc                 String                     @db.NVarChar(150)
  TaskPartner              String                     @db.NVarChar(10)
  TaskPartnerName          String                     @db.NVarChar(50)
  TaskManager              String                     @db.NVarChar(10)
  TaskManagerName          String                     @db.NVarChar(50)
  OfficeCode               String                     @db.NVarChar(10)
  SLGroup                  String                     @db.NVarChar(10)
  ServLineCode             String                     @db.NVarChar(10)
  ServLineDesc             String                     @db.NVarChar(150)
  Active                   String                     @db.VarChar(3)
  TaskDateOpen             DateTime
  TaskDateTerminate        DateTime?
  createdBy                String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  AdjustmentDocument       AdjustmentDocument[]
  AITaxReport              AITaxReport[]
  ClientAcceptanceResponse ClientAcceptanceResponse[]
  ComplianceChecklist      ComplianceChecklist[]
  FilingStatus             FilingStatus[]
  InAppNotification        InAppNotification[]
  LegalPrecedent           LegalPrecedent[]
  MappedAccount            MappedAccount[]
  NotificationPreference   NotificationPreference[]
  OpinionDraft             OpinionDraft[]
  ResearchNote             ResearchNote[]
  SarsResponse             SarsResponse[]
  Client                   Client?                    @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)
  User                     User?                      @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TaskAcceptance           TaskAcceptance?
  TaskDocument             TaskDocument[]
  TaskEngagementLetter     TaskEngagementLetter?
  TaskTeam                 TaskTeam[]
  TaxAdjustment            TaxAdjustment[]
  Wip                      Wip[]
  WIPTransactions          WIPTransactions[]
  AgedWip                  AgedWip[]

  @@index([Active])
  @@index([GSClientID])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([SLGroup])
  @@index([TaskCode])
  @@index([TaskManager])
  @@index([TaskPartner])
  @@index([ServLineCode, Active])
  @@index([updatedAt(sort: Desc)])
  @@index([ServLineCode, Active, updatedAt(sort: Desc)])
  @@index([TaskDesc])
}

model TaskTeam {
  id        Int      @id @default(autoincrement())
  taskId    Int
  userId    String
  role      String   @default("VIEWER")
  createdAt DateTime @default(now())
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@index([role])
  @@index([userId, taskId])
  @@index([userId, taskId, role])
}

model TaskAcceptance {
  id                 Int       @id @default(autoincrement())
  taskId             Int       @unique
  acceptanceApproved Boolean   @default(false)
  approvedBy         String?
  approvedAt         DateTime?
  questionnaireType  String?
  overallRiskScore   Float?
  riskRating         String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  Task               Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([riskRating])
}

model TaskEngagementLetter {
  id          Int       @id @default(autoincrement())
  taskId      Int       @unique
  generated   Boolean   @default(false)
  uploaded    Boolean   @default(false)
  filePath    String?
  content     String?   @db.NVarChar(Max)
  templateId  Int?
  generatedAt DateTime?
  generatedBy String?
  uploadedAt  DateTime?
  uploadedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskDocument {
  id          Int      @id @default(autoincrement())
  taskId      Int
  fileName    String
  fileType    String
  fileSize    Int
  filePath    String
  category    String
  description String?
  version     Int      @default(1)
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([category])
}

model TaxAdjustment {
  id                 Int                  @id @default(autoincrement())
  taskId             Int
  type               String
  description        String
  amount             Float
  status             String               @default("SUGGESTED")
  sourceDocuments    String?
  extractedData      String?
  calculationDetails String?
  notes              String?
  sarsSection        String?
  confidenceScore    Float?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  AdjustmentDocument AdjustmentDocument[]
  Task               Task                 @relation(fields: [taskId], references: [id])

  @@index([createdAt])
  @@index([taskId])
  @@index([taskId, status, createdAt(sort: Desc)])
  @@index([status])
  @@index([status, taskId])
}

model Template {
  id              Int               @id @default(autoincrement())
  name            String
  description     String?
  type            String
  serviceLine     String?
  projectType     String?
  content         String            @db.NVarChar(Max)
  active          Boolean           @default(true)
  createdBy       String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  TemplateSection TemplateSection[]

  @@index([active])
  @@index([projectType])
  @@index([serviceLine])
  @@index([type])
}

model TemplateSection {
  id                     Int      @id @default(autoincrement())
  templateId             Int
  sectionKey             String
  title                  String
  content                String   @db.NVarChar(Max)
  isRequired             Boolean  @default(true)
  isAiAdaptable          Boolean  @default(false)
  order                  Int
  applicableServiceLines String?  @db.NVarChar(Max)
  applicableProjectTypes String?  @db.NVarChar(Max)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  Template               Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([sectionKey])
  @@index([templateId])
}

// News Bulletin - category stored as String (SQL Server doesn't support enums)
// Valid categories: ANNOUNCEMENT, POLICY_UPDATE, EVENT, ACHIEVEMENT, REMINDER,
//                   CLIENT_WIN, MARKET_UPDATE, INDUSTRY_NEWS, PARTNERSHIP, HIRING
model NewsBulletin {
  id                 Int       @id @default(autoincrement())
  title              String    @db.NVarChar(255)
  summary            String    @db.NVarChar(500)
  body               String    @db.NVarChar(Max)
  category           String    @db.NVarChar(50)
  serviceLine        String?   @db.NVarChar(50)
  effectiveDate      DateTime
  expiresAt          DateTime?
  contactPerson      String?   @db.NVarChar(255)
  actionRequired     Boolean   @default(false)
  callToActionUrl    String?   @db.NVarChar(500)
  callToActionText   String?   @db.NVarChar(100)
  isPinned           Boolean   @default(false)
  isActive           Boolean   @default(true)
  documentFileName   String?   @db.NVarChar(255)
  documentFilePath   String?   @db.NVarChar(500)
  documentFileSize   Int?
  documentUploadedAt DateTime?
  showDocumentLink   Boolean   @default(false)
  createdById        String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  createdBy          User      @relation(fields: [createdById], references: [id], onUpdate: NoAction)

  @@index([category])
  @@index([serviceLine])
  @@index([effectiveDate])
  @@index([isActive])
  @@index([isPinned])
  @@index([isActive, effectiveDate(sort: Desc)])
}

model User {
  id                                                   String                   @id
  name                                                 String?
  email                                                String                   @unique
  emailVerified                                        DateTime?
  image                                                String?
  role                                                 String                   @default("USER")
  createdAt                                            DateTime                 @default(now())
  updatedAt                                            DateTime                 @updatedAt
  Account                                              Account[]
  EmailLog                                             EmailLog[]
  InAppNotification_InAppNotification_fromUserIdToUser InAppNotification[]      @relation("InAppNotification_fromUserIdToUser")
  InAppNotification_InAppNotification_userIdToUser     InAppNotification[]      @relation("InAppNotification_userIdToUser")
  NewsBulletin                                         NewsBulletin[]
  NotificationPreference                               NotificationPreference[]
  ServiceLineUser                                      ServiceLineUser[]
  Session                                              Session[]
  Task                                                 Task[]
  TaskTeam                                             TaskTeam[]

  @@index([role])
}

model Debtors {
  id                 Int       @id @default(autoincrement())
  PeriodRef          Int?
  PeriodStart        DateTime?
  PeriodEnd          DateTime?
  GSClientID         String    @db.UniqueIdentifier
  Biller             String    @db.NVarChar(10)
  OfficeCode         String    @db.NVarChar(10)
  ServLineCode       String    @db.NVarChar(10)
  LTDInv             Float?    @db.Money
  LTDFee             Float?    @db.Money
  LTDVat             Float?    @db.Money
  LTDCn              Float?    @db.Money
  LTDRec             Float?    @db.Money
  LTDInt             Float?    @db.Money
  LTDPLFC            Float?    @db.Money
  YTDInv             Float?    @db.Money
  YTDFee             Float?    @db.Money
  YTDVat             Float?    @db.Money
  YTDCn              Float?    @db.Money
  YTDRec             Float?    @db.Money
  YTDInt             Float?    @db.Money
  YTDPLFC            Float?    @db.Money
  PTDInv             Float?    @db.Money
  PTDFee             Float?    @db.Money
  PTDVat             Float?    @db.Money
  PTDCn              Float?    @db.Money
  PTDRec             Float?    @db.Money
  PTDInt             Float?    @db.Money
  PTDPLFC            Float?    @db.Money
  CBal               Float?    @db.Money
  BalCurr            Float?    @db.Money
  Bal30              Float?    @db.Money
  Bal60              Float?    @db.Money
  Bal90              Float?    @db.Money
  Bal120             Float?    @db.Money
  Bal150             Float?    @db.Money
  Bal180             Float?    @db.Money
  DebtorProvision    Float?    @db.Money
  PTDDebtorProvision Float?    @db.Money
  YTDDebtorProvision Float?    @db.Money
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  Client             Client?   @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)

  @@index([GSClientID])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([Biller])
  @@index([PeriodRef])
  @@map("Debtors")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Wip {
  id               Int       @id @default(autoincrement())
  GSWipID          String    @unique @db.UniqueIdentifier
  PeriodRef        Int?
  PeriodStart      DateTime?
  PeriodEnd        DateTime?
  GSClientID       String    @db.UniqueIdentifier
  GSTaskID         String    @db.UniqueIdentifier
  ClientCode       String    @db.NVarChar(10)
  TaskCode         String    @db.NVarChar(10)
  OfficeCode       String    @db.NVarChar(10)
  ServLineCode     String    @db.NVarChar(10)
  TaskPartner      String    @db.NVarChar(10)
  LTDTime          Float?    @db.Money
  LTDDisb          Float?    @db.Money
  LTDFeeTime       Float?    @db.Money
  LTDFeeDisb       Float?    @db.Money
  LTDAdjTime       Float?    @db.Money
  LTDAdjDisb       Float?    @db.Money
  LTDCost          Float?    @db.Money
  YTDTime          Float?    @db.Money
  YTDDisb          Float?    @db.Money
  YTDFeeTime       Float?    @db.Money
  YTDFeeDisb       Float?    @db.Money
  YTDAdjTime       Float?    @db.Money
  YTDAdjDisb       Float?    @db.Money
  YTDCost          Float?    @db.Money
  PTDTime          Float?    @db.Money
  PTDDisb          Float?    @db.Money
  PTDFeeTime       Float?    @db.Money
  PTDFeeDisb       Float?    @db.Money
  PTDAdjTime       Float?    @db.Money
  PTDAdjDisb       Float?    @db.Money
  PTDCost          Float?    @db.Money
  BalTime          Float?    @db.Money
  BalDisb          Float?    @db.Money
  BalWIP           Float?    @db.Money
  WipProvision     Float?    @db.Money
  PTDProvision     Float?    @db.Money
  YTDProvision     Float?    @db.Money
  PTDPendingTime   Float?    @db.Money
  YTDPendingTime   Float?    @db.Money
  LTDPendingTime   Float?    @db.Money
  PTDCostExcludeCP Float?    @db.Money
  YTDCostExcludeCP Float?    @db.Money
  LTDCostExcludeCP Float?    @db.Money
  LTDHours         Float?    @db.Money
  YTDHours         Float?    @db.Money
  PTDHours         Float?    @db.Money
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  Client           Client?   @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)
  Task             Task?     @relation(fields: [GSTaskID], references: [GSTaskID], onDelete: NoAction, onUpdate: NoAction)

  @@index([GSClientID])
  @@index([GSTaskID])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([TaskCode])
  @@index([TaskPartner])
  @@index([PeriodRef])
  @@map("Wip")
}

model WIPTransactions {
  id                   Int       @id @default(autoincrement())
  GSWIPTransID         String    @unique @db.UniqueIdentifier
  GSTaskID             String    @db.UniqueIdentifier
  GSClientID           String?   @db.UniqueIdentifier
  OfficeCode           String    @db.NVarChar(10)
  OfficeDesc           String    @db.NVarChar(100)
  TranDate             DateTime
  TranType             String    @db.VarChar(23)
  TType                String    @db.VarChar(3)
  Ref                  String?   @db.NVarChar(20)
  ClientCode           String    @db.NVarChar(10)
  ClientName           String?   @db.NVarChar(259)
  TaskCode             String    @db.NVarChar(10)
  TaskDesc             String    @db.NVarChar(150)
  TaskPartner          String    @db.NVarChar(10)
  PartnerName          String    @db.NVarChar(50)
  TaskManager          String    @db.NVarChar(10)
  ManagerName          String    @db.NVarChar(50)
  TaskServLine         String    @db.NVarChar(10)
  TaskServLineDesc     String    @db.NVarChar(150)
  EmpCode              String?   @db.NVarChar(10)
  EmpName              String?   @db.NVarChar(50)
  EmpOffice            String?   @db.NVarChar(10)
  EmpServLineCode      String?   @db.NVarChar(10)
  EmpServLineDesc      String?   @db.NVarChar(150)
  TranSubServLine      String?   @db.NVarChar(10)
  TranSubServLineDesc  String?   @db.NVarChar(50)
  ADOType              String?   @db.NVarChar(10)
  ADODesc              String?   @db.NVarChar(100)
  Hour                 Float     @db.Money
  Rate                 String?   @db.NVarChar(2)
  Amount               Float?    @db.Money
  Cost                 Float     @db.Money
  Narr                 String?   @db.Text
  TaskDateTerminate    DateTime?
  Ordinal              Int
  GroupCode            String?   @db.NVarChar(10)
  GroupDesc            String?   @db.NVarChar(150)
  MainServLineCode     String    @db.NVarChar(10)
  MainServLineDesc     String    @db.NVarChar(150)
  ServLineGroup        String    @db.NVarChar(10)
  EmpMainServLineCode  String?   @db.NVarChar(10)
  EmpMainServLineDesc  String?   @db.NVarChar(150)
  EmpServLineGroup     String?   @db.NVarChar(10)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  Client               Client?   @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)
  Task                 Task?     @relation(fields: [GSTaskID], references: [GSTaskID], onDelete: NoAction, onUpdate: NoAction)

  @@index([GSClientID])
  @@index([GSTaskID])
  @@index([TranDate])
  @@index([OfficeCode])
  @@index([ServLineGroup])
  @@index([EmpCode])
  @@index([GSTaskID, TranDate])
  @@map("WIPTransactions")
}

model DrsTransactions {
  id                  Int       @id @default(autoincrement())
  GSDebtorsTranID     String    @unique @db.UniqueIdentifier
  GSClientID          String    @db.UniqueIdentifier
  ClientCode          String    @db.NVarChar(10)
  ClientNameFull      String?   @db.NVarChar(222)
  GroupCode           String    @db.NVarChar(10)
  GroupDesc           String    @db.NVarChar(150)
  OfficeCode          String    @db.NVarChar(10)
  OfficeDesc          String    @db.NVarChar(100)
  ServLineCode        String    @db.NVarChar(10)
  ServLineDesc        String    @db.NVarChar(150)
  Biller              String    @db.NVarChar(10)
  BillerName          String    @db.NVarChar(50)
  TranDate            DateTime
  EntryType           String?   @db.VarChar(19)
  Ordinal             Int?
  Reference           String?   @db.NVarChar(20)
  InvNumber           String?   @db.NVarChar(20)
  Amount              Float?    @db.Money
  Vat                 Float?    @db.Money
  Total               Float?    @db.Money
  Batch               String?   @db.NVarChar(10)
  Allocation          String    @db.NVarChar(20)
  Narration           String?   @db.Text
  VatCode             String?   @db.NVarChar(2)
  PeriodKey           Int
  EntryGroupCode      String?   @db.NVarChar(10)
  EntryGroup          String?   @db.NVarChar(50)
  DRAccount           String?   @db.NVarChar(30)
  CRAccount           String?   @db.NVarChar(30)
  ClientPartner       String    @db.NVarChar(10)
  ClientPartnerName   String    @db.NVarChar(50)
  ClientManager       String    @db.NVarChar(10)
  ClientManagerName   String    @db.NVarChar(50)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  Client              Client    @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)

  @@index([GSClientID])
  @@index([TranDate])
  @@index([Biller])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([PeriodKey])
  @@index([GSClientID, TranDate])
  @@map("DrsTransactions")
}

model AgedWip {
  id           Int       @id @default(autoincrement())
  GSAgedWipID  String    @unique @db.UniqueIdentifier
  GSClientID   String?   @db.UniqueIdentifier
  GSTaskID     String?   @db.UniqueIdentifier
  PeriodRef    Int?
  PeriodStart  DateTime?
  PeriodEnd    DateTime?
  ClientCode   String?   @db.NVarChar(10)
  TaskCode     String?   @db.NVarChar(10)
  OfficeCode   String    @db.NVarChar(10)
  ServLineCode String    @db.NVarChar(10)
  TaskPartner  String    @db.NVarChar(10)
  Curr         Float?    @db.Money
  Bal30        Float?    @db.Money
  Bal60        Float?    @db.Money
  Bal90        Float?    @db.Money
  Bal120       Float?    @db.Money
  Bal150       Float?    @db.Money
  Bal180       Float?    @db.Money
  BalWip       Float?    @db.Money
  Provision    Float?    @db.Money
  NettWip      Float?    @db.Money
  PtdFeeAmt    Float?    @db.Money
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Client       Client?   @relation(fields: [GSClientID], references: [GSClientID], onDelete: NoAction, onUpdate: NoAction)
  Task         Task?     @relation(fields: [GSTaskID], references: [GSTaskID], onDelete: NoAction, onUpdate: NoAction)

  @@index([GSClientID])
  @@index([GSTaskID])
  @@index([PeriodRef])
  @@index([OfficeCode])
  @@index([ServLineCode])
  @@index([TaskPartner])
  @@index([GSClientID, PeriodRef])
  @@index([GSTaskID, PeriodRef])
  @@map("AgedWip")
}

model ExternalLink {
  id        Int      @id @default(autoincrement())
  name      String   @db.NVarChar(100)
  url       String   @db.NVarChar(500)
  icon      String   @db.NVarChar(50)
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([name])
}
