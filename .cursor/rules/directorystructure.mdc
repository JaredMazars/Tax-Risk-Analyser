---
alwaysApply: true
---

# Directory Structure

This project follows a feature-based architecture using Next.js 14 App Router, with clear separation of concerns between presentation, business logic, and data access layers.

## Root Structure

```
/
├── src/                    # Application source code
├── prisma/                 # Database schema and migrations
├── public/                 # Static assets
├── scripts/                # Utility scripts
└── uploads/                # User-uploaded files (runtime)
```

## `/src` - Source Code Organization

### `/src/app` - Next.js App Router

Pages and API routes following App Router conventions.

#### Pages Structure
```
/src/app/
├── page.tsx                           # Landing page
├── layout.tsx                         # Root layout
├── globals.css                        # Global styles
├── auth/                              # Authentication pages
│   ├── signin/page.tsx
│   ├── signout/page.tsx
│   └── error/page.tsx
└── dashboard/                         # Main application
    ├── page.tsx                       # Dashboard home (projects list)
    ├── layout.tsx                     # Dashboard layout with navigation
    ├── clients/
    │   ├── page.tsx                   # Clients list
    │   └── [id]/page.tsx              # Client detail
    ├── projects/[id]/
    │   ├── page.tsx                   # Project overview
    │   ├── mapping/page.tsx           # Trial balance mapping
    │   ├── tax-calculation/           # Tax calculation pages
    │   ├── balance-sheet/page.tsx     # Balance sheet view
    │   ├── income-statement/page.tsx  # P&L view
    │   ├── opinion-drafting/page.tsx  # Tax opinion drafting
    │   ├── compliance-checklist/page.tsx
    │   ├── legal-precedents/page.tsx
    │   ├── research-notes/page.tsx
    │   ├── sars-responses/page.tsx
    │   ├── document-management/page.tsx
    │   ├── filing-status/page.tsx
    │   ├── reporting/page.tsx
    │   └── users/page.tsx             # Project user management
    └── admin/
        └── users/page.tsx             # User administration
```

#### API Routes Structure
```
/src/app/api/
├── health/route.ts                    # Health check endpoint
├── auth/
│   ├── login/route.ts                 # Azure AD login initiation
│   ├── callback/route.ts              # OAuth callback handler
│   ├── logout/route.ts                # Single session logout
│   ├── logout-all/route.ts            # All sessions logout
│   └── session/route.ts               # Current session info
├── clients/
│   ├── route.ts                       # GET (list), POST (create)
│   └── [id]/route.ts                  # GET, PATCH, DELETE
├── projects/
│   ├── route.ts                       # GET (list), POST (create)
│   └── [id]/                          # Project-scoped resources
│       ├── route.ts                   # GET, PATCH, DELETE
│       ├── trial-balance/route.ts
│       ├── mapped-accounts/route.ts
│       ├── tax-adjustments/route.ts
│       ├── tax-calculation/route.ts
│       ├── ai-tax-report/route.ts
│       ├── opinion-drafts/route.ts
│       ├── compliance-checklist/route.ts
│       ├── legal-precedents/route.ts
│       ├── research-notes/route.ts
│       ├── sars-responses/route.ts
│       ├── administration-documents/route.ts
│       ├── filing-status/route.ts
│       └── users/route.ts             # Project user access
├── admin/
│   └── users/route.ts                 # Admin user management
├── users/
│   └── search/route.ts                # User search (for adding to projects)
└── map/route.ts                       # Legacy mapping endpoint
```

### `/src/components` - React Components

Feature-based component organization with shared components.

```
/src/components/
├── features/                          # Feature-specific components
│   ├── clients/
│   │   └── ClientSelector.tsx
│   ├── opinions/
│   │   └── OpinionAssistant/         # Tax opinion drafting UI
│   │       ├── ChatInterface.tsx
│   │       ├── DocumentManager.tsx
│   │       ├── OpinionPreview.tsx
│   │       └── SectionEditor.tsx
│   ├── projects/
│   │   ├── CreateProjectModal.tsx
│   │   ├── ProjectTypeSelector.tsx
│   │   └── UserManagement/           # Project user access
│   │       ├── ProjectUserList.tsx
│   │       ├── RoleSelector.tsx
│   │       └── UserSearchModal.tsx
│   ├── reports/                      # Financial report viewers
│   │   ├── AITaxReport.tsx
│   │   ├── BalanceSheetReport.tsx
│   │   ├── IncomeStatementReport.tsx
│   │   ├── TaxCalculationReport.tsx
│   │   └── TrialBalanceReport.tsx
│   └── tax-adjustments/
│       ├── AddAdjustmentModal.tsx
│       ├── RemappingModal.tsx
│       └── TaxAdjustmentCard.tsx
├── layout/                            # Layout components
│   ├── DashboardNav.tsx              # Main navigation
│   └── UserMenu.tsx                  # User dropdown
├── shared/                            # Reusable UI components
│   ├── CalculationBreakdown.tsx
│   ├── DocumentUploader.tsx
│   ├── ExportMenu.tsx
│   ├── ExtractionResults.tsx
│   ├── FileUpload.tsx
│   ├── ProcessingModal.tsx
│   ├── StatusBadge.tsx
│   └── TaxYearInput.tsx
├── ui/                                # Base UI components (shadcn/ui)
└── Providers.tsx                      # React Query & context providers
```

### `/src/lib` - Business Logic & Services

Core business logic, services, and utilities organized by domain.

```
/src/lib/
├── agents/                            # AI agent orchestration
│   ├── agentOrchestrator.ts          # Main orchestrator
│   ├── analysisAgent.ts              # Document analysis
│   ├── draftingAgent.ts              # Opinion drafting
│   ├── interviewAgent.ts             # Interactive questioning
│   ├── researchAgent.ts              # Legal research
│   ├── reviewAgent.ts                # Quality review
│   └── sectionGenerator.ts           # Section generation
├── ai/                                # AI configuration
│   ├── config.ts                     # Azure OpenAI setup
│   └── schemas.ts                    # AI input/output schemas
├── api/                               # API utilities
│   ├── middleware.ts                 # Auth middleware (withAuth, withProjectAccess)
│   └── types.ts                      # API type definitions
├── auth.ts                            # Authentication core (MSAL, JWT)
├── config/                            # Application configuration
│   ├── env.ts                        # Environment variables
│   └── queryClient.ts                # React Query config
├── db/
│   └── prisma.ts                     # Prisma client singleton
├── services/                          # Domain services
│   ├── auth/
│   │   ├── auth.ts                   # Session management
│   │   └── graphClient.ts            # Microsoft Graph API
│   ├── cache/
│   │   └── CacheService.ts           # Caching layer
│   ├── documents/
│   │   ├── blobStorage.ts            # Azure Blob Storage
│   │   ├── documentExtractor.ts      # Document processing
│   │   └── documentIntelligence.ts   # Azure Document Intelligence
│   ├── export/
│   │   ├── excelExporter.ts          # Excel export
│   │   ├── pdfExporter.ts            # PDF export
│   │   └── wordExporter.ts           # Word export
│   ├── opinions/
│   │   ├── aiTaxReportGenerator.ts   # AI report generation
│   │   ├── ragEngine.ts              # RAG for document retrieval
│   │   └── sectionMapper.ts          # Opinion section mapping
│   ├── projects/
│   │   └── mappingGuide.ts           # Account mapping logic
│   └── tax/
│       ├── taxAdjustmentEngine.ts    # Tax adjustment calculations
│       └── taxAdjustmentsGuide.ts    # Adjustment suggestions
├── utils/                             # Utility functions
│   ├── apiUtils.ts                   # API helpers
│   ├── errorHandler.ts               # Error handling
│   ├── fileValidator.ts              # File validation
│   ├── formatters.ts                 # Data formatting
│   ├── logger.ts                     # Winston logger
│   ├── projectUtils.ts               # Project helpers
│   ├── rateLimit.ts                  # Rate limiting
│   ├── retryUtils.ts                 # Retry logic
│   └── validation.ts                 # Validation utilities
└── validation/
    └── schemas.ts                    # Zod validation schemas
```

### `/src/types` - TypeScript Type Definitions

```
/src/types/
├── index.ts                          # Re-exports
├── api.ts                            # API types
├── dto.ts                            # Data transfer objects
├── branded.ts                        # Branded types for type safety
├── next-auth.d.ts                    # NextAuth type extensions
└── jspdf-autotable.d.ts             # Third-party type definitions
```

### `/src/constants` - Application Constants

```
/src/constants/
├── routes.ts                         # Route constants (ROUTES, API_ROUTES)
└── business-rules.ts                 # Business rule constants
```

### `/src/hooks` - React Hooks

```
/src/hooks/
├── clients/                          # Client-related hooks
├── projects/
│   └── useProjectData.ts            # Project data fetching
└── shared/                           # Shared hooks
```

### `/src/middleware.ts` - Next.js Middleware

Route-level middleware for authentication and redirects.

## `/prisma` - Database

```
/prisma/
├── schema.prisma                     # Prisma schema definition
├── dev.db                            # SQLite dev database (gitignored)
└── migrations/                       # Database migrations
    ├── migration_lock.toml
    └── [timestamp]_[description]/
        └── migration.sql
```

Database: SQL Server (Azure SQL) in production, SQLite for development.

## Key Patterns

1. **Feature-based organization**: Group related components by feature domain (clients, projects, opinions, reports, tax-adjustments)
2. **Service layer**: Business logic lives in `/src/lib/services/<domain>/`
3. **Type safety**: Shared types in `/src/types/`, validated with Zod schemas
4. **API routes**: RESTful conventions with Next.js App Router
5. **Component hierarchy**: features > shared > ui (base components)
