---
alwaysApply: true
---

# Project Conventions

Next.js 14 (App Router) | TypeScript (strict) | Prisma | React Query | Azure OpenAI | Azure AD

## Styling

See `.cursor/rules/styling.mdc`

## AI

See `.cursor/rules/stylingai-patterns.mdc`

## TypeScript

**Type Organization:**
- Prisma Schema → `types/index.ts` → derive DTOs with Partial/Pick/Omit
- `types/branded.ts`: Branded ID types only
- `types/dto.ts`: Data transfer objects
- `types/api.ts`: API-specific types

**Requirements:**
- Strict mode, `@/*` imports
- ALL IDs use branded types
- Route params converted via `parseXxxId()` utilities
- NO duplicate types, NO deprecated code
- Define enums ONCE in types/index.ts
- `undefined` for optional, `null` for database nulls
- Optional chaining (`?.`) and nullish coalescing (`??`)

**Validation:** All input via Zod schemas in `/src/lib/validation/schemas.ts`

## URL Structure

`/dashboard/[serviceLine]/[subServiceLineGroup]/clients/[id]/tasks/[taskId]`

- `serviceLine`: TAX, AUDIT, ACCOUNTING, ADVISORY
- `subServiceLineGroup`: Dynamic grouping from database
- `ClientID`: Client ID
- `taskId`: Task ID
- Even if the user refers to projects they actually mean tasks  
- The applications centres around clients and tasks


## Security (CRITICAL - NOT Optional)

### Three-Tier Model
1. **System**: `SYSTEM_ADMIN` > `USER`
2. **Service Line**: `PARTNER` > `MANAGER` > `SUPERVISOR` > `USER` > `VIEWER`
3. **Task**: `ADMIN` > `REVIEWER` > `EDITOR` > `VIEWER`

Plus granular permissions: PAGE (dashboard, clients, tasks, admin) and FEATURE (clients.create, tasks.edit, etc.)

### API Route Pattern (REQUIRED - 6 Steps)

1. **Authenticate**: `getCurrentUser()` → return 401 if none
2. **Parse IDs**: Use `parseXxxId()` for branded types
3. **Check Permission**: `checkUserPermission(userId, resource, action)` → return 403 if denied
4. **Filter Service Lines**: `getUserServiceLines()` → filter accessible service lines
5. **Execute**: Query with `select:` (explicit fields only), filter by service lines
6. **Respond**: `successResponse(data)` or `handleApiError(error, context)`

**POST/PUT/PATCH:** Add `sanitizeObject()` + Zod validation after step 2

### Backend Security Checklist

- [ ] `getCurrentUser()` at start
- [ ] `checkUserPermission()` before business logic
- [ ] Filter by `getUserServiceLines()` accessible service lines
- [ ] For tasks: `checkTaskAccess(userId, taskId, role?)`
- [ ] For approvals: `canApproveAcceptance()` or `canApproveEngagementLetter()`
- [ ] Return 401/403/404 appropriately
- [ ] `handleApiError()` in catch blocks
- [ ] Explicit `select:` fields only
- [ ] Transactions for multi-step operations
- [ ] Verify task team membership (TaskTeam table)

### Frontend Security

- Wrap UI: `<PermissionGate resource="x" action="Y">`
- Conditional: `usePermission(resource, action)`
- Server Components default, `'use client'` only when needed
- Never browser popups (use custom modals)

### Authorization Utilities

**Task Access** (`@/lib/services/tasks/taskAuthorization`):
- `checkTaskAccess(userId, taskId, role?)`: Check team membership + role
- `getTaskRole(userId, taskId)`: Get user's task role
- `canModifyTask(userId, taskId)`: Check ADMIN/EDITOR
- `canApproveTask(userId, taskId)`: Check approval permission

**Auth** (`@/lib/services/auth/authorization`):
- `isSystemAdmin(userId)`, `getUserSystemRole()`, `getServiceLineRole()`
- `isPartner()`, `isManager()`, `hasServiceLineAccess()`
- `canApproveEngagementLetter()`, `checkFeaturePermission()`

**Permissions** (`@/lib/services/permissions/permissionService`):
- `getUserPermissions()`, `getRolePermissions()`, `getPermissionMatrix()`
- `checkUserPermissions()`, `checkUserHasAnyPermission()`

### Security Principles

1. Defense in Depth: Check at system, service line, AND task levels
2. Fail Secure: Default deny
3. Explicit Checks: Never assume permission
4. Service Line Isolation: Users see only their service lines (unless SYSTEM_ADMIN)
5. Input Validation: Zod schemas + `sanitizeObject()`
6. No Information Leakage: Generic error messages

## Performance (REQUIRED)

### Database

- ALWAYS explicit `select:` fields
- NEVER `include` unnecessarily
- Batch queries: `Promise.all()`
- Transactions for multi-step operations
- Indexes for filtered fields
- Prevent N+1 queries

### Caching (Redis)

**TTLs:**
- Sessions: 1h (3600s)
- Permissions: 5min (300s)
- User/Service Line/Task: 10min (600s)
- Analytics/Static: 30min (1800s)

**Cache Prefixes** (`CACHE_PREFIXES.*`):
- `SESSION`, `PERMISSION`, `RATE_LIMIT`, `USER`, `TASK`, `SERVICE_LINE`, `NOTIFICATION`, `ANALYTICS`

**Rate Limiting:** `await checkRateLimit(request, RateLimitPresets.STANDARD)`
- Presets: AI_ENDPOINTS (5/min), FILE_UPLOADS (10/min), STANDARD (30/min), READ_ONLY (100/min), AUTH_ENDPOINTS (10/min)

**Background Jobs:** `queue.enqueue(queueType, operation, data, options)` for long tasks
- Queue types: documents, emails, reports
- Never fire-and-forget

### Imports

- Static imports only for core dependencies
- Tree-shakeable exports
- Lazy load heavy dependencies

### Client-Side

- React Query for server state
- Pagination for large datasets
- Server Components default

## Error Handling

- Throw: `new AppError(status, message, ErrorCodes.X, metadata)`
- Catch: `handleApiError(error, context)`
- Codes: VALIDATION_ERROR, NOT_FOUND, FORBIDDEN, UNAUTHORIZED

## Code Quality

- Extract utilities for 3+ uses
- Files under 500 lines
- camelCase file names
- No duplicates, no deprecated code
- Delete .bak/.old immediately
- NO summarization files (e.g., SUMMARY.md, overview.md)
- Business logic in `/src/lib/services/<domain>/`
- Component organization: `ui/`, `layout/`, `shared/`, `features/<domain>/`

## AI Assistant Communication

- Upon task completion, simply state "Completed"
- No verbose summaries or explanations after finishing work
- User can observe progress in real-time

## Core Principles

Security checks are NOT optional. Performance patterns are REQUIRED. Type safety is MANDATORY.
