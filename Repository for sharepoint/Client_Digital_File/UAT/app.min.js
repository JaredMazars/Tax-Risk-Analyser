let client_section_functions={};client_section_functions={client_information_cube:[{M_ClientCode:null}]};$(document).on("change","select[data-sp-element-name='search-client-details-name']",function(){client_section_functions.render_client_details($(this).val())});$(document).on("click",".navigation-panel-list-items li[data-history-index='[1,0]']",function(){client_section_functions.render_client_details(client_section_functions.client_information_cube[0].M_ClientCode)});let client_lookup_component={client_drop_down:[{Title:"Client Name",Description:"Please select your client name",sp_field_name:"search-client-details-name",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"single-select-typeahead exclude-from-meta",additional_filters:"",drop_down_title_field:"M_ClientName",drop_down_value_field:"M_ClientCode",drop_down_order_by:"Title asc",list_name:app_configuration.client_list_name,site_context:app_configuration.client_list_site_context,field_icon:""}]};client_section_functions.render_client_lookup=function(){$(".header-search-box").html(sharepoint_utilities.create_container_form(client_lookup_component.client_drop_down,"client-drop-down form-basic"));sharepoint_utilities.apply_form_plugins(client_lookup_component.client_drop_down)};client_section_functions.render_client_details=function(client_code){if(client_code){let get_client_details=sharepoint_utilities.get_list_items_by_title(app_configuration.client_list_site_context,"*","M_ClientCode eq '"+client_code+"'",app_configuration.client_list_name,"");$.when(get_client_details).done(function(client_data){$(".page-section").html(sharepoint_utilities.create_container_form(client_information_fields,"Client-Information-section"));sharepoint_utilities.apply_form_plugins(client_information_fields);sharepoint_utilities.display_saved_list_fields(client_data,client_information_fields,".Client-Information-section");client_section_functions.client_information_cube=client_data})}};var navigation_cube={};navigation_cube.navigation_set=[];let view_dashboard_navigation={title:"View dashboard",icon:"ViewDashboard",data_type:"static_page",form_data:"Dashboard Landing Page",sub_links:[{title:"View My Clients",sub_links:[]},{title:"My Approval Tasks",sub_links:[]},{title:"My Submissions",sub_links:[]}]};let client_risk_assessment={title:"Client Acceptance and Continuance",icon:"OfficeFormsLogo",data_type:"static_page",form_data:"Client Acceptance Landing Page",sub_links:[{title:"Client Acceptance",data_type:"next_link_selection",form_data:null,sub_links:[{title:"General"},{title:"Team Information"},{title:"Client Information",data_type:"next_link_selection",form_data:null,sub_links:[{title:"General Information About the Engagement"},{title:"PIE"},{title:"Transnational Calculator"},{title:"S90 Calculator"},{title:"S90 Considerations"},{title:"Fee Considerations"},{title:"Key Figures - recent financial year"}]},{title:"EQR Calculator"},{title:"GIAC Form"},{title:"Business Sustainability"},{title:"Appendix A Clients",data_type:"next_link_selection",form_data:null,sub_links:[{title:"Part A - Risk Considered as Major"},{title:"Part B - Risk Considered as Normal"},{title:"Risk Status"}]},{title:"Appendix B Engagements",data_type:"next_link_selection",form_data:null,sub_links:[{title:"Acceptance - Independence and other Considerations"}]},{title:"Appendix C Money Laundering",data_type:"next_link_selection",sub_links:[{title:"Conclusion"}]},{title:"Appendix D",data_type:"next_link_selection",sub_links:[{title:"1. Assessment of compliance with Independence rules"}]},{title:"Approvals"},{title:"Supporting Documents"}]},{title:"Client Continuance",data_type:"next_link_selection",form_data:null,sub_links:[{title:"General"},{title:"Team Information"},{title:"EQR Calculator"},{title:"GIAC Form"},{title:"Business Sustainability"},{title:"Client Information",data_type:"next_link_selection",form_data:null,sub_links:[{title:"General Information About the Engagement"},{title:"PIE"},{title:"Transnational Calculator"},{title:"S90 Calculator"},{title:"S90 Considerations"},{title:"Fee Considerations"},{title:"Key Figures - recent financial year"}]},{title:"Appendix A Clients",data_type:"next_link_selection",form_data:null,sub_links:[{title:"Part A - Risk Considered as Major"},{title:"Part B - Risk Considered as Normal"},{title:"Risk Status"}]},{title:"Appendix B Engagements",data_type:"next_link_selection",form_data:null,sub_links:[{title:"Continuance - Independence and other Considerations"}]},{title:"Appendix C Money Laundering",data_type:"next_link_selection",sub_links:[{title:"Conclusion"}]},{title:"Appendix D",data_type:"next_link_selection",sub_links:[{title:"1. Assessment of compliance with Independence rules"}]},{title:"Approvals"},{title:"Supporting Documents"}]}]};let render_navigation={};$(document).on("click",".menu-and-logo .menu",function(){let menu_icon=$(".menu-and-logo  .menu-icon");if(menu_icon.hasClass("ms-Icon--CollapseMenu")){menu_icon.toggleClass("ms-Icon--CollapseMenu ms-Icon--AddNotes");$(".navigation-panel").addClass("collapse");$(".form-canvas-section").addClass("expand-canvas")}else{menu_icon.toggleClass("ms-Icon--AddNotes ms-Icon--CollapseMenu");$(".navigation-panel").removeClass("collapse");$(".form-canvas-section").removeClass("expand-canvas")}render_navigation.calculate_canvas_width()});$(document).on("click",".stick-left-navigation-items li.top-level-nav",function(){$(".page-section-header").html(null);let currently_selected_item=parseInt($(this).attr("data-navigation-index"));render_navigation.render_full_nav_tree([currently_selected_item],$(this));let currently_selected_item_name=$(this).attr("title");$(".stick-left-navigation-items li").removeClass("top-level-nav-selected");$(this).addClass("top-level-nav-selected");$(".navigation-panel").removeClass("collapse");$(".form-canvas-section").removeClass("expand-canvas");$(".navigation-panel-header").html(currently_selected_item_name);$(".page-section").attr("app-name",currently_selected_item_name)});$(document).on("click",".navigation-panel-list-items li.panel-navigation-item",function(){render_navigation.render_by_link_click($(this))});$(document).on("click",".form-canvas-section .bread-crumb .bread-crumb-item",function(){let get_bread_crumb_history=$(this).attr("data-tree-navigation");$(".navigation-panel-list-items .panel-navigation-item[data-link-id='"+get_bread_crumb_history+"']").click();$(".navigation-panel-list-items .panel-navigation-item[data-link-id='"+get_bread_crumb_history+"']").click()});render_navigation.show_section=function(section_name){$(".page-section-form-container").addClass("hide");$("#field_section_container div[form-navigation-target='"+section_name+"']").removeClass("hide")};render_navigation.calculate_canvas_width=function(){$("#main-canvas-container").removeClass("col-5");$("#main-canvas-container").removeClass("col-6");$("#main-canvas-container").removeClass("col-8");$("#main-canvas-container").removeClass("col-10");$("#main-canvas-container").removeClass("col-11");let comments_section_status="open";let navigation_panel_status="";let canvas_calculation=12;let navigation_calculation=4;let comments_calculation=3;if($(".right-help-comments-section-panel").hasClass("hide")){comments_section_status="closed";comments_calculation=0}if($("#navigation-panel").hasClass("collapse")){navigation_panel_status="closed";navigation_calculation=1}canvas_calculation=canvas_calculation-navigation_calculation-comments_calculation;$("#main-canvas-container").addClass("col-"+canvas_calculation)};render_navigation.render_by_link_click=function(list_item_element){$(".page-section-header").html(null);render_navigation.toggle_navigation_sub_links(list_item_element);render_navigation.render_breadcrumb(list_item_element);render_navigation.render_page_features(list_item_element)};render_navigation.toggle_navigation_sub_links=function(current_element){if(current_element.hasClass("currently-open")){current_element.next("ul").addClass("hide");current_element.find("i").removeClass("ms-Icon--ChevronDown").addClass("ms-Icon--ChevronRightMed");current_element.removeClass("currently-open")}else{$(".panel-navigation-item").removeClass("currently-open");current_element.addClass("currently-open");current_element.next("ul").removeClass("hide");current_element.find("i").removeClass("ms-Icon--ChevronRightMed").addClass("ms-Icon--ChevronDown")}};render_navigation.render_breadcrumb=function(current_element){let bread_crumb_array=JSON.parse(current_element.attr("data-bread-crumb-history"));render_navigation.create_bread_crumb(bread_crumb_array)};render_navigation.render_side_nav=function(navigation_set){let processing_navigation_set=navigation_set;let stick_left_navigation_html="<ul id='Left-sticky-menu' class='stick-left-navigation-items'>";for(let index=0;index<processing_navigation_set.length;index++){const nav_item=processing_navigation_set[index];stick_left_navigation_html+=`
            <li data-navigation-index='${index}' data-history-index='${JSON.stringify([index])}' class='nav-icon top-level-nav' title='${nav_item.title}'><i class='ms-Icon ms-Icon--${nav_item.icon}'></i></li>
        `}stick_left_navigation_html+="</ul>";$(".sticky-left-navigation").html(stick_left_navigation_html);return true};render_navigation.render_full_nav_tree=function(tree_history_json){let global_navigation=navigation_cube.navigation_set;let canvas=$(".page-section");let selected_link_index=tree_history_json[0];if(global_navigation[selected_link_index].sub_links){navigation_tree_html=render_navigation.render_navigation_tree(global_navigation[selected_link_index].sub_links,global_navigation[selected_link_index].title,selected_link_index)}let current_selected_item=global_navigation[selected_link_index];if(current_selected_item.data_type){switch(current_selected_item.data_type){case"static_page":render_navigation.render_help_file(canvas,current_selected_item.form_data);break}}$(".navigation-panel-list-items").html(navigation_tree_html)};render_navigation.render_navigation_tree=function(list_of_sub_links,bread_crumb_selection,side_panel_index){let tree_structure=`<ul class='tree-group' data-tree-level='second-level-navigation' data-app-name='${bread_crumb_selection}'>`;for(let second_index=0;second_index<list_of_sub_links.length;second_index++){const second_nav_item=list_of_sub_links[second_index];tree_structure+=render_navigation.create_tree_html(second_index,second_nav_item,"second-level-navigation",[side_panel_index,second_index],[bread_crumb_selection,second_nav_item.title]);if(render_navigation.validate_sub_link(second_nav_item)){tree_structure+=`<ul class='tree-group hide' data-tree-level='third-level-navigation'>`;for(let third_index=0;third_index<second_nav_item.sub_links.length;third_index++){const third_nav_item=second_nav_item.sub_links[third_index];tree_structure+=render_navigation.create_tree_html(third_index,third_nav_item,"third-level-navigation",[side_panel_index,second_index,third_index],[bread_crumb_selection,second_nav_item.title,third_nav_item.title]);if(render_navigation.validate_sub_link(third_nav_item)){tree_structure+=`<ul class='tree-group hide' data-tree-level='fourth-level-navigation'>`;for(let fourth_index=0;fourth_index<third_nav_item.sub_links.length;fourth_index++){const fourth_nav_item=third_nav_item.sub_links[fourth_index];tree_structure+=render_navigation.create_tree_html(fourth_index,fourth_nav_item,"fourth-level-navigation",[side_panel_index,second_index,third_index,fourth_index],[bread_crumb_selection,second_nav_item.title,third_nav_item.title,fourth_nav_item.title]);if(render_navigation.validate_sub_link(fourth_nav_item)){tree_structure+=`<ul class='tree-group hide' data-tree-level='fifth-level-navigation'>`;for(let fifth_index=0;fifth_index<fourth_nav_item.sub_links.length;fifth_index++){const fifth_nav_item=fourth_nav_item.sub_links[fifth_index];tree_structure+=render_navigation.create_tree_html(fifth_index,fifth_nav_item,"fifth-level-navigation",[side_panel_index,second_index,third_index,fourth_index,fifth_index],[bread_crumb_selection,second_nav_item.title,third_nav_item.title,fourth_nav_item.title,fifth_nav_item.title])}tree_structure+="</ul>"}}tree_structure+="</ul>"}}tree_structure+="</ul>"}}tree_structure+="</ul>";return tree_structure};render_navigation.validate_sub_link=function(row_item){let is_valid=false;if(row_item){if(row_item.sub_links){if(row_item.sub_links.length>0){is_valid=true}}}return is_valid};render_navigation.create_tree_html=function(index,row_item,navigation_pointer,history_index,create_bread_crumb_array){let row_item_html="";if(row_item){if(row_item.sub_links){row_item_html+=`
                <li class='list-item panel-navigation-item ${navigation_pointer}' data-bread-crumb-history='${JSON.stringify(create_bread_crumb_array)}' 
                    data-history-index='${JSON.stringify(history_index)}' 
                    data-navigation-index='${index}' 
                    data-link-id='${row_item.title}'>
                    <div class="navigation-item-title-group"><i class='ms-Icon ms-Icon--ChevronRightMed'></i><span>${row_item.title}</span></div>
                </li>
            `}else{row_item_html+=`
                <li class='list-item panel-navigation-item ${navigation_pointer}' data-bread-crumb-history='${JSON.stringify(create_bread_crumb_array)}' 
                    data-history-index='${JSON.stringify(history_index)}' 
                    data-navigation-index='${index}' 
                    data-link-id='${row_item.title}'>
                    
                    <div class="navigation-item-title-group"><span>${row_item.title}</span></div>
                </li>
            `}}return row_item_html};render_navigation.render_page_features=function(current_element){let canvas=$(".page-section");let get_tree_history=JSON.parse(current_element.attr("data-history-index"));let tree_properties=render_navigation.find_tree_position(get_tree_history);let current_tree_position=tree_properties.current_position;if(current_tree_position.data_type){switch(current_tree_position.data_type){case"static_page":canvas.addClass("hide");$(".page-loader-header").removeClass("hide");render_navigation.render_help_file(canvas,current_tree_position.form_data);setTimeout(function(){canvas.removeClass("hide");$(".page-loader-header").addClass("hide")},1e3);break;case"next_link_selection":if(current_tree_position.sub_links){setTimeout(()=>{$("#myList li[data-history-index='["+get_tree_history+",0]']").click()},150)}break;case"href":window.open(current_tree_position.href,"_blank");break}}};render_navigation.find_tree_position=function(history_index){let tree_properties={first_position:[],second_position:[],third_position:[],fourth_position:[],fifth_position:[],current_position:[]};switch(history_index.length){case 1:tree_properties.first_position=navigation_cube.navigation_set[history_index[0]];tree_properties.current_position=tree_properties.first_position;break;case 2:tree_properties.first_position=navigation_cube.navigation_set[history_index[0]];tree_properties.second_position=tree_properties.first_position.sub_links[history_index[1]];tree_properties.current_position=tree_properties.second_position;break;case 3:tree_properties.first_position=navigation_cube.navigation_set[history_index[0]];tree_properties.second_position=tree_properties.first_position.sub_links[history_index[1]];tree_properties.third_position=tree_properties.second_position.sub_links[history_index[2]];tree_properties.current_position=tree_properties.third_position;break;case 4:tree_properties.first_position=navigation_cube.navigation_set[history_index[0]];tree_properties.second_position=tree_properties.first_position.sub_links[history_index[1]];tree_properties.third_position=tree_properties.second_position.sub_links[history_index[2]];tree_properties.fourth_position=tree_properties.third_position.sub_links[history_index[3]];tree_properties.current_position=tree_properties.fourth_position;break;case 5:tree_properties.first_position=navigation_cube.navigation_set[history_index[0]];tree_properties.second_position=tree_properties.first_position.sub_links[history_index[1]];tree_properties.third_position=tree_properties.second_position.sub_links[history_index[2]];tree_properties.fourth_position=tree_properties.third_position.sub_links[history_index[3]];tree_properties.fifth_position=tree_properties.fourth_position.sub_links[history_index[4]];tree_properties.current_position=tree_properties.fifth_position;break}return tree_properties};render_navigation.create_bread_crumb=function(bread_crumb_history){let bread_crumb_slug="";for(let index=0;index<bread_crumb_history.length;index++){bread_crumb_item=bread_crumb_history[index];if(bread_crumb_item){if(index==bread_crumb_history.length-1){bread_crumb_slug+=`<span class='bread-crumb-item last-item' data-tree-navigation='${bread_crumb_item}'>${bread_crumb_item}</span>`}else{bread_crumb_slug+=`<span class='bread-crumb-item' data-tree-navigation='${bread_crumb_item}'>${bread_crumb_item} / </span>`}}}$(".bread-crumb").html(bread_crumb_slug)};render_navigation.render_help_file=function(canvas_element,help_file_identifier){let get_help_file_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,HelpTextHtml, OrderBy","Title eq '"+help_file_identifier+"'",app_configuration.help_file_list_name,"OrderBy asc");$.when(get_help_file_data).done(function(help_results){let help_file_text="";for(let index=0;index<help_results.length;index++){const element=help_results[index];help_file_text+=element.HelpTextHtml}canvas_element.html(help_file_text+"<div id='additional-component-placeholders' data-section-type='"+help_file_identifier+"'></div>")})};let main={};$(document).ready(async function(){client_section_functions.render_client_lookup();navigation_cube.navigation_set.push(view_dashboard_navigation);if(app_configuration.display_bd_module){navigation_cube.navigation_set.push(bd_navigation)}if(app_configuration.display_client_risk_assesment_module){navigation_cube.navigation_set.push(client_risk_assessment)}if(app_configuration.display_lockdown_module){navigation_cube.navigation_set.push(lockdown_navigation)}if(app_configuration.display_consultation_module){navigation_cube.navigation_set.push(consultations_navigation)}if(app_configuration.display_client_listening_programme_module){let render_clp_navigation=clp_base_navigation;let permission_properties=await clp_app_main.check_clp_permissions();app_configuration.is_clp_admin=permission_properties.admin;app_configuration.is_pa_admin=permission_properties.pa_admin;app_configuration.pa_admin_filter=permission_properties.pa_admin_filter;if(permission_properties.admin){render_clp_navigation.sub_links[0].sub_links.push({title:"Removal Requests"})}navigation_cube.navigation_set.push(render_clp_navigation)}render_navigation.render_side_nav(navigation_cube.navigation_set);$("#Left-sticky-menu li[title='View dashboard']").click();$(".version-column").html("v1.3.4.5");main.handle_parameter_forms()});main.handle_parameter_forms=function(){let check_if_link_was_used=sessionStorage.getItem("link_used");if(check_if_link_was_used!="true"){let app_name=sharepoint_utilities.getParameterByName("app_name");let form_reference=sharepoint_utilities.getParameterByName("cdfid");let ac_type=sharepoint_utilities.getParameterByName("acceptance_or_continuance");let request_meta={item_id:form_reference,data_source_type:"v2",acceptance_or_continuance:ac_type};switch(app_name){case"lockdown":$("#Left-sticky-menu li[title='Lockdown']").click();lockdown.render_data_from_email(request_meta);break;case"client-risk-assesments":main["system_click"]=true;$("#Left-sticky-menu li[title='Client Acceptance and Continuance']").click();client_risk_assesments.render_data_from_email(request_meta);break;case"consultation-feedback":main["system_click"]=true;consultations_app.render_data_from_email(request_meta);break;case"clp":main["system_click"]=true;clp_app_main.render_data_from_email(request_meta);break}sessionStorage.setItem("link_used","true")}};main.clean_client_name=function(client_name){let clean_client_name=sharepoint_utilities.fixedEncodeURIComponent(client_name);clean_client_name=clean_client_name.split("%28").filter(Boolean).join("%28");clean_client_name=clean_client_name.split("%29").filter(Boolean).join("%29");return clean_client_name};main.render_help_panel=function(category){let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","Category eq '"+category+"'",app_configuration.help_pop_up_lists,"HelpOrder desc");$.when(get_list_items).done(function(item_results){let table_html=`
                <table id='${category}-help-table' class='dataTable'>
                    <thead>
                        <tr>
                            <td>Area</td>
                            <td>Description</td>
                        </tr>
                    <thead>
                    <tbody style='vertical-align:top;'>                 
            `;for(let index=0;index<item_results.length;index++){const item_row=item_results[index];table_html+=`
                    <tr>
                        <td>${item_row.Title}</td>
                        <td>${item_row.HelpDescription}</td>
                    </tr>                
                `}table_html+=`
                    </tbody>
                </table>            
            `;sharepoint_utilities.render_confirmation_box("Additional Guidance",table_html,{},"70%")})};main.create_form_sections=function(array_of_sections){let section_html="<div id='field_section_container'>";for(let index=0;index<array_of_sections.length;index++){const section=array_of_sections[index];section_html+=`
            <div form-navigation-target='${section}' class='page-section-form-container hide'></div>
        `}section_html+="</div>";return section_html};main.add_loader=function(){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide")};main.remove_loader=function(){let canvas=$(".page-section");canvas.removeClass("hide");$(".page-loader-header").addClass("hide")};main.render_form_reference_number=function(reference_details){let reference_id="<div class='reference-id client-reference-id'>"+reference_details+"</div>";$(".header-right-container-container").html(reference_id)};let my_dashboard_functions={};$(document).on("click",".navigation-panel-list-items li[data-link-id='View My Clients']",function(){my_dashboard_functions.render_outstanding_client_continuances()});$(document).on("click",".navigation-panel-list-items li[data-link-id='My Submissions']",function(){my_dashboard_functions.render_my_submissions()});$(document).on("click","#my_clients_table .table-action-buttons-cell i",function(){my_dashboard_functions.render_actions($(this))});$(document).on("click","#my_submissions_table tbody tr td i",function(){my_dashboard_functions.trigger_action_buttons($(this))});$(document).on("click","#my_tasks_table .bd-approval-task-view, #my_submissions_table .bd-approval-task-view",function(){$("#Left-sticky-menu li[title='Business Development']").click();bd_business_rules.render_existing_form($(this).parent().parent().attr("data-itemid"))});$(document).on("click","#my_tasks_table .lockdown-approval-task-view",function(){$("#Left-sticky-menu li[title='Lockdown']").click();let request_meta={item_id:$(this).parent().parent().attr("data-itemid"),data_source_type:"v2"};lockdown.render_data_from_email(request_meta)});my_dashboard_functions.trigger_action_buttons=function(selected_action){let app_name=selected_action.parentsUntil("tr").parent().attr("data-app-name");let action_type=selected_action.attr("title");switch(app_name){case"Lockdown":if(action_type=="View this lockdown"){$("#Left-sticky-menu li[title='Lockdown']").click()}lockdown.handle_table_action_buttons(selected_action);break;case"business development":break;case"acceptance_continuance":if(action_type=="View the current submission"){main["system_click"]=true;$("#Left-sticky-menu li[title='Client Acceptance and Continuance']").click()}client_risk_assesments.handle_table_action_buttons(selected_action);break}};my_dashboard_functions.render_outstanding_client_continuances=function(){var get_all_clients=sharepoint_utilities.get_list_items_by_title(app_configuration.client_list_site_context,"Id,M_ClientName,Client_x0020_Partner_x0020_Name","Client_x0020_Partner_x0020_Name eq '"+_spPageContextInfo.userDisplayName+"'",app_configuration.client_list_name,"Id desc");var get_all_ac_for_partner=sharepoint_utilities.get_list_items_by_title(app_configuration.archive_ac_submission_site_context,"Id,Form_x0020_Status,RiskStatus,ClientName,Modified,AcceptanceOrContinuance","EngagementPartnerId eq '"+_spPageContextInfo.userId+"' and Modified ge '"+moment().subtract(1,"year").format("YYYY-MM-DD")+"'",app_configuration.archive_list_name,"Id desc");var get_all_ac_for_partner_v2=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,Form_x0020_Status,RiskStatus,ClientName,Modified,AcceptanceOrContinuance","EngagementPartnerId eq '"+_spPageContextInfo.userId+"'  and Modified ge '"+moment().subtract(1,"year").format("YYYY-MM-DD")+"'","ACSubmissions","Id desc");$.when(get_all_clients,get_all_ac_for_partner,get_all_ac_for_partner_v2).done(function(all_client_data,all_ac_partner_data,get_all_ac_for_partner_v2_data){let table_html=`   
                <table id='my_clients_table' class="table-dashboard accordion-table table">
                    <thead>                     
                        <th>Client Name <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Client Partner <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th class="table-submission-date-column">Last Submission <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th> 
                        <th class="table-status-column">Current Status <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th class="table-action-buttons-cell">Actions</th>
                    </thead>
                    <tbody>            
            `;for(let index=0;index<all_client_data.length;index++){const client_row=all_client_data[index];let ac_properties=my_dashboard_functions.get_previous_submissions(client_row.M_ClientName,all_ac_partner_data,get_all_ac_for_partner_v2_data);table_html+=`
                    <tr>                       
                        <td>${client_row.M_ClientName}</td>
                        <td>${client_row.Client_x0020_Partner_x0020_Name}</td>
                        <td class="table-submission-date-column">${ac_properties.last_submission_date}</td>
                        <td>
                            <div class="table-status-container">
                                <div data-client-class='${ac_properties.current_status}'></div>
                                ${ac_properties.current_status}
                            <div>
                        </td>
                        <td class="table-action-buttons-cell">
                            ${ac_properties.action_buttons}                        
                        </td>
                    </tr>
                `}table_html+=`   
                    </tbody>
                </table
            `;$(".page-section").html(table_html);$("#my_clients_table").DataTable({pageLength:10,bLengthChange:true,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]})})};my_dashboard_functions.get_previous_submissions=function(current_client_name,all_ac_partner_data,get_all_ac_for_partner_v2){let last_submission_date="";let current_status="Requires Acceptance";let record=[];let data_source_type="";let action_type="";for(let index=0;index<all_ac_partner_data.length;index++){const element=all_ac_partner_data[index];current_status="Requires Acceptance";if(element.ClientName==current_client_name){last_submission_date=moment(element.Modified).format("YYYY-MM-DD");record=element;if(moment(element.Modified).format("YYYY")==moment().format("YYYY")&&element.Form_x0020_Status=="Completed"){current_status="Compliant"}else if(moment(element.Modified).format("YYYY")==moment().format("YYYY")&&element.Form_x0020_Status=="Declined"){current_status="Declined"}else{if(element.Form_x0020_Status!="Completed"&&element.AcceptanceOrContinuance=="Acceptance"){current_status="Acceptance In Progress"}else if(element.Form_x0020_Status!="Completed"&&element.AcceptanceOrContinuance=="Continuance"){current_status="Continuance In Progress"}else{current_status="Requires Continuance"}}data_source_type="archives";action_type=element.AcceptanceOrContinuance;break}}for(let index_2=0;index_2<get_all_ac_for_partner_v2.length;index_2++){const element=get_all_ac_for_partner_v2[index_2];current_status="Requires Acceptance";if(element.ClientName==current_client_name){last_submission_date=moment(element.Modified).format("YYYY-MM-DD");if(moment(element.Modified).format("YYYY")==moment().format("YYYY")&&element.Form_x0020_Status=="Completed"){current_status="Compliant"}else if(moment(element.Modified).format("YYYY")==moment().format("YYYY")&&element.Form_x0020_Status=="Declined"){current_status="Declined"}else{if(element.Form_x0020_Status!="Completed"&&element.AcceptanceOrContinuance=="Acceptance"){current_status="Acceptance In Progress"}else if(element.Form_x0020_Status!="Completed"&&element.AcceptanceOrContinuance=="Continuance"){current_status="Continuance In Progress"}else{current_status="Requires Continuance"}}data_source_type="latest";action_type=element.AcceptanceOrContinuance;break}}let action_buttons=my_dashboard_functions.render_action_buttons(action_type,data_source_type,record,current_status);return{current_status:current_status,last_submission_date:last_submission_date,selected_record:record,action_buttons:action_buttons}};my_dashboard_functions.render_action_buttons=function(action_type,data_source_type,record,current_status){let field_properties=`
        data-action-type='${action_type}' 
        data-source-type='${data_source_type}'
        data-itemid='${record["Id"]}'  
        data-service-type='${record["ClientAcceptanceType"]}' 
        data-ac-lite='${record["ACLiteVersion"]}'
    `;let action_buttons="";switch(current_status){case"Compliant":action_buttons=`
                <i title='Download the pdf' class='menu-icon ms-Icon ms-Icon--CloudDownload table-action-button' 
                    ${field_properties}
                    data-form-status='existing'                         
                    >
                </i>
            `;break;case"Declined":action_buttons=`<i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button' 
                ${field_properties}
                data-form-status='existing'             
            >
            </i>`;break;case"Continuance In Progress":action_buttons=`<i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button' 
                ${field_properties}  
                data-form-status='existing'            
            >
            </i>`;break;case"Acceptance In Progress":action_buttons=`<i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button' 
                ${field_properties}
                data-form-status='existing'              
            >
            </i>`;break;case"Requires Acceptance":action_buttons=`
            <i title='Submit an acceptance for this client' class='menu-icon ms-Icon ms-Icon--NewFolder table-action-button' 
                data-action-type='acceptance' 
                data-source-type='latest'
                data-itemid='0'
                data-form-status='new'       
            >
            </i>`;break;case"Requires Continuance":action_buttons=`
            <i title='Submit a continuance for this client' class='menu-icon ms-Icon ms-Icon--NewFolder table-action-button' 
                data-action-type='continuance' 
                data-source-type='latest'
                data-itemid='${record["Id"]}'
                data-form-status='new'       
            >
            </i>`;break}return action_buttons};my_dashboard_functions.render_actions=function(action_element){let item_id=parseInt(action_element.attr("data-itemid"));let action_type=action_element.attr("data-action-type");let data_source_type=action_element.attr("data-source-type");if(data_source_type=="archives"){let archive_site_url=app_configuration.ac_archive_link_url+"/EditForm.aspx?ID="+submission_data.item_id+"&Source="+app_configuration.mazars_intranet;window.open(archive_site_url,"_blank")}else{let submission_data={item_id:item_id,action_type:action_type,data_source_type:action_element.attr("data-source-type"),form_type:action_type,form_status:action_element.attr("data-form-status")};$("li[title='Client Acceptance and Continuance']").click();$(".assesment-drop-down-container").addClass("hide");setTimeout(function(){if(action_type.toLowerCase()=="acceptance"){client_risk_assesments.render_acceptance_form_html(submission_data)}else{client_risk_assesments.render_continuance_form_html(submission_data)}},1500)}};my_dashboard_functions.render_my_submissions=function(){var get_all_ac_for_current_user=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,Form_x0020_Status,RiskStatus,ClientName,Modified,AcceptanceOrContinuance,ClientAcceptanceType,ACLiteVersion","AuthorId eq '"+_spPageContextInfo.userId+"'","ACSubmissions","Id desc");let get_bd_client_submissions=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,Author/Title&$expand=Author/Title","substringof(';"+_spPageContextInfo.userId+";',RoleReferenceId) and SystemStatus eq 'Open'",app_configuration.bd_initiation,"ClientName desc");let get_lockdown_submissions=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,Author/Title&$expand=Author/Title","AuthorId eq '"+_spPageContextInfo.userId+"' and FormStatus ne 'Cancelled' and FormStatus ne 'Complete'",app_configuration.lockdown_list_name,"ClientName desc");$.when(get_all_ac_for_current_user,get_bd_client_submissions,get_lockdown_submissions).done(function(current_user_data,get_bd_client_submissions_data,get_lockdown_submission_data){let table_html=`   
            <table id='my_submissions_table' class="table-dashboard accordion-table table">
                <thead>             
                    <th>Client Name <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>             
                    <th class="table-submission-date-column">Last Submission <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th> 
                    <th class="table-status-column">Type<i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                    <th class="table-status-column">Current Status <i class="ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                    <th>Actions</th>
                </thead>
                <tbody>            
                    ${render_html_row(current_user_data,"acceptance_continuance")}
                    ${render_html_row(get_bd_client_submissions_data,"business development")}    
                    ${render_html_row(get_lockdown_submission_data,"Lockdown")}            
                </tbody>
            </table>
        `;$(".page-section").html(table_html);$("#my_submissions_table").DataTable({pageLength:10,bLengthChange:true,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]})});function render_html_row(data_set,data_source_type){let table_html="";let submission_type="";let field_properties="";let action_buttons="";let form_status="";let reference_number="";for(let index=0;index<data_set.length;index++){const current_row=data_set[index];switch(data_source_type){case"Lockdown":action_buttons=lockdown.determine_action_buttons(current_row);submission_type=data_source_type;form_status=current_row.FormStatus;reference_number="LDR"+current_row.Id;break;case"acceptance_continuance":action_buttons=client_risk_assesments.render_action_buttons(current_row["AcceptanceOrContinuance"],"current",current_row);form_status=current_row.Form_x0020_Status;submission_type=determine_if_continuance_lite(current_row["ACLiteVersion"],current_row.AcceptanceOrContinuance);reference_number="CRA"+current_row.Id;break;case"business development":action_buttons=`
                        <i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button bd-approval-task-view'></i>
                    `;submission_type="Business Development";form_status=current_row.SubmissionStatus;reference_number="BD"+current_row.Id;break}table_html+=`
                <tr data-itemid='${current_row.Id}' data-app-name='${data_source_type}'>                   
                    <td>${current_row.ClientName}</td>         
                    <td class="table-submission-date-column" data-sort='${moment(current_row.Modified).format("x")}'>${moment(current_row.Modified).format(app_configuration.display_date_format)}</td>
                    <td>${submission_type} <br/> ${reference_number}</td>
                    <td>
                        <div class="table-status-container">
                            <div data-client-class='${form_status}'></div>
                            ${form_status}
                        <div>
                    </td>
                    <td class="table-action-buttons-cell">
                        ${action_buttons}                        
                    </td>
                </tr>
            `}return table_html}function determine_if_continuance_lite(ac_lite_status,AcceptanceOrContinuance){let status_type=AcceptanceOrContinuance;if(ac_lite_status=="yes"){status_type="Continuance Lite"}return status_type}};let my_tasks_functions={};$(document).on("click",".navigation-panel-list-items li[data-link-id='My Approval Tasks']",function(){my_tasks_functions.render_my_approval_tasks()});$(document).on("click","div[app-name='View dashboard'] #my_tasks_table .view-table-action-button",function(){my_dashboard_functions.render_actions($(this))});my_tasks_functions.render_my_approval_tasks=function(){let current_logged_in_user=_spPageContextInfo.userId;var get_archive_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.archive_ac_submission_site_context,"Title,Created,ReferenceID,TaskStatus","AssignedToId eq '"+current_logged_in_user+"' and TaskStatus eq 'In Progress'","Approval TasksVAL","Id desc");var get_ac_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Title,Created,ReferenceID,TaskStatus","AssignedToId eq '"+current_logged_in_user+"' and TaskStatus eq 'In Progress'","Approval Tasks","ApprovalOrder asc");var get_bd_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","AssignedToId eq '"+current_logged_in_user+"' and TaskStatus eq 'Pending Approval'",app_configuration.bd_approval_tasks,"ApprovalOrder asc");var get_lockdown_partner_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","AssignedToId eq '"+current_logged_in_user+"' and TaskStatus eq 'Not Started' and TaskType eq 'Partner Approval'",app_configuration.lockdown_task_list,"ApprovalOrder asc");var get_lockdown_qrm_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title"," substringof('"+_spPageContextInfo.userEmail+"',TeamAssignedToEmails) and TaskStatus eq 'Not Started' and TaskType eq 'QRM Approval'",app_configuration.lockdown_task_list,"ApprovalOrder asc");var approval_html=`
        <table id='my_tasks_table' class="table-dashboard accordian-table table dataTable no-footer" style='width:100%;'>
            <thead>
                <th>Reference</td>                    
                <th>Created</th>           
                <th>Status</th>
                <th>Action</th>
            </thead>
        <tbody>
    `;$.when(get_archive_approval_tasks,get_ac_approval_tasks,get_bd_approval_tasks,get_lockdown_partner_approval_tasks,get_lockdown_qrm_approval_tasks).done(function(archive_task_data,current_approval_task_data,bd_approval_task_data,lockdown_partner_task_data,lockdown_qrm_task_data){approval_html+=render_html_row(archive_task_data,"ac_archives");approval_html+=render_html_row(current_approval_task_data,"ac_current");approval_html+=render_html_row(bd_approval_task_data,"bd_tasks");approval_html+=render_html_row(lockdown_partner_task_data,"lockdown_tasks");approval_html+=render_html_row(lockdown_qrm_task_data,"lockdown_tasks");approval_html+=`
            </tbody>
            </table>
        `;$("div[app-name='View dashboard']").html(approval_html);$("#my_tasks_table").DataTable({bLengthChange:false,order:[],searching:false,paging:false,info:false})});function render_html_row(row_results,data_source_type){let approval_html="";for(let index=0;index<row_results.length;index++){const row_record=row_results[index];approval_html+=`
                <tr class='ApprovalTableRows'
                    data-itemid='${row_record["ReferenceID"]}'
                >
                    <td style='width:55%;'>${row_record.Title} (${row_record.ReferenceID})</td>             
                    <td data-sort='${moment(row_record.Created).format("x")}'>${moment(row_record.Created).format("DD/MM/YYYY")}</td>
                    <td>
                        <div class="table-status-container">
							<div data-client-class='${row_record.TaskStatus}'></div>
							${row_record.TaskStatus}
						</div>
                    </td>
                    <td>                    
                        ${render_action_buttons(row_record,data_source_type)}                       
                    </td>
                </tr>
            `}return approval_html}function render_action_buttons(row_record,data_source_type){let action_button_html="";let acceptance_or_continuance_check="acceptance";if(row_record.Title.toLowerCase().indexOf("continuance")>=0){acceptance_or_continuance_check="continuance"}switch(data_source_type){case"lockdown_tasks":action_button_html=`
                    <i title='Approve this request' class='menu-icon ms-Icon table-action-button ms-Icon--View lockdown-approval-task-view'></i>&nbsp;&nbsp; 
                `;break;case"bd_tasks":action_button_html=`
                    <i title='Approve this request' class='menu-icon ms-Icon table-action-button ms-Icon--View bd-approval-task-view'></i>&nbsp;&nbsp; 
                `;break;case"ac_archives":action_button_html=`
                    <i title='View this request' class='menu-icon ms-Icon ms-Icon--View view-table-action-button table-action-button'
                    data-itemid='${row_record["ReferenceID"]}'
                    data-action-type='${acceptance_or_continuance_check}' 
                    data-source-type='${data_source_type.split("ac_")[1]}'                        
                    data-form-status='existing'                           
                    >                            
                    </i>&nbsp;&nbsp; 
                `;break;case"ac_current":action_button_html=`
                    <i title='View this request' class='menu-icon ms-Icon ms-Icon--View view-table-action-button table-action-button'
                    data-itemid='${row_record["ReferenceID"]}'
                    data-action-type='${acceptance_or_continuance_check}' 
                    data-source-type='${data_source_type.split("ac_")[1]}'                        
                    data-form-status='existing'                           
                    >                            
                    </i>&nbsp;&nbsp; 
                `;break}return action_button_html}};let lockdown={};$(document).on("click","#Left-sticky-menu li[title='Lockdown']",function(){$(".header-right-container-container").html("");main["selected_lockdown_data"]=[]});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='create-new-lockdown-form']",function(){lockdown.create_new_record(lockdown_fields_configuration.planning,$(".lockdown-planning-section"))});$(document).on("click","ul[data-app-name='Lockdown'] li[data-link-id='Submit a new lockdown']",function(){$("ul[data-app-name='Lockdown']").addClass("disable-interaction");lockdown.render_selected_form(main["selected_lockdown_data"])});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='qrm-country-risk-manager-approval-button']",function(){lockdown.approval_unlock_file()});$(document).on("change",".lockdown-drop-down-container div[sp-field-name='temp-lockdown-search'] select",function(){lockdown.render_lockdown_history($(this).val())});$(document).on("change","div[form-navigation-target='Initiation of Lockdown'] select[data-sp-element-name='ClientName']",function(){lockdown.get_client_code($(this).val());client_risk_assesments.render_task_code_component($(this).val(),"TaskCode")});$(document).on("change","div[form-navigation-target='Date & Details Finalisation'] input[data-sp-element-name='EngagementLevel']",function(){lockdown.engagement_level_rules($(this).val())});$(document).on("change","div[form-navigation-target='Initiation of Lockdown'] input[data-sp-element-name='YearEndEngagement']",function(){lockdown.validation_of_year_end_date()});$(document).on("change","div[form-navigation-target='Initiation of Lockdown'] input[data-sp-element-name='ExpectedSigningDate']",function(){lockdown.auto_populate_dates()});$(document).on("change","div[form-navigation-target='Date & Details Finalisation'] input[data-sp-element-name='IsPIE']",function(){if($(this).val()=="Yes"){sharepoint_utilities.show_fields(["TypeOfPublicInterestEntity"])}else{sharepoint_utilities.hide_fields(["TypeOfPublicInterestEntity"]);sharepoint_utilities.set_select_2_fields_by_text("N/A",$("select[data-sp-element-name='TypeOfPublicInterestEntity']"))}});$(document).on("change","div[form-navigation-target='Date & Details Finalisation'] input[data-sp-element-name='EQRPerformed']",function(){if($(this).val()=="Yes"){sharepoint_utilities.show_fields(["EQRReviewerId"])}else{sharepoint_utilities.hide_fields(["EQRReviewerId"]);sharepoint_utilities.set_select_2_fields("N/A","0",$("select[data-sp-element-name='EQRReviewerId']"))}});$(document).on("click","div[app-name='Lockdown'] #my_lockdown_table tbody tr td i",function(){lockdown.handle_table_action_buttons($(this))});lockdown.handle_table_action_buttons=function(action_element){let request_meta={item_id:action_element.attr("data-itemid"),data_source_type:action_element.attr("data-source-type")};setTimeout(function(){switch(action_element.attr("title")){case"Cancel this lockdown":let lockdown_status=action_element.attr("data-task-status");switch(lockdown_status){case"Waiting on QRM Completion":let qrm_admin_check=sharepoint_utilities.check_user_group("QRMITAdmins",app_configuration.site_context);$.when(qrm_admin_check).done(function(is_valid){if(is_valid){lockdown.remove_request(request_meta.item_id)}else{sharepoint_utilities.render_notification("Cancellation of lockdown","Only the QRM IT ADMINS can cancel this request","Warning")}});break;default:lockdown.remove_request(request_meta.item_id);break}break;case"View this lockdown":lockdown.render_actions(request_meta);break;case"Request to unlock file":lockdown.request_unlock_approval(request_meta);break}},500)};$(document).on("click","#Left-sticky-menu li[title='Lockdown']",function(){setTimeout(function(){lockdown.render_lockdown_search()},500)});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='btn-lockdown-generate key']",function(){lockdown.generate_key()});$(document).on("click","div[app-name='Lockdown'] input[title~='Next']",function(){lockdown.go_to_next_section()});$(document).on("click","div[app-name='Lockdown'] input[title='Back']",function(){lockdown.go_back_to_section()});$(document).on("click","ul[data-app-name='Lockdown'] li",function(){let get_section_name=$(this).attr("data-link-id");lockdown.show_section(get_section_name)});$(document).on("click","ul[data-app-name='Lockdown'] li[data-link-id='Approval History']",function(){lockdown.render_approval_history()});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='submit-for_approval']",function(){lockdown.send_for_approval()});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='approve-lockdown-details']",function(){lockdown.partner_approval()});$(document).on("click","div[app-name='Lockdown'] input[data-sp-element-name='qrm-approval-button']",function(){lockdown.complete_lockdown()});lockdown.show_section=function(section_name){$(".page-section-form-container").addClass("hide");$("#field_section_container div[form-navigation-target='"+section_name+"']").removeClass("hide")};lockdown.auto_populate_dates=function(){let get_field_properties=sharepoint_utilities.get_field_values(["ExpectedSigningDate"]);if(get_field_properties.IsValid){var signing_date=get_field_properties.meta_package["ExpectedSigningDate"];var AssemblyDate=moment(signing_date).add(60,"days").format(app_configuration.display_date_format);var kpi_deadline_date=moment(signing_date).add(45,"days").format(app_configuration.display_date_format);var AssstartDate=moment(signing_date,app_configuration.date_format);var AssendDate=moment(AssemblyDate,app_configuration.date_format);var Assresult="Assembly and lockdown deadline as per paragraph 3(b) & 3(c) of policy ("+AssendDate.diff(AssstartDate,"days")+" days)";sharepoint_utilities.set_field_value("AssemblyDeadline",AssemblyDate);sharepoint_utilities.set_field_value("MazarsKPIDeadline",kpi_deadline_date)}};lockdown.request_unlock_approval=function(request_meta){let item_id=parseInt(request_meta.item_id);let data_source_type=request_meta.data_source_type;let box_button_options={Yes:function(){continue_to_unlock();return false},No:function(){}};let unlock_reason=[{Title:"Reason",Description:"Please add your reason",sp_field_name:"QRMUnlockReason",sp_field_type:"textarea",field_width:"half-width",field_validate:true,sp_additional_properties:""}];let container_html=`
        <div>
            <p>Are you sure you want to cancel this request - you will loose all access to this item?</p> 
            <div id='unlock-reason-details'></div>          
        </div>
    `;sharepoint_utilities.render_confirmation_box("Unlocking of lockdown record",container_html,box_button_options,"30%");setTimeout(function(){$("#unlock-reason-details").html(sharepoint_utilities.create_container_form(unlock_reason,"unlock-details-form-fields"))},500);function continue_to_unlock(){let field_properties=sharepoint_utilities.get_field_values(["QRMUnlockReason"]);if(field_properties.IsValid){sharepoint_utilities.render_notification("Unlocking Record","Please wait while we send your request for approval to the country risk manager","Info");let meta_package={FormStatus:"Waiting on Unlock Approval",QRMUnlockReason:field_properties.meta_package["QRMUnlockReason"]};let update_item=sharepoint_utilities.update_item(app_configuration.lockdown_list_name,app_configuration.site_context,meta_package,item_id);$.when(update_item).done(function(){setTimeout(function(){lockdown.create_notification(0,"Set by workflow","Unlock Approval Requested",item_id);lockdown.render_lockdown_history($("select[title='Search for your lockdowns via Client Name']").val());sharepoint_utilities.close_container_window($(".confirmation-box_content-title"))},1e3)})}else{sharepoint_utilities.render_notification("Unlocking of lockdown request","Please add your reason first","Warning")}}};lockdown.approval_unlock_file=function(){let get_field_values=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Unlock File Approval']"));if(get_field_values.IsValid){$.when(lockdown.set_task_to_approved("Country Risk Manager")).done(function(response){if(response=="success"){sharepoint_utilities.set_field_value("FormStatus","Unlocked with Approval");lockdown.update_current_section_data();lockdown.create_notification(0,"Set by workflow","Unlock Approval Complete",main["selected_lockdown_data"][0].Id);$("#Left-sticky-menu li[title='Lockdown']").click()}})}else{sharepoint_utilities.render_notification("Cannot complete approval","Please complete the following fields first: "+get_field_values.validation_message,"Warning")}};lockdown.send_for_approval=function(){let get_field_values=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Date & Details Finalisation']"));if(get_field_values.IsValid){sharepoint_utilities.set_field_value("FormStatus","Waiting on Approval");lockdown.update_current_section_data();lockdown.create_notification(0,"Set by workflow","New Notification",main["selected_lockdown_data"][0].Id);$("#Left-sticky-menu li[title='Lockdown']").click()}else{sharepoint_utilities.render_notification("Cannot complete approval","Please complete the following fields first: "+get_field_values.validation_message,"Warning")}};lockdown.partner_approval=function(){let get_field_values=sharepoint_utilities.create_meta_package($("div[app-name='Lockdown']"));let validate_partner_id=parseInt(sharepoint_utilities.get_field_values(["EngagementPartnerId"]).meta_package["EngagementPartnerId"]);if(validate_partner_id==_spPageContextInfo.userId){if(get_field_values.IsValid==true){$.when(lockdown.set_task_to_approved("Partner Approval")).done(function(response){if(response=="success"){sharepoint_utilities.set_field_value("FormStatus","Waiting on QRM Completion");let approval_date=moment().format(app_configuration.display_date_format);sharepoint_utilities.set_field_value("PartnerApprovalDate",approval_date);lockdown.update_current_section_data();lockdown.create_notification(0,"Set by workflow","Lockdown Approved",main["selected_lockdown_data"][0].Id);$("#Left-sticky-menu li[title='Lockdown']").click()}})}else{sharepoint_utilities.render_notification("Cannot complete approval","Please complete the following fields first: "+get_field_values.validation_message,"Warning")}}else{sharepoint_utilities.render_notification("Cannot complete approval","You are not authorized to approve this submission","Warning")}};lockdown.set_task_to_approved=function(approval_task_type){let create_promise=$.Deferred();let task_filter="AssignedToId eq '"+_spPageContextInfo.userId+"'";if(approval_task_type=="QRM Approval"){task_filter="substringof('"+_spPageContextInfo.userEmail+"',TeamAssignedToEmails)"}let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id","ReferenceID eq '"+main.selected_lockdown_data[0].Id+"' and TaskType eq '"+approval_task_type+"' and "+task_filter,app_configuration.lockdown_task_list,"Id desc");$.when(get_list_items).done(function(item_results){if(item_results.length>0){let meta_package={TaskStatus:"Approved"};let update_item=sharepoint_utilities.update_item(app_configuration.lockdown_task_list,app_configuration.site_context,meta_package,item_results[0].Id);$.when(update_item).done(function(){create_promise.resolve("success")})}else{create_promise.resolve("error");sharepoint_utilities.render_notification("Cannot Approve Task","There are no "+approval_task_type+" task for you to approve for reference: "+main.selected_lockdown_data[0].Id,"Warning")}});return create_promise};lockdown.create_notification=function(AssignedToId,Message,NotificationType,AssociatedReference){var NotificationProperties={};NotificationProperties["Title"]="New Notification";NotificationProperties["Message"]=Message;NotificationProperties["AssignedToId"]=AssignedToId;NotificationProperties["NotificationType"]=NotificationType;NotificationProperties["AssociatedReferenceID"]=AssociatedReference.toString();sharepoint_utilities.save_item(app_configuration.lockdown_general_notifications,app_configuration.site_context,NotificationProperties)};lockdown.engagement_level_rules=function(selected_value){let initialize_fields=["EngagementLevelOtherDetails","AssuranceWork","OpinionType","IndustryType","IsPIE","TypeOfPublicInterestEntity","ClientCategory","PIScore","EQRPerformed","EQRReviewerId","JointReport","IsTransnational","IsListed","InternallyCompiled","RAYear","EngagementYear","FeesBilled","RemainingFees","AuditSoftwarePackageUsed"];sharepoint_utilities.hide_fields(initialize_fields);sharepoint_utilities.set_fields_as_not_required(initialize_fields);let fields_to_show_and_validate=[];switch(selected_value){case"Group (Holding company and subsidiaries)":fields_to_show_and_validate=["AssuranceWork","OpinionType","IndustryType","IsPIE","ClientCategory","PIScore","EQRPerformed","EQRReviewerId","JointReport","IsTransnational","IsListed","InternallyCompiled","RAYear","EngagementYear","FeesBilled","RemainingFees","AuditSoftwarePackageUsed"];break;case"Standalone entity":fields_to_show_and_validate=["AssuranceWork","OpinionType","IndustryType","IsPIE","ClientCategory","PIScore","EQRPerformed","EQRReviewerId","JointReport","IsTransnational","IsListed","InternallyCompiled","RAYear","EngagementYear","FeesBilled","RemainingFees","AuditSoftwarePackageUsed"];break;case"Other":fields_to_show_and_validate=["EngagementLevelOtherDetails"];break}sharepoint_utilities.show_fields(fields_to_show_and_validate);sharepoint_utilities.set_fields_as_required(fields_to_show_and_validate);$("input[data-sp-element-name='IsPIE']").change();$("input[data-sp-element-name='EQRPerformed']").change()};lockdown.validation_of_year_end_date=function(){let get_field_properties=sharepoint_utilities.get_field_values(["YearEndEngagement","ExpectedSigningDate"]);let field_values=get_field_properties.meta_package;let financial_year_end_date=field_values["YearEndEngagement"];let expected_signing_date=field_values["ExpectedSigningDate"];let reporting_date=expected_signing_date;let reporting_date_check=moment(reporting_date,app_configuration.date_format).isAfter();let is_last_day_of_month=moment(reporting_date,app_configuration.date_format).isSame(moment(reporting_date,app_configuration.date_format).endOf("month"));if(reporting_date_check){sharepoint_utilities.set_field_value("YearEndEngagement","");sharepoint_utilities.set_field_value("ExpectedSigningDate","");sharepoint_utilities.render_notification("Year End Data","Auto adjustment: for the last day of the month","Info")}if(expected_signing_date){let financial_year_end_check=moment(financial_year_end_date,app_configuration.date_format).isAfter(moment(reporting_date,app_configuration.date_format));if(financial_year_end_check){sharepoint_utilities.render_notification("Expected Signing Date","The expected signing date of the engagement report cannot be set to a date before the engagement file's year-end","Warning");sharepoint_utilities.set_field_value("YearEndEngagement","")}else{last_day_of_month=moment(reporting_date,app_configuration.date_format).endOf("month").format(app_configuration.display_date_format);if(is_last_day_of_month){sharepoint_utilities.set_field_value("YearEndEngagement",last_day_of_month)}else{last_day_of_month_of_previous_month=moment(reporting_date,app_configuration.date_format).subtract(1,"months").endOf("month").format(app_configuration.display_date_format);sharepoint_utilities.set_field_value("YearEndEngagement",last_day_of_month_of_previous_month)}sharepoint_utilities.render_notification("Year End Data","Auto adjustment: for the last day of the month","Info")}}};lockdown.get_client_code=function(client_name){sharepoint_utilities.set_field_value("ClientCode","");$.when(sharepoint_utilities.get_list_items_by_title(app_configuration.client_list_site_context,"M_ClientCode","M_ClientName eq '"+main.clean_client_name(client_name)+"'",app_configuration.client_list_name,"Id desc")).done(function(results){if(results.length>0){sharepoint_utilities.set_field_value("ClientCode",results[0].M_ClientCode)}})};lockdown.generate_key=function(){let random_key=Math.random().toString(36).slice(2);sharepoint_utilities.set_field_value("LockdownKey",random_key)};lockdown.render_lockdown_search=function(){let lockdown_lookup_component={lockdown_lookup:[{Title:"Search for your lockdowns via Client Name",Description:"Please select your client name",sp_field_name:"temp-lockdown-search",sp_field_type:"select",field_width:"half-width",field_validate:false,sp_additional_properties:"single-select-typeahead exclude-from-meta allow-own-values",additional_filters:"",drop_down_title_field:"M_ClientName",drop_down_value_field:"M_ClientName",drop_down_order_by:"Title asc",list_name:app_configuration.client_list_name,site_context:app_configuration.client_list_site_context,field_icon:"ContactList"},{Title:"Lockdown table history",Description:"Lockdown table history",sp_field_name:"temp-lockdown-table-history",sp_field_type:"placeholder",field_width:"full-width",field_validate:false,sp_additional_properties:"placeholder exclude-from-meta hide-details"}]};$("#additional-component-placeholders").html(sharepoint_utilities.create_container_form(lockdown_lookup_component.lockdown_lookup,"lockdown-drop-down-container form-basic"));sharepoint_utilities.apply_form_plugins(lockdown_lookup_component.lockdown_lookup)};lockdown.render_lockdown_history=function(client_name){var get_active_lockdowns=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,EngagementPartner/Title&$expand=EngagementPartner/Title","ClientName eq '"+main.clean_client_name(client_name)+"' and FormStatus ne 'Cancelled'",app_configuration.lockdown_list_name,"Id desc");let table_html=`   
            <table id='my_lockdown_table' class='table-dashboard accordin-table table'>
                <thead>                   
                    <th>Client Details</th>                
                    <th>Expected Signing Date</th>
                    <th>Reporting date</th> 
                    <th>Reminder date</th>  
                    <th>Year End</th>   
                    <th>Last updated</th>
                    <th>Actions</th>
                </thead>
                <tbody>            
        `;$.when(get_active_lockdowns).done(function(active_lockdown_data){for(let index=0;index<active_lockdown_data.length;index++){let active_row=active_lockdown_data[index];let action_buttons=lockdown.determine_action_buttons(active_row);let engagement_partner_display="";if(active_row.EngagementPartnerId){engagement_partner_display=active_row.EngagementPartner.Title}table_html+=`
                        <tr>                     
                            <td style='width:20%'>                                
                                <b>${active_row.ClientName.toUpperCase()}</b>
                                <br>
                                ${sharepoint_utilities.check_for_null(active_row.Region,"")}
                                <br>
                                ${engagement_partner_display}
                                <br>
                                <b style='color:#0071CE;'>${active_row.FormStatus}<b/>
                            </td>                            
                            <td>${display_date_field(active_row.ExpectedSigningDate)}</td> 
                            <td>${display_date_field(active_row.Reportingdate)}</td>              
                            <td>${display_date_field(active_row.ReminderDate)}</td>                                      
                            <td>${display_date_field(active_row.YearEndEngagement)}</td>  
                            <td>${display_date_field(active_row.Modified)}</td>
                            <td>${action_buttons}</td>
                        </tr>
                    `}table_html+=`   
                </tbody>
            </table
        `;$(".lockdown-drop-down-container div[sp-field-name='temp-lockdown-table-history'] .field-component").html(table_html);$("#my_lockdown_table").DataTable({pageLength:10,bLengthChange:false,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]})});function display_date_field(source_date){let date="";if(source_date){date=moment(source_date).format(app_configuration.display_date_format)}return date}};lockdown.determine_action_buttons=function(row_details){let action_buttons=`
        <i title='View this lockdown' 
            class='menu-icon ms-Icon ms-Icon--View table-action-button' 
            data-action-type='display_lockdown_data' 
            data-source-type='active' 
            data-task-status='${row_details["FormStatus"]}' 
            data-itemid='${row_details["Id"]}'
        >
        </i>&nbsp;&nbsp; 
    `;if(row_details["FormStatus"]!="Complete"&&row_details["FormStatus"]!="Unlocked with Approval"){action_buttons+=`
            <i title='Cancel this lockdown' 
                class='menu-icon ms-Icon ms-Icon--DeactivateOrders table-action-button'                        
                data-itemid='${row_details["Id"]}'
            >
            </i>&nbsp;&nbsp; 
        `}if(row_details["FormStatus"]=="Complete"){action_buttons+=`
            <i title='Request to unlock file' 
                class='menu-icon ms-Icon ms-Icon--Unlock table-action-button'                        
                data-itemid='${row_details["Id"]}'
            >
            </i>&nbsp;&nbsp; 
        `}return action_buttons};lockdown.render_data_from_email=function(request_meta){$(".lockdown-drop-down-container").addClass("hide");lockdown.render_actions(request_meta)};lockdown.render_actions=function(request_meta){let item_id=parseInt(request_meta.item_id);let data_source_type=request_meta.data_source_type;let list_name=app_configuration.lockdown_list_name;let list_context=app_configuration.site_context;if(data_source_type=="lockdown_archive"){list_context=app_configuration.lockdown_archive_site_context}let selected_fields=sharepoint_utilities.generate_select_and_expand_fields(sharepoint_utilities.consolidate_fields(lockdown_fields_configuration));var get_lockdown_submissions=sharepoint_utilities.get_list_items_by_title(list_context,selected_fields,"Id eq "+item_id,list_name,"Id desc");$.when(get_lockdown_submissions).done(function(get_lockdown_submission_data){main["selected_lockdown_data"]=get_lockdown_submission_data;lockdown.render_selected_form(get_lockdown_submission_data)})};lockdown.render_selected_form=function(get_lockdown_submission_data){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");let section_names=["Initiation of Lockdown","Date & Details Finalisation","Partner Approval","QRM Approval","Unlock File Approval","Approval History"];canvas.html(lockdown.create_form_sections(section_names));canvas.find("div[form-navigation-target='Initiation of Lockdown']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.planning,"lockdown-planning-section"));canvas.find("div[form-navigation-target='Date & Details Finalisation']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.Finalization,"lockdown-finalization-section"));canvas.find("div[form-navigation-target='Partner Approval']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.partner_approval,"lockdown-completion-section"));canvas.find("div[form-navigation-target='QRM Approval']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.qrm_approval,"lockdown-completion-section"));canvas.find("div[form-navigation-target='Unlock File Approval']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.unlock_file,"unlock_file-approval-section"));canvas.find("div[form-navigation-target='Approval History']").html(sharepoint_utilities.create_container_form(lockdown_fields_configuration.approval_history,"approval-history-section"));let consolidate_all_fields=sharepoint_utilities.consolidate_fields(lockdown_fields_configuration);sharepoint_utilities.apply_form_plugins(consolidate_all_fields);if(get_lockdown_submission_data){if(get_lockdown_submission_data.length>0){client_risk_assesments.render_task_code_component(get_lockdown_submission_data[0].ClientName,"TaskCode");main.render_form_reference_number("QLD"+get_lockdown_submission_data[0].Id+" "+sharepoint_utilities.check_for_null(get_lockdown_submission_data[0].ClientCode,""));setTimeout(function(){sharepoint_utilities.display_saved_list_fields(get_lockdown_submission_data,consolidate_all_fields,null);if(!get_lockdown_submission_data[0].ClientCode){lockdown.get_client_code(get_lockdown_submission_data[0].ClientName)}$("li[data-link-id='Submit a new lockdown']").removeClass("currently-open");$("li[data-link-id='Initiation of Lockdown']").addClass("currently-open")},1500)}}else{main["selected_lockdown_data"]=[]}setTimeout(function(){lockdown.form_status_rules();canvas.removeClass("hide");$(".page-loader-header").addClass("hide");canvas.find("div[form-navigation-target='Initiation of Lockdown']").removeClass("hide");lockdown.auto_populate_dates();$("ul[data-app-name='Lockdown']").removeClass("disable-interaction")},2500)};lockdown.render_approval_history=function(){let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","ReferenceID eq '"+main["selected_lockdown_data"][0].Id+"'",app_configuration.lockdown_task_list,"ApprovalOrder asc");$.when(get_list_items).done(function(item_results){let approval_table=`
                <table id='lockdown-approval-table' class='dataTable'>
                    <thead>
                        <tr>
                            <td>Approver</td>
                            <td>Status</td>
                            <td>Created</td>
                            <td>Last update</td>
                        </tr>
                    </thead>
                    <tbody>           
            `;for(let index=0;index<item_results.length;index++){const item_row=item_results[index];let AssignedTo="";switch(item_row.TaskType){case"QRM Approval":AssignedTo="Lockdown Team";break;case"Partner Approval":AssignedTo=item_row.AssignedTo.Title;break}approval_table+=`
                    <tr>
                        <td>${AssignedTo}</td>
                        <td>${item_row.TaskStatus}</td>
                        <td>${moment(item_row.Created).format(app_configuration.display_date_format)}</td>
                        <td>${moment(item_row.Modified).format(app_configuration.display_date_format)}</td>
                    </tr>
                `}approval_table+=`
                    </tbody>
                </table>
            `;$("div[sp-field-name='placeholder-lockdown-approval-table']").html(approval_table)})};lockdown.form_status_rules=function(){$("ul[data-app-name='Lockdown'] li[data-link-id='Unlock File Approval']").addClass("nav-item-disabled");if(main["selected_lockdown_data"].length>0){let form_status=main["selected_lockdown_data"][0].FormStatus;sharepoint_utilities.hide_fields(["create-new-lockdown-form"]);$("ul[data-app-name='Lockdown'] li[data-link-id='QRM Approval']").addClass("nav-item-disabled");switch(form_status){case"Complete":sharepoint_utilities.disable_all_fields_by_section("Initiation of Lockdown",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Date & Details Finalisation",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Partner Approval",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("QRM Approval",["input","select","textarea","button"]);lockdown.disabled_task_code();break;case"Unlocked with Approval":sharepoint_utilities.disable_all_fields_by_section("Initiation of Lockdown",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Date & Details Finalisation",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Partner Approval",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("QRM Approval",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Unlock File Approval",["input","select","textarea","button"]);lockdown.disabled_task_code();break;case"Waiting on Approval":sharepoint_utilities.hide_fields(["submit-for_approval"]);lockdown.disabled_task_code();break;case"Waiting on QRM Completion":sharepoint_utilities.disable_all_fields_by_section("Initiation of Lockdown",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Date & Details Finalisation",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Partner Approval",["input","select","textarea","button"]);sharepoint_utilities.show_fields(["qrm-approval-button"]);lockdown.disabled_task_code();$("ul[data-app-name='Lockdown'] li[data-link-id='QRM Approval']").removeClass("nav-item-disabled");sharepoint_utilities.set_fields_as_required(["ActualLockdownDate"]);break;case"Waiting on Unlock Approval":sharepoint_utilities.disable_all_fields_by_section("Initiation of Lockdown",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Date & Details Finalisation",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("Partner Approval",["input","select","textarea","button"]);sharepoint_utilities.disable_all_fields_by_section("QRM Approval",["input","select","textarea","button"]);$("ul[data-app-name='Lockdown'] li[data-link-id='Unlock File Approval']").removeClass("nav-item-disabled");break;default:sharepoint_utilities.hide_fields(["create-new-lockdown-form"]);sharepoint_utilities.show_fields(["next-go-to-client-details"]);break}$("div[form-navigation-target='Date & Details Finalisation'] input[data-sp-element-name='EngagementLevel']").change();$("ul[data-app-name='Lockdown'] li").removeClass("nav-item-disabled");$("ul[data-tree-level='third-level-navigation']").removeClass("hide")}else{$("ul[data-app-name='Lockdown'] ul li").addClass("nav-item-disabled");$("ul[data-app-name='Lockdown'] li[data-link-id='Initiation of Lockdown']").removeClass("nav-item-disabled");sharepoint_utilities.show_fields(["create-new-lockdown-form"])}};lockdown.create_form_sections=function(array_of_sections){let section_html="<div id='field_section_container'>";for(let index=0;index<array_of_sections.length;index++){const section=array_of_sections[index];section_html+=`
            <div form-navigation-target='${section}' class='page-section-form-container hide'></div>
        `}section_html+="</div>";return section_html};lockdown.go_to_next_section=function(){lockdown.update_current_section_data();let get_current_selected_item=$("ul[data-app-name='Lockdown']").find("li.currently-open");let check_for_sub_link_navigation=get_current_selected_item.next().find("ul");if(check_for_sub_link_navigation.length>0){get_current_selected_item.next().click();get_current_selected_item.next().next().children("li:first-child").click()}else{get_current_selected_item.next().click()}};lockdown.go_back_to_section=function(){let get_current_selected_item=$("ul[data-app-name='Lockdown'] li.currently-open");get_current_selected_item.prev().click()};lockdown.create_new_record=function(field_configuration,form_container_class){let get_meta_package=sharepoint_utilities.create_meta_package(form_container_class);let check_expected_signing_date=sharepoint_utilities.get_field_values(["ExpectedSigningDate"]);if(check_expected_signing_date.IsValid){sharepoint_utilities.vaildate_meta_package(get_meta_package,app_configuration.site_context,app_configuration.lockdown_list_name,function commit_success(data){main["selected_lockdown_data"]=[data];lockdown.form_status_rules();$("ul[data-app-name='Lockdown'] li[data-link-id='Date & Details Finalisation']").removeClass("nav-item-disabled");$("ul[data-app-name='Lockdown'] li[data-link-id='Final-Lockdown-Submission']").removeClass("nav-item-disabled");$("ul[data-app-name='Lockdown'] li[data-link-id='Date & Details Finalisation']").click()},function commit_error(){})}else{sharepoint_utilities.render_notification("Cannot continue","Please ensure you have selected an expected signing date","Warning")}};lockdown.update_current_section_data=function(){let item_id=main["selected_lockdown_data"][0].Id;if(item_id){let get_meta_package=sharepoint_utilities.create_meta_package($("div[app-name='Lockdown']"));$.when(sharepoint_utilities.update_item(app_configuration.lockdown_list_name,app_configuration.site_context,get_meta_package.meta_package,item_id)).done(function(response){if(response=="success"){sharepoint_utilities.render_notification("Form Updated","Your current working form was updated","Info")}else{sharepoint_utilities.render_notification("Error","Something went wrong while updating your form","Warning")}})}else{sharepoint_utilities.render_notification("Cannot update form","Cannot find the unique form reference for the current submission to update","Warning")}};lockdown.complete_lockdown=function(){let qrm_admin_check=sharepoint_utilities.check_user_group("QRMITAdmins",app_configuration.site_context);$.when(qrm_admin_check).done(function(is_valid){if(is_valid){let item_id=main["selected_lockdown_data"][0].Id;let current_section=$("ul[data-app-name='Lockdown'] li.currently-open").attr("data-link-id");if(item_id){$.when(lockdown.set_task_to_approved("QRM Approval")).done(function(task_response){sharepoint_utilities.set_field_value("QRMConfirmationDate",moment().format(app_configuration.display_date_format));let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='"+current_section+"'] > div"));get_meta_package.meta_package["FormStatus"]="Complete";$.when(sharepoint_utilities.update_item(app_configuration.lockdown_list_name,app_configuration.site_context,get_meta_package.meta_package,item_id)).done(function(response){if(response=="success"){lockdown.create_notification(0,"Set by workflow","Lockdown complete",item_id);sharepoint_utilities.render_notification("Lockdown marked as complete","Your lockdown form has been closed","Info");$("#Left-sticky-menu li[title='Lockdown']").click()}else{sharepoint_utilities.render_notification("Error","Something went wrong while updating your form","Warning")}})})}else{sharepoint_utilities.render_notification("Cannot update form","Cannot find the unique form reference for the current submission to update","Warning")}}else{sharepoint_utilities.render_notification("Cannot completed lockdown","Only QRM IT admins can complete the lockdown","Warning")}})};lockdown.remove_request=function(item_id){let box_button_options={Yes:function(){continue_to_remove();return false},No:function(){}};let cancellation_field=[{Title:"Reason",Description:"Please add your reason",sp_field_name:"CancellationReason",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"single-select-drop-down-own-values",own_values:["Duplicate","Incorrect information","Lockdown not required"],field_icon:"ActionCenter"}];let container_html=`
        <div>
            <p>Are you sure you want to cancel this request - you will loose all access to this item?</p>
            <div id='cancellation-options'></div>
        </div>
    `;sharepoint_utilities.render_confirmation_box("Cancellation of lockdown record",container_html,box_button_options,"30%");setTimeout(function(){$("#cancellation-options").html(sharepoint_utilities.create_container_form(cancellation_field,"cancellation-details-form-fields"));sharepoint_utilities.apply_form_plugins(cancellation_field)},500);function continue_to_remove(){let field_properties=sharepoint_utilities.get_field_values(["CancellationReason"]);if(field_properties.IsValid){sharepoint_utilities.render_notification("Removing Record","Please wait while we remove your record","Info");let meta_package={FormStatus:"Cancelled",QRMFileVerification:"Yes",CancellationReason:field_properties.meta_package["CancellationReason"]};let update_item=sharepoint_utilities.update_item(app_configuration.lockdown_list_name,app_configuration.site_context,meta_package,item_id);$.when(update_item).done(function(){setTimeout(function(){lockdown.render_lockdown_history($("select[title='Search for your lockdowns via Client Name']").val());sharepoint_utilities.close_container_window($(".confirmation-box_content-title"))},1e3)})}else{sharepoint_utilities.render_notification("Cancellation of lockdown","Please select a reason first","Warning")}}};lockdown.disabled_task_code=function(){$("div[sp-field-name='TaskCode']").find(".radio-button-component").remove();$("div[sp-field-name='TaskCode']").find("input").removeClass("hide");$("div[sp-field-name='TaskCode']").find("input").prop("disabled",true)};let bd_app_main={};main["selected_bd_data"]=[];$(document).on("click","ul[data-app-name='Business Development'] li[data-link-id='New Client Requests']",function(){bd_app_main.toggle_navigation("New")});$(document).on("click","ul[data-app-name='Business Development'] li[data-link-id='Submit a new Client']",function(){main["selected_bd_data"]=[];app_configuration.form_reference_id=null;sharepoint_utilities.field_comments_list=[];$(".right-help-comment-tabs-container li[data-target-id='3']").click();bd_app_main.render_selected_form([]);$("li[data-link-id='Initiation']").click()});$(document).on("click","#Left-sticky-menu li[title='Business Development']",function(){bd_app_main.render_client_dashboard()});$(document).on("click","ul[data-app-name='Business Development'] li",function(){let get_section_name=$(this).attr("data-link-id");bd_app_main.show_sections(get_section_name)});bd_app_main.show_sections=function(section_name){$(".page-section-form-container").addClass("hide");$("#field_section_container div[form-navigation-target='"+section_name+"']").removeClass("hide")};bd_app_main.render_client_dashboard=function(){setTimeout(function(){bd_app_main.render_bd_search();let client_filter="substringof(';"+_spPageContextInfo.userId+";',RoleReferenceId) and SystemStatus eq 'Open'";bd_app_main.render_bd_client_dashboard(client_filter)},500)};bd_app_main.render_selected_form=function(bd_submission_data){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");let section_names=["Overview","General and Contact Details","Internally Captured Details","Allocation","Restricted Entity Database","Risk Factors","Needs Analysis and Risk Considerations","Conclusion and Analysis of Results","Independence","Acceptance","Approvals"];canvas.html(bd_app_main.create_form_sections(section_names));canvas.find("div[form-navigation-target='Overview']").html(sharepoint_utilities.create_container_form(bd_field_set_configuration.overview,"bd-overview-section"));canvas.find("div[form-navigation-target='General and Contact Details']").html(sharepoint_utilities.create_container_form(bd_intiation_field_set_configuration.initiation_fields_general,"bd-intitation-general-section"));canvas.find("div[form-navigation-target='Internally Captured Details']").html(sharepoint_utilities.create_container_form(bd_intiation_field_set_configuration.initiation_fields_internally_captured,"bd-intitation-internally-captured-section"));canvas.find("div[form-navigation-target='Allocation']").html(sharepoint_utilities.create_container_form(bd_intiation_field_set_configuration.allocation_fields,"bd-allocation-section"));canvas.find("div[form-navigation-target='Restricted Entity Database']").html(sharepoint_utilities.create_container_form(evaluation_field_set_configuration.evaluation_fields_restricted_entity,"bd-evaluation-restricted-section"));canvas.find("div[form-navigation-target='Risk Factors']").html(sharepoint_utilities.create_container_form(evaluation_field_set_configuration.evaluation_fields_risk_factors,"bd-evaluation-risk-factors-section"));canvas.find("div[form-navigation-target='Needs Analysis and Risk Considerations']").html(sharepoint_utilities.create_container_form(evaluation_field_set_configuration.evaluation_fields_needs_analysis,"bd-evaluation-needs-analysis-section"));canvas.find("div[form-navigation-target='Conclusion and Analysis of Results']").html(sharepoint_utilities.create_container_form(evaluation_field_set_configuration.evaluation_fields_conclusion,"bd-evaluation-conclusion-section"));canvas.find("div[form-navigation-target='Independence']").html(sharepoint_utilities.create_container_form(bd_independence_field_set_configuration.independence_fields_independence,"bd-independence-section"));canvas.find("div[form-navigation-target='Acceptance']").html(sharepoint_utilities.create_container_form(bd_independence_field_set_configuration.independence_fields_acceptance,"bd-independence-acceptance-section"));canvas.find("div[form-navigation-target='Approvals']").html(sharepoint_utilities.create_container_form(bd_approval_field_set.approvals,"bd-approvals-section"));let general_all_fields=sharepoint_utilities.consolidate_fields(bd_field_set_configuration);let evaluation_all_fields=sharepoint_utilities.consolidate_fields(evaluation_field_set_configuration);let independence_all_fields=sharepoint_utilities.consolidate_fields(bd_independence_field_set_configuration);let intiation_all_fields=sharepoint_utilities.consolidate_fields(bd_intiation_field_set_configuration);sharepoint_utilities.apply_form_plugins(general_all_fields);sharepoint_utilities.apply_form_plugins(intiation_all_fields);sharepoint_utilities.apply_form_plugins(evaluation_all_fields);sharepoint_utilities.apply_form_plugins(independence_all_fields);if(bd_submission_data){if(bd_submission_data.length>0){let reference_id="<div class='reference-id client-reference-id'>BD-"+bd_submission_data[0].Id+"</div>";sharepoint_utilities.set_field_value("ProposalNumber","BD-"+bd_submission_data[0].Id);$(".header-right-container-container").html(reference_id);comments_controller.get_all_comments(bd_submission_data[0].Id,app_configuration.bd_comments_list_name);setTimeout(function(){sharepoint_utilities.display_saved_list_fields(bd_submission_data,intiation_all_fields,null);bd_supporting_documents.display_all_documents(bd_submission_data[0].Id);let get_evaluation_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,sharepoint_utilities.generate_query_for_expanded_fields(evaluation_all_fields),"ReferenceId eq '"+bd_submission_data[0].Id+"'",app_configuration.bd_evaluation,"Id desc");let get_independence_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,sharepoint_utilities.generate_query_for_expanded_fields(independence_all_fields),"ReferenceId eq '"+bd_submission_data[0].Id+"'",app_configuration.bd_independence,"Id desc");$.when(get_evaluation_data,get_independence_data).done(function(evaluation_data,get_independence_data){if(evaluation_data.length>0){sharepoint_utilities.display_saved_list_fields(evaluation_data,evaluation_all_fields,null);app_configuration["evaluation_ref_id"]=evaluation_data[0].Id}if(get_independence_data.length>0){sharepoint_utilities.display_saved_list_fields(get_independence_data,independence_all_fields,null);app_configuration["independence_ref_id"]=get_independence_data[0].Id}});$("li[data-link-id='New Client Requests']").removeClass("currently-open");$("li[data-link-id='General and Contact Details']").addClass("currently-open")},1500)}}else{main["selected_bd_data"]=[]}setTimeout(function(){bd_app_main.form_status_rules();canvas.removeClass("hide");$(".page-loader-header").addClass("hide");canvas.find("div[form-navigation-target='General and Contact Details']").removeClass("hide");$("ul[data-app-name='Business Development']").removeClass("disable-interaction")},2500)};bd_app_main.create_form_sections=function(array_of_sections){let section_html="<div id='field_section_container'>";for(let index=0;index<array_of_sections.length;index++){const section=array_of_sections[index];section_html+=`
            <div form-navigation-target='${section}' class='page-section-form-container hide'></div>
        `}section_html+="</div>";return section_html};bd_app_main.render_bd_search=function(){let bd_lookup_component={bd_lookup_fields:[{Title:"Search for your Business Development requests via the Client Name",Description:"This will also searched cancelled | stopped and other non in progress submissions",sp_field_name:"temp-bd-request-search",sp_field_type:"select",field_width:"half-width",field_validate:false,sp_additional_properties:"single-select-typeahead exclude-from-meta",additional_filters:" and substringof(';"+_spPageContextInfo.userId+";',RoleReferenceId)",drop_down_title_field:"ClientName",drop_down_value_field:"ClientName",drop_down_order_by:"ClientName asc",list_name:app_configuration.bd_initiation,site_context:app_configuration.site_context,field_icon:"ContactList"},{Title:"Business development table history",Description:"business development table history",sp_field_name:"temp-bd-table-history",sp_field_type:"placeholder",field_width:"full-width",field_validate:false,sp_additional_properties:"placehoslder exclude-from-meta hide-details"}]};$("#additional-component-placeholders").html(sharepoint_utilities.create_container_form(bd_lookup_component.bd_lookup_fields,"bd-drop-down-container form-basic"));sharepoint_utilities.apply_form_plugins(bd_lookup_component.bd_lookup_fields)};bd_app_main.form_status_rules=function(){if(main["selected_bd_data"].length>0){let form_status=main["selected_bd_data"][0].SubmissionStatus;bd_app_main.toggle_navigation(form_status);bd_app_main.disable_fields_section("General and Contact Details");if(form_status.indexOf("Declined")>=0||form_status.indexOf("Approved")>=0){$("input").prop("disabled",true);$("select").prop("disabled",true);$("textarea").prop("disabled",true);$(".radio-button-group-container").addClass("radio-disabled");$("input[title='Back']").addClass("hide");$("input[title='Next']").addClass("hide");$("input[type='button']").addClass("hide")}}else{bd_app_main.toggle_navigation("General Details");$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").click()}if(app_configuration.form_reference_id){$(".field-component-comment-icon-container").removeClass("hide")}else{$(".field-component-comment-icon-container").addClass("hide")}};bd_app_main.toggle_navigation=function(section_name){$("ul[data-app-name='Business Development'] > ul > li").addClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Approvals']").removeClass("nav-item-disabled");let field_set_action_buttons_to_hide=[];let field_set_action_buttons_to_show=[];switch(section_name){case"New":$("ul[data-app-name='Business Development'] li[data-link-id='Submit a new Client']").removeClass("nav-item-disabled");break;case"Restarted":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='General and Contact Details']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Internally Captured Details']").addClass("nav-item-disabled");break;case"General Details":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='General and Contact Details']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Internally Captured Details']").addClass("nav-item-disabled");break;case"Internally Captured Details":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='General and Contact Details']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Internally Captured Details']").removeClass("nav-item-disabled");field_set_action_buttons_to_hide=["sp-button-next-to-internally-captured"];break;case"Allocation":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Allocation']").removeClass("nav-item-disabled");field_set_action_buttons_to_hide=["sp-button-approve-and-start-allocation","sp-button-next-to-internally-captured"];break;case"Evaluation":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Allocation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Evaluation']").removeClass("nav-item-disabled");field_set_action_buttons_to_hide=["sp-button-approve-and-start-allocation","sp-button-next-to-internally-captured","sp-button-approve-and-start-evaluation"];break;case"Independence":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Allocation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Evaluation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Independence']").removeClass("nav-item-disabled");break;case"Approved":$("ul[data-app-name='Business Development'] li[data-link-id='Initiation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Allocation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Evaluation']").removeClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Independence']").removeClass("nav-item-disabled");break}sharepoint_utilities.hide_fields(field_set_action_buttons_to_hide);sharepoint_utilities.show_fields(field_set_action_buttons_to_show)};bd_app_main.disable_fields_section=function(section_link_id){$("div[form-navigation-target='"+section_link_id+"']").find("input").prop("disabled",true);$("div[form-navigation-target='"+section_link_id+"']").find("select").prop("disabled",true);$("div[form-navigation-target='"+section_link_id+"']").find("textarea").prop("disabled",true);$("div[form-navigation-target='"+section_link_id+"']").find(".radio-button-group-container").addClass("radio-disabled");switch(section_link_id){case"General and Contact Details":$("input[data-sp-element-name='BudgetedFee']").prop("disabled",false);$("input[data-sp-element-name='sp-button-preview-approvers']").prop("disabled",false);break}};bd_app_main.render_bd_client_dashboard=function(client_filter){let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,Author/Title&$expand=Author/Title",client_filter,app_configuration.bd_initiation,"ClientName desc");$.when(get_list_items).done(function(item_results){let table_html=`
                <table id='bd-dashboard-table' class=''>
                    <thead>
                        <tr>
                            <th>Ref No</th>
                            <th>Submitted By</th>
                            <th>Client Name</th>
                            <th>Last update</th>  
                            <th>Status</th>                                                      
                            <th>Action</th>                            
                        </tr>
                    </thead>
                <tbody>
            `;for(let index=0;index<item_results.length;index++){const item_row=item_results[index];table_html+=`
                    <tr>
                        <td>BD-${item_row.Id}</td>
                        <td>${item_row.Author.Title}</td>
                        <td>${item_row.ClientName}</td>
                        <td data-sort='${moment(item_row.Modified).format("x")}'>${moment(item_row.Modified).format(app_configuration.display_date_format)}</td>
                        <td>${item_row.SubmissionStatus}</td>
                        <td>
                            <i class='menu-icon ms-Icon ms-Icon--View' data-attr-bd-id='${item_row.Id}' data-attr-action='view' title='view this submission'></i>
                            <i class='menu-icon ms-Icon ms-Icon--DocumentReply' data-attr-bd-id='${item_row.Id}' data-attr-action='restart' title='restart this submission'></i>
                            <i class='menu-icon ms-Icon ms-Icon--ErrorBadge' data-attr-bd-id='${item_row.Id}' data-attr-action='cancel' title='cancel this submission'></i>
                            <i class='menu-icon ms-Icon ms-Icon--Delete' data-attr-bd-id='${item_row.Id}' data-attr-action='remove' title='remove this submission'></i>
                        </td>
                    </tr>
                `}table_html+=`
                </tbody>
                </table>
            `;$("div[sp-field-name='temp-bd-table-history']").html(table_html);$("#bd-dashboard-table").dataTable()})};let save_sections={};$(document).on("click",".save-current-section",function(){save_sections.save_button();client_risk_approvals.validation_on_all_fields()});save_sections.save_button=async function(){let currently_selected_app=$("#Left-sticky-menu").find("li.top-level-nav-selected").attr("title");save_sections.refresh_context_token=sharepoint_utilities.RefreshDigest(app_configuration.site_context);switch(currently_selected_app){case"Client Acceptance and Continuance":sharepoint_utilities.render_notification("Saving all sections","Please wait while we save all the sections in this form","Info");let save_all_sections=save_sections.get_all_sections("Client Acceptance and Continuance");for(let index=0;index<save_all_sections.length;index++){const section_to_update=save_all_sections[index];client_risk_assesments.identify_sections_to_update($("li[data-link-id='"+section_to_update+"']"),false);await delay_updates(500)}break;case"Lockdown":sharepoint_utilities.render_notification("Saving Form","Please wait while we save your form","Info");lockdown.update_current_section_data();break}function delay_updates(ms){return new Promise(resolve=>setTimeout(resolve,ms))}};save_sections.get_all_sections=function(data_app_name){let get_all_sections_to_save=[];let exclusion_sections=["Client Continuance","Client Acceptance","Client Information","Appendix A Clients","Appendix B Engagements","Appendix C Money Laundering","Appendix D"];$(".navigation-panel-list-items ul[data-app-name='"+data_app_name+"'] li[data-link-id]").each(function(){let get_setion_name=$(this).attr("data-link-id");if(exclusion_sections.indexOf(get_setion_name)==-1){get_all_sections_to_save.push($(this).attr("data-link-id"))}});return get_all_sections_to_save};save_sections.has_data=function(payload){let contains_data=true;let check=JSON.stringify(payload);if(check.length==2){contains_data=false}return contains_data};save_sections.update_data_source=function(data_source_item_id,section_name,list_name,include_notifications){let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='"+section_name+"'] > div"));if(data_source_item_id){if(save_sections.has_data(get_meta_package.meta_package)){if(get_meta_package.meta_package["AppendixDEngagagementPartnersId"]=="#;"){delete get_meta_package.meta_package["AppendixDEngagagementPartnersId"]}$.when(save_sections.update_item_custom(list_name,app_configuration.site_context,get_meta_package.meta_package,parseInt(data_source_item_id),include_notifications)).done(function(response){if(response=="success"){if(include_notifications){warning_controller.add_new_warning(section_name+"form Updated","Your current working form was updated","Info")}}else{warning_controller.add_new_warning("EQR Form Updated","Something went wrong while updating your form","Warning")}})}else{}}else{warning_controller.add_new_warning(section_name+"form id not found","The form was not updated","Warning")}};save_sections.update_item_custom=function(sp_list_name,sp_list_url,meta_package,item_id,include_notifications){var Promise=$.Deferred();$.when(sp_custom_auth.get_bearer_token()).done(function(response_token){let headers={"content-type":"application/json;odata=nometadata",accept:"application/json;odata=nometadata","IF-MATCH":"*","X-HTTP-METHOD":"MERGE"};if(response_token){headers["Authorization"]="Bearer "+response_token}else{if(include_notifications){headers["X-RequestDigest"]=sharepoint_utilities.RefreshDigest(app_configuration.site_context)}else{headers["X-RequestDigest"]=save_sections.refresh_context_token}}$.ajax({url:sp_list_url+"/_api/web/lists/getByTitle('"+sp_list_name+"')/items("+item_id+")",type:"POST",headers:headers,data:JSON.stringify(meta_package),success:function(data,status,xhr){Promise.resolve("success")},error:function(xhr,status,error){console.log("Error updating item");console.log(meta_package);Promise.resolve("failed");sharepoint_utilities.render_notification("Error saving item",xhr.responseJSON["odata.error"].message.value,"error")}})});return Promise.promise()};let supporting_documents={};$(document).on("click","i[data-help-category]",function(){main.render_help_panel($(this).attr("data-help-category"))});$(document).on("click",".supporting-document-upload-fake-icon",function(){$("#upload-supporting-documents").click()});$(document).on("click","ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='Supporting Documents']",function(){client_risk_assesments.rule_engine();supporting_documents.convert_older_named_documents();supporting_documents.display_all_supporting_documents()});$(document).on("click","#qrm-supporting-documents-table .download-supporting-document",function(){site_collection_url=app_configuration.site_context;relative_file_path=$(this).attr("data-file-ref");file_name=$(this).attr("data-file-leaf-ref");sharepoint_utilities.download_file(site_collection_url,relative_file_path,file_name)});supporting_documents.convert_older_named_documents=function(){let get_field_properties=sharepoint_utilities.get_field_values(["ListOfRequiredDocumentsJSON","AcceptanceOrContinuance"]);let current_list_of_documents=get_field_properties.meta_package["ListOfRequiredDocumentsJSON"];let converted_list=[];if(current_list_of_documents){if(current_list_of_documents.length>1){document_cube=JSON.parse(current_list_of_documents);for(let index=0;index<document_cube.length;index++){const row_item=document_cube[index];switch(row_item){case"GS Report":converted_list.push("Greatsoft report");break;case"CEO Approval":converted_list.push("CEO/CRM Approval of a non-CARL Partner");break;case"Background Memorandum":converted_list.push("GIAC Background Memorandum");break;default:converted_list.push(row_item);break}}sharepoint_utilities.set_field_value("ListOfRequiredDocumentsJSON",JSON.stringify(converted_list))}}};supporting_documents.display_all_supporting_documents=function(){let qrm_reference_id=0;if(main["selected_client_risk_data"]){qrm_reference_id=main["selected_client_risk_data"].Id}supporting_documents.render_supporting_documents(qrm_reference_id)};supporting_documents.render_supporting_documents=function(qrm_reference_id){let current_status=main["selected_client_risk_data"].Form_x0020_Status;var get_all_supporting_documents=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,FileRef,FileLeafRef","ReferenceID eq '"+qrm_reference_id+"'",app_configuration.supporting_documents_library,"Id desc");let table_html=`           
            <div class="bulk-upload-container"  style='display:inline-block;width:70%;'>              
                <div class="bulk-upload-icon" style='display:inline-block;margin-top: 10px;'>
                    <span class="upload-button-label supporting-document-upload-fake-icon">Upload</span>
                    <i title='View this request' class='menu-icon ms-Icon ms-Icon--Upload supporting-document-upload-fake-icon'></i>
                </div>
                <ul class="bulk-upload-list" style='width:100%;list-style:none;'>                 
                    <li>Once uploaded you can assign the correct document to the required Document type field within the consolidated table.
                    <br/><span style='color:#990909'> *Note <span> - Please create a zip file to upload multiple documents to type.</li>
                </ul>   
            </div> 
            
            <div class="list-of-documents-container">
                <p>
                     <div style='display:inline-block;margin-top: 10px;'>
                        <i style='font-size:39px;' title='View additional information' class='menu-icon ms-Icon ms-Icon--Info' data-help-category='ACHelpDocuments'></i> 
                    </div>
                    <div style='display:inline-block;position: absolute;margin-top: 20px;margin-left: 10px;'>
                        <b>List of required documents before approval can continue:</b>
                    </div>
                </p>
                <p id='list-of-required-documents-to-upload'></p>              
            </div>
        
            <div class='hide'>
                <input type='file' id='upload-supporting-documents' name='upload-supporting-documents'>                    
            </div>        
            <table id='qrm-supporting-documents-table' class="table-dashboard accordian-table table dataTable no-footer" >
                <thead>                   
                    <th>QRM Ref ID</th>
                    <th>File name</th>
                    <th class='document-type'>Document Type</th> 
                    <th>Last Modified</th>                   
                    <th>Actions</th>
                </thead>
                <tbody>            
        `;$.when(get_all_supporting_documents).done(function(get_all_supporting_documents_data){for(let index=0;index<get_all_supporting_documents_data.length;index++){let current_row=get_all_supporting_documents_data[index];let action_buttons=`
                <i title='download this file' 
                        class='menu-icon ms-Icon ms-Icon--CloudDownload download-supporting-document table-action-button'                    
                        data-itemid='${current_row["Id"]}'
                        data-file-leaf-ref='${current_row["FileLeafRef"]}'
                        data-file-ref='${current_row["FileRef"]}'
                    >
                </i>
                <i title='remove this file' 
                        class='menu-icon ms-Icon ms-Icon--Delete remove-supporting-document table-action-button-delete'                    
                        data-itemid='${current_row["Id"]}'
                    >
                </i>
                       
           `;if(current_status=="Resigned"){action_buttons=""}table_html+=`
                    <tr data-document-id='${current_row.Id}'>                     
                        <td>${current_row.ReferenceID}</td>
                        <td>${sharepoint_utilities.check_for_null(current_row.Title,"")}</td>                  
                        <td>${create_dropdown_file_type(current_row.DocumentType)}</td>     
                        <td>${moment(current_row.Modified).format(app_configuration.display_date_format)}</td>                   
                        <td>${action_buttons}</td>
                    </tr>
                `}table_html+=`   
                </tbody>
            </table
        `;$("div[app-name='Client Acceptance and Continuance'] div[sp-field-name='supporting-documents-placeholder'] .field-component").html(table_html);$.when(supporting_documents.validate_all_documents()).done(function(validation_outcome){$("#list-of-required-documents-to-upload").html(validation_outcome.validation_message)});let list_of_statuses=["Not Started","In Progress","Waiting on Approval","Changes Requested"];if(list_of_statuses.indexOf(current_status)==-1){$(".bulk-upload-container").addClass("hide");$(".supporting-documents-change").prop("disabled",true)}$("#qrm-supporting-documents-table").DataTable({pageLength:10,bLengthChange:false,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],search:false,paging:false})});function create_dropdown_file_type(current_value){let list_of_options=app_configuration.list_of_document_types;let drop_down_select_html=`
            <select title='supporting-documents-document-type' class='supporting-documents-change'>
                <option>Please Select...</option>
        `;let is_found=false;for(let index=0;index<list_of_options.length;index++){const option=list_of_options[index];selected_option="";if(current_value==option){selected_option="selected='selected'";is_found=true}drop_down_select_html+=`
                <option ${selected_option} value='${option}'>${option}</option>
            `}if(is_found==false&&current_value!=""){drop_down_select_html+=`
                <option selected='selected' value='${current_value}'>${current_value}</option>
            `}drop_down_select_html+="</select>";return drop_down_select_html}};$(document).on("click","#qrm-supporting-documents-table .remove-supporting-document",function(){let get_document_id=parseInt($(this).attr("data-itemid"));supporting_documents.remove_document(get_document_id)});supporting_documents.remove_document=function(document_id){if(document_id){var remove_document_confirmation=sharepoint_utilities.remove_item(app_configuration.supporting_documents_library,app_configuration.site_context,document_id);$.when(remove_document_confirmation).done(function(){sharepoint_utilities.render_notification("Document removal","Your document was removed successfully","Info");$("ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='Supporting Documents']").click()})}else{sharepoint_utilities.render_notification("Document removal Error","Your document not removed successfully","Warning")}};supporting_documents.append_to_current_document_required=function(required_document,action_type){let get_field_properties=sharepoint_utilities.get_field_values(["ListOfRequiredDocumentsJSON","AcceptanceOrContinuance"]);let current_list_of_documents=get_field_properties.meta_package["ListOfRequiredDocumentsJSON"];let document_cube=[];if(current_list_of_documents){if(current_list_of_documents.length>1){document_cube=JSON.parse(current_list_of_documents);switch(action_type){case"remove":let index=document_cube.indexOf(required_document);if(index!=-1){document_cube.splice(index,1)}break;default:if(document_cube.indexOf(required_document)==-1){document_cube.push(required_document)}break}}else{document_cube.push(required_document)}}else{document_cube.push(required_document)}sharepoint_utilities.set_field_value("ListOfRequiredDocumentsJSON",JSON.stringify(document_cube));warning_controller.display_warnings()};supporting_documents.validate_all_documents=function(){var Promise=$.Deferred();var get_all_supporting_documents=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","ReferenceID eq '"+main["selected_client_risk_data"].Id+"'",app_configuration.supporting_documents_library,"Id desc");$.when(get_all_supporting_documents).done(function(current_uploaded_documents_results){let get_field_properties=sharepoint_utilities.get_field_values(["ListOfRequiredDocumentsJSON"]);let current_list_of_documents=get_field_properties.meta_package["ListOfRequiredDocumentsJSON"];let current_required_documents_cube=[];let validation_outcome={is_valid:false,outstanding_documents:[],validation_message:"",found_document:[]};let number_of_found_documents=0;main["current_uploaded_documents"]=current_uploaded_documents_results;if(current_list_of_documents){if(current_list_of_documents.length>0){current_required_documents_cube=JSON.parse(current_list_of_documents);for(let index=0;index<current_required_documents_cube.length;index++){const required_document_item=current_required_documents_cube[index];let is_found=false;for(let uploads_index=0;uploads_index<current_uploaded_documents_results.length;uploads_index++){const uploaded_document_item=current_uploaded_documents_results[uploads_index];if(uploaded_document_item.DocumentType){if(required_document_item.toLowerCase()==uploaded_document_item.DocumentType.toLowerCase()){validation_outcome.found_document.push(required_document_item);is_found=true;number_of_found_documents+=1}}}if(!is_found){validation_outcome.outstanding_documents.push(required_document_item);validation_outcome.validation_message+="- "+required_document_item+" <br/>"}}if(number_of_found_documents==current_required_documents_cube.length){validation_outcome.is_valid=true}}}else{validation_outcome.is_valid=true;validation_outcome.validation_message+="None"}$("#list-of-required-documents-to-upload").html(validation_outcome.validation_message);Promise.resolve(validation_outcome)});return Promise.promise()};supporting_documents.resignation_validation=function(submission_data){let selectedDocuments=main["current_uploaded_documents"];for(let index=0;index<selectedDocuments.length;index++){const current_document=selectedDocuments[index];if(current_document.DocumentType=="Resignation Letter"){client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handeled","Resigned",submission_data.item_id);sharepoint_utilities.render_notification("Resign from Engagement","Please wait while we resigned your client from the engagement","Info");sharepoint_utilities.set_field_value("Form_x0020_Status","Resigned");$("input[data-sp-element-name='btn-resign-from-engagement']").addClass("nav-item-disabled");client_risk_assesments.identify_sections_to_update($("li[data-link-id='Supporting Documents']"),true);client_risk_assesments.identify_sections_to_update($("li[data-link-id='General']"),true);$("li[title='Client Acceptance and Continuance']").click()}}};supporting_documents.quick_action_resignation=function(submission_data){let custom_options={Yes:continue_to_resign_from_enagagement,No:function(){}};sharepoint_utilities.render_confirmation_box("Resign from the current engagement","Are you sure you want to resign from this engagement?",custom_options,"50%");function continue_to_resign_from_enagagement(){let meta_package={Form_x0020_Status:"Resigned"};let update_item=sharepoint_utilities.update_item(app_configuration.ac_submission,app_configuration.site_context,meta_package,parseInt(submission_data.item_id));$.when(update_item).done(function(){client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handeled","Resigned",submission_data.item_id);client_risk_assesments.render_selected_client_acceptance_continuance($("select[title='Search for your assesments via Client Name']").val())})}};var pie_form={};$(document).on("change","input[data-sp-element-name='OtherPieEntities']",function(){client_risk_assesments.other_pie_entities_comments_toggle();client_risk_assesments.giac_form_validation();client_risk_assesments.carl_partner_validation()});$(document).on("change","input[data-sp-element-name='IsListedClient']",function(){client_risk_assesments.giac_form_validation();client_risk_assesments.carl_partner_validation()});$(document).on("change","input[data-sp-element-name='IsTransnational'],input[data-sp-element-name='SPACEngagment'],input[data-sp-element-name='IPOEngagment']",function(){client_risk_assesments.giac_form_validation()});$(document).on("change","input[data-sp-element-name='HasRussianEntities']",function(){let current_value=$(this).val();client_risk_assesments.determine_risk_status();if(current_value=="Yes"){sharepoint_utilities.render_notification("Client Identified as Risky","Your submission has now been identified as risky","Warning")}client_risk_assesments.giac_form_validation()});$(document).on("change","input[data-sp-element-name='HasRiskAppetite']",function(){let current_value=$(this).val();client_risk_assesments.determine_risk_status();if(current_value=="Yes"){sharepoint_utilities.render_notification("Client Identified as Risky","Your submission has now been identified as risky","Warning")}client_risk_assesments.giac_form_validation()});$(document).on("change","input[data-sp-element-name='CryptoEngagment']",function(){pie_form.determine_is_crypto_currency();client_risk_assesments.giac_form_validation()});pie_form.determine_is_crypto_currency=function(){var cryptoEngagement=$("select[data-sp-element-name='CryptoEngagment']").val();warning_controller.remove_warning("ISRE Standard","The Engagement has been flagged as Risky","Warning");if(cryptoEngagement=="Yes"){warning_controller.add_new_warning("ISRE Standard","The Engagement has been flagged as Risky","Warning")}};let client_risk_assesments={};$(document).on("click",".client-acceptance-general input[data-sp-element-name='client-risk-assessments-create-button']",function(){client_risk_assesments.prompt_new_acceptance_record()});$(document).on("click",".client-continuance-general input[data-sp-element-name='client-risk-assessments-create-button']",function(){client_risk_assesments.prompt_new_continuance_record()});$(document).on("click","div[app-name='Client Acceptance and Continuance'] input[title='Next']",function(){client_risk_assesments.go_to_next_section()});$(document).on("click","div[app-name='Client Acceptance and Continuance'] input[title='Back']",function(){client_risk_assesments.go_back_to_section()});$(document).on("click","div[app-name='Client Acceptance and Continuance'] input[data-sp-element-name='new-acceptance-action-button']",function(){let record_properties={item_id:0,action_type:"Acceptance",data_source_type:"Current",form_type:"Acceptance",form_status:"new"};client_risk_assesments.render_acceptance_form_html(record_properties)});$(document).on("click","ul[data-app-name='Client Acceptance and Continuance'] li",function(){let get_section_name=$(this).attr("data-link-id");app_configuration["previous-selected-section"]=app_configuration["currently-selected-section"];app_configuration["currently-selected-section"]=$(this);client_risk_assesments.show_section(get_section_name)});$(document).on("click","#client_search_assessents_table tbody tr td i",function(){client_risk_assesments.handle_table_action_buttons($(this))});$(document).on("click","input[data-sp-element-name='btn-resign-from-engagement']",function(){let submission_data={item_id:main.selected_client_risk_data.Id,action_type:main.selected_client_risk_data.action_type,data_source_type:"current",form_type:"exisiting",form_x0020_status:"Resigned"};let custom_options={Yes:continue_to_resign,No:function(){}};sharepoint_utilities.render_confirmation_box("Resign from the current engagement","Are you sure you want to resign from this engagement?",custom_options,"50%");function continue_to_resign(){supporting_documents.append_to_current_document_required("Resignation Letter");supporting_documents.resignation_validation(submission_data)}});$(document).on("change","input[data-sp-element-name='Q12PartA']",function(){client_risk_assesments.check_if_rely_comply_assesment_is_required()});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-part-a']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='Part A - Risk Considered as Major']"),"Low / Standard");$('input[name$="PartA"]').each(function(){$(this).filter('[value="Low / Standard"]').click()})});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-part-b']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='Part B - Risk Considered as Normal']"),"Low / Standard");$('input[name$="PartB"]').each(function(){$(this).filter('[value="Low / Standard"]').click()})});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-as-no-part-a']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='Part A - Risk Considered as Major']"),"No")});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-as-no-part-b']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='Part B - Risk Considered as Normal']"),"No")});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-as-no-ac-lite']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='LITE']"),"No")});$(document).on("click","div[sp-field-name*='ACLite']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='LITE']"),"No")});$(document).on("click","input[data-sp-element-name='sp-temp-bulk-mark-risks-as-no-independence']",function(){client_risk_assesments.mark_all_risks_in_bulk($("div[form-navigation-target='Indpendence and other considerations']"),"No")});$(document).on("change",".custom-lite-form-answers div[sp-additional-properties='radio-buttons-own-values'] input",function(){client_risk_assesments.continuance_lite_risk_rules()});$(document).on("change","select[data-sp-element-name='ClientAcceptanceType']",function(){client_risk_assesments.rule_engine()});$(document).on("change","select[data-sp-element-name='ApplicableStandard']",function(){client_risk_assesments.run_applicable_standard_rules()});$(document).on("change","input[data-sp-element-name='IsCarlPartner']",function(){client_risk_assesments.carl_partner_validation()});$(document).on("change","input[data-sp-element-name='s90Calculator']",function(){assurance_functions.display_s90_considerations()});$(document).on("change","select[data-sp-element-name='ApplicableStandard']",function(){sharepoint_utilities.hide_fields(["ApplicableStandardOther"]);sharepoint_utilities.set_fields_as_not_required(["ApplicableStandardOther"])});$(document).on("change","input[data-sp-element-name='MoneyLaunderingRisk'], select[data-sp-element-name='NASRiskyServices']",function(){client_risk_assesments.determine_risk_status()});$(document).on("change","input[data-sp-element-name='IsNaturalPerson']",function(){client_risk_assesments.check_relevant_source_of_funds()});$(document).on("change","select[data-sp-element-name='SourceOfFunds']",function(){client_risk_assesments.check_relevant_source_of_funds()});$(document).on("change","select[data-sp-element-name='MazarsServiceLine']",function(){let selected_value=$(this).val();client_risk_assesments.set_client_service_line_field(selected_value);let field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType"]).meta_package;client_risk_assesments.cascade_list_of_services(field_properties.ClientAcceptanceType,selected_value);client_risk_assesments.giac_form_validation();client_risk_assesments.business_sustainablity_form_rules();client_risk_assesments.check_if_rely_comply_assesment_is_required()});$(document).on("change","input[data-sp-element-name='IsKYCClient']",function(){let current_value=$(this).val();if(current_value=="No"||current_value=="N/A"){$("li[data-link-id='Know your client (KYC) procedures performed']").addClass("nav-item-disabled")}else{$("li[data-link-id='Know your client (KYC) procedures performed']").removeClass("nav-item-disabled")}});$(document).on("click","#Left-sticky-menu li[title='Client Acceptance and Continuance']",function(){client_risk_assesments.reset_form();if(!main["system_click"]){setTimeout(function(){client_risk_assesments.render_risk_assesment_search()},500)}});$(document).on("change","select[data-sp-element-name='temp-assesment-search']",function(){client_risk_assesments.render_selected_client_acceptance_continuance($(this).val())});$(document).on("change","select[data-sp-element-name='temp-assesment-search-by-code']",function(){client_risk_assesments.render_selected_client_acceptance_continuance($(this).val())});$(document).on("change","input[data-sp-element-name='subcontractors']",function(){client_risk_assesments.render_subcontractor_conditional()});$(document).on("change","div[form-navigation-target='Business Sustainability'] input[data-sp-element-name='IsIndependant']",function(){client_risk_assesments.business_sustainablity_form_rules()});client_risk_assesments.business_sustainablity_form_rules;client_risk_assesments.lockdown_sync_client_details=function(){let field_properties=sharepoint_utilities.get_field_values(["ClientTaskCode","ClientName","AuditSoftwarePackageUsed","ClientIndustry"]);let reference_id=main["selected_client_risk_data"].Id;let meta_package={ClientName:field_properties.meta_package["ClientName"],TaskCode:sharepoint_utilities.check_for_null(field_properties.meta_package["ClientTaskCode"],"Not Applicable"),IndustryType:field_properties.meta_package["ClientIndustry"],AuditSoftwarePackageUsed:field_properties.meta_package["AuditSoftwarePackageUsed"]};if(reference_id){let check_for_lockdown_item=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id","QRMACReference eq '"+reference_id+"'",app_configuration.lockdown_list_name,"Id desc");$.when(check_for_lockdown_item).done(function(item_results){if(item_results.length>0){let update_item=sharepoint_utilities.update_item(app_configuration.lockdown_list_name,app_configuration.site_context,meta_package,item_results[0].Id);$.when(update_item).done(function(){})}})}};client_risk_assesments.render_data_from_email=function(request_meta){$(".assesment-drop-down-container").addClass("hide");let action_element=$("<i></i>");action_element.attr("data-itemid",request_meta.item_id);action_element.attr("title","View the current submission");action_element.attr("data-action-type",request_meta.acceptance_or_continuance);action_element.attr("data-source-type","current");client_risk_assesments.handle_table_action_buttons(action_element)};client_risk_assesments.handle_table_action_buttons=function(action_element){main["system_click"]=false;setTimeout(function(){let submission_data={item_id:action_element.attr("data-itemid"),action_type:action_element.attr("data-action-type"),data_source_type:action_element.attr("data-source-type"),form_type:action_element.attr("data-action-type"),form_status:"existing"};client_risk_assesments.action_element_status=action_element.attr("title");switch(action_element.attr("title")){case"Create new continuance":client_risk_assesments["new_continuance_form"]="yes";client_risk_assesments.get_continuance_form(action_element);break;case"Resign from engagement":supporting_documents.quick_action_resignation(submission_data);break;case"View the current submission":if(submission_data.data_source_type=="archives"){list_name=app_configuration.archive_list_name;list_context=app_configuration.archive_ac_submission_site_context;let archive_site_url=app_configuration.ac_archive_link_url+"/EditForm.aspx?ID="+submission_data.item_id+"&Source="+app_configuration.mazars_intranet;window.open(archive_site_url,"_blank")}else if(submission_data.action_type=="Acceptance"){client_risk_assesments.render_acceptance_form_html(submission_data)}else{client_risk_assesments.render_continuance_form_html(submission_data)}break;case"Reset the current submission back into progress":custom_options={Yes:continue_to_reset,No:function(){}};sharepoint_utilities.render_confirmation_box("Reset Submission","Are you sure you want to reset this submission? <br/>"+"This will reset the form and remove all approvers.<br/> "+"This is required when you have made a mistake and wish to correct it whilst its under approval | declined or it has been cancelled.",custom_options,"50%");function continue_to_reset(){client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handled","ResetSubmission",submission_data.item_id);sharepoint_utilities.render_notification("Resetting Submission","Please wait while we reset your submission, you will receive an email confirmation when the process has completed.","Info");setTimeout(function(){client_risk_assesments.render_selected_client_acceptance_continuance($("select[data-sp-field-name='temp-assesment-search']").val())},2e3)}break;case"Cancel the current submission":custom_options={Yes:continue_to_cancel,No:function(){}};sharepoint_utilities.render_confirmation_box("Cancelling Submission","Are you sure you want to cancel this submission",custom_options,"50%");function continue_to_cancel(){client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handled","CancelSubmission",submission_data.item_id);sharepoint_utilities.render_notification("Cancelling Submission","Please wait while we cancel your submission","Info");setTimeout(function(){client_risk_assesments.render_selected_client_acceptance_continuance($("select[data-sp-field-name='temp-assesment-search']").val())},2e3)}break;case"Download the pdf":client_risk_assesments.download_pdf(action_element);break}},500)};client_risk_assesments.reset_form=function(){$("#main-canvas-container div.bread-crumb").html(null);$("#main-canvas-container div.page-section-header").html(null);$(".right-help-comments-section-panel").addClass("hide");$("#main-canvas-container").removeClass("col-5");$("#main-canvas-container").addClass("col-8");$(".right-help-comments-content").html(null);sharepoint_utilities.field_comments_list=null;warning_controller["warning_cache"]=null};client_risk_assesments.rule_engine=function(){var ServiceType=$("select[data-sp-element-name='ClientAcceptanceType']").val();$("li[data-link-id='S90 Calculator']").addClass("nav-item-disabled");$("li[data-link-id='S90 Considerations']").addClass("nav-item-disabled");$("li[data-link-id='Fee Considerations']").addClass("nav-item-disabled");$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled");$("li[data-link-id='EQR Calculator']").addClass("nav-item-disabled");$("li[data-link-id='Business Sustainability']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Transnational Calculator']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix D']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='1. Assessment of compliance with Independence rules']").addClass("nav-item-disabled");let assurance_field_set=["FinancialReportingFramework","SPACEngagment","IPOEngagment","IsCarlPartner","significantVariation","SignificantVariationComments","recoveryOrWriteOff","StatusPerformed","eqrCalculator","nonAssuranceServicePerformed","Q1IsTransnational","EngagementPartnerComm","s90Calculator","SpecialistsRequired","percentageCoverGroup","IsConcurringReviewPartner","PreviousFirmAppointed","group-engagement-schedule-placeholder","FinancialYearEnd","ExpectedSigningDate","Q8Independence","PreviousAuditSignOff","AuditTakeover","IsTransnational","ApplicableStandard","feeConsiderations","NonAssuranceFeesJSON","AuditSoftwarePackageUsed"];sharepoint_utilities.hide_fields(assurance_field_set);sharepoint_utilities.set_fields_as_not_required(assurance_field_set);if(ServiceType=="Assurance"){sharepoint_utilities.show_fields(assurance_field_set);sharepoint_utilities.set_fields_as_required(assurance_field_set);$("li[data-link-id='S90 Calculator']").removeClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Transnational Calculator']").removeClass("nav-item-disabled");assurance_functions.general_rules();supporting_documents.append_to_current_document_required("Annual Financial Statements")}let shared_nas_fields=["NASReport","PeriodYearEnd","NASRiskyServices"];sharepoint_utilities.hide_fields(shared_nas_fields);sharepoint_utilities.set_fields_as_not_required(shared_nas_fields);let non_assurance_fields=["Q7Independence","C7Independence","IsTransnational"];sharepoint_utilities.hide_fields(non_assurance_fields);sharepoint_utilities.set_fields_as_not_required(non_assurance_fields);if(ServiceType=="Non-Assurance"){sharepoint_utilities.show_fields(non_assurance_fields);sharepoint_utilities.show_fields(shared_nas_fields);sharepoint_utilities.set_fields_as_required(shared_nas_fields);sharepoint_utilities.set_fields_as_required(non_assurance_fields);non_assurance_functions.general_rules();$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Transnational Calculator']").removeClass("nav-item-disabled")}let appendix_d_fields=["AuditCommiteeApproval","OtherServicesProposedFee","IsListedInUSA","IsSelfInterestThreat","IsKYCClient","LeadAuditPartnerId","feeConsiderations"];sharepoint_utilities.hide_fields(appendix_d_fields);sharepoint_utilities.set_fields_as_not_required(appendix_d_fields);if(ServiceType=="Non assurance service on existing assurance client (Appendix D)"){$("li[data-link-id='Fee Considerations']").removeClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix D']").removeClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='1. Assessment of compliance with Independence rules']").removeClass("nav-item-disabled");sharepoint_utilities.show_fields(appendix_d_fields);sharepoint_utilities.set_fields_as_required(appendix_d_fields);sharepoint_utilities.show_fields(shared_nas_fields);sharepoint_utilities.set_fields_as_required(shared_nas_fields);$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix A Clients']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix A Clients']").next("ul").find("li").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix B Engagements']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix B Engagements']").next("ul").find("li").addClass("nav-item-disabled");non_assurance_on_existing_assurance_client_functions.general_rules()}client_risk_assesments.cascade_service_type(ServiceType);client_risk_assesments.populate_nas_and_appendix_d_services();client_risk_assesments.render_applicable_standard_options();client_risk_assesments.render_subcontractor_conditional();client_risk_assesments.run_applicable_standard_rules();client_risk_assesments.giac_form_validation();client_risk_assesments.check_specialist_other();client_risk_assesments.carl_partner_validation();client_risk_assesments.general_acceptance_continuance_rules();client_risk_assesments.display_conditional_appendix_q11();client_risk_assesments.validate_blacklisted();client_risk_assesments.is_self_interest_threat();team_information_functions.run_general_rules();pie_form.determine_is_crypto_currency();client_risk_assesments.global_required_documents();client_risk_assesments.determine_risk_status();client_risk_assesments.other_pie_entities_comments_toggle();client_risk_assesments.check_if_rely_comply_assesment_is_required();client_risk_assesments.check_relevant_source_of_funds();client_risk_assesments.business_sustainablity_form_rules()};client_risk_assesments.cascade_list_of_services=function(service_type,service_line){let get_service_line_details=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","ServiceType eq '"+service_type+"' and Title eq '"+service_line+"'","MazarsServiceLines","Title asc");$.when(get_service_line_details).done(function(get_service_line_details_data){let service_lines="";let list_of_services_to_display="";for(let index=0;index<get_service_line_details_data.length;index++){const get_service_line_details_data_row=get_service_line_details_data[index];service_lines+="<option value='"+get_service_line_details_data_row.Title+"'>"+get_service_line_details_data_row.Title+"</option>";let cascade_options=get_service_line_details_data_row.DropDownOptions;if(cascade_options){for(let c_index=0;c_index<cascade_options.length;c_index++){const element=cascade_options[c_index];list_of_services_to_display+="<option value='"+element+"'>"+element+"</option>"}}}$("select[data-sp-element-name='NatureOfServicesDescription']").html(list_of_services_to_display)})};client_risk_assesments.populate_nas_and_appendix_d_services=function(){let field_properties=sharepoint_utilities.get_field_values(["NASServices"]);let get_services_list=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","","MazarsServiceLines","Title asc");$.when(get_services_list).done(function(get_services_list_data){let list_of_non_assurance_and_appendix_d_services="";let list_of_unique_services=[];for(let index=0;index<get_services_list_data.length;index++){const item_row=get_services_list_data[index];let cascade_options=item_row.DropDownOptions;if(cascade_options){for(let c_index=0;c_index<cascade_options.length;c_index++){const element=cascade_options[c_index];if(list_of_unique_services.indexOf(element)==-1){if(item_row.ServiceType.indexOf("Non-Assurance")>=0||item_row.ServiceType.indexOf("Appendix D")>=0){list_of_non_assurance_and_appendix_d_services+="<option value='"+element+"'>"+element+"</option>"}list_of_unique_services.push(element)}}}}list_of_non_assurance_and_appendix_d_services+="<option value='Other'>Other</option>";$("select[data-sp-element-name='NASServices']").html(list_of_non_assurance_and_appendix_d_services);sharepoint_utilities.set_field_value("NASServices",field_properties.meta_package["NASServices"]);$("select[data-sp-element-name='NASServices']").change()})};client_risk_assesments.cascade_service_type=function(service_type){let field_properties=sharepoint_utilities.get_field_values(["MazarsServiceLine"]).meta_package;let get_service_line_details=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","ServiceType eq '"+service_type+"'","MazarsServiceLines","Title asc");$.when(get_service_line_details).done(function(get_service_line_details_data){let service_lines="<option value=''>Please select...</option>";let is_found=false;for(let index=0;index<get_service_line_details_data.length;index++){const get_service_line_details_data_row=get_service_line_details_data[index];if(field_properties.MazarsServiceLine==get_service_line_details_data_row.Title){is_found=true}service_lines+="<option value='"+get_service_line_details_data_row.Title+"'>"+get_service_line_details_data_row.Title+"</option>"}$("select[data-sp-element-name='MazarsServiceLine']").html(service_lines);$("select[data-sp-element-name='ClientServiceLine']").html(service_lines);if(is_found){sharepoint_utilities.set_field_value("MazarsServiceLine",field_properties.MazarsServiceLine);sharepoint_utilities.set_field_value("ClientServiceLine",field_properties.MazarsServiceLine)}})};client_risk_assesments.check_relevant_source_of_funds=function(){let field_properties=sharepoint_utilities.get_field_values(["IsNaturalPerson","SourceOfFunds"]);sharepoint_utilities.set_fields_as_not_required(["SourceOfFunds","SourceOfFundsOther"]);sharepoint_utilities.hide_fields(["SourceOfFunds","SourceOfFundsOther"]);if(field_properties.meta_package["IsNaturalPerson"]=="No"){sharepoint_utilities.show_fields(["SourceOfFundsOther"]);sharepoint_utilities.set_fields_as_required(["SourceOfFundsOther"]);client_risk_assesments.clear_multi_select_box("SourceOfFunds")}else if(field_properties.meta_package["IsNaturalPerson"]=="Yes"){sharepoint_utilities.show_fields(["SourceOfFunds"]);sharepoint_utilities.set_fields_as_required(["SourceOfFunds"]);if(field_properties.meta_package["SourceOfFunds"]){if(field_properties.meta_package["SourceOfFunds"].indexOf("Other")>=0){sharepoint_utilities.show_fields(["SourceOfFundsOther"]);sharepoint_utilities.set_fields_as_required(["SourceOfFundsOther"])}}}};client_risk_assesments.clear_multi_select_box=function(sp_field_name){$("div[sp-field-name='"+sp_field_name+"'").find("select").next().find(".select2-selection__rendered li").each(function(){let remove_item=$(this).find(".select2-selection__choice__remove");remove_item.click()})};client_risk_assesments.set_client_service_line_field=function(service_line_value){sharepoint_utilities.set_field_value("ClientServiceLine",service_line_value)};client_risk_assesments.check_if_rely_comply_assesment_is_required=function(){if(app_configuration.display_rely_comply_module){let rely_comply_assesment_fields=["ClientServiceLine","ClientAddress","ClientCountry","ClientRegOrTaxNumber","NatureOfClient","ClientServiceType","Q12PartA"];let field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType","AcceptanceOrContinuance","ClientServiceLine","Q12PartA"]);let rely_assesement_required=false;let service_lines_required=["Corporate Finance","Tax Consulting","Company Secretarial","Independent Trustee"];for(let index=0;index<service_lines_required.length;index++){const element=service_lines_required[index];if(field_properties.meta_package["ClientServiceLine"]){if(field_properties.meta_package["ClientServiceLine"].indexOf(element)>=0){rely_assesement_required=true}}}if(field_properties.meta_package["Q12PartA"]=="Yes"){sharepoint_utilities.show_fields(["C12PartA"]);sharepoint_utilities.set_fields_as_required(["C12PartA"])}supporting_documents.append_to_current_document_required("Rely Comply Risk Assesment","remove");sharepoint_utilities.hide_fields(["sp-button-nas-rely-comply-assesment-creation"]);sharepoint_utilities.hide_fields(rely_comply_assesment_fields);sharepoint_utilities.set_fields_as_not_required(rely_comply_assesment_fields);if(rely_assesement_required){warning_controller.add_new_warning("Rely Comply Risk Assesment","Please create and upload your Rely Comply Risk Assesment for this client under supporting documents","Info");supporting_documents.append_to_current_document_required("Rely Comply Risk Assesment");sharepoint_utilities.show_fields(rely_comply_assesment_fields);sharepoint_utilities.set_fields_as_required(rely_comply_assesment_fields);sharepoint_utilities.show_fields(["sp-button-nas-rely-comply-assesment-creation"])}else{sharepoint_utilities.hide_fields(["C12PartA"]);sharepoint_utilities.set_fields_as_not_required(["C12PartA"])}}};client_risk_assesments.other_pie_entities_comments_toggle=function(){let field_properties=sharepoint_utilities.get_field_values(["OtherPieEntities"]);let fields_to_toggle=["PIEclassification"];sharepoint_utilities.hide_fields(fields_to_toggle);sharepoint_utilities.set_fields_as_not_required(fields_to_toggle);if(field_properties.meta_package["OtherPieEntities"]=="Yes"){sharepoint_utilities.show_fields(fields_to_toggle);sharepoint_utilities.set_fields_as_required(fields_to_toggle)}};client_risk_assesments.global_required_documents=function(){supporting_documents.append_to_current_document_required("Draft Engagement Letter");supporting_documents.append_to_current_document_required("WeCheck Report");supporting_documents.append_to_current_document_required("KAC report");let get_field_properties=sharepoint_utilities.get_field_values(["AcceptanceOrContinuance"]).meta_package;if(get_field_properties.AcceptanceOrContinuance!="Continuance"){supporting_documents.append_to_current_document_required("PONG Report")}else{supporting_documents.append_to_current_document_required("PONG Report","remove")}};client_risk_assesments.render_subcontractor_conditional=function(){let get_field_properties=sharepoint_utilities.get_field_values(["subcontractors"]);let field_values=get_field_properties.meta_package;let subcontractors=field_values["subcontractors"];if(subcontractors=="Yes"){sharepoint_utilities.show_fields(["subcontractorsComm"]);sharepoint_utilities.set_fields_as_required(["subcontractorsComm"]);supporting_documents.append_to_current_document_required("Subcontractor Certificate")}else{sharepoint_utilities.hide_fields(["subcontractorsComm"]);sharepoint_utilities.set_fields_as_not_required(["subcontractorsComm"]);supporting_documents.append_to_current_document_required("Subcontractor Certificate","remove")}};$(document).on("change",".client-acceptance-general select[data-sp-element-name='ClientName']",function(){sharepoint_utilities.set_field_value("ClientTaskCode","");client_risk_assesments.render_task_code_component($(this).val(),"ClientTaskCode")});$(document).on("change","input[data-sp-element-name='nonAssuranceServicePerformed']",function(){client_risk_assesments.is_self_interest_threat()});client_risk_assesments.render_task_code_component=function(client_name,task_code_field_name){let clean_client_name=main.clean_client_name(client_name);$.when(sharepoint_utilities.get_list_items_by_title(app_configuration.client_list_site_context,"TaskCodes","M_ClientName eq '"+clean_client_name+"'",app_configuration.client_list_name,"Id desc")).done(function(task_code_results){let task_code_options=["Not Applicable"];if(main["selected_client_risk_data"]){if(main["selected_client_risk_data"].AcceptanceOrContinuance=="Continuance"){task_code_options=[]}}for(let index=0;index<task_code_results.length;index++){const task_code_field=task_code_results[index].TaskCodes;if(task_code_field){if(task_code_field.indexOf("|")>=0){task_code_options=["Not Applicable"];if(main["selected_client_risk_data"]){if(main["selected_client_risk_data"].AcceptanceOrContinuance=="Continuance"){task_code_options=[]}}let list_of_task_codes=task_code_field.split("|");for(let index=0;index<list_of_task_codes.length;index++){const task_code=list_of_task_codes[index];task_code_options.push(task_code)}}else{task_code_options.push(task_code_field)}}}client_risk_assesments.render_task_codes(task_code_options,task_code_field_name)})};client_risk_assesments.is_self_interest_threat=function(){let nonAssuranceServicePerformed=$("input[data-sp-element-name='nonAssuranceServicePerformed']").val();if(nonAssuranceServicePerformed=="Yes"){sharepoint_utilities.show_fields(["IsSelfInterestThreat","AppendixDEngagagementPartnersId"]);sharepoint_utilities.set_fields_as_required(["IsSelfInterestThreat","AppendixDEngagagementPartnersId"])}else{sharepoint_utilities.hide_fields(["IsSelfInterestThreat","AppendixDEngagagementPartnersId"]);sharepoint_utilities.set_fields_as_not_required(["IsSelfInterestThreat","AppendixDEngagagementPartnersId"])}};client_risk_assesments.continuance_lite_risk_rules=function(){let is_risky=false;let working_fields_kyc=["Q1ACLiteKYC"];let working_fields_money=["Q1ACLiteMoney","Q2ACLiteMoney"];let working_fields_part_a=["Q1ACLitePartA","Q2ACLitePartA","Q3ACLitePartA","Q4ACLitePartA","Q5ACLitePartA","Q6ACLitePartA"];let working_fields_part_b=["Q1ACLitePartB","Q2ACLitePartB","Q3ACLitePartB"];let working_fields_ind=["Q1ACLiteINDP","Q2ACLiteINDP","Q3ACLiteINDP"];let working_fields_ac_lite=["Q1ACLite","Q2ACLite","Q3ACLite","Q4ACLite","Q5ACLite","Q6ACLite"];let working_fields_risk_statuses=["RiskStatusACLiteKYC","RiskStatusACLiteMoney","RiskStatusACLiteINDP","RiskStatusACLitePartB","RiskStatusACLitePartA","RiskStatusACLite"];let working_all_fields=[];working_all_fields=working_all_fields.concat(working_fields_kyc,working_fields_money,working_fields_part_a,working_fields_part_b,working_fields_ind,working_fields_ac_lite,working_fields_risk_statuses);let get_field_properties=sharepoint_utilities.get_field_values(working_all_fields);let get_field_values=get_field_properties.meta_package;if(determine_risk_status(working_fields_money,get_field_values,"RiskStatusACLiteMoney")){is_risky=true}if(determine_risk_status(working_fields_part_a,get_field_values,"RiskStatusACLitePartA")){is_risky=true}if(determine_risk_status(working_fields_part_b,get_field_values,"RiskStatusACLitePartB")){is_risky=true}if(determine_risk_status(working_fields_ind,get_field_values,"RiskStatusACLiteINDP")){is_risky=true}if(determine_risk_status(working_fields_ac_lite,get_field_values,"RiskStatusACLite")){is_risky=true}sharepoint_utilities.set_field_value("RiskStatusACLiteKYC","Allowed");if(get_field_values["Q1ACLiteKYC"]=="None of the above"){sharepoint_utilities.set_field_value("RiskStatusACLiteKYC","Not Allowed");is_risky=true}sharepoint_utilities.set_field_value("RiskStatus","Not Risky");if(is_risky){sharepoint_utilities.set_field_value("RiskStatus","Risky");let outcome_options={Continue:function(){let submission_data={item_id:main["selected_client_risk_data"]["Id"],action_type:"continuance",data_source_type:"current",form_type:"continuance",form_status:"existing"};client_risk_assesments.render_continuance_form_html(submission_data);sharepoint_utilities.update_item(app_configuration.ac_submission,app_configuration.site_context,{ACLiteVersion:"no"},parseInt(main["selected_client_risk_data"]["Id"]))}};sharepoint_utilities.render_confirmation_box("Client Identified as Risky","Selecting 'Yes' indicates that the client is considered risky, and you will not be able to proceed with the Continuance Lite Form.",outcome_options,"60%");$("input[name='Q1ACLite'][value='yes']").prop("checked",false)}function determine_risk_status(field_set,field_set_values,sp_risk_field_name){let is_risky=false;sharepoint_utilities.set_field_value(sp_risk_field_name,"Allowed");for(let index=0;index<field_set.length;index++){const field_value=field_set_values[field_set[index]];if(field_value=="Yes"){sharepoint_utilities.set_field_value(sp_risk_field_name,"Not Allowed");is_risky=true}}return is_risky}};client_risk_assesments.render_task_codes=function(list_of_client_codes,task_code_field_name){let form_json_field_properties={Title:"Client task code",Description:"The task code from greatsoft that applies to this client",sp_field_name:task_code_field_name,own_values:list_of_client_codes};let sp_field_name=form_json_field_properties.sp_field_name;let plugin_container=$("div[sp-field-name='"+sp_field_name+"']");plugin_container.find(".radio-button-component").remove();sharepoint_utilities.create_radio_buttons_with_own_values(form_json_field_properties);$("div[sp-field-name='"+task_code_field_name+"'] .field-component .radio-button-component").css("height","auto");let field_properties=sharepoint_utilities.get_field_values([task_code_field_name]);if(field_properties.meta_package[task_code_field_name]){sharepoint_utilities.set_radio_value(task_code_field_name,field_properties.meta_package[task_code_field_name])}};client_risk_assesments.run_applicable_standard_rules=function(){let applicable_field_options=["ApplicableStdModified","ApplicableStandardOther","AUPPolicy","AUPClient"];sharepoint_utilities.hide_fields(applicable_field_options);sharepoint_utilities.set_fields_as_not_required(applicable_field_options);assurance_functions.validate_other_selected();assurance_functions.validate_isa_705_rule();non_assurance_functions.validate_isrs4400_rule()};client_risk_assesments.render_applicable_standard_options=function(){var ServiceType=$("select[data-sp-element-name='ClientAcceptanceType']").val();$("div[sp-field-name='ApplicableStandard'] .select2-container").remove();let get_field_property=global_field_set_navigation.general_section[12];get_field_property["additional_filters"]="ServiceType eq '"+ServiceType+"'";$.when(sharepoint_utilities.apply_single_select_drop_down(get_field_property)).done(function(){if(main["selected_client_risk_data"]){if(main["selected_client_risk_data"].ApplicableStandard){setTimeout(function(){sharepoint_utilities.set_select_2_fields_by_value(main["selected_client_risk_data"].ApplicableStandard,$("select[data-sp-element-name='ApplicableStandard']"))},1500)}}if(ServiceType=="Assurance"){$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='Appendix D']").addClass("nav-item-disabled");$('[data-link-id="Appendix D"]').attr("title","Appendix D is only applicable when selecting the 'Non-Assurance on Existing' Client via the service type").addClass("tooltip-disabled")}})};client_risk_assesments.render_risk_assesment_search=function(){let assesment_lookup_component={assesment_lookup:[{Title:"Search Type",Description:"Select whether you would like to find the client by name or code",sp_field_name:"temp-client-search-type",sp_field_type:"input",field_width:"full-width",field_validate:true,sp_additional_properties:"radio-buttons-own-values",own_values:["Client Name","Client Code"],field_icon:"ProductionFloorManagement"},{Title:"Search for your assesments via Client Name",Description:"Please select your client name",sp_field_name:"temp-assesment-search",sp_field_type:"select",field_width:"half-width",field_validate:false,sp_additional_properties:"single-select-typeahead exclude-from-meta allow-own-values",additional_filters:"",drop_down_title_field:"M_ClientName",drop_down_value_field:"M_ClientName",drop_down_order_by:"Title asc",list_name:app_configuration.client_list_name,site_context:app_configuration.client_list_site_context,field_icon:"ContactList"},{Title:"New Acceptance",Description:"Click to create your new acceptance form",sp_field_name:"new-acceptance-action-button",sp_field_type:"button",field_width:"half-width",field_validate:false,sp_additional_properties:"exclude-from-meta hide-details"},{Title:"Assesment table history",Description:"Assesment table history",sp_field_name:"temp-assesment-table-history",sp_field_type:"placeholder",field_width:"full-width",field_validate:false,sp_additional_properties:"placeholder exclude-from-meta hide-details"}]};$("#additional-component-placeholders").html(sharepoint_utilities.create_container_form(assesment_lookup_component.assesment_lookup,"assesment-drop-down-container form-basic"));$("li[data-link-id='Client Acceptance']").addClass("nav-item-disabled");$("li[data-link-id='Client Continuance']").addClass("nav-item-disabled");$("li[data-link-id='Client Continuance Lite']").addClass("nav-item-disabled");sharepoint_utilities.apply_form_plugins(assesment_lookup_component.assesment_lookup);sharepoint_utilities.set_radio_value("temp-client-search-type","Client Name")};client_risk_assesments.render_selected_client_acceptance_continuance=function(client_name){let select_fields="Id,Form_x0020_Status,RiskStatus,ClientName,Modified,AcceptanceOrContinuance,EngagementPartnerId,EngagementPartner/Title,ClientAcceptanceType,ACLiteVersion";let expand_fields="&$expand=EngagementPartner/Title";$("div[sp-field-name='temp-assesment-table-history'] .field-component ").html("");var archive_site_submissions=sharepoint_utilities.get_list_items_by_title(app_configuration.archive_ac_submission_site_context,select_fields+expand_fields,"ClientName eq '"+main.clean_client_name(client_name)+"'",app_configuration.archive_list_name,"Id desc");var new_site_submissions=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,select_fields+expand_fields,"ClientName eq '"+main.clean_client_name(client_name)+"'","ACSubmissions","Id desc");$.when(archive_site_submissions,new_site_submissions).done(function(archive_site_submissions,new_site_submissions){let table_html=`   
                <table id='client_search_assessents_table' class='table-dashboard accordin-table table' style='width:100%;'>
                    <thead>                      
                        <th>Client Name <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Partner <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Last Submission <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th> 
                        <th>Service <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Type <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Status <i class="menu-icon ms-Icon ms-Icon--ChevronUnfold10 sort-icon"></i></th>
                        <th>Actions</th>
                    </thead>
                    <tbody>            
            `;for(let index=0;index<archive_site_submissions.length;index++){const archive_row=archive_site_submissions[index];table_html+=`
                    <tr>                       
                        <td>${archive_row.ClientName}</td>
                        <td>${archive_row.EngagementPartner.Title}</td>
                        <td data-sort='${moment(archive_row.Modified).format("x")}'>${moment(archive_row.Modified).format("ll")}</td>
                        <td>${archive_row.ClientAcceptanceType}</td>
                        <td class="table-type-column"'>${archive_row.AcceptanceOrContinuance}</td>
                        <td>
                            <div class="table-status-container">
                                <div data-client-class='${archive_row.Form_x0020_Status}'></div>
                                ${archive_row.Form_x0020_Status}
                            </div>
                        </td>
                        <td class="table-action-buttons-cell">
                             ${client_risk_assesments.render_action_buttons(archive_row.AcceptanceOrContinuance,"archives",archive_row)}                     
                        </td>
                    </tr>
                `}for(let index=0;index<new_site_submissions.length;index++){const current_site_row=new_site_submissions[index];let engagement_partner="None Selected";if(current_site_row.EngagementPartnerId){engagement_partner=current_site_row.EngagementPartner.Title}table_html+=`
                    <tr>                     
                        <td>${current_site_row.ClientName}</td>
                        <td>${engagement_partner}</td>
                        <td>${moment(current_site_row.Modified).format("ll")}</td>
                        <td>${current_site_row.ClientAcceptanceType} <br/> CRA ${current_site_row.Id}</td>
                        <td>${determine_if_continuance_lite(current_site_row.ACLiteVersion,current_site_row.AcceptanceOrContinuance)}</td>
                        <td>
                            <div class="table-status-container">
                                <div data-client-class='${current_site_row.Form_x0020_Status}'></div>
                                ${current_site_row.Form_x0020_Status}
                            </div>
                        </td>
                        <td class="table-action-buttons-cell">
                             ${client_risk_assesments.render_action_buttons(current_site_row.AcceptanceOrContinuance,"current",current_site_row)}                     
                        </td>
                    </tr>
                `}table_html+=`   
                    </tbody>
                </table
            `;$("div[sp-field-name='temp-assesment-table-history'] .field-component ").html(table_html);$("#client_search_assessents_table").DataTable({pageLength:10,bLengthChange:false,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]});sharepoint_utilities.show_fields(["new-continuance-action-button"])});function determine_if_continuance_lite(ac_lite_status,AcceptanceOrContinuance){let status_type=AcceptanceOrContinuance;if(ac_lite_status=="yes"){status_type="Continuance Lite"}return status_type}};client_risk_assesments.render_action_buttons=function(action_type,data_source_type,record){let field_properties=`
        data-action-type='${action_type}' 
        data-source-type='${data_source_type}'
        data-itemid='${record["Id"]}'  
        data-service-type='${record["ClientAcceptanceType"]}' 
        data-ac-lite='${record["ACLiteVersion"]}'        
    `;switch(record.Form_x0020_Status){case"Completed":action_buttons=`
                <i title='Download the pdf' class='menu-icon ms-Icon ms-Icon--CloudDownload table-action-button table-action-button' 
                    ${field_properties}                            
                ></i>&nbsp;&nbsp;  
                <i title='Create new continuance' class='menu-icon ms-Icon ms-Icon--Generate table-action-button-cancel table-action-button' 
                    ${field_properties}  
                >
                </i>&nbsp;&nbsp; 
            `;break;case"Cancelled":action_buttons=`  
                <i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button table-action-button' 
                    ${field_properties}              
                ></i>&nbsp;&nbsp;       
                <i title='Reset the current submission back into progress' class='menu-icon ms-Icon ms-Icon--SyncFolder table-action-button-reset-form table-action-button' 
                    ${field_properties}              
                ></i>&nbsp;&nbsp;                 
            `;break;case"s90 Cancelled":action_buttons=`  
                <i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button table-action-button' 
                    ${field_properties}              
                ></i>&nbsp;&nbsp;       
                <i title='Reset the current submission back into progress' class='menu-icon ms-Icon ms-Icon--SyncFolder table-action-button-reset-form table-action-button' 
                    ${field_properties}              
                ></i>&nbsp;&nbsp;                
            `;break;default:action_buttons=`  
                <i title='View the current submission' class='menu-icon ms-Icon ms-Icon--View table-action-button' 
                ${field_properties}    
                data-form-status='existing'              
                >
                </i>&nbsp;&nbsp;       
                <i title='Cancel the current submission' class='menu-icon ms-Icon ms-Icon--DeactivateOrders table-action-button-cancel table-action-button' 
                    ${field_properties}   
                    data-form-status='existing'           
                >
                </i>&nbsp;&nbsp; 
                <i title='Reset the current submission back into progress' class='menu-icon ms-Icon ms-Icon--SyncFolder table-action-button-reset-form table-action-button' 
                    ${field_properties}              
                ></i>&nbsp;&nbsp; 
                <i title='Resign from engagement' class='menu-icon ms-Icon ms-Icon--SignOut table-action-button-resign-from-engagement table-action-button' 
                    ${field_properties}  
                    data-form-status='existing'            
                ></i>&nbsp;&nbsp; 
            `;break}return action_buttons};client_risk_assesments.render_acceptance_form_html=function(submission_data){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='General']").removeClass("nav-item-disabled");$("li[data-link-id='Appendix D']").addClass("nav-item-disabled");$("li[data-link-id='Client Continuance']").next().remove();$("li[data-link-id='Client Continuance']").remove();$("li[data-link-id='Client Continuance Lite']").next().remove();$("li[data-link-id='Client Continuance Lite']").remove();let section_names=["General","Team Information","EQR Calculator","GIAC Form","Business Sustainability","General Information About the Engagement","PIE","Transnational Calculator","S90 Calculator","S90 Considerations","Fee Considerations","Key Figures - recent financial year","Risk Status","Part A - Risk Considered as Major","Part B - Risk Considered as Normal","Acceptance - Independence and other Considerations","Appendix C - Risk Assesment","Conclusion","1. Assessment of compliance with Independence rules","Approvals","Supporting Documents"];canvas.html(client_risk_assesments.create_form_sections(section_names));canvas.find("div[form-navigation-target='General']").html(sharepoint_utilities.create_container_form(acceptance_fields.general_section,"client-acceptance-general"));canvas.find("div[form-navigation-target='Team Information']").html(sharepoint_utilities.create_container_form(acceptance_fields.team_information,"client-acceptance-team-info"));canvas.find("div[form-navigation-target='EQR Calculator']").html(sharepoint_utilities.create_container_form(acceptance_fields.eqr_appointment_form,"client-eqr-appointment-form"));canvas.find("div[form-navigation-target='GIAC Form']").html(sharepoint_utilities.create_container_form(global_giac_form_fields.giac_form,"client-giac-form"));canvas.find("div[form-navigation-target='Business Sustainability']").html(sharepoint_utilities.create_container_form(global_field_set_navigation.business_sustainability,"client-business-sustainability-form"));canvas.find("div[form-navigation-target='General Information About the Engagement']").html(sharepoint_utilities.create_container_form(acceptance_fields.general_overview_fields,"client-acceptance-general-overview"));canvas.find("div[form-navigation-target='PIE']").html(sharepoint_utilities.create_container_form(acceptance_fields.PIE,"pie-form"));canvas.find("div[form-navigation-target='Key Figures - recent financial year']").html(sharepoint_utilities.create_container_form(acceptance_fields.key_figures,"key-figures"));canvas.find("div[form-navigation-target='Transnational Calculator']").html(sharepoint_utilities.create_container_form(acceptance_fields.transnational_calculator,"transnational-calculator-section"));canvas.find("div[form-navigation-target='S90 Calculator']").html(sharepoint_utilities.create_container_form(acceptance_fields.s90_calculator,"s90-calculator-section"));canvas.find("div[form-navigation-target='S90 Considerations']").html(sharepoint_utilities.create_container_form(acceptance_fields.s90_considerations,"s90-considerations-section"));canvas.find("div[form-navigation-target='Fee Considerations']").html(sharepoint_utilities.create_container_form(acceptance_fields.assurance_non_assurance_calculator,"assurance-vs-non-assurance Calculator"));canvas.find("div[form-navigation-target='Risk Status']").html(sharepoint_utilities.create_container_form(acceptance_fields.risk_status,"risk-status-section"));canvas.find("div[form-navigation-target='Part A - Risk Considered as Major']").html(sharepoint_utilities.create_container_form(acceptance_fields.appendix_a_part_a_risk_considered_as_major,"appendix-a-part-a"));canvas.find("div[form-navigation-target='Part B - Risk Considered as Normal']").html(sharepoint_utilities.create_container_form(acceptance_fields.part_b_risk_considered_normal,"appendix-a-part-b"));canvas.find("div[form-navigation-target='Acceptance - Independence and other Considerations']").html(sharepoint_utilities.create_container_form(acceptance_fields.acceptance_independence_and_other_considerations,"appendix-b-acceptance"));canvas.find("div[form-navigation-target='Appendix C - Risk Assesment']").html(sharepoint_utilities.create_container_form(acceptance_fields.appendix_c,"appendix-c-risk-assessment"));canvas.find("div[form-navigation-target='Conclusion']").html(sharepoint_utilities.create_container_form(acceptance_fields.conclusion,"appendix-c-conclusion"));canvas.find("div[form-navigation-target='1. Assessment of compliance with Independence rules']").html(sharepoint_utilities.create_container_form(acceptance_fields.appendix_d_assessment_of_compliance,"appendix-d-assesment"));canvas.find("div[form-navigation-target='Approvals']").html(sharepoint_utilities.create_container_form(acceptance_fields.approvals,"approvals-section"));canvas.find("div[form-navigation-target='Supporting Documents']").html(sharepoint_utilities.create_container_form(acceptance_fields.supporting_documents,"supporting-documents-section"));let apply_plugin_fields=sharepoint_utilities.consolidate_fields(acceptance_fields);sharepoint_utilities.apply_form_plugins(apply_plugin_fields);sharepoint_utilities.apply_form_plugins(global_giac_form_fields.giac_form);setTimeout(function(){client_risk_assesments.render_selected_form_data(submission_data)},3e3)};client_risk_assesments.render_continuance_form_html=function(submission_data){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='General']").removeClass("nav-item-disabled");$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled");$("li[data-link-id='EQR Calculator']").addClass("nav-item-disabled");$("li[data-link-id='Client Acceptance']").next().remove();$("li[data-link-id='Client Acceptance']").remove();$("li[data-link-id='Client Continuance Lite']").next().remove();$("li[data-link-id='Client Continuance Lite']").remove();let section_names=["General","Team Information","EQR Calculator","GIAC Form","Business Sustainability","General Information About the Engagement","PIE","Transnational Calculator","S90 Calculator","S90 Considerations","Fee Considerations","Key Figures - recent financial year","Risk Status","Part A - Risk Considered as Major","Part B - Risk Considered as Normal","Continuance - Independence and other Considerations","Appendix C - Risk Assesment","Conclusion","1. Assessment of compliance with Independence rules","Approvals","Supporting Documents"];canvas.html(client_risk_assesments.create_form_sections(section_names));canvas.find("div[form-navigation-target='General']").html(sharepoint_utilities.create_container_form(continuance_fields.general_section,"client-continuance-general"));canvas.find("div[form-navigation-target='Team Information']").html(sharepoint_utilities.create_container_form(continuance_fields.team_information,"client-continuance-team-info"));canvas.find("div[form-navigation-target='EQR Calculator']").html(sharepoint_utilities.create_container_form(continuance_fields.eqr_appointment_form,"client-eqr-appointment-form"));canvas.find("div[form-navigation-target='GIAC Form']").html(sharepoint_utilities.create_container_form(global_giac_form_fields.giac_form,"client-giac-form"));canvas.find("div[form-navigation-target='Business Sustainability']").html(sharepoint_utilities.create_container_form(global_field_set_navigation.business_sustainability,"client-business-sustainability-form"));canvas.find("div[form-navigation-target='General Information About the Engagement']").html(sharepoint_utilities.create_container_form(continuance_fields.general_overview_fields,"client-continuance-general-overview"));canvas.find("div[form-navigation-target='PIE']").html(sharepoint_utilities.create_container_form(continuance_fields.PIE,"pie-form"));canvas.find("div[form-navigation-target='Key Figures - recent financial year']").html(sharepoint_utilities.create_container_form(continuance_fields.key_figures,"key-figures"));canvas.find("div[form-navigation-target='Transnational Calculator']").html(sharepoint_utilities.create_container_form(continuance_fields.transnational_calculator,"transnational-calculator-section"));canvas.find("div[form-navigation-target='S90 Calculator']").html(sharepoint_utilities.create_container_form(acceptance_fields.s90_calculator,"s90-calculator-section"));canvas.find("div[form-navigation-target='S90 Considerations']").html(sharepoint_utilities.create_container_form(continuance_fields.s90_considerations,"s90-considerations-section"));canvas.find("div[form-navigation-target='Fee Considerations']").html(sharepoint_utilities.create_container_form(acceptance_fields.assurance_non_assurance_calculator,"fee-considerations-section"));canvas.find("div[form-navigation-target='Risk Status']").html(sharepoint_utilities.create_container_form(continuance_fields.risk_status,"risk-status-section"));canvas.find("div[form-navigation-target='Part A - Risk Considered as Major']").html(sharepoint_utilities.create_container_form(continuance_fields.appendix_a_part_a_risk_considered_as_major,"appendix-a-part-a"));canvas.find("div[form-navigation-target='Part B - Risk Considered as Normal']").html(sharepoint_utilities.create_container_form(continuance_fields.part_b_risk_considered_normal,"appendix-a-part-b"));canvas.find("div[form-navigation-target='Continuance - Independence and other Considerations']").html(sharepoint_utilities.create_container_form(continuance_fields.continuance_independence_and_other_considerations,"appendix-b-continuance"));canvas.find("div[form-navigation-target='Appendix C - Risk Assesment']").html(sharepoint_utilities.create_container_form(continuance_fields.appendix_c,"appendix-c-risk-assessment"));canvas.find("div[form-navigation-target='Conclusion']").html(sharepoint_utilities.create_container_form(continuance_fields.conclusion,"appendix-c-conclusion"));canvas.find("div[form-navigation-target='1. Assessment of compliance with Independence rules']").html(sharepoint_utilities.create_container_form(continuance_fields.appendix_d_assessment_of_compliance,"appendix-d-assesment"));canvas.find("div[form-navigation-target='Approvals']").html(sharepoint_utilities.create_container_form(continuance_fields.approvals,"approvals-section"));canvas.find("div[form-navigation-target='Supporting Documents']").html(sharepoint_utilities.create_container_form(continuance_fields.supporting_documents,"supporting-documents-section"));let apply_plugin_fields=sharepoint_utilities.consolidate_fields(continuance_fields);sharepoint_utilities.apply_form_plugins(apply_plugin_fields);sharepoint_utilities.apply_form_plugins(global_giac_form_fields.giac_form);sharepoint_utilities.apply_form_plugins(global_field_set_navigation.business_sustainability);setTimeout(function(){client_risk_assesments.render_selected_form_data(submission_data)},3e3)};client_risk_assesments.render_continuance_lite_form_html=function(record_properties){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='General']").removeClass("nav-item-disabled");$("li[data-link-id='EQR Calculator']").addClass("nav-item-disabled");$("li[data-link-id='S90 Considerations']").addClass("nav-item-disabled");$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled");$("li[data-link-id='Appendix D']").addClass("nav-item-disabled");$("li[data-link-id='Client Acceptance']").next().remove();$("li[data-link-id='Client Acceptance']").remove();$("li[data-link-id='Client Continuance']").addClass("nav-item-disabled");let section_names=["General","General Information About the Engagement","PIE","Key Figures - recent financial year","LITE","Part A - Risk Considered as Major","Part B - Risk Considered as Normal","Indpendence and other considerations","Assessment of the risk of money laundering and terrorist financing acts","Know your client (KYC) procedures performed","Risk Status","Approvals","Supporting Documents"];canvas.html(client_risk_assesments.create_form_sections(section_names));canvas.find("div[form-navigation-target='General']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.general_section,"client-continuance-general "));canvas.find("div[form-navigation-target='General Information About the Engagement']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.general_overview_fields,"ac-lite-general"));canvas.find("div[form-navigation-target='PIE']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.PIE,"pie-form"));canvas.find("div[form-navigation-target='Key Figures - recent financial year']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.key_figures,"key-figures"));canvas.find("div[form-navigation-target='LITE']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.ac_lite,"lite-form custom-lite-form-answers"));canvas.find("div[form-navigation-target='Part A - Risk Considered as Major']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.part_a_risk_considered_as_major,"part-a-risk-considered-as-major custom-lite-form-answers"));canvas.find("div[form-navigation-target='Part B - Risk Considered as Normal']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.part_b_risk_considered_as_normal,"part-b-risk-considered-as-normal custom-lite-form-answers"));canvas.find("div[form-navigation-target='Indpendence and other considerations']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.independence_and_other_considerations,"independence-and-other-consideration custom-lite-form-answers"));canvas.find("div[form-navigation-target='Assessment of the risk of money laundering and terrorist financing acts']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.a_and_c_lite_assessment_of_risk,"lite-assessment-of-risk custom-lite-form-answers"));canvas.find("div[form-navigation-target='Know your client (KYC) procedures performed']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.engagement_lite_know_your_client,"engagement-lite-kyc custom-lite-form-answers"));canvas.find("div[form-navigation-target='Risk Status']").html(sharepoint_utilities.create_container_form(continuance_fields.risk_status,"risk-status-section"));canvas.find("div[form-navigation-target='Approvals']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.approvals,"approvals-section"));canvas.find("div[form-navigation-target='Supporting Documents']").html(sharepoint_utilities.create_container_form(continuance_lite_fields.supporting_documents,"supporting-documents-section"));let apply_plugin_fields=sharepoint_utilities.consolidate_fields(continuance_lite_fields);sharepoint_utilities.apply_form_plugins(apply_plugin_fields);setTimeout(function(){client_risk_assesments.render_selected_form_data(record_properties)},3e3)};client_risk_assesments.create_form_sections=function(array_of_sections){let section_html="<div id='field_section_container'>";for(let index=0;index<array_of_sections.length;index++){const section=array_of_sections[index];section_html+=`
            <div form-navigation-target='${section}' class='page-section-form-container hide'></div>
        `}section_html+="</div>";return section_html};client_risk_assesments.show_section=function(section_name){$(".page-section-form-container").addClass("hide");$("#field_section_container div[form-navigation-target='"+section_name+"']").removeClass("hide")};client_risk_assesments.get_continuance_form=function(selected_form_properties){let submission_data={item_id:selected_form_properties.attr("data-itemid"),action_type:"continuance",data_source_type:selected_form_properties.attr("data-source-type"),form_type:"continuance",form_status:"new"};client_risk_assesments.render_continuance_form_html(submission_data)};client_risk_assesments.giac_form_validation=function(){let field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType","IsListedClient","CryptoEngagment","SPACEngagment","IPOEngagment","IsTransnational","OtherPieEntities","AcceptanceOrContinuance","HasRussianEntities","MazarsServiceLine","HasRiskAppetite"]);let field_values=field_properties.meta_package;let acceptance_or_continuance=field_values["AcceptanceOrContinuance"];let service_type=field_values["ClientAcceptanceType"];let listed_entity=field_values["IsListedClient"];let transnational_status=field_values["IsTransnational"];let crypto_engagement=field_values["CryptoEngagment"];let spac_engagement=field_values["SPACEngagment"];let ipo_engagement=field_values["IPOEngagment"];let other_pie_entities=field_values["OtherPieEntities"];let has_russain_entities=field_values["HasRussianEntities"];let is_on_watch_list=field_values["HasRiskAppetite"];let mazars_service_line=field_values["MazarsServiceLine"];$("li[data-link-id='GIAC Form']").removeClass("nav-item-disabled");switch(acceptance_or_continuance){case"Acceptance":switch(service_type){case"Assurance":if(is_on_watch_list=="Yes"||other_pie_entities=="Yes"&&mazars_service_line=="Audit"||has_russain_entities=="Yes"||listed_entity=="Yes"||crypto_engagement=="Yes"||ipo_engagement=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;case"Non-Assurance":if(crypto_engagement=="Yes"||is_on_watch_list=="Yes"||has_russain_entities=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;case"Non assurance service on existing assurance client (Appendix D)":if(crypto_engagement=="Yes"||is_on_watch_list=="Yes"||has_russain_entities=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;default:$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled");break}break;case"Continuance":switch(service_type){case"Assurance":if(is_on_watch_list=="Yes"||has_russain_entities=="Yes"||crypto_engagement=="Yes"||ipo_engagement=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;case"Non-Assurance":if(is_on_watch_list=="Yes"||crypto_engagement=="Yes"||has_russain_entities=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;case"Non assurance service on existing assurance client (Appendix D)":if(crypto_engagement=="Yes"||is_on_watch_list=="Yes"||has_russain_entities=="Yes"){warning_controller.add_new_warning("GIAC Form","Please complete the GIAC Form","Info")}else{$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled")}break;default:$("li[data-link-id='GIAC Form']").addClass("nav-item-disabled");break}break}};client_risk_assesments.render_selected_form_data=function(selected_form_properties){let item_id=parseInt(selected_form_properties.item_id);let action_type=selected_form_properties.action_type;let data_source_type=selected_form_properties.data_source_type;let form_status=selected_form_properties.form_status;let canvas=$(".page-section");let query_fields="";let consolidate_all_fields=[];let appendix_a_major_fields=[];let appendix_a_normal_fields=[];let appendix_b_indpendence_fields=[];let appendix_c_dummy_fields=[];let appedix_c_unusual_operations=[];let appendix_c_conclusion=[];let appendix_c_kyc=[];let transnational_calculator=[];let s90_calculator=[];let s90_considerations=[];let assurance_non_assurance_calculator=[];let appendix_d=[];let ac_lite_main_section_fields=[];let ac_lite_money_laundering_fields=[];let giac_query_fields=[];switch(action_type.toLowerCase()){case"acceptance":consolidate_all_fields=sharepoint_utilities.consolidate_fields(acceptance_fields);query_fields=sharepoint_utilities.generate_query_for_expanded_fields(consolidate_all_fields);giac_query_fields=sharepoint_utilities.generate_query_for_expanded_fields(global_giac_form_fields.giac_form);appendix_a_major_fields=acceptance_fields.appendix_a_part_a_risk_considered_as_major;appendix_a_normal_fields=acceptance_fields.part_b_risk_considered_normal;appendix_b_indpendence_fields=acceptance_fields.acceptance_independence_and_other_considerations;appendix_c_dummy_fields=acceptance_fields.dummy_entities_companies_trust;appedix_c_unusual_operations=acceptance_fields.unusual_operations_regarding_economic_activites;appendix_c_conclusion=acceptance_fields.conclusion;appendix_c_kyc=acceptance_fields.kyc_procedures_performed;appendix_d=acceptance_fields.appendix_d_assessment_of_compliance;transnational_calculator=acceptance_fields.transnational_calculator;s90_calculator=acceptance_fields.s90_calculator;s90_considerations=acceptance_fields.s90_considerations;assurance_non_assurance_calculator=acceptance_fields.assurance_non_assurance_calculator;break;case"continuance":consolidate_all_fields=sharepoint_utilities.consolidate_fields(acceptance_fields);query_fields=sharepoint_utilities.generate_query_for_expanded_fields(consolidate_all_fields);giac_query_fields=sharepoint_utilities.generate_query_for_expanded_fields(global_giac_form_fields.giac_form);appendix_a_major_fields=continuance_fields.appendix_a_part_a_risk_considered_as_major;appendix_a_normal_fields=continuance_fields.part_b_risk_considered_normal;appendix_b_indpendence_fields=continuance_fields.continuance_independence_and_other_considerations;appendix_c_dummy_fields=continuance_fields.dummy_entities_companies_trust;appedix_c_unusual_operations=continuance_fields.unusual_operations_regarding_economic_activites;appendix_c_conclusion=continuance_fields.conclusion;appendix_c_kyc=continuance_fields.kyc_procedures_performed;appendix_d=continuance_fields.appendix_d_assessment_of_compliance;transnational_calculator=continuance_fields.transnational_calculator;s90_calculator=continuance_fields.s90_calculator;s90_considerations=continuance_fields.s90_considerations;assurance_non_assurance_calculator=acceptance_fields.assurance_non_assurance_calculator;break;case"continuance lite":consolidate_all_fields=sharepoint_utilities.consolidate_fields(continuance_lite_fields);query_fields=sharepoint_utilities.generate_query_for_expanded_fields(consolidate_all_fields);giac_query_fields=sharepoint_utilities.generate_query_for_expanded_fields(global_giac_form_fields.giac_form);appendix_a_major_fields=continuance_lite_fields.part_a_risk_considered_as_major;appendix_a_normal_fields=continuance_lite_fields.part_b_risk_considered_as_normal;appendix_b_indpendence_fields=continuance_lite_fields.independence_and_other_considerations;appendix_c_kyc=continuance_lite_fields.engagement_lite_know_your_client;transnational_calculator=continuance_lite_fields.transnational_calculator;s90_calculator=continuance_lite_fields.s90_calculator;ac_lite_main_section_fields=continuance_lite_fields.ac_lite;ac_lite_money_laundering_fields=continuance_lite_fields.a_and_c_lite_assessment_of_risk}let list_name=app_configuration.ac_submission;let list_context=app_configuration.site_context;if(data_source_type=="archives"){list_name=app_configuration.archive_list_name;list_context=app_configuration.archive_ac_submission_site_context}if(data_source_type=="archives"&&form_status=="existing"){let archive_site_url="https://mazarsglobalcloud.sharepoint.com/sites/ZAF-QRM/QCAppendices/Lists/Client%20Information/EditForm.aspx?ID="+item_id+"&Source="+"https://mazarsglobalcloud.sharepoint.com/sites/ZAF-Mazars/SitePages/Mazars.aspx";window.open(archive_site_url,"_blank")}else{var get_all_ac_data=sharepoint_utilities.get_list_items_by_title(list_context,query_fields,"Id eq "+item_id,list_name,"Id desc");var get_giac_form_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,giac_query_fields,"QRMACReference eq '"+item_id.toString()+"'","GIAC Form","Id desc");var supporting_questions_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","QRMACReference eq '"+item_id.toString()+"'","SupportingQuestions","Id desc");var eqr_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","QRMACReference eq '"+item_id.toString()+"'","EQRAppointmentForm","Id desc");var business_sustainability_data=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","QRMACReference eq '"+item_id.toString()+"'",app_configuration.business_sustainability_list_name,"Id desc");$.when(get_all_ac_data,get_giac_form_data,supporting_questions_data,eqr_data,business_sustainability_data).done(function(get_all_ac_data_results,get_giac_form_data_results,supporting_questions_data_results,eqr_data_results,get_business_sustainability_data_results){main["selected_client_risk_data"]=get_all_ac_data_results[0];if(get_all_ac_data_results.length>0){sharepoint_utilities.display_saved_list_fields(get_all_ac_data_results,consolidate_all_fields,null)}if(get_business_sustainability_data_results.length>0){client_risk_assesments.render_business_sustainability_form(get_business_sustainability_data_results,global_field_set_navigation.business_sustainability)}if(get_giac_form_data_results.length>0){giac_form.render_form_value(get_giac_form_data_results,global_giac_form_fields.giac_form)}if(supporting_questions_data_results.length>0){appendix_a_form.render_form_value(supporting_questions_data_results,appendix_a_major_fields);appendix_a_form.render_form_value(supporting_questions_data_results,appendix_a_normal_fields);supporting_questions.render_form_value(supporting_questions_data_results,appendix_b_indpendence_fields);supporting_questions.render_form_value(supporting_questions_data_results,appendix_c_dummy_fields);supporting_questions.render_form_value(supporting_questions_data_results,appedix_c_unusual_operations);supporting_questions.render_form_value(supporting_questions_data_results,appendix_c_conclusion);supporting_questions.render_form_value(supporting_questions_data_results,appendix_c_kyc);supporting_questions.render_form_value(supporting_questions_data_results,appendix_d);supporting_questions.render_form_value(supporting_questions_data_results,transnational_calculator);supporting_questions.render_form_value(supporting_questions_data_results,s90_calculator);supporting_questions.render_form_value(supporting_questions_data_results,s90_considerations);supporting_questions.render_form_value(supporting_questions_data_results,assurance_non_assurance_calculator)}if(eqr_data_results.length>0){eqr_appointment_form.render_form_value(eqr_data_results,global_field_set_navigation.eqr_appointment_form)}if(form_status=="new"){sharepoint_utilities.set_field_value("Form_x0020_Status","Not Started");$(".header-right-container-container").html("<div class='reference-id client-reference-id'>Waiting for submission</div>")}else{sharepoint_utilities.hide_fields(["client-risk-assessments-create-button"]);sharepoint_utilities.show_fields(["client-assessment-general-next"]);let client_form_description="CRA "+get_all_ac_data_results[0].Id+" - "+sharepoint_utilities.check_for_null(get_all_ac_data_results[0].ClientTaskCode,"N/A");$(".header-right-container-container").html("<div class='reference-id client-reference-id'>"+client_form_description+"</div>");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").removeClass("nav-item-disabled")}if(get_all_ac_data_results.length>0){sharepoint_utilities.hide_fields(["btn-query-approver-configuration","btn-approve-approval-task-request","btn-decline-approval-task-request","current-approval-progress-section-placeholder","btn-start-approval-process","preview-approval-section-placeholder"]);let default_disabled_fields=["ClientName","ClientTaskCode","AcceptanceOrContinuance","RequestOffice","ClientAcceptanceType"];sharepoint_utilities.disable_fields(default_disabled_fields);let field_properties=sharepoint_utilities.get_field_values(["Form_x0020_Status","ClientName"]);switch(field_properties.meta_package["Form_x0020_Status"]){case"Not Started":sharepoint_utilities.show_fields(["btn-query-approver-configuration"]);sharepoint_utilities.show_fields(["preview-approval-section-placeholder"]);sharepoint_utilities.show_fields(["btn-start-approval-process"]);sharepoint_utilities.enable_fields(default_disabled_fields);client_risk_assesments.render_task_code_component(field_properties.meta_package["ClientName"],"ClientTaskCode");break;case"In Progress":sharepoint_utilities.show_fields(["btn-query-approver-configuration"]);sharepoint_utilities.show_fields(["preview-approval-section-placeholder"]);sharepoint_utilities.show_fields(["btn-start-approval-process"]);sharepoint_utilities.enable_fields(default_disabled_fields);client_risk_assesments.render_task_code_component(field_properties.meta_package["ClientName"],"ClientTaskCode");break;case"Changes Requested":sharepoint_utilities.show_fields(["btn-query-approver-configuration"]);sharepoint_utilities.show_fields(["preview-approval-section-placeholder"]);sharepoint_utilities.show_fields(["btn-start-approval-process"]);sharepoint_utilities.enable_fields(default_disabled_fields);client_risk_assesments.render_task_code_component(field_properties.meta_package["ClientName"],"ClientTaskCode");break;case"s90 Cancelled":client_risk_assesments.lock_down_form();break;case"Cancelled":client_risk_assesments.lock_down_form();break;case"Declined":client_risk_assesments.lock_down_form();break;case"Resigned":client_risk_assesments.lock_down_form();break;case"Waiting on Approval":client_risk_assesments.lock_down_form();sharepoint_utilities.show_fields(["btn-approve-approval-task-request","btn-decline-approval-task-request","current-approval-progress-section-placeholder"]);break;case"Completed":client_risk_assesments.lock_down_form();break}}switch(action_type.toLowerCase()){case"acceptance":sharepoint_utilities.set_select_2_fields_by_value("Acceptance",$("select[data-sp-element-name='AcceptanceOrContinuance']"));$("li[data-link-id='Client Acceptance']").removeClass("nav-item-disabled");$("li[data-link-id='Client Acceptance']").click();break;case"continuance":sharepoint_utilities.set_select_2_fields_by_value("Continuance",$("select[data-sp-element-name='AcceptanceOrContinuance']"));sharepoint_utilities.disable_fields(["ClientName"]);sharepoint_utilities.set_select_2_fields_by_value("Already proposed and won",$("select[data-sp-element-name='StatusPerformed']"));sharepoint_utilities.hide_fields(["StatusPerformed"]);$("li[data-link-id='Client Continuance']").removeClass("nav-item-disabled");$("li[data-link-id='Client Continuance']").click();break;case"continuance lite":if(supporting_questions_data_results.length>0){supporting_questions.render_form_value(supporting_questions_data_results,ac_lite_main_section_fields);supporting_questions.render_form_value(supporting_questions_data_results,ac_lite_money_laundering_fields)}sharepoint_utilities.set_select_2_fields_by_value("Continuance",$("select[data-sp-element-name='AcceptanceOrContinuance']"));$("li[data-link-id='Client Continuance Lite']").removeClass("nav-item-disabled");$("li[data-link-id='Client Continuance Lite']").click();break}setTimeout(function(){canvas.removeClass("hide");$(".page-loader-header").addClass("hide");canvas.find("div[form-navigation-target]:first-child").removeClass("hide");if(get_all_ac_data_results.length>0){comments_controller.get_all_comments(get_all_ac_data_results[0].Id,app_configuration.ac_comments_list_name)}if(client_risk_assesments["new_continuance_form"]=="yes"){sharepoint_utilities.set_select_2_fields_by_value("Continuance",$("select[data-sp-element-name='AcceptanceOrContinuance']"));client_risk_assesments["new_continuance_form"]="done";$("select[data-sp-element-name='ClientName']").prop("disabled",true);client_risk_assesments.render_task_code_component(get_all_ac_data_results[0].ClientName,"ClientTaskCode")}client_risk_assesments.rule_engine()},1e3)})}};client_risk_assesments.lock_down_form=function(){sharepoint_utilities.hide_fields(["btn-approve-approval-task-request","btn-decline-approval-task-request","btn-resign-from-engagement","sp-temp-bulk-mark-risks-part-a","sp-temp-bulk-mark-risks-part-b"]);$("input[value='Next']").parent().addClass("hide");$("input[value='Back']").parent().addClass("hide");$("div[app-name='Client Acceptance and Continuance'] input").prop("disabled",true);$("div[app-name='Client Acceptance and Continuance'] select").prop("disabled",true);$("div[app-name='Client Acceptance and Continuance'] textarea").prop("disabled",true);$("div[app-name='Client Acceptance and Continuance'] .radio-button-component").prop("disabled",true);$("div[app-name='Client Acceptance and Continuance'] .radio-button-component").css("pointer-events","none");$(".add-new-repeating-table-row").addClass("hide");$("div[sp-additional-properties*='display-field-commenting']").find("div.field-commenting-container textarea").prop("disabled",false)};client_risk_assesments.mark_all_risks_in_bulk=function(section_name,selected_value){section_name.find("div.form-row[sp-additional-properties='radio-buttons-own-values']").each(function(){let sp_field_name=$(this).attr("sp-field-name");if(sp_field_name.indexOf("temp-bulk")==-1){sharepoint_utilities.set_radio_value(sp_field_name,selected_value)}});client_risk_assesments.determine_risk_status()};client_risk_assesments.determine_risk_status=function(){var TotalMediumRisks=0;var TotalHighRisks=0;var TotalMajorRisksHigh=0;var TotalMajorRisksMedium=0;var risk_outcome="Not Risky";$("div[form-navigation-target='Part A - Risk Considered as Major'] input[data-sp-element-name *='PartA']").each(function(){switch($(this).val()){case"Medium":TotalMajorRisksMedium+=1;break;case"High":TotalMajorRisksHigh+=1;break}});$("div[form-navigation-target='Part B - Risk Considered as Major'] input[data-sp-element-name *='PartB']").each(function(){switch($(this).val()){case"Medium":TotalMediumRisks+=1;break;case"High":TotalHighRisks+=1;break}});if(TotalMajorRisksHigh>=1){risk_outcome="Risky"}if(TotalMajorRisksMedium>=2){risk_outcome="Risky"}if(TotalMajorRisksMedium>=1&&TotalMediumRisks>=2){risk_outcome="Risky"}if(TotalHighRisks>=2&&TotalMediumRisks>=1){risk_outcome="Risky"}if(TotalHighRisks>=1&&TotalMediumRisks>=2){risk_outcome="Risky"}let crypro_engagement_value=$("input[data-sp-element-name='CryptoEngagment']").val();if(crypro_engagement_value=="Yes"){risk_outcome="Risky"}let field_properties=sharepoint_utilities.get_field_values(["HasRussianEntities","HasRiskAppetite","MoneyLaunderingRisk","NASRiskyServices"]).meta_package;if(field_properties.HasRussianEntities=="Yes"||field_properties.HasRiskAppetite=="Yes"||field_properties.MoneyLaunderingRisk=="High"){risk_outcome="Risky"}if(field_properties.NASRiskyServices){if(field_properties.NASRiskyServices.indexOf("None")==-1||field_properties.NASRiskyServices.indexOf("")==-1){risk_outcome="Risky"}}if(risk_outcome=="Risky"){sharepoint_utilities.set_fields_as_required(["RiskDescription"])}else{sharepoint_utilities.set_fields_as_not_required(["RiskDescription"])}sharepoint_utilities.set_field_value("RiskStatus",risk_outcome)};client_risk_assesments.download_pdf=function(submission_data){let item_id=parseInt(submission_data.attr("data-itemid"));let action_type=submission_data.attr("data-action-type");let data_source_type=submission_data.attr("data-source-type");let data_service_type=submission_data.attr("data-service-type");let library_name=app_configuration.ac_current_supporting_documents_library;let list_context=app_configuration.site_context;if(data_source_type=="archives"){library_name=app_configuration.ac_archive_supporting_documents_library;list_context=app_configuration.archive_ac_submission_site_context;data_service_type="Client Acceptance and Continuance (A to C)"}var get_form_reference=sharepoint_utilities.get_list_items_by_title(list_context,"Id,FileRef,FileLeafRef","ReferenceID eq '"+item_id+"' and DocumentType eq '"+data_service_type+"'",library_name,"Id desc&$top=1");$.when(get_form_reference).done(function(document_properties){if(document_properties.length>0){sharepoint_utilities.download_file(list_context,document_properties[0].FileRef,document_properties[0].FileLeafRef)}else{sharepoint_utilities.render_notification("Download PDF","Cannot find PDF to download in the "+data_source_type+" system","Warning");if(data_source_type=="archives"){window.open(app_configuration.archive_ac_submission_site_context+"/Lists/Client%20Information/EditForm.aspx?ID="+item_id+"&Source="+app_configuration.mazars_intranet,"blank")}}})};client_risk_assesments.prompt_new_acceptance_record=function(){let box_options={Yes:function(){client_risk_assesments.create_new_acceptance_record()},No:function(){}};sharepoint_utilities.render_confirmation_box("Creating a new client acceptance","You are about to create a new client acceptance form. Are you sure you want to do this",box_options,"95%")};client_risk_assesments.create_new_acceptance_record=function(){sharepoint_utilities.hide_fields(["client-risk-assessments-create-button"]);let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='General'] .client-acceptance-general"));if(!get_meta_package.IsValid){sharepoint_utilities.render_notification("Error",get_meta_package.validation_message,"Warning");sharepoint_utilities.show_fields(["client-risk-assessments-create-button"])}else{get_meta_package["Form_x0020_Status"]="In Progress";sharepoint_utilities.vaildate_meta_package(get_meta_package,app_configuration.site_context,app_configuration.ac_submission,function commit_success(data){sharepoint_utilities.render_notification("Creating your acceptance form","Busy creating your acceptance form","Info");main["selected_client_risk_data"]=data;main["has_source_data"]=true;$(".third-level-navigation[data-history-index='[2,0,1]']").click();giac_form.create_new_form(data.Id);eqr_appointment_form.create_new_record(data.Id);supporting_questions.create_new_record(data.Id);client_risk_assesments.create_new_business_sustainability_form(data.Id);client_risk_assesments.intiate_lockdown_form(data.Id);client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handled","New request submitted",data.Id);let client_form_description="CRA "+data.Id+" - "+sharepoint_utilities.check_for_null(data.ClientTaskCode,"N/A");$(".header-right-container-container").html("<div class='reference-id client-reference-id'>"+client_form_description+"</div>");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").removeClass("nav-item-disabled");client_risk_assesments.rule_engine()},function commit_error(){main["selected_client_risk_data"]=[];main["has_source_data"]=false;sharepoint_utilities.show_fields(["client-risk-assessments-create-button"])})}};client_risk_assesments.prompt_new_continuance_record=function(){let box_options={Yes:function(){client_risk_assesments.create_new_continuance_record()},No:function(){}};sharepoint_utilities.render_confirmation_box("Creating a new client continuance","You are about to start a continuance using the most recent record in the table below. Are you sure you want to do this",box_options,"70%")};client_risk_assesments.create_new_continuance_record=function(){$("input[data-sp-element-name='client-risk-assessments-create-button']").addClass("hide");let general_meta=sharepoint_utilities.create_meta_package($("div[form-navigation-target='General'] > div"));let general_information_meta=sharepoint_utilities.create_meta_package($("div[form-navigation-target='General Information About the Engagement'] > div"));let team_meta=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Team Information'] > div"));let pie_meta=sharepoint_utilities.create_meta_package($("div[form-navigation-target='PIE'] > div"));let key_figure_meta=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Key Figures - recent financial year'] > div"));let new_continuance_record_meta={};let general_meta_properties=general_meta.meta_package;general_meta.meta_package["Form_x0020_Status"]="In Progress";if(general_meta_properties.ClientAcceptanceType=="Non-Assurance"){new_continuance_record_meta["ACLiteVersion"]="yes"}if(general_meta.IsValid){new_continuance_record_meta={...general_meta.meta_package,...general_information_meta.meta_package,...team_meta.meta_package,...pie_meta.meta_package,...key_figure_meta.meta_package};$.when(sharepoint_utilities.save_item(app_configuration.ac_submission,app_configuration.site_context,new_continuance_record_meta)).done(function(data){sharepoint_utilities.render_notification("Saving your continuance form","Busy saving your continuance form","Info");main["selected_client_risk_data"]=data;main["has_source_data"]=true;$(".third-level-navigation[data-history-index='[2,0,1]']").click();giac_form.create_new_form(data.Id);eqr_appointment_form.create_new_record(data.Id);supporting_questions.create_new_record(data.Id);client_risk_assesments.create_new_business_sustainability_form(data.Id);client_risk_assesments.intiate_lockdown_form(data.Id);client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handled","New request submitted",data.Id);$("ul[data-app-name='Client Acceptance and Continuance'] > ul li").removeClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='GIAC Form']").addClass("nav-item-disabled");$("ul[data-app-name='Client Acceptance and Continuance'] > ul li[data-link-id='EQR Calculator']").addClass("nav-item-disabled")}).fail(function(){main["selected_client_risk_data"]=[];main["has_source_data"]=false})}else{sharepoint_utilities.render_notification("Cannot continue",general_meta.validation_message,"Warning");$("input[data-sp-element-name='client-risk-assessments-create-button']").removeClass("hide")}};client_risk_assesments.go_to_next_section=function(){let get_current_selected_item=app_configuration["currently-selected-section"];if(get_current_selected_item.length!=0){client_risk_assesments.identify_sections_to_update(get_current_selected_item,true);let check_for_sub_link_navigation=get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().find("ul");if(check_for_sub_link_navigation.length>0){get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().click();get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().next().children("li:first-child").click()}else{get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().click()}if(get_current_selected_item.is(":last-child")){parent_level=get_current_selected_item.parent();parent_level.nextAll("li").not(".nav-item-disabled").first().click()}}else{warning_controller.add_new_warning("Error","Section "+get_current_selected_item.attr("data-link-id")+" not saved, Please ensure you have selected a section","Warning");sharepoint_utilities.render_notification("Error","Section not saved, Please ensure you have selected a section","Warning")}client_risk_approvals.validation_on_all_fields()};client_risk_assesments.go_back_to_section=function(){let get_current_selected_item=app_configuration["currently-selected-section"];if(get_current_selected_item.length!=0){client_risk_assesments.identify_sections_to_update(get_current_selected_item,true);let check_for_sub_link_navigation=get_current_selected_item.prevAll("li").not(".nav-item-disabled").last().find("ul");if(check_for_sub_link_navigation.length>0){get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().click();get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().next().children("li:first-child").click()}else{get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().click()}if(get_current_selected_item.is(":first-child")){parent_level=get_current_selected_item.parent();parent_level.prevAll("li").not(".nav-item-disabled").first().prev().click()}}else{warning_controller.add_new_warning("Error","Section "+get_current_selected_item.attr("data-link-id")+" not saved, Please ensure you have selected a section","Warning");sharepoint_utilities.render_notification("Error","Section not saved, Please ensure you have selected a section","Warning")}client_risk_approvals.validation_on_all_fields()};client_risk_assesments.identify_sections_to_update=function(current_section_name,include_notifications){let data_link_id=current_section_name.attr("data-link-id");let field_properties=sharepoint_utilities.get_field_values(["Form_x0020_Status"]);let form_status=field_properties.meta_package.Form_x0020_Status;if(form_status=="Not Started"||form_status=="In Progress"||form_status=="Changes Requested"||form_status=="Resigned"){if(include_notifications){sharepoint_utilities.render_notification("Saving your form","Please wait while we save your selected section","Info")}let associated_source_id=null;let source_list_name="";switch(data_link_id){case"GIAC Form":associated_source_id=main["giac_form_id"];source_list_name=app_configuration.giac_list_name;break;case"Business Sustainability":associated_source_id=main["business_sustainability_form_id"];source_list_name=app_configuration.business_sustainability_list_name;break;case"EQR Calculator":associated_source_id=main["eqr_form_id"];source_list_name="EQRAppointmentForm";break;case"Part B - Risk Considered as Normal":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Part A - Risk Considered as Major":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"LITE":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Acceptance - Independence and other Considerations":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Continuance - Independence and other Considerations":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Indpendence and other considerations":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"PIE":associated_source_id=main["selected_client_risk_data"].Id;source_list_name=app_configuration.ac_submission;break;case"S90 Calculator":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";if(include_notifications){save_sections.update_data_source(main["selected_client_risk_data"].Id,"PIE",app_configuration.ac_submission,include_notifications)}break;case"S90 Considerations":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";if(include_notifications){save_sections.update_data_source(main["selected_client_risk_data"].Id,"PIE",app_configuration.ac_submission,include_notifications)}break;case"Transnational Calculator":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";if(include_notifications){save_sections.update_data_source(main["selected_client_risk_data"].Id,"PIE",app_configuration.ac_submission,include_notifications)}break;case"Fee Considerations":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Know your client (KYC) procedures performed":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Risk Status":associated_source_id=main["selected_client_risk_data"].Id;source_list_name=app_configuration.ac_submission;break;case"Dummy Entities, Companies or Trusts Other Purpose":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Unusual Operations Regarding the Economic Activities of the Client":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Conclusion":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"1. Assessment of compliance with Independence rules":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Assessment of the risk of money laundering and terrorist financing acts":associated_source_id=main["supporting_questions_id"];source_list_name="SupportingQuestions";break;case"Approvals":associated_source_id=main["selected_client_risk_data"].Id;source_list_name=app_configuration.ac_submission;break;case"Supporting Documents":associated_source_id=main["selected_client_risk_data"].Id;source_list_name=app_configuration.ac_submission;if(include_notifications){save_sections.update_data_source(associated_source_id,"General",source_list_name,include_notifications)}break;default:associated_source_id=main["selected_client_risk_data"].Id;source_list_name=app_configuration.ac_submission;if(data_link_id=="General"||data_link_id=="Team Information"){client_risk_assesments.lockdown_sync_client_details()}break}save_sections.update_data_source(associated_source_id,data_link_id,source_list_name,include_notifications)}else{sharepoint_utilities.render_notification("Saving Prohibited","You can only save values when the form is Not Started | In Progress | Changes Requested | Resigned Status","Info|Warning")}};client_risk_assesments.update_form_values=function(section_name,include_notifications){let item_id=main["selected_client_risk_data"].Id;if(item_id){let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='"+section_name+"'] > div"));if(save_sections.has_data(get_meta_package.meta_package)){let field_properties=sharepoint_utilities.get_field_values(["Form_x0020_Status"]);if(field_properties.meta_package["Form_x0020_Status"]=="Not Started"){get_meta_package.meta_package["Form_x0020_Status"]="In Progress"}if(field_properties.meta_package["AppendixDEngagagementPartnersId"]=="#;"){delete field_properties.meta_package["AppendixDEngagagementPartnersId"]}$.when(sharepoint_utilities.update_item(app_configuration.ac_submission,app_configuration.site_context,get_meta_package.meta_package,item_id)).done(function(response){if(response=="success"){if(include_notifications){warning_controller.add_new_warning(section_name+"form Updated","Your current working form was updated","Info")}}else{if(include_notifications){warning_controller.add_new_warning("Error","Something went wrong while updating your form","Warning")}}})}else{console.log("Nothing to save in "+section_name+". Nothing has been selected yet")}}else{sharepoint_utilities.render_notification("Cannot update form","Cannot find the unique form reference for the current submission to update","Warning")}};client_risk_assesments.intiate_lockdown_form=function(qrm_ac_id){let field_properties=sharepoint_utilities.get_field_values(["ExpectedSigningDate","ClientName","RequestOffice","EngagementPartnerId","EngagementManagerId","FinancialYearEnd","ClientRegOrTaxNumber","ClientTaskCode","ClientAcceptanceType","AuditSoftwarePackageUsed"]);if(field_properties.meta_package["ClientAcceptanceType"]=="Assurance"){var AssemblyDate=moment(field_properties.meta_package["ExpectedSigningDate"]).add(60,"days").format(app_configuration.date_format);var kpi_deadline_date=moment(field_properties.meta_package["ExpectedSigningDate"]).add(45,"days").format(app_configuration.date_format);let record_meta={QRMACReference:qrm_ac_id.toString(),ExpectedSigningDate:field_properties.meta_package["ExpectedSigningDate"],ClientName:field_properties.meta_package["ClientName"],RegistrationNumber:field_properties.meta_package["ClientRegOrTaxNumber"],Region:field_properties.meta_package["RequestOffice"],TaskCode:field_properties.meta_package["ClientTaskCode"],AssemblyDeadline:AssemblyDate,MazarsKPIDeadline:kpi_deadline_date,YearEndEngagement:moment(field_properties.meta_package["FinancialYearEnd"]).format(app_configuration.date_format),EngagementPartnerId:parseInt(field_properties.meta_package["EngagementPartnerId"]),EngagementManagerId:parseInt(field_properties.meta_package["EngagementManagerId"]),AuditSoftwarePackageUsed:field_properties.meta_package["AuditSoftwarePackageUsed"]};$.when(sharepoint_utilities.save_item("Lockdown List",app_configuration.site_context,record_meta)).done(function(response){})}};$(document).on("change","input[data-sp-element-name='IsGroupEngagement']",function(){client_risk_assesments.display_conditional_appendix_q11()});client_risk_assesments.display_conditional_appendix_q11=function(){let value=$("input[data-sp-element-name='IsGroupEngagement']").val();if(value=="Yes"){sharepoint_utilities.show_fields(["Q11PartA","C11PartA"]);sharepoint_utilities.set_fields_as_required(["Q11PartA","C11PartA"])}else{sharepoint_utilities.hide_fields(["C11PartA","Q11PartA"]);sharepoint_utilities.set_fields_as_not_required(["Q11PartA","C11PartA"])}};$(document).on("change","input[data-sp-element-name='IsBlackListed']",function(){client_risk_assesments.validate_blacklisted()});client_risk_assesments.validate_blacklisted=function(){let value=$("input[data-sp-element-name='IsBlackListed']").val();if(value=="Yes"){sharepoint_utilities.show_fields(["onlineBlacklisted","onlineBlacklisted"]);sharepoint_utilities.set_fields_as_required(["onlineBlacklisted","onlineBlacklisted"])}else{sharepoint_utilities.hide_fields(["onlineBlacklisted","onlineBlacklisted"]);sharepoint_utilities.set_fields_as_not_required(["onlineBlacklisted","onlineBlacklisted"])}};$(document).on("change","select[data-sp-element-name='SpecialistsRequired']",function(){client_risk_assesments.check_specialist_other()});client_risk_assesments.check_specialist_other=function(){var selectedValues=[];$(".select2-selection__choice").each(function(){var value=$(this).text().substring(1).trim();selectedValues.push(value);if(selectedValues.includes("Other")==true){sharepoint_utilities.show_fields(["SpecialistComments"]);sharepoint_utilities.set_fields_as_required(["SpecialistComments"])}else{sharepoint_utilities.hide_fields(["SpecialistComments"]);sharepoint_utilities.set_fields_as_not_required(["SpecialistComments"])}if(selectedValues.includes("None")){selectedValues=["None"]}})};client_risk_assesments.carl_partner_validation=function(){let get_field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType","IsTransnational","OtherPieEntities","IsListedClient","IsCarlPartner"]);let field_values=get_field_properties.meta_package;let ServiceType=field_values["ClientAcceptanceType"];let TransnationalStatus=field_values["IsTransnational"];let IsOtherPie=field_values["OtherPieEntities"];let IsListed=field_values["IsListedClient"];let carl_status=field_values["IsCarlPartner"];let check_if_PIE_client=client_risk_approvals.check_for_pie_client(IsOtherPie,IsListed);if(check_if_PIE_client){sharepoint_utilities.set_fields_as_required(["IsCarlPartner"]);sharepoint_utilities.show_fields(["IsCarlPartner"]);sharepoint_utilities.set_field_value("Q1ClientCalc","Yes");if(ServiceType=="Assurance"){if(carl_status=="No"){warning_controller.add_new_warning("CEO Approval for non-CARL partner required","Please upload your CEO and Country Risk Manager Approval for this client under supporting documents","Info");supporting_documents.append_to_current_document_required("CEO/CRM Approval of a non-CARL Partner")}else{supporting_documents.append_to_current_document_required("CEO/CRM Approval of a non-CARL Partner","remove")}}}else{sharepoint_utilities.set_radio_value("IsCarlPartner","");sharepoint_utilities.hide_fields(["IsCarlPartner"]);sharepoint_utilities.set_fields_as_not_required(["IsCarlPartner"]);sharepoint_utilities.set_field_value("Q1ClientCalc","No")}};client_risk_assesments.general_acceptance_continuance_rules=function(){let field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType","AcceptanceOrContinuance"]).meta_package;let acceptance_or_continuance=field_properties["AcceptanceOrContinuance"];let assurance_or_non_assurance=field_properties["ClientAcceptanceType"];let assurance_specific_fields=["IsNewClient"];sharepoint_utilities.hide_fields(assurance_specific_fields);sharepoint_utilities.set_fields_as_not_required(assurance_specific_fields);let continuance_specific_fields=["NewEngagementUtilized"];switch(acceptance_or_continuance){case"Acceptance":if(assurance_or_non_assurance=="Acceptance"){sharepoint_utilities.show_fields(assurance_specific_fields);sharepoint_utilities.set_fields_as_required(assurance_specific_fields)}break;case"Continuance":sharepoint_utilities.show_fields(continuance_specific_fields);sharepoint_utilities.set_fields_as_required(continuance_specific_fields);break}};client_risk_assesments.business_sustainablity_form_rules=function(){let required_fields=["BSPAQ1","BSPAQ2","BSPBQ1","BSPBQ2","BSPBQ3","BSPBQ4","BSPBQ5","BSPBQ6","IsIndependant","BSPAQ1Comments","BSPAQ2Comments","BSPBQ1Comments","BSPBQ2Comments","BSPBQ3Comments","BSPBQ4Comments","BSPBQ5Comments","BSPBQ6Comments"];let additional_questions=["IsGroupEngagementPartner","PreviousAuditorOrIASP"];let get_field_properties=sharepoint_utilities.get_field_values(["MazarsServiceLine","IsIndependant"]).meta_package;sharepoint_utilities.set_fields_as_not_required(required_fields);sharepoint_utilities.set_fields_as_not_required(additional_questions);sharepoint_utilities.hide_fields(additional_questions);if(get_field_properties["MazarsServiceLine"]=="Advisory - Business Sustainability"){$("li[data-link-id='Business Sustainability']").removeClass("nav-item-disabled");sharepoint_utilities.set_fields_as_required(required_fields)}else{$("li[data-link-id='Business Sustainability']").addClass("nav-item-disabled")}if(get_field_properties["IsIndependant"]=="Yes"){sharepoint_utilities.show_fields(additional_questions);sharepoint_utilities.set_fields_as_required(additional_questions)}};client_risk_assesments.create_new_business_sustainability_form=function(qrm_ac_id){let record_meta={QRMACReference:qrm_ac_id.toString()};$.when(sharepoint_utilities.save_item(app_configuration.business_sustainability_list_name,app_configuration.site_context,record_meta)).done(function(response){main["business_sustainability_form_id"]=response.Id})};client_risk_assesments.render_business_sustainability_form=function(field_results,field_set){main["business_sustainability_form_id"]=field_results[0].Id;sharepoint_utilities.display_saved_list_fields(field_results,field_set,null)};var assurance_functions={};$(document).on("change","input[data-sp-element-name='PreviousFirmAppointed']",function(){assurance_functions.determine_previous_auditor_questions()});$(document).on("change","input[data-sp-element-name *='IsTransnational']",function(){assurance_functions.determine_is_transnational()});$(document).on("change","input[data-sp-element-name *='IsS90Calculator']",function(){assurance_functions.general_rules()});$(document).on("change","div[form-navigation-target='Part A - Risk Considered as Major'] input[data-sp-element-name *='PartA'], div[form-navigation-target='Part B - Risk Considered as Major'] input[data-sp-element-name *='PartB']",function(){client_risk_assesments.determine_risk_status()});$(document).on("change","input[data-sp-element-name *='s90Consideration']",function(){assurance_functions.determine_s90_considerations();client_risk_assesments.identify_sections_to_update($("li[data-link-id='General']"),true);client_risk_assesments.identify_sections_to_update($("li[data-link-id='S90 Considerations']"),true)});$(document).on("change","input[data-sp-element-name='IsConcurringReviewPartner']",function(){assurance_functions.concurring_review_partner_document()});$(document).on("change","input[data-sp-element-name='Q1ClientCalc']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='Q2ClientCalc']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='Q3ClientCalc']",function(){assurance_functions.general_rules()});$(document).on("change","select[data-sp-element-name='FinancialReportingFramework']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='ApplicableStdModified']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='IsListedClient']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='IsSECRegistrant']",function(){assurance_functions.general_rules()});$(document).on("change","input[data-sp-element-name='eqrCalculatorType']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name='isEqrOverride']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name *='EQRAppointment']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name='EQRAppointment8']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name='EQRNotStated']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name *='internalEqrPartner']",function(){assurance_functions.determine_eqr_type_required()});$(document).on("change","input[data-sp-element-name='Q17Independence']",function(){var q17_independence=$("input[data-sp-element-name='Q17Independence']").val();if(q17_independence=="Yes"){sharepoint_utilities.show_fields(["C18Independence"]);sharepoint_utilities.set_fields_as_required(["C18Independence"])}else{sharepoint_utilities.hide_fields(["C18Independence"]);sharepoint_utilities.set_fields_as_not_required(["C18Independence"])}});$(document).on("change","div[form-navigation-target='Team Information'] select[data-sp-element-name='ClientIndustry']",function(){assurance_functions.run_client_industry_rule()});$(document).on("change","div[form-navigation-target='General Information About the Engagement'] input[data-sp-element-name='nonAssuranceServicePerformed']",function(){assurance_functions.risk_outcome_calculator()});assurance_functions.general_rules=function(){assurance_functions.determine_significant_variation();assurance_functions.assurance_vs_non_assurance_calculator();assurance_functions.risk_outcome_calculator();assurance_functions.financial_reporting();assurance_functions.validate_disclaimer_of_opinion();assurance_functions.display_s90_considerations();assurance_functions.determine_eqr_type_required();assurance_functions.determine_is_transnational();assurance_functions.determine_s90_considerations();assurance_functions.determine_previous_auditor_questions();assurance_functions.run_client_industry_rule()};assurance_functions.run_client_industry_rule=function(){let field_properties=sharepoint_utilities.get_field_values(["ClientIndustry","ClientAcceptanceType","IsListedClient","IsSECRegistrant","OtherPieEntities"]);let client_industry_value=field_properties.meta_package["ClientIndustry"];let client_acceptance_type=field_properties.meta_package["ClientAcceptanceType"];if(client_industry_value=="Crypto"){sharepoint_utilities.set_field_value("CryptoEngagment","Yes")}else{sharepoint_utilities.set_field_value("CryptoEngagment","No")}if(client_acceptance_type=="Assurance"){$("li[data-link-id='EQR Calculator']").addClass("nav-item-disabled");if(client_industry_value){let eqr_required=false;let list_of_industries_to_validate=["Financial and insurance activities","Medical schemes","Retirement pension & provident funds"];for(let index=0;index<list_of_industries_to_validate.length;index++){const validation_fields=list_of_industries_to_validate[index];if(client_industry_value==validation_fields){eqr_required=true}}if(field_properties.meta_package["IsListedClient"]=="Yes"||field_properties.meta_package["IsSECRegistrant"]=="Yes"||field_properties.meta_package["OtherPieEntities"]=="Yes"){eqr_required=true}if(eqr_required){$("li[data-link-id='EQR Calculator']").removeClass("nav-item-disabled")}}assurance_functions.eqr_partner_rules()}client_risk_assesments.giac_form_validation()};assurance_functions.determine_previous_auditor_questions=function(){let field_properties=sharepoint_utilities.get_field_values(["PreviousFirmAppointed","ClientAcceptanceType","AcceptanceOrContinuance"]).meta_package;let field_set=["PreviousAuditSignOff","AuditTakeover"];sharepoint_utilities.hide_fields(field_set);sharepoint_utilities.set_fields_as_not_required(field_set);if(field_properties.ClientAcceptanceType=="Assurance"&&field_properties.AcceptanceOrContinuance=="Acceptance"){if(field_properties.PreviousFirmAppointed=="Yes"){sharepoint_utilities.show_fields(field_set);sharepoint_utilities.set_fields_as_required(field_set)}}};assurance_functions.assurance_vs_non_assurance_calculator=function(){let field_properties=sharepoint_utilities.get_field_values(["Q1ClientCalc","Q2ClientCalc","Q3ClientCalc"]);if(field_properties.IsValid){let result=parseInt(field_properties.meta_package["Q2ClientCalc"])/parseInt(field_properties.meta_package["Q3ClientCalc"]);if(parseInt(field_properties.meta_package["Q3ClientCalc"])<=0){result=0}let percentage=result*100;sharepoint_utilities.set_field_value("Q4ClientCalc",parseInt(percentage));assurance_functions.risk_outcome_calculator();client_risk_assesments.update_form_values("PIE")}};assurance_functions.risk_outcome_calculator=function(){let field_properties=sharepoint_utilities.get_field_values(["Q1ClientCalc","Q4ClientCalc","feeConsiderations","nonAssuranceServicePerformed"]);let pie_entity_value=field_properties.meta_package["Q1ClientCalc"];let risk_outcome_value=field_properties.meta_package["Q4ClientCalc"];let risk_outcome="Not Applicable";if(risk_outcome_value!=0){switch(pie_entity_value){case"Yes":switch(true){case risk_outcome_value<20:risk_outcome="Generally considered low risk";break;case risk_outcome_value>20&&risk_outcome_value<40:risk_outcome="Generally considered increased risk";break;case risk_outcome_value>40:risk_outcome="Generally considered high risk";break;default:break}break;case"No":switch(true){case risk_outcome_value<30:risk_outcome="Generally considered low risk";break;case risk_outcome_value>30&&risk_outcome_value<60:risk_outcome="Generally considered increased risk";break;case risk_outcome_value>60:risk_outcome="Generally considered high risk";break;default:break}break;default:break}}if(field_properties.meta_package["nonAssuranceServicePerformed"]=="No"){risk_outcome="Not Applicable"}sharepoint_utilities.set_field_value("feeConsiderations",risk_outcome)};assurance_functions.eqr_partner_rules=function(){let field_properties=sharepoint_utilities.get_field_values(["eqrCalculatorType","internalEqrPartner"]);let field_values=field_properties.meta_package;let eqr_calculator_type=field_values["eqrCalculatorType"];let eqr_partner_value=field_values["internalEqrPartner"];if(eqr_calculator_type=="Internal"){sharepoint_utilities.show_fields(["internalEqrPartner"]);sharepoint_utilities.set_fields_as_required(["internalEqrPartner"]);if(eqr_partner_value=="TBC by CRM Allocation"){supporting_documents.append_to_current_document_required("CRM approval of EQR")}else{supporting_documents.append_to_current_document_required("CRM approval of EQR","remove")}}else{sharepoint_utilities.hide_fields(["internalEqrPartner"]);sharepoint_utilities.set_fields_as_not_required(["internalEqrPartner"])}};assurance_functions.determine_s90_considerations=function(){let list_of_fields=["Q1s90Consideration","Q2s90Consideration","Q3s90Consideration","Q4s90Consideration","Q5s90Consideration"];let get_field_properties=sharepoint_utilities.get_field_values(list_of_fields);let field_values=get_field_properties.meta_package;let must_cancel=false;for(let index=0;index<list_of_fields.length;index++){const field_name=list_of_fields[index];if(field_values[field_name]=="Yes"){must_cancel=true}}let get_field_status=sharepoint_utilities.get_field_values(["Form_x0020_Status"]).meta_package;let allowed_form_status=["Changes Requested","Not Started","In Progress","s90 Cancelled"];if(allowed_form_status.indexOf(get_field_status)>=0){if(must_cancel){sharepoint_utilities.set_field_value("Form_x0020_Status","s90 Cancelled");sharepoint_utilities.render_notification("Assurance services may NOT be provided to the client.","A cooling off period of "+"5 years from such prohibited services is required before assurance services can be provided. "+"You cannot continue with this Acceptance or continuance","Warning")}else{if(get_field_status!="Changes Requested"){sharepoint_utilities.set_field_value("Form_x0020_Status","In Progress")}}}};assurance_functions.concurring_review_partner_document=function(){let concurringReviewPartnerYes=$("input[data-sp-element-name='IsConcurringReviewPartner']").val();if(concurringReviewPartnerYes=="Yes"){sharepoint_utilities.render_notification("Document Download Required","Please complete the downloaded document and upload it once completed","Warning");supporting_documents.append_to_current_document_required("CRM Approval of CRP")}else{supporting_documents.append_to_current_document_required("CRM Approval of CRP","remove")}};assurance_functions.display_s90_considerations=function(){let field_properties=sharepoint_utilities.get_field_values(["Q1IsS90Calculator","Q2IsS90Calculator","Q3IsS90Calculator","Q4IsS90Calculator","Q5IsS90Calculator","Q6IsS90Calculator"]);let calculator_outcome="No";if(field_properties.IsValid){for(let index=0;index<field_properties.array_of_values.length;index++){const current_value=field_properties.array_of_values[index];if(current_value=="Yes"){calculator_outcome="Yes"}}if(calculator_outcome=="Yes"){$("li[data-link-id='S90 Considerations']").removeClass("nav-item-disabled")}else{$("li[data-link-id='S90 Considerations']").addClass("nav-item-disabled")}sharepoint_utilities.set_field_value("s90Calculator",calculator_outcome)}};assurance_functions.financial_reporting=function(){var FinancialReportingFramework=$("select[data-sp-element-name='FinancialReportingFramework']").val();if(FinancialReportingFramework=="Other"){sharepoint_utilities.show_fields(["FinancialReportingFrameworkOther"]);sharepoint_utilities.set_fields_as_required(["FinancialReportingFrameworkOther"])}else{sharepoint_utilities.hide_fields(["FinancialReportingFrameworkOther"]);sharepoint_utilities.set_fields_as_not_required(["FinancialReportingFrameworkOther"])}};assurance_functions.validate_other_selected=function(){var ApplicableStandard=$("select[data-sp-element-name='ApplicableStandard']").val();if(ApplicableStandard){if(ApplicableStandard.indexOf("Other")>=0){sharepoint_utilities.show_fields(["ApplicableStandardOther"]);sharepoint_utilities.set_fields_as_required(["ApplicableStandardOther"])}}};assurance_functions.validate_isa_705_rule=function(){var validate_isa_705=$("select[data-sp-element-name='ApplicableStandard']").val();if(validate_isa_705){if(validate_isa_705.indexOf("ISA 705")>=0){sharepoint_utilities.show_fields(["ApplicableStdModified"]);sharepoint_utilities.set_fields_as_required(["ApplicableStdModified"])}}};assurance_functions.validate_disclaimer_of_opinion=function(){var disclaimer_of_opinion=$("input[data-sp-element-name='ApplicableStdModified']").val();if(disclaimer_of_opinion=="Disclaimer of Opinion"){sharepoint_utilities.render_notification("ISA 705","Your engagement cannot be accepted","Warning")}};assurance_functions.determine_is_transnational=function(){sharepoint_utilities.set_field_value("IsTransnational","No");$("div[form-navigation-target='Transnational Calculator'] input[data-sp-element-name *='IsTransnational']").each(function(){let current_value=$(this).val();if($(this).attr("data-sp-element-name").indexOf("Q")>=0){if(current_value=="Yes"){sharepoint_utilities.set_field_value("IsTransnational","Yes")}}})};assurance_functions.determine_eqr_type_required=function(){let field_properties=sharepoint_utilities.get_field_values(["EQRAppointment1","EQRAppointment2","EQRAppointment3","EQRAppointment4","EQRAppointment5","EQRAppointment6","EQRAppointment7","EQRAppointment8","EQRNotStated"]);let field_values=field_properties.meta_package;sharepoint_utilities.hide_fields(["isEqrOverride","eqrCalculatorType","internalEqrPartner"]);sharepoint_utilities.set_fields_as_not_required(["isEqrOverride","eqrCalculatorType","internalEqrPartner"]);let eqr_approval_required=false;let voluntary_eqr_check=false;for(let index=0;index<field_properties.array_of_values.length;index++){const selected_value=field_properties.array_of_values[index];if(selected_value=="Yes"){eqr_approval_required=true}if(selected_value=="Yes"&&index!=7){voluntary_eqr_check=true}}if(eqr_approval_required){sharepoint_utilities.show_fields(["isEqrOverride","eqrCalculatorType"]);sharepoint_utilities.set_fields_as_required(["isEqrOverride","eqrCalculatorType"]);sharepoint_utilities.set_field_value("eqrIsRequiredStatus","EQR Approver is required");assurance_functions.reason_for_eqr_override();assurance_functions.eqr_partner_rules()}else{sharepoint_utilities.set_field_value("eqrIsRequiredStatus","EQR Approval is not required");sharepoint_utilities.hide_fields(["reasonForEQROverride"]);sharepoint_utilities.set_fields_as_not_required(["reasonForEQROverride"])}if(voluntary_eqr_check){sharepoint_utilities.hide_fields(["EQRAppointment8"]);sharepoint_utilities.set_fields_as_not_required(["EQRAppointment8"])}else{sharepoint_utilities.show_fields(["EQRAppointment8"]);sharepoint_utilities.set_fields_as_required(["EQRAppointment8"])}};assurance_functions.reason_for_eqr_override=function(){let field_properties=sharepoint_utilities.get_field_values(["isEqrOverride"]);let field_values=field_properties.meta_package;let eqr_override=field_values["isEqrOverride"];if(eqr_override=="Yes"){sharepoint_utilities.show_fields(["reasonForEQROverride"]);sharepoint_utilities.set_fields_as_required(["reasonForEQROverride"])}else{sharepoint_utilities.hide_fields(["reasonForEQROverride"]);sharepoint_utilities.set_fields_as_not_required(["reasonForEQROverride"])}};assurance_functions.determine_spac_agreement=function(){var spac_agreement=$("select[data-sp-element-name='SPACEngagment']").val()};$(document).on("change","input[data-sp-element-name='significantVariation']",function(){assurance_functions.determine_significant_variation()});$(document).on("change","div[form-navigation-target='Key Figures - recent financial year'] input[data-sp-element-name='significantVariation']",function(){assurance_functions.determine_significant_variation()});assurance_functions.determine_significant_variation=function(){var significant_variation_question=$("input[data-sp-element-name='significantVariation']").val();if(significant_variation_question=="Yes"){sharepoint_utilities.show_fields(["SignificantVariationComments"]);sharepoint_utilities.set_fields_as_required(["SignificantVariationComments"])}else{sharepoint_utilities.hide_fields(["SignificantVariationComments"]);sharepoint_utilities.set_fields_as_not_required(["SignificantVariationComments"])}};var non_assurance_on_existing_assurance_client_functions={};non_assurance_on_existing_assurance_client_functions.general_rules=function(){non_assurance_functions.show_applicable_nas_standards()};var non_assurance_functions={};$(document).on("change","input[data-sp-element-name='AUPClient']",function(){non_assurance_functions.aup_report()});$(document).on("change","input[data-sp-element-name='NASReport']",function(){non_assurance_functions.show_applicable_nas_standards()});non_assurance_functions.general_rules=function(){non_assurance_functions.determine_fee_considerations_display();non_assurance_functions.independance_and_other_considerations_rules();non_assurance_functions.show_applicable_nas_standards()};non_assurance_functions.show_applicable_nas_standards=function(){let field_properties=sharepoint_utilities.get_field_values(["NASReport"]);sharepoint_utilities.hide_fields(["ApplicableStandard"]);if(field_properties.meta_package["NASReport"]=="Yes"){sharepoint_utilities.show_fields(["ApplicableStandard"])}};non_assurance_functions.aup_report=function(){var AUPReportPublic=$("input[data-sp-element-name='AUPClient']").val();if(AUPReportPublic=="Yes"){sharepoint_utilities.show_fields(["engagementIsRisky"]);sharepoint_utilities.render_notification("Engagement Status","Your engagement has been flagged as risky","Warning")}else{sharepoint_utilities.hide_fields(["engagementIsRisky"])}};non_assurance_functions.validate_isrs4400_rule=function(){var validate_isrs4400=$("select[data-sp-element-name='ApplicableStandard']").val();let isrs_fields=["AUPPolicy","AUPClient"];if(validate_isrs4400){if(validate_isrs4400.indexOf("ISRS 4400")>=0){sharepoint_utilities.show_fields(isrs_fields);sharepoint_utilities.set_fields_as_required(isrs_fields)}}};non_assurance_functions.aup_policy=function(){var AUPPolicy=$("input[data-sp-element-name='AUPPolicy']").val();if(AUPPolicy=="Yes"){sharepoint_utilities.show_fields(["engagementIsRisky"]);sharepoint_utilities.render_notification("Engagement Status","Your engagement has been flagged as risky","Warning")}else{sharepoint_utilities.hide_fields(["engagementIsRisky"])}};$(document).on("change","select[data-sp-element-name='ClientAcceptanceType']",function(){non_assurance_functions.determine_fee_considerations_display()});$(document).on("change","input[data-sp-element-name='nonAssuranceServicePerformed']",function(){non_assurance_functions.determine_fee_considerations_display()});$(document).on("click","input[data-sp-element-name='sp-button-nas-rely-comply-assesment-creation']",function(){non_assurance_functions.create_rely_comply_assesment()});non_assurance_functions.create_rely_comply_assesment=function(){let list_of_fields=["M_ClientName","ClientRegOrTaxNumber","ClientAddress","NatureOfServicesDescription","ClientCountry","ClientIndustry","ClientServiceLine","NatureOfClient","ClientServiceType"];let get_field_properties=sharepoint_utilities.get_field_values(list_of_fields);if(get_field_properties.IsValid){sharepoint_utilities.render_notification("Creating Rely Comply Assesment","You will recieve a confirmation email once completed","Info");client_risk_approvals.create_notification(_spPageContextInfo.userId,"Workflow handled","RelyComplyAssesment",main["selected_client_risk_data"].Id)}else{sharepoint_utilities.render_notification("Rely Comply Assesment",get_field_properties.validation_message,"Warning")}};non_assurance_functions.determine_fee_considerations_display=function(){let get_field_properties=sharepoint_utilities.get_field_values(["nonAssuranceServicePerformed","ClientAcceptanceType","ListOfRequiredDocumentsJSON"]);let field_values=get_field_properties.meta_package;let nas_performed=field_values["nonAssuranceServicePerformed"];let acceptance_type=field_values["ClientAcceptanceType"];if(acceptance_type=="Assurance"&&nas_performed=="Yes"){$("li[data-link-id='Fee Considerations']").removeClass("nav-item-disabled");supporting_documents.append_to_current_document_required("Greatsoft Report");sharepoint_utilities.render_notification("Please upload Greatsoft Report","Please pull a report from GS and upload it as a supporting document","Warning");sharepoint_utilities.set_fields_as_required(["feeConsiderations"])}else{$("li[data-link-id='Fee Considerations']").addClass("nav-item-disabled");supporting_documents.append_to_current_document_required("Greatsoft Report","remove");sharepoint_utilities.set_fields_as_not_required(["feeConsiderations"])}};non_assurance_functions.independance_and_other_considerations_rules=function(){let get_field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType"]);let field_values=get_field_properties.meta_package;let acceptance_type=field_values["ClientAcceptanceType"];let question_set_to_toggle=["Q8Independence","C8Independence","Q9Independence","C9Independence","Q12Independence","C12Independence","Q13Independence","C13Independence","Q14Independence","C14Independence"];if(acceptance_type=="Non-Assurance"){sharepoint_utilities.set_fields_as_not_required(question_set_to_toggle);sharepoint_utilities.hide_fields(question_set_to_toggle)}else{sharepoint_utilities.set_fields_as_required(question_set_to_toggle);sharepoint_utilities.show_fields(question_set_to_toggle)}};non_assurance_functions.independance_and_other_considerations_rules=function(){let get_field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType"]);let field_values=get_field_properties.meta_package;let acceptance_type=field_values["ClientAcceptanceType"];let question_set_to_toggle=["Q7Independence","C7Independence","C8Independence","Q9Independence","C9Independence","Q12Independence","C12Independence","Q13Independence","C13Independence","Q14Independence","C14Independence"];if(acceptance_type=="Non-Assurance"){sharepoint_utilities.set_fields_as_not_required(question_set_to_toggle);sharepoint_utilities.hide_fields(question_set_to_toggle)}else{sharepoint_utilities.set_fields_as_required(question_set_to_toggle);sharepoint_utilities.show_fields(question_set_to_toggle)}};non_assurance_functions.appendix_b_continuance_other_considerations=function(){};let giac_form={};giac_form.render_form_value=function(field_results,field_set){main["giac_form_id"]=field_results[0].Id;sharepoint_utilities.display_saved_list_fields(field_results,field_set,null)};giac_form.create_new_form=function(qrm_ac_id){let record_meta={QRMACReference:qrm_ac_id.toString()};$.when(sharepoint_utilities.save_item(app_configuration.giac_list_name,app_configuration.site_context,record_meta)).done(function(response){main["giac_form_id"]=response.Id})};let appendix_a_form={};$(document).on("click","ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='Risk Status']",function(){client_risk_assesments.determine_risk_status()});appendix_a_form.render_form_value=function(field_results,field_set){sharepoint_utilities.display_saved_list_fields(field_results,field_set,null)};let key_figures={};$(document).on("change","#KeyFiguresJSON_table .repeating-section-input",function(){sharepoint_utilities.format_thousand_separators($(this).val(),$(this),",")});$(document).on("change","#FeeBudgetJSON_table .repeating-section-input",function(){sharepoint_utilities.format_thousand_separators($(this).val(),$(this),",")});$(document).on("change","#NonAssuranceFeesJSON_table .repeating-section-input",function(){sharepoint_utilities.format_thousand_separators($(this).val(),$(this),",")});var team_information_functions={};$(document).on("change","div[form-navigation-target='Team Information'] input[data-sp-element-name='eqrCalculator']",function(){});$(document).on("change","div[form-navigation-target='Team Information'] input[data-sp-element-name='SpecialistsRequired']",function(){team_information_functions.run_specialist_rules()});team_information_functions.run_general_rules=function(){team_information_functions.run_specialist_rules()};team_information_functions.run_specialist_rules=function(){var specialistRequired=$("input[data-sp-element-name='SpecialistsRequired']").val();if(specialistRequired=="Other"){sharepoint_utilities.show_fields(["SpecialistComments"]);sharepoint_utilities.set_fields_as_required(["SpecialistComments"])}else{sharepoint_utilities.hide_fields(["SpecialistComments"]);sharepoint_utilities.set_fields_as_not_required(["SpecialistComments"])}};let eqr_appointment_form={};eqr_appointment_form.create_new_record=function(qrm_ac_id){let record_meta={QRMACReference:qrm_ac_id.toString()};$.when(sharepoint_utilities.save_item("EQRAppointmentForm",app_configuration.site_context,record_meta)).done(function(response){main["eqr_form_id"]=response.Id})};eqr_appointment_form.render_form_value=function(field_results,field_set){main["eqr_form_id"]=field_results[0].Id;sharepoint_utilities.display_saved_list_fields(field_results,field_set,null)};let upload_documents={};$(document).on("change","#upload-supporting-documents",function(event){var ArrayOfFiles=event.target.files;upload_documents.UploadSetOfFiles(ArrayOfFiles)});$(document).on("change","#qrm-supporting-documents-table .supporting-documents-change",function(event){document_type=$(this).val();let file_id=parseInt($(this).parent().parent().attr("data-document-id"));if(!check_if_document_type_exists(document_type)){$.when(upload_documents.updateFileMetadata(file_id,null,document_type)).done(function(){setTimeout(function(){supporting_documents.validate_all_documents()},200)})}else{sharepoint_utilities.render_notification("Document type already exists","You cannot upload duplicate document types ("+document_type+")","Warning")}function check_if_document_type_exists(document_type){let already_exists=false;let number_of_occurances=0;$("#qrm-supporting-documents-table .supporting-documents-change").each(function(){let existing_document_type=$(this).val();if(document_type==existing_document_type){number_of_occurances+=1}});if(number_of_occurances>1){already_exists=true}return already_exists}});upload_documents.UploadSetOfFiles=function(FilesArray){var files=FilesArray;var UploadedFileId=[];sharepoint_utilities.render_notification("Uploading your files","Please wait while we upload your files. You will get a confirmation once it has uploaded successfully.","Info");for(var i=0;i<files.length;i++){var file=files[i];var fileName=file.name;var fileUploaded;fileUploaded=uploadDocument(file,fileName);$.when(fileUploaded).done(function(FileData){var FileName=FileData.d.Name;var FileID=FileData.d.ListItemAllFields.Id;UploadedFileId.push(FileID);upload_documents.updateFileMetadata(FileID,FileName,null);setTimeout(function(){sharepoint_utilities.render_notification("Uploading documents",FileName+" was uploaded successfully","Info");supporting_documents.display_all_supporting_documents()},600)})}function uploadDocument(file,fileName){adjusted_fileName=moment().format("x")+" - "+fileName;var url="";url=app_configuration.site_context+"/_api/web/getfolderbyserverrelativeurl('"+app_configuration.supporting_documents_library+"')/files/add(url='"+adjusted_fileName+"',overwrite=true)?$select=*,Id&$expand=ListItemAllFields";return $.ajax({url:url,type:"POST",data:file,processData:false,headers:{accept:"application/json;odata=verbose","content-type":"application/octet-stream","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(){},error:function(){}})}};upload_documents.updateFileMetadata=function(FileId,FileName,document_type){var restSource=app_configuration.site_context+"/_api/Web/Lists/getByTitle('"+app_configuration.supporting_documents_library+"')/Items("+FileId+")";var itemPayload={__metadata:{type:"SP.Data.AcceptanceContinuanceDocumentsItem"}};itemPayload["ReferenceID"]=main["selected_client_risk_data"].Id.toString();if(FileName){itemPayload["Title"]=FileName}if(document_type){itemPayload["DocumentType"]=document_type}return $.ajax({url:restSource,method:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(itemPayload),headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val(),"X-HTTP-Method":"MERGE","If-Match":"*"},error:function(xhr,ajaxOptions,thrownError){sharepoint_utilities.render_notification("Error","Could not upload your documents, please refresh the page","Warning")}})};let supporting_questions={};supporting_questions.create_new_record=function(qrm_ac_id){let record_meta={QRMACReference:qrm_ac_id.toString()};$.when(sharepoint_utilities.save_item("SupportingQuestions",app_configuration.site_context,record_meta)).done(function(response){main["supporting_questions_id"]=response.Id})};supporting_questions.render_form_value=function(field_results,field_set){main["supporting_questions_id"]=field_results[0].Id;sharepoint_utilities.display_saved_list_fields(field_results,field_set,null)};let client_risk_approvals={};client_risk_approvals.fields_to_validate=["IsTransnational","IsListedClient","IsSECRegistrant","OtherPieEntities","AcceptanceOrContinuance","RiskStatus","ClientAcceptanceType","Form_x0020_Status","EngagementPartnerId","internalEqrPartner"];$(document).on("click","ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='Approvals']",function(){save_sections.save_button();sharepoint_utilities.create_loader($("div[form-navigation-target='Approvals']"));client_risk_assesments.rule_engine();let form_field_validation_properties=client_risk_approvals.validation_on_all_fields();if(!form_field_validation_properties.validation_status){sharepoint_utilities.hide_fields(["btn-temp-pre-approval"]);sharepoint_utilities.hide_fields(["btn-start-approval-process"]);$("div[title='Indicates additional information about your submission']").click();$(".right-help-comment-tabs-container ul li[data-target-id='2']").click()}else{let field_properties=sharepoint_utilities.get_field_values(["Form_x0020_Status"]).meta_package;if(field_properties.Form_x0020_Status=="In Progress"||field_properties.Form_x0020_Status=="Not Started"||field_properties.Form_x0020_Status=="Changes Requested"){sharepoint_utilities.show_fields(["btn-start-approval-process"]);sharepoint_utilities.show_fields(["btn-temp-pre-approval"])}}client_risk_approvals.display_approval_tasks(main["selected_client_risk_data"]);client_risk_assesments.update_form_values("Supporting Documents")});$(document).on("click","input[data-sp-element-name='btn-query-approver-configuration']",function(){client_risk_approvals.display_approval_reason()});$(document).on("click","#client-risk-assesments-in-progress-approvers-table .client-assesment-approval-task-action",function(){client_risk_approvals.apply_task_action($(this))});$(document).on("click","input[data-sp-element-name='btn-temp-pre-approval']",function(){client_risk_approvals.get_pre_approval()});$(document).on("click","input[data-sp-element-name='btn-start-approval-process']",function(){$(".warnings-section i").removeClass("has-warnings");$(this).css("pointer-events","none");let form_field_validation_properties=client_risk_approvals.validation_on_all_fields();if(form_field_validation_properties.validation_status){$.when(supporting_documents.validate_all_documents()).done(function(validation_outcome){$("#list-of-required-documents-to-upload").html(validation_outcome.validation_message);if(!validation_outcome.is_valid){sharepoint_utilities.render_notification("Documents Required","Please upload the following documents under the supporting documents section:<br/><br/>"+validation_outcome.validation_message,"Warning");$(this).css("pointer-events","auto")}else{client_risk_approvals.start_approval_process()}setTimeout(function(){$("input[data-sp-element-name='btn-start-approval-process']").css("pointer-events","auto")},1500)})}else{sharepoint_utilities.render_notification("Cannot start approval","Please view the validation tab for more information","Warning")}});client_risk_approvals.validation_on_all_fields=function(){warning_controller["warning_validation_cache"]=[];let list_of_sections_to_validate=["General","Team Information","EQR Calculator","GIAC Form","Business Sustainability","General Information About the Engagement","PIE","Transnational Calculator","S90 Calculator","S90 Considerations","Fee Considerations","Key Figures - recent financial year","Part A - Risk Considered as Major","Part B - Risk Considered as Normal","Anti-corruption","Risk Status","Acceptance - Independence and other Considerations","Dummy Entities, Companies or Trusts Other Purpose","Unusual Operations Regarding the Economic Activities of the Client","Know your client (KYC) procedures performed","Conclusion","Continuance - Independence and other Considerations","1. Assessment of compliance with Independence rules"];let validation_message="";let validation_status=true;for(let index=0;index<list_of_sections_to_validate.length;index++){const section_name=list_of_sections_to_validate[index];exclude_section=$("#myList li[data-link-id='"+section_name+"']").hasClass("nav-item-disabled");if(!exclude_section){validate_field_properties=sharepoint_utilities.create_meta_package($("div[form-navigation-target='"+section_name+"']"));if(!validate_field_properties.IsValid){validation_message+=`<b>${section_name} section</b>:<br/>${validate_field_properties.validation_message}`;validation_status=false;validation_warning_message=`<b>${section_name} section</b>:<br/>${validate_field_properties.validation_message}`;warning_controller.add_new_validation_warning(section_name,validation_warning_message,"Validation")}else{}}}if(validation_status==false){$(".warnings-section i").addClass("has-warnings")}warning_controller.display_validation_warnings();$(".right-help-comment-tabs-container ul li[data-target-id='2']").click();return{validation_status:validation_status,validation_message:validation_message}};client_risk_approvals.apply_task_action=function(approval_properties){let task_fields=[{Title:"Select a person to re-assign this task to",Description:"",sp_field_name:"temp-re-assign-field",sp_field_type:"select",field_width:"full-width",field_validate:false,sp_additional_properties:"number single-select-typeahead hide-field",drop_down_title_field:"Title",drop_down_value_field:"Id",list_name:"User Information List",site_context:app_configuration.people_picker_site_context,field_icon:"AccountManagement"},{Title:"Additional Information",Description:"Please add any additional information you wish to add into the notification",sp_field_name:"temp-additional-information",sp_field_type:"textarea",field_width:"full-width",field_validate:false,sp_additional_properties:"exclude-from-meta"}];let current_approver_id=parseInt(approval_properties.attr("data-current-approver-id"));let approval_action=approval_properties.attr("data-approval-action");if(current_approver_id==_spPageContextInfo.userId){let approval_butons={Yes:function(){client_risk_approvals.continue_to_action_task(approval_properties,approval_action)},Back:function(){}};let approval_box_message=`
			<div class='content-pop-up-window-content' style='min-height:200px !important;width:100%'>				
				<div class='confirm-box-container'></div>
				Are you ready to continue?
			</div>
		`;let box_title=approval_action;switch(approval_action){case"ReAssigned":box_title="Re assign";break;case"ChangesRequested":box_title="Change Requested";break}$.confirm({title:box_title+" task action",content:approval_box_message,titleClass:"confirmation-box_content-title",boxWidth:"50%",type:"green",useBootstrap:false,buttons:approval_butons,onContentReady:function(){$(".confirm-box-container").html(sharepoint_utilities.create_container_form(task_fields,"approvals-action-section"));sharepoint_utilities.apply_form_plugins(task_fields);if(approval_action=="Declined"){let current_row_description=$(".approvals-action-section .row-description").text();$(".approvals-action-section .row-description").html(current_row_description)}if(approval_action=="ReAssigned"||approval_action=="ChangesRequested"){sharepoint_utilities.show_fields(["temp-re-assign-field"])}}})}else{sharepoint_utilities.render_notification("Approval Action","You cannot action another persons tasks","Warning")}};client_risk_approvals.continue_to_action_task=function(approval_properties,approval_action){let current_task_id=parseInt(approval_properties.attr("data-current-task-id"));let next_task_id=parseInt(approval_properties.attr("data-next-task-id"));let next_approver_id=parseInt(approval_properties.attr("data-next-approver-id"));let approver_name=approval_properties.attr("data-approver-name");let field_properties=sharepoint_utilities.get_field_values(["AcceptanceOrContinuance","ClientAcceptanceType","ClientName"]);let field_values=field_properties.meta_package;let qrm_submission_reference_id=main["selected_client_risk_data"].Id;var task_properties={};let notification_message="";let comments=$("textarea[data-sp-element-name='temp-additional-information']").val();let new_approver_id=parseInt($("select[data-sp-element-name='temp-re-assign-field']").val());let feedback_user_id=parseInt($("select[data-sp-element-name='temp-re-assign-field']").val());if(comments){comments=`
			<br/>
			Additional comments were left for you:<br/>
			${comments}
		`}switch(approval_action){case"ReAssigned":if(new_approver_id){task_properties["AssignedTo"]=parseInt(new_approver_id);client_risk_approvals.update_approval_task(current_task_id,task_properties);client_risk_approvals.create_notification(new_approver_id,comments,"Task Re-Assigned",qrm_submission_reference_id);$("ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='Approvals']").click();sharepoint_utilities.render_notification("Re-assigning","Your task was re-assigned","Info")}else{sharepoint_utilities.render_notification("Re-assigning approver","Please select an approver first","Warning")}break;case"ChangesRequested":if(comments){if(feedback_user_id){client_risk_approvals.create_notification(feedback_user_id,comments,"ChangesRequested",qrm_submission_reference_id);sharepoint_utilities.render_notification("Feedback","Your message has been sent","Info");sharepoint_utilities.set_field_value("Form_x0020_Status","Changes Requested");client_risk_assesments.update_form_values("General");$("#Left-sticky-menu li[title='Client Acceptance and Continuance']").click()}else{sharepoint_utilities.render_notification("Feedback","Please ensure you have selected someone to send feedback to.","Warning")}}else{sharepoint_utilities.render_notification("Feedback","Please ensure you have added your comments","Warning")}break;case"Approved":update_table_status(approval_properties,approval_action);task_properties["TaskStatus"]=approval_action;client_risk_approvals.update_approval_task(current_task_id,task_properties);notification_message=`
				<p>
					${approver_name} has signed off the ${field_values.AcceptanceOrContinuance} for ${field_values.ClientName}
					<br/>You have been selected as the next approver. Please follow these steps to approve this request:"+
					<ul>
						<li>1. Click on the approve request button below.</li>
						<li>2. Review the information displayed on the form.</li>
						<li>3. Once you are in agreement , click on the red approvals tab.</li>
						<li>3.1 Click the green approve button to continue the approval process.</li>
						<li>3.2 Click the red decline button to stop this process completely</li>
						<li>4. Wait for the confirmation of approval</li>"+
					</ul>
					You can re-assign your approval request by accessing the form, clicking on approvals section and clicking the 're-assign your approval task button'<br/>
					${comments}
				</p>	
			`;if(check_if_all_approved()){notification_message=`
					<p>
						${approver_name} has signed off the ${field_values.AcceptanceOrContinuance} for ${field_values.ClientName}
						<br/>Your submission approval has now been completed. Please see attached approval confirmation.						
						${comments}
					</p>	
				`;next_approver_id=0;sharepoint_utilities.set_field_value("Form_x0020_Status","Completed");client_risk_approvals.create_notification(main["selected_client_risk_data"].AuthorId,notification_message,"ApprovalComplete",qrm_submission_reference_id);client_risk_approvals.create_notification(main["selected_client_risk_data"].AuthorId,"Workflow Generaterd","GeneratePDF",qrm_submission_reference_id);client_risk_assesments.update_form_values("General")}else{task_properties["TaskStatus"]="In Progress";client_risk_approvals.update_approval_task(next_task_id,task_properties);let next_table_status_element=approval_properties.parent().parent().next();update_next_table_status(next_table_status_element,"In Progress");client_risk_approvals.create_notification(next_approver_id,notification_message,"ApprovalRequest",qrm_submission_reference_id)}break;case"Declined":update_table_status(approval_properties,approval_action);task_properties["TaskStatus"]=approval_action;client_risk_approvals.update_approval_task(current_task_id,task_properties);client_risk_approvals.create_notification(next_approver_id,comments,"FormDeclined",qrm_submission_reference_id);sharepoint_utilities.set_field_value("Form_x0020_Status","Declined");client_risk_assesments.update_form_values("General");break}function update_table_status(approval_element,status){approval_element.parent().find("i").addClass("hide");approval_element.parent().prev().find(".table-status-container").html(`<div data-client-class='${status}'></div>${status}`);approval_element.parent().parent().attr("data-approval-status",status)}function update_next_table_status(approval_element,status){approval_element.find(".table-status-container").html(`<div data-client-class='${status}'></div>${status}`);approval_element.attr("data-approval-status",status)}function check_if_all_approved(){let is_all_approved=false;let number_of_tasks=0;let number_of_approved_tasks=0;$("#client-risk-assesments-in-progress-approvers-table tbody tr").each(function(){number_of_tasks+=1;if($(this).attr("data-approval-status")=="Approved"){number_of_approved_tasks+=1}});if(number_of_tasks==number_of_approved_tasks){is_all_approved=true}return is_all_approved}};client_risk_approvals.update_approval_task=function(task_id,meta_package){sharepoint_utilities.update_item("Approval Tasks",app_configuration.site_context,meta_package,task_id)};client_risk_approvals.check_for_pie_client=function(IsOtherPie,IsListed){var IsPIEClient=false;if(IsListed=="Yes"||IsOtherPie=="Yes"){IsPIEClient=true}main["IsPIEClient"]=IsPIEClient;return IsPIEClient};client_risk_approvals.check_for_non_pie_client=function(IsOtherPie,IsListed){var IsNonPIEClient=false;if(IsOtherPie!="Yes"&&IsListed!="Yes"){IsNonPIEClient=true}main["IsNonPIEClient"]=IsNonPIEClient;return IsNonPIEClient};client_risk_approvals.get_list_of_approvers=function(){let get_field_properties=sharepoint_utilities.get_field_values(["RequestOffice","MazarsServiceLine"]);var get_service_line_leader=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"ServiceLineLeader/Id,ServiceLineLeader/Title&$expand=ServiceLineLeader/Id,ServiceLineLeader/Title","Title eq '"+get_field_properties.meta_package["MazarsServiceLine"]+"'","MazarsServiceLines","");var get_approvers_for_office=sharepoint_utilities.get_list_items_by_title("https://mazarsglobalcloud.sharepoint.com/sites/ZAF-Mazars","*,ManagingPartner/Title,CountryRiskManager/Title,QualityOfficer/Title"+"&$expand=ManagingPartner/Title,CountryRiskManager/Title,QualityOfficer/Title","Title eq '"+get_field_properties.meta_package["RequestOffice"]+"'","Office Contact Info","");$.when(get_approvers_for_office,get_service_line_leader).done(function(office_data,service_line_leader_data){if(office_data.length>0){var row_results=office_data[0];client_risk_approvals.approval_cube=row_results;let service_line_leader_results={Id:0,Title:"None"};if(service_line_leader_data.length>0){service_line_leader_results={Id:service_line_leader_data[0].ServiceLineLeader.Id,Title:service_line_leader_data[0].ServiceLineLeader.Title}}client_risk_approvals.approval_cube["service_line_leader"]={id:service_line_leader_results.Id,Title:service_line_leader_results.Title};client_risk_approvals.preview_or_start_approval(false)}else{sharepoint_utilities.render_notification("Getting Approvers","Please select and office before send your form for approval","Warning");$("ul[data-app-name='Client Acceptance and Continuance'] li[data-link-id='General']").click()}})};client_risk_approvals.get_pre_approval=function(){let pre_approval_field=[{Title:"Selected Pre-Approver",Description:"Please select the person you would like to send the link to review",sp_field_name:"PreApproverId",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"number single-select-typeahead",drop_down_title_field:"Title",drop_down_value_field:"Id",list_name:"User Information List",site_context:app_configuration.people_picker_site_context,field_icon:"AddFriend"}];let container_html=`
        <div>
            <p>You are starting the pre-approval notification process.</p>
            <div id='selected-pre-approver-container'></div>
			<p>Are you ready to proceed?</p>
        </div>
    `;let box_options={Yes:function(){this.$$Yes.prop("disabled",true);sharepoint_utilities.render_notification("Sending pre approval","Please wait while we send out a notification with a link to your submission. This dialog will close automatically","Info");client_risk_approvals.send_pre_approval_notification()},No:function(){}};let get_field_properties=sharepoint_utilities.get_field_values(client_risk_approvals.fields_to_validate);if(get_field_properties.IsValid){sharepoint_utilities.render_confirmation_box("Send for pre-approval",container_html,box_options,"50%");setTimeout(function(){$("#selected-pre-approver-container").html(sharepoint_utilities.create_container_form(pre_approval_field,"selected-pre-approver-form-fields'"));sharepoint_utilities.apply_form_plugins(pre_approval_field)},500)}else{sharepoint_utilities.render_notification("Cannot start approval",get_field_properties.validation_message,"Warning")}};client_risk_approvals.send_pre_approval_notification=function(){let field_properties=sharepoint_utilities.get_field_values(["PreApproverId"]);if(field_properties.IsValid){client_risk_approvals.create_notification(field_properties.meta_package["PreApproverId"],"Workflow handled","Pre Approval Request",main.selected_client_risk_data.Id)}else{sharepoint_utilities.render_notification("Cannot start pre-approval",field_properties.validation_message,"Warning")}};client_risk_approvals.start_approval_process=function(){let box_options={Yes:function(){this.$$Yes.prop("disabled",true);sharepoint_utilities.render_notification("Sending for approval","Please wait while we send out notifications and create your approval tasks. This dialog will close automatically","Info");client_risk_approvals.preview_or_start_approval(true)},No:function(){}};let get_field_properties=sharepoint_utilities.get_field_values(client_risk_approvals.fields_to_validate);if(get_field_properties.IsValid){sharepoint_utilities.render_confirmation_box("Send for approval","You are about to start the approval process. Are you sure you want to continue",box_options,"50%")}else{sharepoint_utilities.render_notification("Cannot start approval",get_field_properties.validation_message,"Warning")}};client_risk_approvals.preview_or_start_approval=function(StartApprovalProcess){var get_managing_partner_id=client_risk_approvals.get_user_id(client_risk_approvals.approval_cube.ManagingPartner.Title);var get_country_risk_manager_id=client_risk_approvals.get_user_id(client_risk_approvals.approval_cube.CountryRiskManager.Title);let internal_eqr_partner_display_name=$("div[sp-field-name='internalEqrPartner'] select option:selected").text();let engagement_partner_display_name=$("div[sp-field-name='EngagementPartnerId'] select option:selected").text();let lead_audit_partner_display_name=$("div[sp-field-name='LeadAuditPartnerId'] select option:selected").text();var get_internal_eqr_partner_id=client_risk_approvals.get_user_id(internal_eqr_partner_display_name);var get_engagement_partner_id=client_risk_approvals.get_user_id(engagement_partner_display_name);var get_lead_audit_partner_id=client_risk_approvals.get_user_id(lead_audit_partner_display_name);$.when(get_managing_partner_id,get_country_risk_manager_id,get_internal_eqr_partner_id,get_engagement_partner_id,get_lead_audit_partner_id).done(function(managing_partner_id,country_risk_manager_id,internal_eqr_partner_id,engagement_partner_id,lead_audit_partner_id){let approvers_properties={EngagementManagerId:0,ManagingPartnerId:managing_partner_id,CountryRiskManagerId:country_risk_manager_id,EngagementPartnerId:engagement_partner_id,LeadAuditPartnerId:lead_audit_partner_id,InternalEQRPartnerId:internal_eqr_partner_id,ServiceLineLeaderId:client_risk_approvals.approval_cube.service_line_leader.id};let get_field_properties=sharepoint_utilities.get_field_values(client_risk_approvals.fields_to_validate);var TransnationalStatus=get_field_properties.meta_package["IsTransnational"];var IsListed=get_field_properties.meta_package["IsListedClient"];var IsOtherPie=get_field_properties.meta_package["OtherPieEntities"];var ServiceSubType=get_field_properties.meta_package["AcceptanceOrContinuance"];var RiskStatus=get_field_properties.meta_package["RiskStatus"];var ClientAcceptanceType=get_field_properties.meta_package["ClientAcceptanceType"];var approval_html=`
			<table id='client-risk-assesments-preview-approvers-table' class="table-dashboard accordian-table table dataTable no-footer"  style='width:100%;'>
				<thead>
					<th>Role</th>
					<th>Name</th>
					<th></th>
					<th>Status</th>
				</thead>
			<tbody>
		`;switch(ServiceSubType){case"Continuance":approval_html+=client_risk_approvals.continuance_approval_rules(RiskStatus,IsOtherPie,IsListed,ClientAcceptanceType,StartApprovalProcess,approvers_properties);break;case"Acceptance":approval_html+=client_risk_approvals.acceptance_approval_rules(RiskStatus,TransnationalStatus,IsOtherPie,IsListed,ClientAcceptanceType,StartApprovalProcess,approvers_properties);break}approval_html+=`
			</tbody>
				</table>
		`;$("div[sp-field-name='preview-approval-section-placeholder'] .field-component").html(approval_html);$("#client-risk-assesments-preview-approvers-table").DataTable({bLengthChange:false,bSort:false});if(StartApprovalProcess){sharepoint_utilities.set_field_value("Form_x0020_Status","Waiting on Approval");client_risk_assesments.update_form_values("General");setTimeout(function(){$("#Left-sticky-menu li[title='Client Acceptance and Continuance']").click()},1500)}sharepoint_utilities.remove_loader($("div[form-navigation-target='Approvals']"))})};client_risk_approvals.display_approval_tasks=function(qrm_submission_data){let list_of_approved_statuses=["Waiting on Approval","Completed","Cancelled","Declined","Feedback Requested"];if(qrm_submission_data.Id){if(list_of_approved_statuses.indexOf(qrm_submission_data.Form_x0020_Status)>=0){sharepoint_utilities.hide_fields(["preview-approval-section-placeholder","btn-start-approval-process"]);sharepoint_utilities.show_fields(["current-approval-progress-section-placeholder"]);var GetApprovalTasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","ReferenceID eq '"+qrm_submission_data.Id+"'","Approval Tasks","ApprovalOrder asc");var approval_html=`
				<table id='client-risk-assesments-in-progress-approvers-table' class="table-dashboard accordian-table table dataTable no-footer" style='width:100%;'>
					<thead>
						<th>Role</th>
						<th>Name</th>
						<th>Created</th>
						<th>Modified</th>
						<th>Status</th>
						<th></th>
					</thead>
				<tbody>
			`;$.when(GetApprovalTasks).done(function(task_data){var task_results=task_data;var CountApprovals=0;for(t=0;task_results.length>t;t++){let task_row=task_results[t];var next_approver_index=t+1;let next_approver_id="0";let next_task_id="0";if(next_approver_index<task_results.length){next_approver_id=task_results[next_approver_index].AssignedToId;next_task_id=task_results[next_approver_index].Id}approval_html+=`
						<tr class='ApprovalTableRows' data-approval-status='${task_row.TaskStatus}'>
							<td>${task_row.Description}</td>
							<td>${task_row.AssignedTo.Title}</td>
							<td>${moment(task_row.Created).format("DD/MM/YYYY")}</td>
							<td>${moment(task_row.Modified).format("DD/MM/YYYY")}</td>
							<td>
								<div class="table-status-container">
									<div data-client-class='${task_row.TaskStatus}'></div>
									${task_row.TaskStatus}
								</div>
							</td>
							<td>
								${client_risk_approvals.display_icon(task_row.TaskStatus,task_row,next_approver_id,next_task_id)}
							</td>
						</tr>
					`}approval_html+=`
						</tbody>
					</table>
				`;$("div[sp-field-name='current-approval-progress-section-placeholder'] .field-component").html(approval_html);$("#client-risk-assesments-in-progress-approvers-table").DataTable({bLengthChange:false,order:[],searching:false,paging:false,info:false});sharepoint_utilities.remove_loader($("div[form-navigation-target='Approvals']"))})}else{client_risk_approvals.get_list_of_approvers()}}};client_risk_approvals.display_icon=function(task_status,task_row,next_approver_id,next_task_id){let action_icons="";if(task_status=="In Progress"){action_icons=`
			<i title='Approve this request' class='menu-icon ms-Icon ms-Icon--ActivateOrders client-assesment-approval-task-action table-action-button'
				data-current-task-id='${task_row["Id"]}'
				data-next-approver-id='${next_approver_id}' 
				data-next-task-id='${next_task_id}'  
				data-approver-name='${task_row.AssignedTo.Title}' 
				data-current-approver-id='${task_row.AssignedToId}'
				data-approval-action='Approved'
			>                            
			</i>&nbsp;&nbsp;  
			<i title='Decline this request' class='menu-icon ms-Icon ms-Icon--DeactivateOrders client-assesment-approval-task-action table-action-button'
				data-current-task-id='${task_row["Id"]}'
				data-next-approver-id='${next_approver_id}' 
				data-next-task-id='${next_task_id}'  
				data-approver-name='${task_row.AssignedTo.Title}'  
				data-approval-action='Declined'
				data-current-approver-id='${task_row.AssignedToId}'
			>                            
			</i>&nbsp;&nbsp; 
			<i title='ReAssigned this request' class='menu-icon ms-Icon ms-Icon--FollowUser client-assesment-approval-task-action table-action-button'
				data-current-task-id='${task_row["Id"]}'
				data-next-approver-id='${next_approver_id}' 
				data-next-task-id='${next_task_id}'  
				data-approver-name='${task_row.AssignedTo.Title}'  
				data-approval-action='ReAssigned'
				data-current-approver-id='${task_row.AssignedToId}'
			>                            
			</i>&nbsp;&nbsp;
			<i title='Request changes' class='menu-icon ms-Icon ms-Icon--Feedback client-assesment-approval-task-action table-action-button'
				data-current-task-id='${task_row["Id"]}'
				data-next-approver-id='${next_approver_id}' 
				data-next-task-id='${next_task_id}'  
				data-approver-name='${task_row.AssignedTo.Title}'  
				data-approval-action='ChangesRequested'
				data-current-approver-id='${task_row.AssignedToId}'
			>                            
			</i>&nbsp;&nbsp;
		`}return action_icons};client_risk_approvals.get_user_id=function(userDisplayName){var Promise=$.Deferred();var UserId=0;$.ajax({async:true,url:app_configuration.site_context+"/_api/web/siteusers?&$filter=Title eq '"+userDisplayName+"'",method:"GET",headers:{Accept:"application/json; odata=nometadata"},success:function(data){if(data.value.length>0){UserId=data.value[0].Id}Promise.resolve(UserId)}});return Promise.promise()};client_risk_approvals.continuance_approval_rules=function(RiskStatus,IsOtherPie,IsListed,ClientAcceptanceType,StartApprovalProcess,approver_properties){var IsPIEClient=client_risk_approvals.check_for_pie_client(IsOtherPie,IsListed);var IsNONPIEClient=client_risk_approvals.check_for_non_pie_client(IsOtherPie,IsListed);var ListOfApprovers=client_risk_approvals.approval_cube;let engagement_manager_display_name=$("div[sp-field-name='EngagementManagerId'] select option:selected").text();let engagement_partner_display_name=$("div[sp-field-name='EngagementPartnerId'] select option:selected").text();let lead_audit_partner_display_name=$("div[sp-field-name='LeadAuditPartnerId'] select option:selected").text();let internal_eqr_partner_display_name=$("div[sp-field-name='internalEqrPartner'] select option:selected").text();let qrm_submission_reference_id=main["selected_client_risk_data"].Id;var EngagementPartnerHtml="<tr class='ApprovalTableRows'><td>Engagement Partner</td><td>"+sharepoint_utilities.check_for_null(engagement_partner_display_name,"Add your engagement partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var LeadAuditPartnerHtml="<tr class='ApprovalTableRows'><td>Lead Audit Partner</td><td>"+sharepoint_utilities.check_for_null(lead_audit_partner_display_name,"Add your lead audit partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var InternalEqrPartnerHtml="<tr class='ApprovalTableRows'><td>Internal EQR Partner</td><td>"+sharepoint_utilities.check_for_null(internal_eqr_partner_display_name,"Add your internal eqr partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var service_line_leader_html="<tr class='ApprovalTableRows'><td>Service Line Leader</td><td>"+ListOfApprovers.service_line_leader.Title+"</td></td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var ManagingPartnerHtml="<tr class='ApprovalTableRows'><td>Managing Partner</td><td>"+ListOfApprovers.ManagingPartner.Title+"</td></td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var CountryRiskManagerHtml="<tr class='ApprovalTableRows'><td>Country Risk Manager</td><td>"+ListOfApprovers.CountryRiskManager.Title+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var ApprovalHtml="";if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.EngagementPartnerId,"Engagement Partner","In Progress",qrm_submission_reference_id,"2");if(ClientAcceptanceType=="Non assurance service on existing assurance client (Appendix D)"){client_risk_approvals.create_approval_tasks(approver_properties.LeadAuditPartnerId,"Lead Audit Partner","Waiting",qrm_submission_reference_id,"3")}}else{ApprovalHtml+=EngagementPartnerHtml;if(ClientAcceptanceType=="Non assurance service on existing assurance client (Appendix D)"){ApprovalHtml+=LeadAuditPartnerHtml}}switch(RiskStatus){case"Risky":if(IsPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ServiceLineLeaderId,"Service Line Leader","Waiting",qrm_submission_reference_id,"4");client_risk_approvals.create_approval_tasks(approver_properties.ManagingPartnerId,"Managing Partner","Waiting",qrm_submission_reference_id,"5");client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"6")}else{ApprovalHtml+=service_line_leader_html;ApprovalHtml+=ManagingPartnerHtml;ApprovalHtml+=CountryRiskManagerHtml}}else if(IsNONPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"4")}else{ApprovalHtml+=CountryRiskManagerHtml}}break;case"Not Risky":if(IsPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ManagingPartnerId,"Managing Partner","Waiting",qrm_submission_reference_id,"4")}else{ApprovalHtml+=ManagingPartnerHtml}}else if(IsNONPIEClient){if(ClientAcceptanceType=="Assurance"){if(StartApprovalProcess){}else{}}else if(ClientAcceptanceType=="Non-Assurance"){}}break;case"Not Applicable":if(IsPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ServiceLineLeaderId,"Service Line Leader","Waiting",qrm_submission_reference_id,"4")}else{ApprovalHtml+=service_line_leader_html}}break}return ApprovalHtml};client_risk_approvals.acceptance_approval_rules=function(RiskStatus,TransnationalStatus,IsOtherPie,IsListed,ClientAcceptanceType,StartApprovalProcess,approver_properties){var IsPIEClient=client_risk_approvals.check_for_pie_client(IsOtherPie,IsListed);var IsNONPIEClient=client_risk_approvals.check_for_non_pie_client(IsOtherPie,IsListed);let is_blacklisted=sharepoint_utilities.get_field_values(["IsBlackListed"]).meta_package["IsBlackListed"];let internal_eqr_partner=sharepoint_utilities.get_field_values(["internalEqrPartner"]).meta_package["internalEqrPartner"];var ListOfApprovers=client_risk_approvals.approval_cube;let engagement_manager_display_name=$("div[sp-field-name='EngagementManagerId'] select option:selected").text();let engagement_partner_display_name=$("div[sp-field-name='EngagementPartnerId'] select option:selected").text();let lead_audit_partner_display_name=$("div[sp-field-name='LeadAuditPartnerId'] select option:selected").text();let qrm_submission_reference_id=main["selected_client_risk_data"].Id;var EngagementManagerHtml="<tr class='ApprovalTableRows'><td>Engagement Manager</td><td>"+sharepoint_utilities.check_for_null(engagement_manager_display_name,"Add your engagement partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var EngagementPartnerHtml="<tr class='ApprovalTableRows'><td>Engagement Partner</td><td>"+sharepoint_utilities.check_for_null(engagement_partner_display_name,"Add your engagement partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var LeadAuditPartnerHtml="<tr class='ApprovalTableRows'><td>Lead Audit Partner</td><td>"+sharepoint_utilities.check_for_null(lead_audit_partner_display_name,"Add your lead audit partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var InternalEQRPartnerHtml="<tr class='ApprovalTableRows'><td>Internal EQR Partner</td><td>"+sharepoint_utilities.check_for_null(internal_eqr_partner,"Add your internal eqr partner")+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var service_line_leader_html="<tr class='ApprovalTableRows'><td>Service Line Leader</td><td>"+ListOfApprovers.service_line_leader.Title+"</td></td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var ManagingPartnerHtml="<tr class='ApprovalTableRows'><td>Managing Partner</td><td>"+ListOfApprovers.ManagingPartner.Title+"</td></td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var CountryRiskManagerHtml="<tr class='ApprovalTableRows'><td>Country Risk Manager</td><td>"+ListOfApprovers.CountryRiskManager.Title+"</td><td></td><td><div class='table-status-container'><div data-client-class='Waiting'></div>Waiting to start</div></td></tr>";var ApprovalHtml="";if(StartApprovalProcess){if(internal_eqr_partner){client_risk_approvals.create_approval_tasks(approver_properties.InternalEQRPartnerId,"EQR Partner","In Progress",qrm_submission_reference_id,"1");client_risk_approvals.create_approval_tasks(approver_properties.EngagementPartnerId,"Engagement Partner","Waiting",qrm_submission_reference_id,"2")}else{client_risk_approvals.create_approval_tasks(approver_properties.EngagementPartnerId,"Engagement Partner","In Progress",qrm_submission_reference_id,"2")}if(ClientAcceptanceType=="Non assurance service on existing assurance client (Appendix D)"){client_risk_approvals.create_approval_tasks(approver_properties.LeadAuditPartnerId,"Lead Audit Partner","Waiting",qrm_submission_reference_id,"3")}}else{if(internal_eqr_partner){ApprovalHtml+=InternalEQRPartnerHtml}ApprovalHtml+=EngagementPartnerHtml;if(ClientAcceptanceType=="Non assurance service on existing assurance client (Appendix D)"){ApprovalHtml+=LeadAuditPartnerHtml}}let has_country_risk_manager=false;switch(RiskStatus){case"Risky":if(IsPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ServiceLineLeaderId,"Service Line Leader","Waiting",qrm_submission_reference_id,"4");client_risk_approvals.create_approval_tasks(approver_properties.ManagingPartnerId,"Managing Partner","Waiting",qrm_submission_reference_id,"5");client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"6");has_country_risk_manager=true}else{ApprovalHtml+=service_line_leader_html;ApprovalHtml+=ManagingPartnerHtml;ApprovalHtml+=CountryRiskManagerHtml}}else if(IsNONPIEClient){if(TransnationalStatus=="Yes"){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ServiceLineLeaderId,"Service Line Leader","Waiting",qrm_submission_reference_id,"4");client_risk_approvals.create_approval_tasks(approver_properties.ManagingPartnerId,"Managing Partner","Waiting",qrm_submission_reference_id,"5");client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"6");has_country_risk_manager=true}else{ApprovalHtml+=service_line_leader_html;ApprovalHtml+=ManagingPartnerHtml;ApprovalHtml+=CountryRiskManagerHtml}}else if(TransnationalStatus=="No"){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"4");has_country_risk_manager=true}else{ApprovalHtml+=CountryRiskManagerHtml}}}break;case"Not Risky":if(IsPIEClient){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.ServiceLineLeaderId,"Service Line Leader","Waiting",qrm_submission_reference_id,"4");client_risk_approvals.create_approval_tasks(approver_properties.ManagingPartnerId,"Managing Partner","Waiting",qrm_submission_reference_id,"5");client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"6")}else{ApprovalHtml+=service_line_leader_html;ApprovalHtml+=ManagingPartnerHtml;ApprovalHtml+=CountryRiskManagerHtml}}else if(IsNONPIEClient){if(StartApprovalProcess){}else{}}break;case"Not Applicable":if(IsPIEClient){if(StartApprovalProcess){}else{}}break}if(is_blacklisted=="Yes"&&has_country_risk_manager==false){if(StartApprovalProcess){client_risk_approvals.create_approval_tasks(approver_properties.CountryRiskManagerId,"Country Risk Manager","Waiting",qrm_submission_reference_id,"6")}else{ApprovalHtml+=CountryRiskManagerHtml}}return ApprovalHtml};client_risk_approvals.create_approval_tasks=function(AssignedToId,Description,TaskStatus,ReferenceID,approval_order){let get_field_properties=sharepoint_utilities.get_field_values(["AcceptanceOrContinuance","ClientName","ClientAcceptanceType"]);var TaskProperties={};TaskProperties["Title"]="New Approval Task - "+get_field_properties.meta_package["AcceptanceOrContinuance"]+" "+get_field_properties.meta_package["ClientName"]+" "+get_field_properties.meta_package["ClientAcceptanceType"]+" ";TaskProperties["Description"]=Description;TaskProperties["SignatureType"]=Description;TaskProperties["AssignedToId"]=AssignedToId;TaskProperties["TaskStatus"]=TaskStatus;TaskProperties["ReferenceID"]=ReferenceID.toString();TaskProperties["ApprovalOrder"]=approval_order;sharepoint_utilities.save_item("Approval Tasks",app_configuration.site_context,TaskProperties);if(Description=="Engagement Partner"){var Message="<p>"+_spPageContextInfo.userDisplayName+" has requested your approval."+"<br/>Please follow the below steps to complete your approval:"+"<ul>"+"<li>1. Click on the approve request button below.</li>"+"<li>2. Review the information displayed on the form.</li>"+"<li>3. Once you are in agreement , click on the red approvals tab.</li>"+"<li>3.1 Click the green approve button to continue the approval process.</li>"+"<li>3.2 Click the red decline button to stop this process completely</li>"+"<li>4. Wait for the confirmation page to appear</li>"+"</ul>"+"You can re-assign your approval request by accessing the form, clicking on approvals section and clicking the 're-assign your approval task button' "+"</p>";client_risk_approvals.create_notification(AssignedToId,Message,"ApprovalRequest",ReferenceID)}};client_risk_approvals.create_notification=function(AssignedToId,Message,NotificationType,AssociatedReference){var NotificationProperties={};NotificationProperties["Title"]="New Notification";NotificationProperties["Message"]=Message;NotificationProperties["AssignedToId"]=AssignedToId;NotificationProperties["NotificationType"]=NotificationType;NotificationProperties["AssociatedReferenceID"]=AssociatedReference.toString();sharepoint_utilities.save_item(app_configuration.ac_general_notifications,app_configuration.site_context,NotificationProperties)};client_risk_approvals.display_approval_reason=function(){var ApprovalReasoning="Please see below indicators of why the current set of approvers have been selected:<br/><br/>";let field_properties=sharepoint_utilities.get_field_values(["ClientAcceptanceType","AcceptanceOrContinuance","IsPIEClient","IsNonPIEClient","IsListedClient","CryptoEngagment","SPACEngagment","IPOEngagment","OtherPieEntities","IsTransnational","RiskStatus"]);ApprovalReasoning+=`
		<table id='approval-reason-table'>
			<thead>
				<tr>
					<th>Condition</th>
					<th>Selection</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><b>Service type</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["ClientAcceptanceType"],"None")}</td>
				</tr>
				<tr>
					<td><b>Take on type</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["AcceptanceOrContinuance"],"None")}</td>
				</tr>
				<tr>
					<td><b>Is Listed Client</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["IsListedClient"],"None")}</td>
				</tr>
				<tr>
					<td><b>Crypto Engagement</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["CryptoEngagment"],"None")}</td>
				</tr>

				<tr>
					<td><b>SPAC Engagement</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["SPACEngagment"],"None")}</td>
				</tr>

				<tr>
					<td><b>IPO Engagement</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["IPOEngagment"],"None")}</td>
				</tr>
				<tr>
					<td><b>Other PIE Entities</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["OtherPieEntities"],"None")}</td>
				</tr>
				<tr>
					<td><b>Is Transnational</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["IsTransnational"],"None")}</td>
				</tr>
				<tr>
					<td><b>Risk Status</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["RiskStatus"],"None")}</td>
				</tr>
				<tr>
					<td><b>Is PIE Client</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["IsPIEClient"],"None")}</td>
				</tr>
				<tr>
					<td><b>Is Non PIE Client</b></td><td>${sharepoint_utilities.check_for_null(field_properties.meta_package["IsNonPIEClient"],"None")}</td>
				</tr>
			</tbody>
		</table>		
	`;sharepoint_utilities.render_confirmation_box("Approval Indicator",ApprovalReasoning,{},"50%");setTimeout(function(){$("#approval-reason-table").DataTable({searching:false,lengthChange:false})},50)};let template_controller={};$(document).on("change","select[data-sp-element-name='template-selector']",function(){let selected_template_id=parseInt($(this).val());let record_properties={item_id:selected_template_id,action_type:"Acceptance",data_source_type:"Current",form_type:"Acceptance",form_status:"new"};client_risk_assesments.render_acceptance_form_html(record_properties)});let warning_controller={};$(document).on("click",".warnings-section i",function(){if($(".right-help-comments-section-panel").hasClass("hide")){$(".right-help-comments-section-panel").removeClass("hide")}else{$(".right-help-comments-section-panel").addClass("hide")}if(!$(".right-help-comments-section-panel").hasClass("hide")){$(".right-help-comment-tabs-container ul li[data-target-id='1']").click();warning_controller.display_warnings()}render_navigation.calculate_canvas_width()});$(document).on("click",".right-help-comment-tabs-container ul li[data-target-id='1']",function(){warning_controller.display_warnings();$(".right-help-comment-tabs-container ul li").removeClass("selected-btn");$(this).addClass("selected-btn");$(".ms-Icon--FileComment").removeClass("ms-Icon--FileComment").addClass("ms-Icon--AlertSettings")});$(document).on("click",".right-help-comment-tabs-container ul li[data-target-id='2']",function(){warning_controller.display_validation_warnings();$(".right-help-comment-tabs-container ul li").removeClass("selected-btn");$(this).addClass("selected-btn");$(".ms-Icon--FileComment").removeClass("ms-Icon--FileComment").addClass("ms-Icon--AlertSettings")});$(document).on("click",".right-help-comments-content ul li[data-section-name-id]",function(){warning_controller.go_to_page_section($(this).attr("data-section-name-id"))});warning_controller.go_to_page_section=function(section_name){let history_index=JSON.parse($(".navigation-panel-list-items li[data-link-id='"+section_name+"']").attr("data-history-index"));let get_slug=history_index.slice(0,-1).toString();$(".panel-navigation-item[data-history-index='["+get_slug+"]']").click();app_configuration["previous-selected-section"]=app_configuration["currently-selected-section"];app_configuration["currently-selected-section"]=$(".navigation-panel-list-items li[data-link-id='"+section_name+"']");setTimeout(function(){$(".navigation-panel-list-items li[data-link-id='"+section_name+"']").click()},400)};warning_controller.display_warnings=function(){let get_warnings=warning_controller["warning_cache"];let warnings_list_html="<ul>";$(".warnings-section i").removeClass("has-warnings");if(get_warnings){for(let index=0;index<get_warnings.length;index++){const warning_row=get_warnings[index];warnings_list_html+=`
                <li>
                    <div class='warning-item'>
                        <strong>${warning_row.title}</strong><br/>
                        ${warning_row.description}
                    </div>
                </li>
            `}if(get_warnings.length>0){$(".warnings-section i").addClass("has-warnings")}}warnings_list_html+="</ul>";$(".right-help-comments-content").html(warnings_list_html)};warning_controller.display_validation_warnings=function(){let get_warning_validation_cache=warning_controller["warning_validation_cache"];let warnings_list_html="<ul>";if(get_warning_validation_cache){for(let index=0;index<get_warning_validation_cache.length;index++){const warning_row=get_warning_validation_cache[index];warnings_list_html+=`
                <li data-section-name-id='${warning_row.title}'>
                    <div class='warning-item'>                   
                        ${warning_row.description}                
                    </div>
                </li>
            `}}else{get_warning_validation_cache=[]}warnings_list_html+="</ul>";$(".right-help-comments-content").html(warnings_list_html);$(".warnings-section i").removeClass("has-warnings");if(get_warning_validation_cache.length>0){$(".warnings-section i").addClass("has-warnings")}};warning_controller.add_new_validation_warning=function(title,description,type){let warning_validation_cache=[];if(warning_controller["warning_validation_cache"]){warning_validation_cache=warning_controller["warning_validation_cache"]}let warning_meta={title:title,description:description,type:type};warning_validation_cache.push(warning_meta);warning_controller["warning_validation_cache"]=warning_validation_cache};warning_controller.add_new_warning=function(title,description,type){let warning_cache=warning_controller["warning_cache"];let warning_meta={title:title,description:description,type:type};let duplicate_warning=false;if(warning_cache){for(let index=0;index<warning_cache.length;index++){const warning_row=warning_cache[index];if(warning_row.description==description&&warning_row.title==title){duplicate_warning=true;break}}}else{warning_cache=[]}if(!duplicate_warning){warning_cache.push(warning_meta)}warning_controller["warning_cache"]=warning_cache};warning_controller.remove_warning=function(title,description,type){let warning_cache=warning_controller["warning_cache"];let new_warning_cache=[];if(warning_cache){for(let index=0;index<warning_cache.length;index++){const warning_row=warning_cache[index];if(warning_row.description==description&&warning_row.title==title){new_warning_cache=warning_cache.splice(index,1);break}}}warning_controller["warning_cache"]=new_warning_cache};let audit_log_controller={};$(document).on("click",".right-help-comment-tabs-container ul li[data-target-id='4']",function(){audit_log_controller.display_audit_log();$(".right-help-comment-tabs-container ul li").removeClass("selected-btn");$(this).addClass("selected-btn");$(".ms-Icon--FileComment").removeClass("ms-Icon--FileComment").addClass("ms-Icon--AlertSettings")});audit_log_controller.display_audit_log=function(){let get_current_app_name=$("#Left-sticky-menu li.top-level-nav-selected").attr("title");let list_name="";let audit_log_filter="";let field_description="";switch(get_current_app_name){case"Business Development":list_name=app_configuration.bd_general_notifications;audit_log_filter="FormReferenceId eq '"+main["selected_bd_data"][0].Id+"'";break;case"Client Acceptance and Continuance":list_name=app_configuration.ac_general_notifications;audit_log_filter="AssociatedReferenceID eq '"+main["selected_client_risk_data"].Id+"'";break;case"Lockdown":list_name=app_configuration.lockdown_general_notifications;audit_log_filter="AssociatedReferenceID eq '"+main["selected_lockdown_data"][0].Id+"'";break}let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,Author/Title,AssignedTo/Title&$expand=Author/Title,AssignedTo/Title",audit_log_filter,list_name,"Id desc");$.when(get_list_items).done(function(item_results){let audit_log_results="<ul>";for(let index=0;index<item_results.length;index++){const audit_log_row=item_results[index];let notification_type=audit_log_row.NotificationType.replace(/([A-Z])/g," $1").replace(/^./,function(str){return str.toUpperCase()});audit_log_results+=`
                    <li>
                        <div class='audit-log-item'>
                            <div class='title'>${audit_log_row.Title}</div>                     
                            <div class='notification-type'>${notification_type}</div>
                            <div class='author'>by ${audit_log_row.Author.Title} on ${moment(audit_log_row.created).format(app_configuration.display_date_format)}</div>
                        </div>
                    </li>
                `}audit_log_results+="</ul>";$(".right-help-comments-content").html(audit_log_results)})};let comments_controller={};$(document).on("click","div[app-name='Client Acceptance and Continuance'] .add-new-comment-container i",function(){comments_controller.create_or_update_comments(main["selected_client_risk_data"],app_configuration.ac_comments_list_name)});$(document).on("click","div[app-name='Business Development'] .add-new-comment-container i",function(){comments_controller.create_or_update_comments(main["selected_bd_data"],app_configuration.bd_comments_list_name)});$(document).on("click",".right-help-comments-section-panel .right-help-comments-content li",function(){let sp_field_name=$(this).attr("data-sp-field-name");let find_field_in_section=$(".page-section").find("div[sp-field-name='"+sp_field_name+"']");let section_name=find_field_in_section.parentsUntil(".page-section-form-container").parent().attr("form-navigation-target");if(section_name){let history_index=JSON.parse($(".navigation-panel-list-items li[data-link-id='"+section_name+"']").attr("data-history-index"));let get_slug=history_index.slice(0,-1).toString();$(".panel-navigation-item[data-history-index='["+get_slug+"]']").click();$(".field-commenting-container").addClass("hide");setTimeout(function(){$(".navigation-panel-list-items li[data-link-id='"+section_name+"']").click();setTimeout(function(){$("div[sp-field-name='"+sp_field_name+"']").find(".field-component-comment-icon-container i").click();$("#main-canvas-container").animate({scrollTop:$("div[sp-field-name='"+sp_field_name+"']").offset().top},1e3)},100)},200)}});$(document).on("click",".right-help-comment-tabs-container li[data-target-id='3']",function(){$(".right-help-comment-tabs-container ul li").removeClass("selected-btn");$(".right-help-comments-content ul").html(null);$(this).addClass("selected-btn");$(".ms-Icon--AlertSettings").removeClass("ms-Icon--AlertSettings").addClass("ms-Icon--FileComment");let saved_comments=sharepoint_utilities.field_comments_list;let comments_html="";if(saved_comments){for(let index=0;index<saved_comments.length;index++){const comments_row=saved_comments[index];if(comments_row.comments.length>0){last_comment_made=comments_row.comments[comments_row.comments.length-1];comments_html+=`
                    <li data-sp-field-name='${comments_row.field_name}'>
                        <div class='comments-item'>                   
                            <div class='comment-item'>	                                
                                <div class='comments-field-name'>${comments_row.field_name}</div>
                                <div class='comment'>${last_comment_made.comment}</div>	
                                <div class='comment-meta'>			
                                    <div class='comment-person' data-userId='${last_comment_made.userId}' data-userEmail='${last_comment_made.userEmail}'>${last_comment_made.userDisplayName}</div>
                                    <div class='comment-date'>${last_comment_made.date}</div>                                
                                </div>	

                            </div>	                                       
                        </div>
                    </li>
                `}}}$(".right-help-comments-content").html(comments_html);$(".ms-Icon--AlertSettings").removeClass("has-warnings");if(saved_comments>0){$(".ms-Icon--AlertSettings").addClass("has-warnings")}});comments_controller.get_all_comments=function(form_reference_id,comments_list_name){if(form_reference_id){$.when(sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","FormReferenceId eq "+parseInt(form_reference_id),comments_list_name,"Id desc")).done(function(comment_results){if(comment_results.length>0){sharepoint_utilities.field_comments_list=JSON.parse(comment_results[0].CommentsJSON);sharepoint_utilities.field_comments_list_Id=comment_results[0].Id}})}};comments_controller.create_or_update_comments=function(existing_data_cube,comment_list_name){if(existing_data_cube){setTimeout(function(){if(sharepoint_utilities.field_comments_list_Id){comments_controller.update_added_comments(sharepoint_utilities.field_comments_list_Id,comment_list_name)}else{comments_controller.save_added_comments(existing_data_cube.Id.toString(),comment_list_name)}},500)}else{$("div[sp-additional-properties*='display-field-commenting']").find("div.comment-item").remove();sharepoint_utilities.render_notification("Error","Please create or save the form first before addings comments","Warning")}};comments_controller.save_added_comments=function(form_reference_id,comments_list_name){if(form_reference_id){let meta_package={CommentsJSON:JSON.stringify(sharepoint_utilities.field_comments_list),FormReferenceId:form_reference_id};sharepoint_utilities.save_item(comments_list_name,app_configuration.site_context,meta_package)}else{sharepoint_utilities.render_notification("Error","Please create or save the form first before addings comments","Warning")}};comments_controller.update_added_comments=function(form_reference_id,comments_list_name){$.when(sharepoint_utilities.update_item(comments_list_name,app_configuration.site_context,{CommentsJSON:JSON.stringify(sharepoint_utilities.field_comments_list)},form_reference_id)).done(function(response){if(response=="success"){$(".right-help-comment-tabs-container ul li[data-target-id='3']").click()}})};let action_buttons={};$(document).on("click","div[app-name='Business Development'] input[title*='Next']",function(){if(app_configuration.form_reference_id){action_buttons.go_to_next_section($(this))}});$(document).on("click","div[app-name='Business Development'] input[title*='Back']",function(){if(app_configuration.form_reference_id){action_buttons.go_back_to_section($(this))}});$(document).on("mousedown","ul[data-app-name='Business Development'] li",function(){if(app_configuration.form_reference_id){let section_name=$("ul[data-app-name='Business Development']").find("li.currently-open").attr("data-link-id");action_buttons.update_existing_submission(section_name)}});$(document).on("click","div[app-name='Business Development'] ul li[navigation-target-container='Supporting-Documents']",function(){supporting_documents.display_all_documents(app_configuration.form_reference_id.toString())});$(document).on("click","div[app-name='Business Development'] input[data-sp-element-name='btn-submit']",function(){if(app_configuration.form_reference_id){sharepoint_utilities.hide_fields(["btn-submit"]);action_buttons.update_existing_submission($("div[app-name='Business Development']"))}else{sharepoint_utilities.render_notification("Error","Could not submit","Warning")}});$(document).on("change","div[app-name='Business Development'] select[data-sp-element-name='temp-bd-request-search']",function(){let client_filter="ClientName eq '"+$(this).val()+"'";bd_app_main.render_bd_client_dashboard(client_filter)});$(document).on("click","ul[data-app-name='Business Development'] li[data-link-id='Conclusion and Analysis of Results']",function(){bd_evaluation_rules.render_bd_conclusion_and_analysis_table()});$(document).on("click","div[app-name='Business Development'] input[data-sp-element-name*='sp-button-approve']",function(){bd_approval_configuration.approve_application($(this))});$(document).on("click","div[app-name='Business Development'] input[data-sp-element-name*='sp-button-decline']",function(){bd_approval_configuration.decline_application($(this))});$(document).on("click","#bd-dashboard-table tbody tr i",function(){action_buttons.dashboard_table_icon_actions($(this))});action_buttons.dashboard_table_icon_actions=function(icon_element){let action_type=icon_element.attr("data-attr-action");let get_reference_id=icon_element.attr("data-attr-bd-id");switch(action_type){case"remove":action_buttons.remove_form(get_reference_id);break;case"view":bd_business_rules.render_existing_form(get_reference_id);break;case"restart":action_buttons.restart_form(get_reference_id);action_buttons.restart_form_notification(get_reference_id);break;case"cancel":action_buttons.cancel_form(get_reference_id);break}};action_buttons.remove_form=function(reference_id){action_buttons.dashboard_update_submission_status("Removed",reference_id)};action_buttons.restart_form=function(reference_id){action_buttons.dashboard_update_submission_status("Allocation",reference_id)};action_buttons.cancel_form=function(reference_id){action_buttons.dashboard_update_submission_status("Cancelled",reference_id)};action_buttons.restart_form_notification=function(reference_id){let notification_meta_package={Title:"Status Change Notification",ApprovalTaskReferenceId:"-",AssignedToId:0,AssignedToDisplayName:"system defined",NotificationDetails:"-",NotificationType:"Reset approvals",NotificationStatus:"Allocation",FormReferenceId:reference_id,ChangeType:"-"};action_buttons.create_notification(notification_meta_package)};action_buttons.dashboard_update_submission_status=function(new_status,reference_id){let meta_package={SubmissionStatus:new_status};if(new_status=="Cancelled"||new_status=="Removed"){meta_package["SystemStatus"]="Closed"}else{meta_package["SystemStatus"]="Open"}let notification_meta_package={Title:"Status Change Notification",ApprovalTaskReferenceId:"-",AssignedToId:0,AssignedToDisplayName:"system defined",NotificationDetails:"-",NotificationType:"status change",NotificationStatus:new_status,FormReferenceId:reference_id,ChangeType:"-"};let update_item=sharepoint_utilities.update_item(app_configuration.bd_initiation,app_configuration.site_context,meta_package,parseInt(reference_id));$.when(update_item).done(function(){sharepoint_utilities.render_notification("Form Submission Update","Your form was updated to "+new_status,"Info");bd_app_main.render_client_dashboard();action_buttons.create_notification(notification_meta_package)})};action_buttons.create_notification=function(meta_package){let create_item=sharepoint_utilities.save_item(app_configuration.bd_general_notifications,app_configuration.site_context,meta_package);$.when(create_item).done(function(item_id){})};action_buttons.go_to_next_section=function(selected_button){let get_current_selected_item=$("ul[data-app-name='Business Development']").find("li.currently-open");if(get_current_selected_item.length!=0){if(selected_button.attr("data-sp-element-name")!="sp-button-next-to-internally-captured"){let section_name=$("ul[data-app-name='Business Development']").find("li.currently-open").attr("data-link-id");action_buttons.update_existing_submission(section_name)}let check_for_sub_link_navigation=get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().find("ul");if(check_for_sub_link_navigation.length>0){get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().click();get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().next().children("li:first-child").click()}else{get_current_selected_item.nextAll("li").not(".nav-item-disabled").first().click()}if(get_current_selected_item.is(":last-child")){parent_level=get_current_selected_item.parent();parent_level.nextAll("li").not(".nav-item-disabled").first().click()}}else{warning_controller.add_new_warning("Error","Section "+get_current_selected_item+" not saved, Please ensure you have selected a section","Warning");sharepoint_utilities.render_notification("Error","Section not saved, Please ensure you have selected a section","Warning")}};action_buttons.go_back_to_section=function(selected_button){let get_current_selected_item=$("ul[data-app-name='Business Development']").find("li.currently-open");if(get_current_selected_item.length!=0){let section_name=$("ul[data-app-name='Business Development']").find("li.currently-open").attr("data-link-id");action_buttons.update_existing_submission(section_name);let check_for_sub_link_navigation=get_current_selected_item.prevAll("li").not(".nav-item-disabled").last().find("ul");if(check_for_sub_link_navigation.length>0){get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().click();get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().next().children("li:first-child").click()}else{get_current_selected_item.prevAll("li").not(".nav-item-disabled").first().click()}if(get_current_selected_item.is(":first-child")){parent_level=get_current_selected_item.parent();parent_level.prevAll("li").not(".nav-item-disabled").first().prev().click()}}else{warning_controller.add_new_warning("Error","Section "+get_current_selected_item+" not saved, Please ensure you have selected a section","Warning")}};action_buttons.update_existing_submission=function(section_name){if(main["selected_bd_data"][0].SystemStatus=="Open"){let listName=app_configuration.bd_initiation;let form_section=$("div[form-navigation-target='"+section_name+"']");let list_reference_id=app_configuration.form_reference_id;switch(section_name){case"General and Contact Details":listName=app_configuration.bd_initiation;break;case"Internally Captured Details":listName=app_configuration.bd_initiation;break;case"Initiation":listName=app_configuration.bd_initiation;break;case"Allocation":listName=app_configuration.bd_initiation;break;case"Restricted Entity Database":listName=app_configuration.bd_evaluation;list_reference_id=app_configuration["evaluation_ref_id"];break;case"Risk Factors":listName=app_configuration.bd_evaluation;list_reference_id=app_configuration["evaluation_ref_id"];break;case"Needs Analysis and Risk Considerations":listName=app_configuration.bd_evaluation;list_reference_id=app_configuration["evaluation_ref_id"];break;case"Conclusion and Analysis of Results":listName=app_configuration.bd_evaluation;list_reference_id=app_configuration["evaluation_ref_id"];break;case"Independence":listName=app_configuration.bd_independence;list_reference_id=app_configuration["independence_ref_id"];break;case"Acceptance":listName=app_configuration.bd_independence;list_reference_id=app_configuration["independence_ref_id"];break}if(app_configuration.form_reference_id){let get_meta_package=sharepoint_utilities.create_meta_package(form_section);if(get_meta_package.IsValid){let update_item=sharepoint_utilities.update_item(listName,app_configuration.site_context,get_meta_package.meta_package,list_reference_id);$.when(update_item).done(function(results){})}else{sharepoint_utilities.navigation_sections("Back");sharepoint_utilities.render_notification("Cannot Continue","Please complete the following sections before proceeding: <br/>"+get_meta_package.validation_message,"Warning")}}}};let bd_allocation_rules={};$(document).on("click","ul[data-app-name='Business Development'] li[data-link-id='Allocation']",function(){bd_security.render_bd_allocation_team_members_table(JSON.parse(main["selected_bd_data"][0].RoleDetails))});$(document).on("click","div[app-name='Business Development'] input[data-sp-element-name*='sp-button-add-new']",function(){bd_allocation_rules.add_new_team_member_form()});$(document).on("click","#bd-allocation-team-members-table tbody tr td .remove-user",function(){sharepoint_utilities.render_notification("Removing User","Please wait while we remove the user","Info");let get_index_id=$(this).parent().parent().attr("data-attr-bd-id");let user_id=$(this).parent().parent().attr("data-attr-bd-user-id");let user_name=$(this).parent().parent().attr("data-attr-bd-user-name");let team_properties=bd_security.remove_team_member(get_index_id);bd_security.render_bd_allocation_team_members_table(team_properties.list_of_team_members);bd_security.update_security_record(team_properties.new_role_reference_ids,team_properties.list_of_team_members);notification_meta_package={Title:"Permimission Change",ApprovalTaskReferenceId:"-",AssignedToId:parseInt(user_id),AssignedToDisplayName:user_name,NotificationDetails:team_properties.team_member_details.display_name+" was remove with the "+team_properties.team_member_details.role_name,NotificationType:"Remove User",NotificationStatus:"Permission change",FormReferenceId:app_configuration.form_reference_id,ChangeType:"-"};action_buttons.create_notification(notification_meta_package)});bd_allocation_rules.add_new_team_member_form=function(default_persona){let form_title="Add new team member to the submission";let task_fields=[{Title:"Approver",Description:"Please select the new assignee",sp_field_name:"sp-temp-assigned-approver",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"number single-select-typeahead",drop_down_title_field:"Title",drop_down_value_field:"EMail",list_name:"User Information List",site_context:app_configuration.people_picker_site_context,field_icon:"AccountBrowser"},{Title:"Role",Description:"Please select the role of the new assignee",sp_field_name:"sp-temp-assigned-role",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"single-select-drop-down-external-list",additional_filters:"",drop_down_title_field:"Title",drop_down_value_field:"Id",drop_down_order_by:"Title asc",list_name:"BDRoleTypes",site_context:app_configuration.site_context,field_icon:"AccountBrowser"},{Title:"Permission Level",Description:"Please select the level of interaction",sp_field_name:"sp-temp-assigned-permission-level",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"single-select-drop-down-external-list",additional_filters:"",drop_down_title_field:"Title",drop_down_value_field:"Id",drop_down_order_by:"Title asc",list_name:"BDRolePermissions",site_context:app_configuration.site_context,field_icon:"AccountBrowser"},{Title:"Reason for assignment",Description:"Please provide a reason for this reassignment",sp_field_name:"sp-temp-assigned-reason",sp_field_type:"textarea",field_width:"full-width",field_validate:true,sp_additional_properties:"exclude-from-meta"}];let approval_butons={Confirm:function(){let field_properties=sharepoint_utilities.get_field_values(["sp-temp-assigned-approver","sp-temp-assigned-role","sp-temp-assigned-permission-level","sp-temp-assigned-reason","RoleDetails"]);if(field_properties.IsValid){sharepoint_utilities.render_notification("Adding Permissions","Please wait while we add permissions and send out communications","Info");let row_data=field_properties.meta_package;let get_user_id=sharepoint_utilities.validate_user_in_site_collection(row_data["sp-temp-assigned-approver"],app_configuration.site_context);$.when(get_user_id).done(function(user_id){let role_name=$("select[data-sp-element-name='sp-temp-assigned-role'] option:selected").text();let approver_name=$("select[data-sp-element-name='sp-temp-assigned-approver'] option:selected").text();let permission_name=$("select[data-sp-element-name='sp-temp-assigned-permission-level'] option:selected").text();let new_team_member_details={role_name:role_name,display_name:approver_name,email:row_data["sp-temp-assigned-approver"],user_id:user_id,role_name:role_name,role_id:row_data["sp-temp-assigned-role"],role_permission_id:row_data["sp-temp-assigned-permission-level"],role_permission_name:permission_name};let get_current_team_members=JSON.parse(field_properties.meta_package.RoleDetails);get_current_team_members.push(new_team_member_details);let team_member_properties=bd_security.add_team_member(get_current_team_members);bd_security.render_bd_allocation_team_members_table(get_current_team_members);notification_meta_package={Title:"Permimission Change",ApprovalTaskReferenceId:"-",AssignedToId:user_id,AssignedToDisplayName:approver_name,NotificationDetails:approver_name+" was added with the "+role_name+" role for the following reason "+row_data["sp-temp-assigned-reason"],NotificationType:"Add New User",NotificationStatus:"Permission change",FormReferenceId:app_configuration.form_reference_id,ChangeType:"-"};action_buttons.create_notification(notification_meta_package);sharepoint_utilities.close_container_window($(".allocation-assigning-team-member"));bd_security.update_security_record(team_member_properties.new_role_reference_ids,get_current_team_members);switch(default_persona){case"QRM":bd_evaluation_rules.create_qrm_task(user_id,row_data["sp-temp-assigned-role"]);break}})}else{sharepoint_utilities.render_notification("Cannot action member permissions",field_properties.validation_message,"Warning")}return false},Cancel:function(){}};let approval_box_message=`
       <div class='content-pop-up-window-content' style='min-height:200px !important;width:100%'>				
           <div class='confirm-box-container'></div>
       </div>
   `;$.confirm({title:form_title,content:approval_box_message,titleClass:"allocation-assigning-team-member",boxWidth:"50%",type:"green",useBootstrap:false,buttons:approval_butons,onContentReady:function(){$(".confirm-box-container").html(sharepoint_utilities.create_container_form(task_fields,"bd_allocation_assign_engagement_partner"));sharepoint_utilities.apply_form_plugins(task_fields);switch(default_persona){case"QRM":setTimeout(()=>{sharepoint_utilities.set_select_2_fields_by_value(12,$("select[data-sp-element-name='sp-temp-assigned-role']"));sharepoint_utilities.set_select_2_fields_by_value(1,$("select[data-sp-element-name='sp-temp-assigned-permission-level']"));sharepoint_utilities.disable_fields(["sp-temp-assigned-role","sp-temp-assigned-permission-level"]);sharepoint_utilities.set_field_value("sp-temp-assigned-reason","QRM Assistance Required")},1e3);break}}})};bd_allocation_rules.determine_approvers=function(form_details){let approver_promise=$.Deferred();let channel_properties=determine_channel_filter(form_details.ServiceLines);let has_error=false;let error_message="";let get_approver_rules=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,PermissionType/Title,AssociatedRoles/Title&$expand=PermissionType/Title,AssociatedRoles/Title","StartThresholdAmount le "+form_details.BudgetedFee+" and EndThresholdAmount ge "+form_details.BudgetedFee+channel_properties.channel_filter,app_configuration.bd_approver_rules,"Id asc");let get_approver_roles=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssociatedRoles/Title,AssociatedPerson/Title,AssociatedPerson/EMail,AssociatedPerson/Id&$expand=AssociatedRoles/Title,AssociatedPerson/Title,AssociatedPerson/EMail,AssociatedPerson/Id","",app_configuration.bd_approver_roles,"Id desc");$.when(get_approver_rules,get_approver_roles).done(function(approver_results,approver_role_results){let additional_details="";let list_of_members=[];for(let index=0;index<approver_results.length;index++){const approver_configuration=approver_results[index];let configured_roles=approver_configuration.AssociatedRoles;additional_details+="Rule Id: "+approver_configuration.Id+" - "+approver_configuration.Title+"<br/>";for(let role_index=0;role_index<configured_roles.length;role_index++){const current_role=configured_roles[role_index];let current_role_id=approver_configuration.AssociatedRolesId[role_index];let lookup_specific_approver_details=lookup_Approver_details(form_details,current_role_id,approver_role_results,channel_properties);if(lookup_specific_approver_details.process_role){role_security_details={role_name:current_role.Title,role_id:current_role_id,role_permission_id:approver_configuration.PermissionTypeId,role_permission_name:approver_configuration.PermissionType.Title};let approver_object=Object.assign(lookup_specific_approver_details.json_team_data,role_security_details);list_of_members.push(approver_object);for(const[key,value]of Object.entries(role_security_details)){if(!value){error_message+="- "+key+" is not found<br/>";has_error=true}}}}}approver_promise.resolve({list_of_members:list_of_members,has_error:has_error,error_message:error_message,additional_details:additional_details})});return approver_promise.promise();function lookup_Approver_details(field_properties,current_role_Id,approver_role_configuration){let process_role=true;let approver_login_details=get_approver_login_details(field_properties,current_role_Id,approver_role_configuration);let json_team_data={display_name:approver_login_details.display_name,email:approver_login_details.EMail,user_id:approver_login_details.Id};if(field_properties.PrimaryAssignedEngagementPartnerId>0){if(current_role_Id==10||current_role_Id==5){process_role=false}}else{if(field_properties.ScopeOfServices.indexOf("Other")==-1&&current_role_Id==6){process_role=false}if(current_role_Id==9){process_role=false}}return{process_role:process_role,json_team_data:json_team_data,has_error:has_error,error_message:error_message}}function get_approver_login_details(field_properties,current_role_Id,approver_role_configuration){let approver_login_details={};let extract_scope_of_services=field_properties.ScopeOfServices.split("#;");let is_found=false;for(let index=0;index<approver_role_configuration.length;index++){const approver_roles_row=approver_role_configuration[index];if(current_role_Id==9&&field_properties.PrimaryAssignedEngagementPartnerId>0){if(main["selected_bd_data"][0]){approver_login_details={display_name:$("select[data-sp-element-name='PrimaryAssignedEngagementPartnerId']  option:selected").text(),EMail:"",Id:main["selected_bd_data"][0].PrimaryAssignedEngagementPartnerId};is_found=true}}else if(approver_roles_row.AssociatedRolesId==current_role_Id){switch(current_role_Id){case 4:if(approver_roles_row.ServiceLineType==field_properties.ServiceLines){approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id};is_found=true}break;case 5:if(approver_roles_row.PrioritySector==field_properties.Industry){approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id};is_found=true}break;case 6:if(field_properties.ScopeOfServices.indexOf("Other")>=0){if(approver_roles_row.NonPrioritySector==field_properties.StateRegion){approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id};is_found=true}}break;case 9:break;case 10:if(approver_roles_row.ServiceLineType==field_properties.ServiceLines){approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id};is_found=true}break;case 11:for(let index=0;index<extract_scope_of_services.length;index++){const element=extract_scope_of_services[index];let get_sub_service=element.split(" - ")[1];if(approver_roles_row.FocusGroup.toLowerCase()==get_sub_service.toLowerCase()){approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id}}is_found=true}break;case 15:approver_login_details={display_name:_spPageContextInfo.userDisplayName,EMail:_spPageContextInfo.userEmail,Id:_spPageContextInfo.userId};is_found=true;break;default:approver_login_details={display_name:approver_roles_row.AssociatedPerson.Title,EMail:approver_roles_row.AssociatedPerson.EMail,Id:approver_roles_row.AssociatedPerson.Id};is_found=true;break}}if(is_found){break}}return approver_login_details}function determine_channel_filter(selected_service_lines){let channel_filter="";let assurance_found=false;let non_assurance_found=false;if(selected_service_lines){let list_of_selections=selected_service_lines.split("#;");for(let index=0;index<list_of_selections.length;index++){const row_item=list_of_selections[index];if(assurance_found==false){if(row_item=="Audit"||row_item=="Statutory compliance"){assurance_found=true}}if(non_assurance_found==false){if(row_item!="Audit"&&row_item!="Statutory compliance"){non_assurance_found=true}}}}if(assurance_found==true&&non_assurance_found==true){channel_filter=" and (Channel eq 'Assurance' or Channel eq 'Non Assurance')"}else if(assurance_found==true){channel_filter=" and Channel eq 'Assurance'"}else if(non_assurance_found==true){channel_filter=" and Channel eq 'Non Assurance'"}return{channel_filter:channel_filter,non_assurance_found:non_assurance_found,assurance_found:assurance_found}}};let bd_approval_configuration={};$(document).on("click","ul[data-app-name='Business Development'] li[data-link-id='Approvals']",function(){bd_approval_configuration.render_approval_tasks()});bd_approval_configuration.decline_application=function(clicked_button){let get_button_action=clicked_button.attr("data-sp-element-name");let field_properties=sharepoint_utilities.get_field_values(["AddConcludingComments","ApprovalComments"]).meta_package;let get_approval_properties=bd_approval_configuration.get_next_approver_details("declined");let declined_status=get_approval_properties.current_task_details.TaskType;let decline_reason="";if(get_approval_properties.is_approver){switch(get_button_action){case"sp-button-decline-evaluation":decline_reason=field_properties["AddConcludingComments"];break;case"sp-button-decline-independence-acceptance":decline_reason=field_properties["ApprovalComments"];break}let meta_package={SubmissionStatus:"Declined",SystemStatus:"Closed"};notification_meta_package={Title:"Form Application Declined",ApprovalTaskReferenceId:get_approval_properties.current_task_details.Id.toString(),AssignedToId:0,AssignedToDisplayName:"system defined",NotificationDetails:decline_reason,NotificationType:"Form Declined",NotificationStatus:declined_status+" declined",FormReferenceId:app_configuration.form_reference_id,ChangeType:"-"};if(decline_reason.length>10){sharepoint_utilities.render_notification("Declining your approval","Please wait while we submit your reason and send out the relevant notifications.","Info");let section_name=$("ul[data-app-name='Business Development']").find("li.currently-open").attr("data-link-id");action_buttons.update_existing_submission(section_name);let update_item=sharepoint_utilities.update_item(app_configuration.bd_initiation,app_configuration.site_context,meta_package,parseInt(app_configuration.form_reference_id));let update_current_task=sharepoint_utilities.update_item(app_configuration.bd_approval_tasks,app_configuration.site_context,{TaskStatus:"Declined"},parseInt(get_approval_properties.current_task_details.Id));$.when(update_item,update_current_task).done(function(){action_buttons.create_notification(notification_meta_package)})}else{sharepoint_utilities.render_notification("Declining Application","Please ensure you have a substantial reason why you are declining this request under the comments section","Warning")}}else{sharepoint_utilities.render_notification("Unauthorized","You are not designed to decline this application section.","Warning")}};bd_approval_configuration.approve_application=function(clicked_button){let get_approval_properties=bd_approval_configuration.get_next_approver_details("approved");let validation=true;switch(clicked_button.attr("data-sp-element-name")){case"sp-button-approve-and-start-completion":validation=bd_independance_rules.validate_uploaded_documents();break}if(get_approval_properties.is_approver==true){if(validation==true){sharepoint_utilities.render_notification("Applying your approval","Please wait while we submit your approval and send out the relevant notifications.","Info");let meta_package={SubmissionStatus:get_approval_properties.next_approver_details.TaskType,SystemStatus:"Open"};if(get_approval_properties.approval_completed){meta_package.SystemStatus="Closed"}notification_meta_package={Title:"Form process change notification",ApprovalTaskReferenceId:get_approval_properties.next_approver_details.Id.toString(),AssignedToId:get_approval_properties.next_approver_details.AssignedToId,AssignedToDisplayName:"system defined",NotificationDetails:"-",NotificationType:"Form Approved",NotificationStatus:get_approval_properties.next_approver_details.TaskType,FormReferenceId:app_configuration.form_reference_id,ChangeType:"-"};let update_item=sharepoint_utilities.update_item(app_configuration.bd_initiation,app_configuration.site_context,meta_package,parseInt(app_configuration.form_reference_id));let update_current_task=sharepoint_utilities.update_item(app_configuration.bd_approval_tasks,app_configuration.site_context,{TaskStatus:"Approved"},parseInt(get_approval_properties.current_task_details.Id));let set_next_task_to_pending=sharepoint_utilities.update_item(app_configuration.bd_approval_tasks,app_configuration.site_context,{TaskStatus:"Pending Approval"},get_approval_properties.next_approver_details.Id);$.when(update_item,update_current_task,set_next_task_to_pending).done(function(){action_buttons.create_notification(notification_meta_package);$("#Left-sticky-menu li[title='Business Development']").click()})}else{sharepoint_utilities.render_notification("Documents Required","Please ensure all the required documents are required to be uploaded before proceeding to approve","Warning")}}else{sharepoint_utilities.render_notification("Unauthorized","You are not designed to approve this application section. <br/>"+"Approval from "+get_approval_properties.current_task_details.AssignedTo.Title+" is required","Warning")}};bd_approval_configuration.get_next_approver_details=function(approval_status){let next_approver_details={};let current_task_details={};let declined_approver_details={};let approval_completed=false;let is_approver=false;let next_approver_is_found=false;let approval_task_cube=app_configuration["bd_approval_tasks_data"];let approval_count=0;for(let index=0;index<approval_task_cube.length;index++){const approval_row=approval_task_cube[index];if(approval_row.TaskStatus=="Pending Approval"){if(approval_row.AssignedToId==_spPageContextInfo.userId){is_approver=true}current_task_details=approval_row}if(approval_row.TaskStatus=="Waiting"&&next_approver_is_found==false){approval_count+=1;next_approver_details=approval_row;next_approver_is_found=true}if(approval_status=="declined"&&approval_row.TaskType=="Pending Approval"){approval_count+=1;declined_approver_details=approval_row}}if(approval_count==0){approval_completed=true;next_approver_details={TaskType:"Approved",AssignedToId:0,Id:"-"}}return{next_approver_details:next_approver_details,declined_approver_details:declined_approver_details,current_task_details:current_task_details,approval_completed:approval_completed,is_approver:is_approver}};bd_approval_configuration.render_approval_tasks=function(){var get_bd_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","ReferenceID eq '"+main["selected_bd_data"][0].Id+"'",app_configuration.bd_approval_tasks,"ApprovalOrder asc");var approval_html=`
        <table id='bd-approver-table-overview' class="table-dashboard accordian-table table dataTable no-footer" style='width:100%;'>
            <thead>
                <th>Reference</td>  
                <th>Assigned To</th>                  
                <th>Created</th>           
                <th>Status</th>             
            </thead>
        <tbody>
    `;$.when(get_bd_approval_tasks).done(function(get_bd_approval_tasks_results){app_configuration["bd_approval_tasks_data"]=get_bd_approval_tasks_results;for(let index=0;index<get_bd_approval_tasks_results.length;index++){const task_row=get_bd_approval_tasks_results[index];approval_html+=`
                <tr class='ApprovalTableRows' 
                    data-itemid='${task_row["ID"]}'
                    data-item-status='${task_row["TaskStatus"]}'    
                >
                    <td>${task_row.TaskType}</td>  
                    <td>${task_row.AssignedTo.Title}</td>             
                    <td>${moment(task_row.Created).format("DD/MM/YYYY")}</td>
                    <td>
                        <div class="table-status-container">
							<div data-bd-approval-class='${task_row.TaskStatus}'></div>
							${task_row.TaskStatus}
						</div>
                    </td>
                </tr>
            `}$("div[sp-field-name='temp-bd-approval-table']").html(approval_html);$("#bd-approver-table-overview").DataTable({bLengthChange:false,order:[],searching:false,paging:false,info:false})})};bd_approval_configuration.create_approval_tasks=async function(role_approver_details){let field_properties=sharepoint_utilities.get_field_values(["ClientName"]).meta_package;sharepoint_utilities.render_notification("Approval Tasks","Finalizing approvals and creating approval tasks where necessary","Info");let list_of_updates=[];let list_of_sections_to_approve=["Internally Captured Details","Allocation","Evaluation","Independence"];if(role_approver_details.length>0){let role_approvers=role_approver_details;let approval_order=0;for(let section_index=0;section_index<list_of_sections_to_approve.length;section_index++){const approval_section_name=list_of_sections_to_approve[section_index];let found_first_approver=false;for(let index=0;index<role_approvers.length;index++){const role_aprover=role_approvers[index];if(role_aprover.role_permission_id==1){let must_create_task=true;let approval_status="Waiting";if(approval_section_name=="Internally Captured Details"&&section_index==0&&found_first_approver==false){approval_status="Pending Approval";found_first_approver=true}else if(approval_section_name=="Internally Captured Details"){must_create_task=false}approval_order+=1;let meta_package={Title:"New Approval Task - Business Development - "+field_properties["ClientName"],Description:"Approval task allocated for "+approval_section_name,AssignedToId:role_aprover.user_id,TaskStatus:approval_status,ReferenceID:app_configuration.form_reference_id.toString(),SignatureType:role_aprover.role_name,Comments:"-",TaskType:approval_section_name,ApprovalOrder:approval_order.toString()};if(must_create_task){list_of_updates.push(sharepoint_utilities.save_item(app_configuration.bd_approval_tasks,app_configuration.site_context,meta_package))}}}}const finalized_async_updates=await Promise.all(list_of_updates)}};let bd_business_rules={};bd_business_rules.render_existing_form=function(get_reference_id){let consolidated_intiation_fields=sharepoint_utilities.consolidate_fields(bd_intiation_field_set_configuration);let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,sharepoint_utilities.generate_query_for_expanded_fields(consolidated_intiation_fields),"Id eq '"+get_reference_id+"'",app_configuration.bd_initiation,"Id desc");$.when(get_list_items).done(function(item_results){app_configuration.form_reference_id=get_reference_id;main["selected_bd_data"]=item_results;sharepoint_utilities.field_comments_list=[];bd_app_main.render_selected_form(main["selected_bd_data"]);$("li[data-link-id='New Client Requests']").click();$("li[data-link-id='Initiation']").click();bd_approval_configuration.render_approval_tasks()})};let bd_evaluation_rules={};$(document).on("click","div[sp-field-name='sp-button-mitigating-factors'] input",function(){bd_allocation_rules.add_new_team_member_form("QRM")});$(document).on("click","div[sp-field-name='sp-button-database-check'] input",function(){window.open(app_configuration.bd_entity_database_url,"blank")});$(document).on("click","div[sp-field-name='sp-button-complete-we-check'] input",function(){window.open(app_configuration.bd_wecheck_url,"blank")});$(document).on("click","div[sp-field-name='sp-button-link-to-hubspot'] input",function(){window.open(app_configuration.bd_hubspot_url,"blank")});$(document).on("click","div[sp-field-name='sp-button-apply-qrm-approval'] input",function(){let get_user_id=parseInt($(this).attr("data-approver-id"));let get_task_id=parseInt($(this).attr("data-task-id"));if(get_user_id==_spPageContextInfo.userId){bd_evaluation_rules.update_qrm_task(get_task_id)}else{sharepoint_utilities.render_notification("Oops","You know you are not the approver for this task - why click it","Warning")}});bd_evaluation_rules.update_qrm_task=function(get_task_id){sharepoint_utilities.render_notification("Approving Task","Approving your task and sending out the notification","Info");let meta_package={TaskStatus:"Approved"};let update_item=sharepoint_utilities.update_item(app_configuration.bd_qrm_approval_tasks,app_configuration.site_context,meta_package,get_task_id);$.when(update_item).done(function(){let notification_meta_package={Title:"Status Change Notification",ApprovalTaskReferenceId:"-",AssignedToId:0,AssignedToDisplayName:"system defined",NotificationDetails:"-",NotificationType:"status change",NotificationStatus:"Evaluation",FormReferenceId:app_configuration.form_reference_id.toString(),ChangeType:"-"};action_buttons.create_notification(notification_meta_package);setTimeout(()=>{$("#Left-sticky-menu li[title='Business Development']").click()},200)})};bd_evaluation_rules.create_qrm_task=function(approver_id,role_name){let meta_package={Title:"New Approval Task - Business Development - "+main["selected_bd_data"][0].ClientName,Description:"Approval task allocated for Evaluation Phase",AssignedToId:approver_id,TaskStatus:"Pending Approval",ReferenceID:app_configuration.form_reference_id.toString(),SignatureType:role_name,Comments:"-",TaskType:"Requires QRM Assistance",ApprovalOrder:"0"};sharepoint_utilities.save_item(app_configuration.bd_qrm_approval_tasks,app_configuration.site_context,meta_package)};bd_evaluation_rules.determine_conclusion=function(responses){let get_qrm_approval_tasks=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,AssignedTo/Title&$expand=AssignedTo/Title","ReferenceID eq '"+app_configuration.form_reference_id.toString()+"'",app_configuration.bd_qrm_approval_tasks,"Id desc");$.when(get_qrm_approval_tasks).done(function(item_results){let table_html=`
            <table>
                <thead>
                <tr>
                    <td>Assigned To</td>
                    <td>Status</td>
                    <td>Modified</td>
                </tr>
                </thead>
                <tbody>
        `;let check_for_in_progress_tasks=false;let current_user_id_requiring_approval=null;let task_id=null;let has_qrm_approved=false;for(let index=0;index<item_results.length;index++){const item_row=item_results[index];if(item_row.TaskStatus=="Pending Approval"){check_for_in_progress_tasks=true;current_user_id_requiring_approval=item_row.AssignedToId;task_id=item_row.Id}if(item_row.TaskStatus=="Approved"){has_qrm_approved=true}table_html+=`
                <tr>
                    <td>${item_row.AssignedTo.Title}</td>
                    <td>${item_row.TaskStatus}</td>
                    <td>${moment(item_row.Modified).format(app_configuration.display_date_format)}</td>
                </tr>
            `}table_html+=`
                </body>
            </table>
        `;$("div[sp-field-name='placeholder-on-qrm-approval-tasks'] div.field-component").html(table_html);sharepoint_utilities.hide_fields(["placeholder-on-qrm-approval-tasks"]);if(item_results.length>0){sharepoint_utilities.show_fields(["placeholder-on-qrm-approval-tasks"])}let result_total={yes:0,no:0};let response="";let message="";let evaluation_action_buttons=["sp-button-approve-and-start-independence","sp-button-mitigating-factors"];sharepoint_utilities.hide_fields(evaluation_action_buttons);for(let index=0;index<responses.length;index++){const response=responses[index];if(response=="Yes"){result_total.yes+=1}else if(response=="No"){result_total.no+=1}}if(result_total.yes==responses.length){response="Authorized to continue";message="You may approve this submission";sharepoint_utilities.show_fields(["sp-button-approve-and-start-independence"])}else if(result_total.no==responses.length){response="Decline and stop process";message="Please decline this submission"}else{response="Further considerations are required";if(check_for_in_progress_tasks){sharepoint_utilities.show_fields(["sp-button-apply-qrm-approval"]);sharepoint_utilities.hide_fields(["sp-button-mitigating-factors"]);$("input[data-sp-element-name='sp-button-apply-qrm-approval']").attr("data-approver-id",current_user_id_requiring_approval);$("input[data-sp-element-name='sp-button-apply-qrm-approval']").attr("data-task-id",task_id);if(current_user_id_requiring_approval==_spPageContextInfo.userId){message="As the QRM approver, please use the approval button below to continue with the application"}else{message="Only the assigned QRM approver can apply thier approval"}}else{if(!has_qrm_approved){message="Please involve a QRM representative on this submission using the 'request QRM Assistance' if you wish to continue with this application";sharepoint_utilities.show_fields(["sp-button-mitigating-factors"]);sharepoint_utilities.hide_fields(["sp-button-approve-and-start-independence"])}else{response="Further considerations are required and QRM approval has been obtained";sharepoint_utilities.show_fields(["sp-button-approve-and-start-independence"])}}}sharepoint_utilities.set_field_description("bd_evaluation_recommendation_header",response+"<br/>"+message);sharepoint_utilities.render_notification(response,message,"Info")})};bd_evaluation_rules.render_bd_conclusion_and_analysis_table=function(){let field_properties=sharepoint_utilities.get_field_values(["AchieveStrategy","ReputationalRisk","SkillsAndResources","ProfitMargins","WinningProbability"]);let table_html=`
            <table id='bd-conclusion-and-analysis-table' class=''>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Question</th>
                        <th>Answer</th>                          
                    </tr>
                </thead>
            <tbody>
        `;table_html+=`
            <tr>
                <td>1</td>
                <td>Will this client opportunity help us achieve out strategy?</td>
                <td>${field_properties.meta_package.AchieveStrategy}</td>
            </tr>
            <tr>
                <td>2</td>
                <td>Does the client carry any reputational risk?</td>
                <td>${field_properties.meta_package.ReputationalRisk}</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Do we have the skills and available resources to deliver the required services?</td>
                <td>${field_properties.meta_package.SkillsAndResources}</td>
            </tr>
            <tr>
                <td>4</td>
                <td>Is this opportunity capable of being delivered profitably reaching thresholds set for recovery and margins?</td>
                <td>${field_properties.meta_package.ProfitMargins}</td>
            </tr>
            <tr>
                <td>5</td>
                <td>What is the probability of us winning the tender?</td>
                <td>${field_properties.meta_package.WinningProbability}</td>
            </tr>
        `;table_html+=`
            </tbody>
            </table>
        `;if(field_properties.IsValid){$("div[sp-field-name='bd-conclusion-and-results-table-placeholder']").html(table_html);bd_evaluation_rules.determine_conclusion(field_properties.array_of_values)}};let bd_independance_rules={};bd_independance_rules.validate_uploaded_documents=function(){let required_document_types=["dpa and nda","acceptance | continuance"];let validation_count=0;let is_valid=false;for(let index=0;index<app_configuration["bd_supporting_documents_data"].length;index++){const documents_row=app_configuration["bd_supporting_documents_data"][index];if(required_document_types.indexOf(documents_row.DocumentType)>=0){validation_count+=1}}if(required_document_types.length==validation_count){is_valid=true}return{is_valid:is_valid}};let bd_initiation_rules={};$(document).on("click","div[app-name='Business Development'] input[data-sp-element-name='sp-button-next-to-internally-captured']",function(){bd_initiation_rules.create_reference_number()});bd_initiation_rules.create_reference_number=function(){if(!app_configuration.form_reference_id){bd_initiation_rules.create_submission()}else{bd_initiation_rules.proceed_to_create_approvers(main["selected_bd_data"][0])}};$(document).on("change","input[data-sp-element-name='BudgetedFee']",function(){bd_initiation_rules.validate_general_detail_changes($(this).attr("data-sp-element-name"),"input")});$(document).on("click","input[data-sp-element-name='sp-button-preview-approvers']",function(){bd_initiation_rules.preview_approvers("BudgetedFee")});bd_initiation_rules.validate_general_detail_changes=function(field_name,field_type){let existing_record=main["selected_bd_data"];if(existing_record){if(existing_record.length>0){bd_initiation_rules.general_details_adjusted(field_name,field_type)}}};bd_initiation_rules.general_details_adjusted=function(field_name,field_type){let form_title="Changes require alternative approver allocations";let existing_record=main["selected_bd_data"];let approval_butons={Confirm:function(){$("ul[data-app-name='Business Development'] li[data-link-id='Internally Captured Details']").addClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Allocation']").addClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Evaluation']").addClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Independence']").addClass("nav-item-disabled");$("ul[data-app-name='Business Development'] li[data-link-id='Approvals']").addClass("nav-item-disabled");sharepoint_utilities.render_notification("Adjustment of approvers in progress","Please wait while we adjust the selected approvers","Info");action_buttons.restart_form_notification(existing_record[0].Id.toString());bd_initiation_rules.proceed_to_create_approvers(existing_record[0]);sharepoint_utilities.close_container_window($(".approver-changes-required-confirmation"));return false},Cancel:function(){if(existing_record.length>0){switch(field_type){case"input":sharepoint_utilities.set_field_value(field_name,existing_record[0][field_name]);break}}}};let approval_box_message=`
       <div class='content-pop-up-window-content' style='min-height:200px !important;width:100%'>				
           <div class='confirm-box-container'>
                We have detected that you have changed certain details of the form which influence the approver allocations.<br/>
                This will completly reset the form back to allocation, remove all the current tasks and create new approval tasks.
                Please click 'Confirm' to proceed with these adjustments.
           </div>
       </div>
   `;$.confirm({title:form_title,content:approval_box_message,titleClass:"approver-changes-required-confirmation",boxWidth:"50%",type:"green",useBootstrap:false,buttons:approval_butons,onContentReady:function(){$("ul[data-app-name='Business Development'] li[data-link-id='General and Contact Details']").click();bd_initiation_rules.preview_approvers("BudgetedFee")}})};bd_initiation_rules.create_submission=function(){let field_properties=sharepoint_utilities.create_meta_package($("div.bd-intitation-general-section"));field_properties.meta_package["RoleReferenceId"]=";"+_spPageContextInfo.userId+";";if(field_properties.IsValid){sharepoint_utilities.render_notification("Sending Submission","Thank you for your submission - please wait while we finalize the process","Info");let create_item=sharepoint_utilities.save_item(app_configuration.bd_initiation,app_configuration.site_context,field_properties.meta_package);$.when(create_item).done(function(item_result){app_configuration.form_reference_id=item_result.Id;main["selected_bd_data"].push(item_result);bd_initiation_rules.proceed_to_create_approvers(item_result);let create_evaluation_item=sharepoint_utilities.save_item(app_configuration.bd_evaluation,app_configuration.site_context,{ReferenceId:app_configuration.form_reference_id.toString()});let create_independence_item=sharepoint_utilities.save_item(app_configuration.bd_independence,app_configuration.site_context,{ReferenceId:app_configuration.form_reference_id.toString()})}).fail(function(){sharepoint_utilities.render_notification("OOPS!","Something went wrong whilst submitting your form","Info")})}else{sharepoint_utilities.render_notification("Cannot Continue","Please complete the following sections before proceeding: <br/>"+field_properties.validation_message,"Warning")}};bd_initiation_rules.preview_approvers=function(trigger_field_name){let list_of_trigger_fields=["ServiceLines","EntityRegType","Industry","OtherIndustry","ScopeOfServices","PrimaryAssignedEngagementPartnerId","EngagementType","BudgetedFee"];if(list_of_trigger_fields.indexOf(trigger_field_name)>0){let field_properties=sharepoint_utilities.create_meta_package($("div.bd-intitation-general-section"));if(field_properties.IsValid){$.when(bd_allocation_rules.determine_approvers(field_properties.meta_package)).done(function(approver_properties){$("div[sp-field-name='placeholder-allocation-preview-approver-container'] .row-description").html(approver_properties.additional_details);bd_security.create_allocation_table(approver_properties.list_of_members,$("div[sp-field-name='placeholder-allocation-preview-approver-container'] .field-component"),"preview");sharepoint_utilities.show_fields(["placeholder-allocation-preview-approver-container"])})}}};bd_initiation_rules.proceed_to_create_approvers=function(item_result){let field_properties=sharepoint_utilities.create_meta_package($("div.bd-intitation-general-section"));$.when(bd_allocation_rules.determine_approvers(field_properties.meta_package)).done(function(approver_properties){if(!approver_properties.has_error){bd_approval_configuration.create_approval_tasks(approver_properties.list_of_members);if(approver_properties.list_of_members.length==0){sharepoint_utilities.render_notification("Cannot Create Tasks","Your form was submitted without approvers and cannot continue as there were thresholds that were outside of this tools scope","Warning")}else{let applied_team_properties=bd_security.add_team_member(approver_properties.list_of_members);bd_security.render_bd_allocation_team_members_table(approver_properties.list_of_members);bd_security.update_security_record(applied_team_properties.new_role_reference_ids,approver_properties.list_of_members);action_buttons.dashboard_update_submission_status("Internally Captured Details",item_result.Id.toString());setTimeout(function(){$("#Left-sticky-menu li[title='Business Development']").click()},2e3)}}else{warning_controller.add_new_validation_warning("Cannot continue with your submission",approver_properties.error_message,"Warning");sharepoint_utilities.render_notification("Cannot continue with your submission","Your selection contains criteria that does not have an associated approver","Warning")}})};let bd_security={};bd_security.apply_role_security=function(){let field_properties=sharepoint_utilities.get_field_values(["RoleDetails","RoleReferenceId"]).meta_package;let approval_buttons=["sp-button-approve-and-start-allocation","sp-button-next-to-internally-captured","sp-button-approve-and-start-evaluation"];let allocation_buttons=["sp-button-add-new"];let team_members=JSON.parse(field_properties.RoleDetails);let list_of_role_permissions=[];for(let index=0;index<team_members.length;index++){const team_member_row=team_members[index];if(team_member_row.user_id==_spPageContextInfo.userId){list_of_role_permissions.push(team_member_row.role_permission_id)}}if(list_of_role_permissions.indexOf(1)>=0||list_of_role_permissions.indexOf(4)>=0){sharepoint_utilities.show_fields(allocation_buttons);$("bd-allocation-team-members tbody tr td i.remove-user").removeClass("hide")}else{sharepoint_utilities.hide_fields(allocation_buttons);$("bd-allocation-team-members tbody tr td i.remove-user").addClass("hide")}};bd_security.create_allocation_table=function(list_of_team_members,field_container_element,render_type){let table_html=`
        <table id='bd-allocation-team-members-table' class=''>
            <thead>
                <tr>
                    <th>Team Member</th>
                    <th>Member's Role</th>
                    <th>Role Type</th>
    `;if(render_type!="preview"){table_html+=`<th>Remove</th>`}table_html+=`                                      
                </tr>
            </thead>
            <tbody>
    `;if(list_of_team_members.length>0){for(let index=0;index<list_of_team_members.length;index++){const role_row=list_of_team_members[index];table_html+=`
                    <tr
                        data-attr-role-id='${role_row.role_id}' 
                        data-attr-bd-user-id='${role_row.user_id}'
                        data-attr-bd-user-name='${role_row.display_name}'
                        data-attr-bd-id='${index}'
                    >
                        <td>${role_row.display_name}</td>
                        <td>${role_row.role_name}</td>   
                        <td>${role_row.role_permission_name}</td> 
                `;if(render_type!="preview"){table_html+=`
                        <td class=>
                            <i class='menu-icon ms-Icon ms-Icon--Delete remove-user' title='Remove Team Member'></i>                        
                        </td>
                    `}table_html+=`       
                    </tr>
                `}}table_html+=`
            </tbody>
        </table>
    `;field_container_element.html(table_html);field_container_element.find("#bd-allocation-team-members-table").dataTable({searching:false,paging:false,info:false})};bd_security.render_bd_allocation_team_members_table=function(list_of_team_members){bd_security.create_allocation_table(list_of_team_members,$("div[sp-field-name='bd-allocation-team-members-table-placeholder'] .field-component"),"applied");bd_security.apply_role_security()};bd_security.add_team_member=function(list_of_team_members){let new_role_reference_ids="";if(list_of_team_members){for(let index=0;index<list_of_team_members.length;index++){const team_member_row=list_of_team_members[index];if(new_role_reference_ids.indexOf(";"+team_member_row.user_id+";")==-1){new_role_reference_ids+=team_member_row.user_id+";"}if(index==0){new_role_reference_ids=";"+team_member_row.user_id+";"}}}sharepoint_utilities.set_field_value("RoleReferenceId",new_role_reference_ids);sharepoint_utilities.set_field_value("RoleDetails",JSON.stringify(list_of_team_members));return{new_role_reference_ids:new_role_reference_ids}};bd_security.remove_team_member=function(index_to_remove){let field_properties=sharepoint_utilities.get_field_values(["RoleDetails","RoleReferenceId"]).meta_package;let role_details=JSON.parse(field_properties.RoleDetails);let team_member_details=role_details[index_to_remove];let new_role_reference_ids=field_properties.RoleReferenceId;role_details.splice(parseInt(index_to_remove),1);for(let index=0;index<role_details.length;index++){const role_row=role_details[index];if(new_role_reference_ids.indexOf(";"+role_row.user_id+";")==-1){new_role_reference_ids+=role_row.user_id+";"}if(index==0){new_role_reference_ids=";"+role_row.user_id+";"}}sharepoint_utilities.set_field_value("RoleDetails",JSON.stringify(role_details));sharepoint_utilities.set_field_value("RoleReferenceId",new_role_reference_ids);return{team_member_details:team_member_details,new_role_reference_ids:new_role_reference_ids,list_of_team_members:role_details}};bd_security.update_security_record=function(new_role_reference_ids,new_role_details){if(!valid_stringified_object(new_role_details)){new_role_details=JSON.stringify(new_role_details)}let security_meta_package={RoleReferenceId:new_role_reference_ids,RoleDetails:new_role_details};let update_item=sharepoint_utilities.update_item(app_configuration.bd_initiation,app_configuration.site_context,security_meta_package,app_configuration.form_reference_id);$.when(update_item).done(function(results){if(!valid_stringified_object(new_role_details)){new_role_details=JSON.stringify(new_role_details)}main["selected_bd_data"][0].RoleDetails=new_role_details;main["selected_bd_data"][0].RoleReferenceId=new_role_reference_ids});function valid_stringified_object(json_string){if(typeof json_string!=="string"){return false}try{var json=JSON.parse(json_string);return typeof json==="object"}catch(error){return false}}};let bd_supporting_documents={};$(document).on("change","div[app-name='Business Development'] .form-row input[type='file']",function(event){var file_content=event.target.files;let file_document_type=bd_supporting_documents.get_document_type($(this).attr("data-sp-element-name"));bd_supporting_documents.upload_file(file_content,file_document_type)});$(document).on("click",".table-action-button-delete",function(){let get_document_id=parseInt($(this).attr("data-itemid"));bd_supporting_documents.remove_document(get_document_id)});$(document).on("click",".table-action-button-view",function(){bd_supporting_documents.view_document($(this))});bd_supporting_documents.get_document_type=function(sp_field_name){let document_type="";switch(sp_field_name){case"intitation-internally-captured-details-upload":document_type="internally captured details";break;case"evaluation-risk-factors-upload":document_type="risk factors";break;case"achieve-strategy-upload":document_type="client opportunities";break;case"reputational-risk-upload":document_type="reputational risk";break;case"skills-and-resources-upload":document_type="skills and available resources";break;case"profit-margins-upload":document_type="profitability";break;case"winning-probability-upload":document_type="tender probability";break;case"we-check-upload":document_type="independence issues";break;case"pong-upload":document_type="pong issues";break;case"hubspot-upload":document_type="hub spot issues";break;case"qrm-ac-upload":documents_type="qrm acceptance";break;case"dpa-nda-upload":document_type="dpa and nda";break}return document_type};bd_supporting_documents.upload_file=function(file_content,document_type){let file_meta={Title:file_content[0].name,DocumentType:document_type,FormReferenceId:app_configuration.form_reference_id.toString()};var upload_file=sharepoint_utilities.upload_file(file_content,file_meta,app_configuration.site_context,app_configuration.bd_supporting_documents_library);$.when(upload_file).done(function(){bd_supporting_documents.display_all_documents(app_configuration.form_reference_id.toString())})};bd_supporting_documents.view_document=function(selected_document){sharepoint_utilities.download_file(app_configuration.site_context,selected_document.attr("data-relative-url"),selected_document.attr("data-file-name"))};bd_supporting_documents.remove_document=function(document_id){var remove_document_confirmation=sharepoint_utilities.remove_item(app_configuration.bd_supporting_documents_library,app_configuration.site_context,document_id);$.when(remove_document_confirmation).done(function(document_type){bd_supporting_documents.display_all_documents(app_configuration.form_reference_id.toString());sharepoint_utilities.render_notification("Document removal","Your document was removed successfully","Info")})};bd_supporting_documents.display_all_documents=function(form_reference_id){var get_all_supporting_documents=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,FileLeafRef,FileRef","FormReferenceId eq '"+form_reference_id+"'",app_configuration.bd_supporting_documents_library,"Id desc");$.when(get_all_supporting_documents).done(function(get_all_supporting_documents_data){app_configuration["bd_supporting_documents_data"]=get_all_supporting_documents_data;let list_of_document_sections=["internally captured details","risk factors","client opportunities","reputational risk","skills and available resources","profitability","tender probability","independence issues","pong issues","hub spot issues","qrm acceptance","dpa and nda"];for(let index=0;index<list_of_document_sections.length;index++){const section_name=list_of_document_sections[index];let table_html=`
                <h3>Supporting Documents Uploaded</h3>
                <table id='${section_name.split(" ").join("-")}-supporting-documents-table' class='bd_supporting_documents_table table dataTable' style='width:100%;'>
                    <thead>
                        <tr>
                            <th class='table-header'>Ref Id</th>
                            <th class='table-header'>Type</th>    
                            <th class='table-header'>File Name</th>                            
                            <th class='table-header'>Last Modified</th>
                            <th class='table-header'>Actions</th>
                        </tr>
                    </thead>
                <tbody>
            `;for(let index=0;index<get_all_supporting_documents_data.length;index++){let current_row=get_all_supporting_documents_data[index];if(current_row.DocumentType==section_name){let action_buttons=`
                        <i title='view this file' 
                                class='menu-icon ms-Icon ms-Icon--View remove-supporting-document table-action-button-view'                    
                                data-itemid='${current_row["Id"]}'
                                data-relative-url='${current_row["FileRef"]}'
                                data-file-name='${current_row["FileLeafRef"]}'
                            >
                        </i>
                        <i title='remove this file' 
                                class='menu-icon ms-Icon ms-Icon--Delete remove-supporting-document table-action-button-delete'                    
                                data-itemid='${current_row["Id"]}'
                            >
                        </i>
                                
                    `;table_html+=`
                            <tr data-document-id='${current_row.Id}'>                     
                                <td>${current_row.Id}</td>
                                <td>${current_row.DocumentType}</td>
                                <td>${sharepoint_utilities.check_for_null(current_row.Title,"")}</td>  
                                <td>${moment(current_row.Modified).format(app_configuration.display_date_format)}</td>                   
                                <td>${action_buttons}</td>
                            </tr>
                        `}}table_html+=`   
                    </tbody>
                </table
            `;$("div[sp-field-name='"+section_name.split(" ").join("-")+"-supporting-documents-table']").html(table_html)}})};let consultations_app={};consultations_app.configurations={legacy_word_template_data:{}};$(document).on("click","ul[data-app-name='Consultations'] li",function(){let get_section_name=$(this).attr("data-link-id");render_navigation.show_section(get_section_name)});$(document).on("click","ul[data-app-name='Consultations'] li[data-link-id='Submit your rating feedback']",function(){consultations_app.render_form_fields(null);$("ul[data-app-name='Consultations'] li[data-link-id='Consultation Feedback']").click()});$(document).on("click","input[data-sp-element-name='sp-button-submit-consultation-feedback-review']",function(){consultations_app.submit_review()});$(document).on("change","input[data-sp-element-name='FeedbackType']",function(){consultations_app.form_rules()});consultations_app.render_form_fields=function(form_reference_id){let canvas=$(".page-section");main.add_loader();let section_names=["Not Available","Consultation Feedback"];canvas.html(main.create_form_sections(section_names));canvas.find("div[form-navigation-target='Not Available']").html(sharepoint_utilities.create_container_form(consultations_fields_configuration.not_available,"consultation-not-available-section"));canvas.find("div[form-navigation-target='Consultation Feedback']").html(sharepoint_utilities.create_container_form(consultations_fields_configuration.team_rating_fields,"consultations-team-feedback-section"));let consolidate_all_fields=sharepoint_utilities.consolidate_fields(consultations_fields_configuration);sharepoint_utilities.apply_form_plugins(consolidate_all_fields);if(form_reference_id){sharepoint_utilities.render_saved_values(form_reference_id,consultations_fields_configuration,app_configuration.consultations_list_name,2500,function(get_consultations_data){main["selected_consultation_data"]=get_consultations_data[0];consultations_app.Id=form_reference_id;consultations_app.form_rules();main.remove_loader();consultations_app.setup_legacy_template(main["selected_consultation_data"].ConsultationReferenceId);main.render_form_reference_number("QCF"+get_consultations_data[0].Id)},function(){})}else{main.remove_loader()}};consultations_app.form_rules=function(){let default_fields=["ConsultationReferenceId","FeedbackType","AdditionalFeedback"];let consultation_team_fields=["TechnicalQuality","Communication","TimeManagment","Professionalism"];let engagement_team_fields=["Clarity","Relevance","Research","SupportingDocuments"];let field_properties=sharepoint_utilities.get_field_values(["FeedbackType","Status"]);let feedback_fields=consultation_team_fields.concat(engagement_team_fields);sharepoint_utilities.hide_fields(feedback_fields);sharepoint_utilities.set_fields_as_not_required(feedback_fields);let fields_to_display=consultations_app.determine_form_field_per_team(field_properties.meta_package["FeedbackType"]);sharepoint_utilities.show_fields(fields_to_display);sharepoint_utilities.set_fields_as_required(fields_to_display);sharepoint_utilities.set_fields_as_not_required(["AdditionalFeedback"]);sharepoint_utilities.disable_fields(["FeedbackType"]);switch(field_properties.meta_package["Status"]){case"Completed":sharepoint_utilities.disable_all_fields_by_section("Consultation Feedback",["input","select","textarea","button"]);sharepoint_utilities.hide_fields(["sp-button-submit-consultation-feedback-review"]);break}};consultations_app.render_data_from_email=function(request_meta){$("#Left-sticky-menu li[title='Consultations']").click();render_navigation.render_by_link_click($("ul[data-app-name='Consultations'] li[data-link-id='Submit your rating feedback']"));render_navigation.render_by_link_click($("ul[data-app-name='Consultations'] li[data-link-id='Consultation Feedback']"));setTimeout(function(){consultations_app.render_form_fields(parseInt(request_meta.item_id));render_navigation.show_section("Consultation Feedback")},500)};consultations_app.submit_review=function(){let get_feedback_type=sharepoint_utilities.get_field_values(["FeedbackType"]).meta_package["FeedbackType"];let fields_to_validate=consultations_app.determine_form_field_per_team(get_feedback_type);let field_properties=sharepoint_utilities.get_field_values(fields_to_validate);let rating_message=consultations_app.create_rating_message();if(field_properties.IsValid){let CreatedById=consultations_app.configurations.original_data.AuthorId;let QRMConsultantId=consultations_app.configurations.original_data.QRMConsultantId;sharepoint_utilities.set_select_2_fields_by_value("Completed",$("select[data-sp-element-name='Status']"));consultations_app.save_or_update_form();if(field_properties.meta_package["FeedbackType"]=="Consultation Team"){consultations_app.create_notification_in_legacy_system(CreatedById,JSON.stringify(consultations_app.configurations.legacy_word_template_data),"Generate Final PDF",field_properties.meta_package["ConsultationReferenceId"],field_properties.meta_package["FeedbackType"]);consultations_app.create_notification_in_legacy_system(0,rating_message,"Feedback Survey Responses",field_properties.meta_package["ConsultationReferenceId"],field_properties.meta_package["FeedbackType"])}else{consultations_app.create_notification_in_legacy_system(CreatedById,rating_message,"Feedback Survey Responses",field_properties.meta_package["ConsultationReferenceId"],field_properties.meta_package["FeedbackType"]);consultations_app.create_notification_in_legacy_system(CreatedById,"","Requested Engagement Team Feedback Survey",field_properties.meta_package["ConsultationReferenceId"],field_properties.meta_package["FeedbackType"])}}else{sharepoint_utilities.render_notification("Survey Submission",field_properties.validation_message,"Warning")}};consultations_app.determine_form_field_per_team=function(feedback_type){let default_fields=["ConsultationReferenceId","FeedbackType","AdditionalFeedback"];let consultation_team_fields=["TechnicalQuality","Communication","TimeManagment","Professionalism"];let engagement_team_fields=["Clarity","Relevance","Research","SupportingDocuments"];let fields_to_display=[];switch(feedback_type){case"Consultation Team":fields_to_display=default_fields.concat(consultation_team_fields);break;case"Engagement Team":fields_to_display=default_fields.concat(engagement_team_fields);break}return fields_to_display};consultations_app.create_rating_message=function(){let get_meta_package=sharepoint_utilities.create_meta_package($(".consultations-team-feedback-section"));let consultation_team_fields=["TechnicalQuality","Communication","TimeManagment","Professionalism"];let engagement_team_fields=["Clarity","Relevance","Research","SupportingDocuments"];let consultation_display_names=["Technical Quality","Communication","Time Managment","Professionalism"];let engagement_display_names=["Clarity","Relevance","Research","Supporting Documents"];let rating_message=`
        <table>
            <thead>
                <tr>
                    <th colspan='2'>&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><b>Consultation Reference</b></td>
                    <td>${get_meta_package.meta_package["ConsultationReferenceId"]}</td>
                </tr>
                <tr>
                    <td colspan='2'>&nbsp;</td>                    
                </tr>
                <tr>
                    <td><b>Feedback Type</b></td>
                    <td>Consultation Feedback</td>
                </tr> 
    `;if(get_meta_package.meta_package["FeedbackType"]=="Consultation Team"){for(let index=0;index<consultation_team_fields.length;index++){const row_data=consultation_team_fields[index];rating_message+=`
                <tr>
                    <td><b>${consultation_display_names[index]}</b></td>
                    <td>${get_meta_package.meta_package[row_data]}</td>
                </tr>
            `}}if(get_meta_package.meta_package["FeedbackType"]=="Engagement Team"){for(let index=0;index<engagement_team_fields.length;index++){const row_data=engagement_team_fields[index];rating_message+=`
                <tr>
                    <td><b>${engagement_display_names[index]}</b></td>
                    <td>${get_meta_package.meta_package[row_data]}</td>
                </tr>
            `}}rating_message+=`
                <tr>
                    <td colspan='2'>&nbsp;</td>                    
                </tr>
                <tr>
                    <td colspan='2'><b>Additional Feedback</b></td>                    
                </tr>
                <tr>
                    <td colspan='2'>${sharepoint_utilities.check_for_null(get_meta_package.meta_package["AdditionalFeedback"],"")}</td>                    
                </tr>               
            </tbody>
        </table>
    `;return rating_message};consultations_app.save_or_update_form=function(){let get_meta_package=sharepoint_utilities.create_meta_package($(".consultations-team-feedback-section"));let field_properties=sharepoint_utilities.get_field_values(["AdditionalFeedback"]);if(field_properties.IsValid)if(get_meta_package.IsValid==true){if(consultations_app.Id){sharepoint_utilities.vaildate_meta_package_for_updates(get_meta_package,app_configuration.site_context,app_configuration.consultations_list_name,consultations_app.Id,function(){sharepoint_utilities.render_notification("Submitting Feedback","Please wait while we submit your feeback","Info");$("#Left-sticky-menu li[title='View dashboard']").click()},function(){})}else{sharepoint_utilities.vaildate_meta_package(get_meta_package,app_configuration.site_context,app_configuration.vendor_submission_list,function(result){consultations_app.form_reference_id=result.Id},function(){})}}else{sharepoint_utilities.render_notification("Submission of consultation feedback",get_meta_package.validation_message,"Warning")}};consultations_app.create_notification_in_legacy_system=function(assigned_to_id,message,notification_type,reference_id,NotificationProperties){let promise=$.Deferred();var meta_package={};meta_package["Title"]="New Notification";meta_package["Message"]=message;meta_package["AssignedToId"]=assigned_to_id;meta_package["NotificationType"]=notification_type;meta_package["AssociatedReferenceID"]=reference_id;meta_package["NotificationProperties"]=NotificationProperties;let create_item=sharepoint_utilities.save_item("GeneralNotifications","https://mazarsglobalcloud.sharepoint.com/sites/ZAF-QRM/QRM-Consulations/",meta_package);$.when(create_item).done(function(item_id){promise.resolve("done")});return promise.promise()};consultations_app.setup_legacy_template=function(consultation_reference_id){let get_list_items=sharepoint_utilities.get_list_items_by_title("https://mazarsglobalcloud.sharepoint.com/sites/ZAF-QRM/QRM-Consulations","*","Id eq "+consultation_reference_id,"QRMConsultations","Id desc");$.when(get_list_items).done(function(item_results){let legacy_consultation_data=item_results[0];consultations_app.configurations.original_data=legacy_consultation_data;var WordProperties={};WordProperties["Office"]=legacy_consultation_data.Office;WordProperties["MazarsLetterHead"]=legacy_consultation_data.MazarsLetterHead;WordProperties["Client"]=legacy_consultation_data.Client;WordProperties["Footer"]=legacy_consultation_data.MazarsFooter;WordProperties["Priority"]=legacy_consultation_data.Priority;WordProperties["YearEnd"]=legacy_consultation_data.Year_x0020_End;WordProperties["ChargeCode"]=legacy_consultation_data.ChargeCode;WordProperties["DeadlineDate"]=legacy_consultation_data.DeadlineDate;WordProperties["ListedCompany"]=legacy_consultation_data.ListedCompany;WordProperties["Category"]=legacy_consultation_data.Category;consultations_app.configurations.legacy_word_template_data=WordProperties})};let clp_action_buttons={};$(document).on("click","#Left-sticky-menu li[title='Client Listening Programme']",function(){$(".header-right-container-container").html("");main["selected_clp_data"]=[]});$(document).on("click","ul[data-app-name='Client Listening Programme'] li[data-link-id='New Survey']",function(){main["selected_clp_data"]=[];clp_business_rules.render_selected_form([])});$(document).on("click","ul[data-app-name='Client Listening Programme'] li[data-link-id='Help Guide']",function(){main["selected_clp_data"]=[];clp_business_rules.render_help_document()});$(document).on("click","div[app-name='Client Listening Programme'] input[data-sp-element-name='btn-submit-clp-request']",function(){if(app_configuration.form_reference_id){clp_business_rules.approve_and_send_survey_to_client()}else{clp_business_rules.create_new_survey_request()}});$(document).on("click","div[app-name='Client Listening Programme'] input[data-sp-element-name='btn-approve-clp-request']",function(){});$(document).on("change","div[app-name='Client Listening Programme'] select[data-sp-element-name='temp-search-client-name']",function(){let clientCodeField=$("div[app-name='Client Listening Programme'] [data-sp-element-name='clientCode']");let newValue=$(this).val();if(clientCodeField.length>0){sharepoint_utilities.set_field_value("clientCode",newValue);clp_business_rules.get_client_details(newValue)}let client_name=$(this).find(":selected").text();let clientNameField=$("div[app-name='Client Listening Programme'] [data-sp-element-name='clientName']");if(clientNameField.length>0){sharepoint_utilities.set_field_value("clientName",client_name);let isDisabled=clientNameField.is(":disabled");if(isDisabled){clientNameField.prop("disabled",false);clientNameField.val(client_name);clientNameField.prop("disabled",true)}else{clientNameField.val(client_name)}}client_risk_assesments.render_task_code_component(client_name,"taskCode")});$(document).on("change",".clp-drop-down-container div[sp-field-name='temp-clp-search'] select[data-sp-element-name='clp-overview-search-client-name']",function(){let selectedClient=$(this).find(":selected").text();clp_app_main.render_submissions_by_client(selectedClient)});$(document).on("click","#clp_submissions_table tbody tr td .clp-reminder-request",function(){clp_action_buttons.send_reminder_request($(this).attr("data-itemid"))});$(document).on("click","#clp_submissions_table tbody tr td .clp-view-submission",function(){clp_app_main["mode"]="view";let item_id=$(this).attr("data-itemid");clp_app_main.render_submission_details(item_id)});$(document).on("click","#clp_submissions_table tbody tr td .clp-open-form",function(){clp_app_main["mode"]="edit";let item_id=$(this).attr("data-itemid");clp_app_main.render_submission_details(item_id)});$(document).on("click","#clp_submissions_table tbody tr td .clp-view-feedback",function(){clp_app_main.render_survey_feedback($(this))});$(document).on("click","#clp_deletion_requests_table tbody tr td .clp-approve-deletion",function(){let clicked_action_button=$(this);let itemId=$(this).attr("data-itemid");sharepoint_utilities.render_notification("Approve Deletion","Please wait while we process your approval","Info");clp_app_main.create_general_notification(itemId,"Removal Approved");let meta_package={surveyStatus:"Removal Approved"};let update_item=sharepoint_utilities.update_item(app_configuration.clp_list_name,app_configuration.site_context,meta_package,parseInt(itemId));$.when(update_item).done(function(){clicked_action_button.parent().parent().remove()})});$(document).on("click","#clp_deletion_requests_table tbody tr td .clp-reject-deletion",function(){let clicked_action_button=$(this);let itemId=$(this).attr("data-itemid");let box_button_options={Yes:function(){continue_to_reject(clicked_action_button);return false},No:function(){}};let rejectionJustificationField=[{Title:"Reject Reason",Description:"Please provide a reason for rejecting the removal request",sp_field_name:"RejectReason",sp_field_type:"textarea",field_width:"full-width",field_validate:true,sp_additional_properties:"none",field_icon:"Edit"}];let container_html=`
        <div>
            <p>Are you sure you want to reject this removal request?</p>
            <div id='rejection-options'></div>
        </div>
    `;sharepoint_utilities.render_confirmation_box("Reject Removal Request",container_html,box_button_options,"30%");setTimeout(function(){$("#rejection-options").html(sharepoint_utilities.create_container_form(rejectionJustificationField,"rejection-details-form-fields"));sharepoint_utilities.apply_form_plugins(rejectionJustificationField)},500);function continue_to_reject(clicked_action_button){let field_properties=sharepoint_utilities.get_field_values(["RejectReason"]);if(field_properties.IsValid){sharepoint_utilities.render_notification("Reject Deletion","Please wait while we process your rejection","Info");clp_app_main.create_general_notification(itemId,"Removal Rejected");let meta_package={surveyStatus:"Removal Rejected",RejectReason:field_properties.meta_package["RejectReason"]};let update_item=sharepoint_utilities.update_item(app_configuration.clp_list_name,app_configuration.site_context,meta_package,itemId);$.when(update_item).done(function(){setTimeout(function(){clicked_action_button.parent().parent().remove();sharepoint_utilities.close_container_window($(".confirmation-box_content-title"))},1e3)})}else{sharepoint_utilities.render_notification("Reject Deletion","Please fill in all required fields","Warning")}}});$(document).on("click","ul[data-app-name='Client Listening Programme'] li[data-link-id='Submit a Survey']",function(){$("ul[data-app-name='Client Listening Programme']").addClass("disable-interaction");clp_app_main.render_submissions_table()});$(document).on("click","ul[data-app-name='Client Listening Programme'] li[data-link-id='View Submissions']",function(){$("ul[data-app-name='Client Listening Programme']").addClass("disable-interaction");clp_app_main.render_submissions_table()});$(document).on("click","ul[data-app-name='Client Listening Programme'] li[data-link-id='Removal Requests']",async function(){const isAdmin=app_configuration.is_clp_admin;if(isAdmin){$("ul[data-app-name='Client Listening Programme']").addClass("disable-interaction");clp_app_main.render_deletion_requests_table()}else{sharepoint_utilities.render_notification("Access Denied","You do not have permission to view Removal Requests.","Warning")}});$(document).on("click","#clp_submissions_table tbody tr td .clp-deletion-request",function(){let itemId=$(this).attr("data-itemid");let box_button_options={Yes:function(){continue_to_remove();return false},No:function(){}};let removalJustificationField=[{Title:"Reason",Description:"Please add your reason",sp_field_name:"RemovalReason",sp_field_type:"select",field_width:"half-width",field_validate:true,sp_additional_properties:"single-select-drop-down-own-values",own_values:["Duplicate","Proposal not accepted","No longer a client","Other"],field_icon:"ActionCenter"},{Title:"Justification",Description:"Please provide additional justification for the removal",sp_field_name:"RemovalJustification",sp_field_type:"textarea",field_width:"full-width",field_validate:true,sp_additional_properties:"none",field_icon:"Edit"}];let container_html=`
        <div>
            <p>Are you sure you want to request the removal of this survey? You will lose access to this item.</p>
            <div id='removal-options'></div>
        </div>
    `;sharepoint_utilities.render_confirmation_box("Request Deletion",container_html,box_button_options,"30%");setTimeout(function(){$("#removal-options").html(sharepoint_utilities.create_container_form(removalJustificationField,"removal-details-form-fields"));sharepoint_utilities.apply_form_plugins(removalJustificationField)},500);function continue_to_remove(){let field_properties=sharepoint_utilities.get_field_values(["RemovalReason","RemovalJustification"]);if(field_properties.IsValid){sharepoint_utilities.render_notification("Request Deletion","Please wait while we process your request","Info");clp_app_main.create_general_notification(itemId,"Removal Requested");let meta_package={surveyStatus:"Removal Requested",RemovalReason:field_properties.meta_package["RemovalReason"],RemovalJustification:field_properties.meta_package["RemovalJustification"]};let update_item=sharepoint_utilities.update_item(app_configuration.clp_list_name,app_configuration.site_context,meta_package,itemId);$.when(update_item).done(function(){setTimeout(function(){clp_app_main.render_submissions_table();sharepoint_utilities.close_container_window($(".confirmation-box_content-title"))},1e3)})}else{sharepoint_utilities.render_notification("Request Deletion","Please fill in all required fields","Warning")}}});clp_action_buttons.send_reminder_request=function(reference_id){let paragraph="You are about to send a reminder to the select client. Are you sure you want to do this?";let reminder_function={yes:function(){clp_action_buttons.send_reminder_notification(reference_id)},no:function(){return true}};sharepoint_utilities.render_confirmation_box("Send Reminder Action",paragraph,reminder_function,"50%")};clp_action_buttons.send_reminder_notification=function(reference_id){sharepoint_utilities.render_notification("Reminder Notification","Please wait while we send out the reminder","Info");clp_app_main.create_general_notification(reference_id,"Reminder Notification")};let clp_app_main={};clp_app_main.check_clp_permissions=function(){return new Promise(resolve=>{let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","AdminId eq '"+_spPageContextInfo.userId+"'",app_configuration.clp_admin_list,"Id desc");$.when(get_list_items).done(function(item_results){let permissions={admin:false,pa_admin:false,pa_admin_filter:""};for(let index=0;index<item_results.length;index++){const item_row=item_results[index];if(item_row.Title=="Admin"){permissions.admin=true}if(item_row.Title=="PA Admin"){permissions.pa_admin=true}if(item_row.AssociatedPartnersId){permissions.pa_admin_filter=create_pa_partner_filter(item_row.AssociatedPartnersId)}}resolve(permissions)})});function create_pa_partner_filter(array_of_partner_ids){let filter=" or ";for(let index=0;index<array_of_partner_ids.length;index++){const element=array_of_partner_ids[index];filter+="(partnerId eq "+element+" ) or "}filter=filter.slice(0,-4);return filter}};clp_app_main.render_submissions_table=function(){clp_app_main.render_submissions_by_client("")};clp_app_main.render_deletion_requests_table=async function(){const isAdmin=app_configuration.is_clp_admin;if(!isAdmin){$(".page-section").html("<p>You do not have permission to view this content.</p>");return}var filter="surveyStatus eq 'Removal Requested'";var get_deletion_requests=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,Title,clientName,clientCode,clientContactName,clientContactEmail,taskCode,Period,surveyStatus,Modified,RemovalJustification,RemovalReason",filter,app_configuration.clp_list_name,"Modified desc");$.when(get_deletion_requests).done(function(deletionData){let table_html=`
            <div class="clp-table-wrapper" style="width: 100%;">
                <div class="clp-drop-down-container" style="width: 100%;">
                    <div sp-field-name="temp-clp-search" class="field-component" style="margin-bottom: 20px;"></div>
                    <div sp-field-name="temp-clp-table" class="field-component">
                        <table id="clp_deletion_requests_table" class="table-dashboard accordion-table table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Client Name</th>
                                    <th>Client Code</th>
                                    <th>Task Code</th>                                     
                                    <th>Survey Status</th>
                                    <th>Removal Reason</th>
                                    <th>Removal Justification</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>`;deletionData.forEach(function(item){let actionButtons=`
                <i title="Approve" class="menu-icon ms-Icon ms-Icon--CheckMark clp-approve-deletion" data-itemid="${item.Id}" style="margin-right: 8px; color: green;"></i>
                <i title="Reject" class="menu-icon ms-Icon ms-Icon--Blocked clp-reject-deletion" data-itemid="${item.Id}" style="color: red;"></i>
            `;table_html+=`
                <tr data-itemid="${item.Id}">
                    <td>${item.Title||""}</td>
                    <td>${item.clientName||""}</td>
                    <td>${item.clientCode||""}</td>   
                    <td>${item.surveyStatus||""}</td>
                    <td>${item.RemovalReason||""}</td>
                    <td>${item.RemovalJustification||""}</td>
                    <td>${moment(item.Modified).format(app_configuration.display_date_format)}</td>
                    <td class="table-action-buttons-cell">${actionButtons}</td>
                </tr>`});table_html+=`
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;$(".page-section").html(table_html);$("#clp_deletion_requests_table").DataTable({pageLength:10,bLengthChange:true,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],dom:'<"top"lf>rt<"bottom"ip><"clear">',drawCallback:function(){$("#clp_deletion_requests_table_length select").css({width:"auto"});$("#clp_deletion_requests_table_filter input").css({width:"auto","min-width":"200px"});$(".dataTables_wrapper").css("width","100%")}});$("ul[data-app-name='Client Listening Programme']").removeClass("disable-interaction")})};clp_app_main.trigger_action_buttons=function(selected_action){let item_id=selected_action.attr("data-itemid");clp_app_main.render_submission_details(item_id)};clp_app_main.render_submission_details=function(item_id){let consolidated_fields=sharepoint_utilities.consolidate_fields(clp_field_configuration);let query=sharepoint_utilities.generate_query_for_expanded_fields(consolidated_fields);var get_submission=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,query,"Id eq '"+item_id+"'",app_configuration.clp_list_name,"Id desc");$.when(get_submission).done(function(item_results){if(item_results.length>0){app_configuration.form_reference_id=item_id;main["selected_clp_data"]=item_results;clp_business_rules.render_selected_form(item_results)}})};clp_app_main.render_submissions_by_client=function(client_name){var filter="( "+"(partnerId eq "+_spPageContextInfo.userId+") or "+"(managersId eq "+_spPageContextInfo.userId+") or "+"(AuthorId eq "+_spPageContextInfo.userId+")"+app_configuration.pa_admin_filter+") and "+"surveyStatus ne 'Removal Approved'";if(client_name){filter="clientName eq '"+main.clean_client_name(client_name)+"' and surveyStatus ne 'Removal Approved'"}var get_all_clp_submissions=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,Title,clientName,clientCode,clientContactName,clientContactEmail,taskCode,Period,surveyStatus,Modified,partnerId,managersId",filter,app_configuration.clp_list_name,"Modified desc");$.when(get_all_clp_submissions).done(function(submissionData){let table_html=`
            <div class="clp-table-wrapper" style="width: 100%;">
                <div class="clp-drop-down-container" style="width: 100%;">
                    <div sp-field-name="temp-clp-search" class="field-component" style="margin-bottom: 20px;"></div>
                    <div sp-field-name="temp-clp-table" class="field-component">
                        <table id="clp_submissions_table" class="table-dashboard accordion-table table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Client Name</th>
                                    <th>Client Code</th>                                 
                                    <th>Survey Status</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>`;if(submissionData.length>0){let userIds=new Set;submissionData.forEach(item=>{if(item.partnerId)userIds.add(item.partnerId);if(item.managersId&&Array.isArray(item.managersId))item.managersId.forEach(id=>userIds.add(id))});let userQuery=Array.from(userIds).map(id=>`Id eq ${id}`).join(" or ");let userEndpoint=`${app_configuration.people_picker_site_context}/_api/web/lists/getbytitle('User Information List')/items?$select=Id,Title&$filter=${encodeURIComponent(userQuery)}`;$.when(sharepoint_utilities.get_items_by_url(userEndpoint)).done(function(userData){let usersMap={};userData.forEach(user=>usersMap[user.Id]=user.Title);renderTable(submissionData,usersMap)}).fail(function(error){console.error("Failed to fetch user data:",error);renderTable(submissionData,{})})}else{renderTable(submissionData,{})}function renderTable(data,usersMap){data.forEach(function(item){let isUserAssigned=item.partnerId===_spPageContextInfo.userId||item.managersId&&Array.isArray(item.managersId)&&item.managersId.includes(_spPageContextInfo.userId)||app_configuration.is_clp_admin||app_configuration.is_pa_admin;let actionButtons=`<i title="View Submission" class="menu-icon ms-Icon ms-Icon--View clp-view-submission" style="margin-right: 8px;" data-itemid="${item.Id}" data-app-name="clp"></i>`;if(isUserAssigned){if(item.surveyStatus==="Feedback Received"){actionButtons+=`<i title="View Feedback" class="menu-icon ms-Icon ms-Icon--Comment clp-view-feedback" style="margin-right: 8px;" data-itemid="${item.Id}" data-app-name="clp"></i>`}if(item.surveyStatus==="Pending Submission"||item.surveyStatus==="Removal Rejected"||item.surveyStatus=="Pending Partner Approval"){actionButtons+=`<i title="Open Form" class="menu-icon ms-Icon ms-Icon--Edit clp-open-form" data-itemid="${item.Id}" data-app-name="clp"></i>`}if(item.surveyStatus=="Pending Partner Approval"){actionButtons=`<i title="Open Form" class="menu-icon ms-Icon ms-Icon--Edit clp-open-form" data-itemid="${item.Id}" data-app-name="clp"></i>`}if(item.surveyStatus=="Submitted - Pending Response"||item.surveyStatus=="Submitted"){actionButtons+=`<i title="Request Deletion" class="menu-icon ms-Icon ms-Icon--Delete clp-deletion-request" style="margin-left:8px;" data-itemid="${item.Id}" data-app-name="clp"></i>`}if(item.surveyStatus=="Submitted - Pending Response"){actionButtons+=`<i title="Send a reminder" class="menu-icon ms-Icon ms-Icon--MailReminder clp-reminder-request" style="margin-left:8px;" data-itemid="${item.Id}" data-app-name="clp"></i>`}}table_html+=`<tr data-itemid="${item.Id}">
                        <td>${item.Id}</td>
                        <td>${item.clientName||""}</td>
                        <td>${item.clientCode||""}</td>                        
                        <td>${item.surveyStatus||""}</td>
                        <td>${moment(item.Modified).format(app_configuration.display_date_format)}</td>
                        <td class="table-action-buttons-cell">${actionButtons}</td>
                    </tr>`});table_html+=`
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;$(".page-section").html(table_html);let search_field=[{Title:"Search client details",Description:"Use the search box to find your client and associated client code from greatsoft.",sp_field_name:"clp-overview-search-client-name",sp_field_type:"select",field_width:"full-width",field_validate:true,sp_additional_properties:"exclude-from-meta single-select-typeahead plain-text-field",additional_filters:"",drop_down_title_field:"M_ClientName",drop_down_value_field:"M_ClientCode",drop_down_order_by:"Title asc",list_name:app_configuration.client_list_name,site_context:app_configuration.client_list_site_context,field_icon:"ContactList"}];let search_html=sharepoint_utilities.create_container_form(search_field,"clp-search-section");$(".clp-drop-down-container div[sp-field-name='temp-clp-search']").html(search_html);sharepoint_utilities.apply_form_plugins(search_field);$("#clp_submissions_table").DataTable({pageLength:10,bLengthChange:true,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],dom:'<"top"lf>rt<"bottom"ip><"clear">',drawCallback:function(){$("#clp_submissions_table_length select").css({width:"auto"});$("#clp_submissions_table_filter input").css({width:"auto","min-width":"200px"});$(".dataTables_wrapper").css("width","100%")}});$("ul[data-app-name='Client Listening Programme']").removeClass("disable-interaction")}})};clp_app_main.render_survey_feedback=function(selected_action){let item_id=selected_action.attr("data-itemid");var get_submission=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","Id eq '"+item_id+"'",app_configuration.clp_list_name,"Id desc");$.when(get_submission).done(function(original_request_details){if(original_request_details.length>0){var get_results=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*","AssociatedReferenceId eq '"+item_id+"'","CLPResponses","Id desc");$.when(get_results).done(function(survey_response_details){if(survey_response_details.length>0){$(".page-section").html("<div class='clp-survey-results-container'></div>");let all_survey_responses=survey_response_details;clp_survey_results_page.render_results(original_request_details[0],survey_response_details[0],all_survey_responses)}else{$(".page-section").html("<p>No survey results found for this submission.</p>")}}).fail(function(error){$(".page-section").html("<p>Error fetching survey results.</p>")})}else{$(".page-section").html("<p>Submission not found.</p>")}})};clp_app_main.render_data_from_email=function(request_meta){$("#Left-sticky-menu li[title='Client Listening Programme']").click();var get_submission=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"Id,surveyStatus,partnerId,managersId","Id eq '"+parseInt(request_meta.item_id)+"'",app_configuration.clp_list_name,"Id desc");$.when(get_submission).done(function(item_results){if(item_results.length>0){let item=item_results[0];let surveyStatus=item.surveyStatus||"";let partnerId=item.partnerId||null;let managersId=item.managersId&&Array.isArray(item.managersId)?item.managersId:[];let mode="read";let currentUserId=_spPageContextInfo.userId;let isAuthorized=partnerId===currentUserId||managersId.includes(currentUserId)||app_configuration.is_clp_admin||app_configuration.is_pa_admin;if(isAuthorized&&surveyStatus==="Pending Submission"){mode="edit"}else if(!isAuthorized&&surveyStatus==="Pending Submission"){sharepoint_utilities.render_notification("Access Restriction","You do not have permission to edit this submission. It is opened in read-only mode.","Warning")}setTimeout(function(){if(surveyStatus==="Feedback Received"){let fakeElement=$("<div></div>").attr("data-itemid",item.Id);clp_app_main.render_survey_feedback(fakeElement)}else{clp_app_main.render_submission_details(parseInt(request_meta.item_id),mode)}},500)}else{sharepoint_utilities.render_notification("Error","No submission found for the provided ID.","Warning");$(".page-section").html("<p>No submission found for the provided ID.</p>")}}).fail(function(error){sharepoint_utilities.render_notification("Error","Error loading submission details.","Warning");$(".page-section").html("<p>Error loading submission details.</p>")})};clp_app_main.create_general_notification=function(Reference_Id,NotificationType){let meta_package={Title:"New Notification",NotificationType:NotificationType,AssociatedReferenceID:Reference_Id};let create_item=sharepoint_utilities.save_item(app_configuration.clp_general_notifications,app_configuration.site_context,meta_package)};let clp_business_rules={};clp_business_rules.render_help_document=function(){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");let clp_form_container_html=clp_business_rules.create_form_sections(["Help Guide"]);$(".page-section").html(clp_form_container_html);$("div[form-navigation-target='Help Guide']").html(sharepoint_utilities.create_container_form(clp_help_guide_configuration.help_fields,"client-survey-help-section"));sharepoint_utilities.apply_form_plugins(clp_help_guide_configuration.help_fields);setTimeout(function(){canvas.removeClass("hide");$(".page-loader-header").addClass("hide");canvas.find("div[form-navigation-target='Help Guide']").removeClass("hide")},800)};clp_business_rules.render_selected_form=function(data_result){let canvas=$(".page-section");canvas.addClass("hide");$(".page-loader-header").removeClass("hide");let clp_form_container_html=clp_business_rules.create_form_sections(["Client Survey Programme"]);$(".page-section").html(clp_form_container_html);$("div[form-navigation-target='Client Survey Programme']").html(sharepoint_utilities.create_container_form(clp_field_configuration.survey_form,"client-survey-section"));sharepoint_utilities.apply_form_plugins(clp_field_configuration.survey_form);let client_name="";setTimeout(()=>{if(data_result.length>0){client_name=data_result[0].clientName;sharepoint_utilities.display_saved_list_fields(data_result,clp_field_configuration.survey_form,".client-survey-section");clp_business_rules.handle_form_status(data_result[0].surveyStatus);clp_business_rules.handle_view_modes(clp_app_main["mode"])}else{let period_value=moment().format("YYYY")+moment().quarter();sharepoint_utilities.set_field_value("Period",period_value)}client_risk_assesments.render_task_code_component(client_name,"taskCode");canvas.removeClass("hide");$(".page-loader-header").addClass("hide");canvas.find("div[form-navigation-target='Client Survey Programme']").removeClass("hide")},2e3)};clp_business_rules.create_form_sections=function(array_of_sections){let section_html="<div id='field_section_container'>";for(let index=0;index<array_of_sections.length;index++){const section=array_of_sections[index];section_html+=`
            <div form-navigation-target='${section}' class='page-section-form-container hide'></div>
        `}section_html+="</div>";return section_html};clp_business_rules.handle_view_modes=function(view_mode){switch(view_mode){case"view":sharepoint_utilities.lock_form($("div[form-navigation-target='Client Survey Programme']"));break;default:break}};clp_business_rules.handle_form_status=function(form_status){sharepoint_utilities.hide_fields(["btn-submit-clp-request","btn-approve-clp-request"]);switch(form_status){case"Pending Partner Approval":sharepoint_utilities.show_fields(["btn-submit-clp-request"]);break;case"Submitted":break;case"Submitted - Pending Response":break;case"Feedback Received":break;case"Removal Requested":break;case"Removal Approved":break;case"Removal Rejected":sharepoint_utilities.show_fields(["btn-approve-clp-request"]);break}};clp_business_rules.get_client_details=function(client_code){let get_client_details=sharepoint_utilities.get_list_items_by_title(app_configuration.client_list_site_context,"*","M_ClientCode eq '"+client_code+"'",app_configuration.client_list_name,"Id desc");let get_ac_details=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"ClientServiceLine,RequestOffice,EngagementManager/Title,EngagementManager/Id,EngagementPartner/Id,EngagementPartner/EMail"+"&$expand=EngagementManager/Title,EngagementManager/Id,EngagementPartner/Id,EngagementPartner/EMail","ClientCode eq '"+client_code+"'",app_configuration.ac_submission,"Id desc");$.when(get_client_details,get_ac_details).done(function(client_results,ac_results){if(ac_results.length>0){sharepoint_utilities.set_field_value("office",ac_results[0].RequestOffice);sharepoint_utilities.set_field_value("serviceLine",ac_results[0].ClientServiceLine);sharepoint_utilities.force_select_2_value(ac_results[0].EngagementPartner.EMail,ac_results[0].EngagementPartner.Id,$("select[data-sp-element-name='partnerId']"));$("select[data-sp-element-name='managersId']").html(`<option value='${ac_results[0].EngagementManager.Id}'>${ac_results[0].EngagementManager.Title}</option>`);$("select[data-sp-element-name='managersId']").val([ac_results[0].EngagementManager.Id]);$("select[data-sp-element-name='managersId']").trigger("change.select2")}if(client_results.length>0){sharepoint_utilities.set_field_value("clientContactName",client_results[0].M_ClientContactName);sharepoint_utilities.set_field_value("clientContactEmail",client_results[0].M_ClientContactEmail);sharepoint_utilities.set_field_value("clientContactPhone",client_results[0].M_ClientContactPhone);sharepoint_utilities.set_field_value("clientGroupCode",client_results[0].ClientGroupCode)}})};clp_business_rules.approve_and_send_survey_to_client=function(){let reference_id=parseInt(app_configuration.form_reference_id);let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Client Survey Programme'] > div"));sharepoint_utilities.render_notification("Checking your approval","Please wait while we check your approval","Info|Warning");if(get_meta_package.IsValid){sharepoint_utilities.set_field_value("surveyStatus","Submitted");let update_item=sharepoint_utilities.update_item(app_configuration.clp_list_name,app_configuration.site_context,get_meta_package.meta_package,reference_id);$.when(update_item).done(function(){sharepoint_utilities.render_notification("Submission Success","Please wait while we send out the approval notification","Info");clp_app_main.create_general_notification(reference_id.toString(),"Submitted");$("#Left-sticky-menu li[title='Client Listening Programme']").click()})}else{sharepoint_utilities.render_notification("Cannot Approve Submission",get_meta_package.validation_message,"Warning")}};clp_business_rules.create_new_survey_request=function(){let field_properties=sharepoint_utilities.get_field_values(["taskCode","clientCode","Period"]);sharepoint_utilities.render_notification("Checking your submission details","Please wait while we validate your submission","Info");$.when(clp_business_rules.check_for_duplicate_submission()).done(function(no_duplicate_exists){if(no_duplicate_exists){sharepoint_utilities.set_field_value("surveyStatus","Submitted");sharepoint_utilities.set_field_value("Title",clp_business_rules.create_unique_title(field_properties.meta_package));let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Client Survey Programme'] > div"));let field_values=clp_business_rules.clean_fields(get_meta_package.meta_package);let valid_email=clp_business_rules.validate_email(field_values["clientContactEmail"]);if(valid_email){if(get_meta_package.IsValid){let create_item=sharepoint_utilities.save_item(app_configuration.clp_list_name,app_configuration.site_context,field_values);$.when(create_item).done(function(item_id){clp_app_main.create_general_notification(item_id.Id.toString(),"Submitted");sharepoint_utilities.render_notification("Submission Success","Please wait while we send out the approval notification","Info");$("#Left-sticky-menu li[title='Client Listening Programme']").click()})}else{sharepoint_utilities.render_notification("Cannot submit",get_meta_package.validation_message,"Warning")}}}})};clp_business_rules.validate_email=function(email_address){var emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;let is_valid=true;if(!emailRegex.test(email_address)){sharepoint_utilities.render_notification("Cannot submit","Please provide a valid email address.","Warning");is_valid=false}return is_valid};clp_business_rules.clean_fields=function(meta_package){for(const[key,value]of Object.entries(meta_package)){if(value){if(typeof value==="string"){meta_package[key]=value.trim()}}}return meta_package};clp_business_rules.create_unique_title=function(get_meta_package){let clientCode=get_meta_package["clientCode"]||"";let taskCode=get_meta_package["taskCode"]||"";let period=get_meta_package["Period"]||"";let unique_str=clientCode+"-"+taskCode+"-"+period;let hash=CryptoJS.MD5(unique_str).toString().substring(0,8).toUpperCase();let generated_title="CLP-"+hash;return generated_title};clp_business_rules.check_for_duplicate_submission=function(){let CreatePromise=$.Deferred();let no_duplicate_exists=false;let get_meta_package=sharepoint_utilities.create_meta_package($("div[form-navigation-target='Client Survey Programme'] > div")).meta_package;sharepoint_utilities.hide_fields(["btn-submit-clp-request"]);let duplicate_filter="Period eq '"+get_meta_package["Period"]+"' "+"and clientGroupCode eq '"+get_meta_package["clientGroupCode"]+"'"+" and taskCode eq '"+get_meta_package["taskCode"]+"'"+" and surveyStatus eq 'Submitted'";let get_list_items=sharepoint_utilities.get_list_items_by_title(app_configuration.site_context,"*,Author/Title&$expand=Author/Title",duplicate_filter,app_configuration.clp_list_name,"Id desc");$.when(get_list_items).done(function(item_results){if(item_results.length>0){sharepoint_utilities.render_notification("Survey already exists","A submission (##"+item_results[0].Id+" - "+item_results[0].surveyStatus+") submitted by "+item_results[0].Author.Title+" already exists for this quarter and task code ("+item_results[0].taskCode+")","Warning");no_duplicate_exists=false}else{sharepoint_utilities.show_fields(["btn-submit-clp-request"]);no_duplicate_exists=true}CreatePromise.resolve(no_duplicate_exists)});return CreatePromise.promise()};let clp_survey_results_page={};$(document).on("change","input[data-sp-element-name='surveyResultsDropdown']",function(){clp_survey_results_page.render_selected_survey_record_from_options($(this).val())});clp_survey_results_page.render_results=function(original_request_data,survey_data,all_survey_data){let parse_response=JSON.parse(survey_data.ResponseJSON);let version_number=clp_survey_results_page.determine_version(parse_response);let field_set_to_use={};switch(version_number){case"1":field_set_to_use=clp_survey_results_field_configuration;break;case"2":field_set_to_use=clp_survey_results_field_configuration_v2;break}$(".clp-survey-results-container").html(sharepoint_utilities.create_container_form(field_set_to_use.survey_results_fields,"qualtrics-responses"));let survey_record_selector=[];for(let s_index=0;s_index<all_survey_data.length;s_index++){const row_item=all_survey_data[s_index];extract_info=JSON.parse(row_item.ResponseJSON);survey_record_selector.push(extract_info.responseId+" - "+moment(extract_info.values.recordedDate).format("DD/MM/YYYY HH:mm:ss"))}field_set_to_use.survey_results_fields[2].own_values=survey_record_selector;let all_fields=sharepoint_utilities.consolidate_fields(field_set_to_use);sharepoint_utilities.apply_form_plugins(all_fields);sharepoint_utilities.display_saved_list_fields([original_request_data],all_fields,null);let parse_survey_results=parse_response.labels;for(let key in parse_survey_results){if(parse_survey_results.hasOwnProperty(key)){let selected_response_value=parse_survey_results[key];if(key.indexOf("_")==-1){if(Array.isArray(selected_response_value)){selected_response_value=selected_response_value.join(",")}$("input[data-sp-element-name*='"+key+"']").val(sharepoint_utilities.check_for_null(selected_response_value,"N/A"));$("textarea[data-sp-element-name*='"+key+"']").val(sharepoint_utilities.check_for_null(selected_response_value,"N/A"))}}}let custom_survey_results=parse_response.values;switch(version_number){case"1":clp_survey_results_page.render_version_1_dataset(custom_survey_results,parse_response);break;case"2":clp_survey_results_page.render_version_2_dataset(custom_survey_results,parse_response);break}clp_survey_results_page["cached_survey_responses"]=all_survey_data;clp_survey_results_page["cached_original_requests_data"]=original_request_data};clp_survey_results_page.determine_version=function(survey_results){let version_number="";if(survey_results.displayedFields[0].indexOf("QID1216")>=0){version_number="1"}else if(survey_results.displayedFields[0].indexOf("QID1218")>=0){version_number="2"}return version_number};clp_survey_results_page.render_version_2_dataset=function(custom_survey_results,parse_response){let table_data_set=[{title:"Client Needs.",description:"Forvis Mazars listens to understand my needs.",survey_field:"QID1218456923_1"},{title:"Expertise.",description:"Forvis Mazars is very responsive to my requests.",survey_field:"QID1218456923_2"},{title:"Project Management.",description:"Forvis Mazars meets my deadlines.",survey_field:"QID1218456923_3"},{title:"Responsiveness.",description:" Forvis Mazars communicates proactively.",survey_field:"QID1218456923_4"},{title:"Service Quality.",description:"Forvis Mazars provides consistent service across departments and/or geographies.",survey_field:"QID1218456923_5"},{title:"Value Add.",description:"Forvis Mazars demonstrates deep industry knowledge.",survey_field:"QID1218456923_6"},{title:"Business Understanding.",description:"Forvis Mazars delivers outstanding quality of service.",survey_field:"QID1218456923_7"}];sharepoint_utilities.set_field_value("OutcomeDate",moment(custom_survey_results.recordedDate).format("ll"));sharepoint_utilities.set_field_value("surveyResultsDropdown",parse_response.responseId+" - "+moment(custom_survey_results.recordedDate).format("DD/MM/YYYY HH:mm:ss"));sharepoint_utilities.set_field_value("QID1218456927_NPS_GROUP_Display",parse_response.labels.QID1218456927_NPS_GROUP);sharepoint_utilities.set_field_value("QID1218456927",custom_survey_results.QID1218456927);sharepoint_utilities.set_field_value("QID1218456926_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456926_TEXT,"N/A"));sharepoint_utilities.set_field_value("QID1218456925_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456925_TEXT,"N/A"));sharepoint_utilities.set_field_value("QID1218456924_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456924_TEXT,"N/A"));sharepoint_utilities.set_field_value("QID1218456916_10_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456916_10_TEXT,"N/A"));sharepoint_utilities.set_field_value("QID1218456928_11_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456928_11_TEXT,"N/A"));sharepoint_utilities.set_field_value("QID1218456920_14_TEXT",sharepoint_utilities.check_for_null(custom_survey_results.QID1218456920_14_TEXT,"N/A"));$("div[sp-field-name='feedback_ratings'] .field-component").html(clp_survey_results_page.render_feedback_and_ratings_table(table_data_set,parse_response.labels));$("div[sp-field-name='feedback_ratings'] .field-component").find("#feedback_ratings_table").dataTable({searching:false,paging:false,info:false})};clp_survey_results_page.render_version_1_dataset=function(custom_survey_results,parse_response){sharepoint_utilities.set_field_value("OutcomeDate",moment(custom_survey_results.recordedDate).format("ll"));sharepoint_utilities.set_field_value("QID1216014158_NPS_GROUP_Display",parse_response.labels.QID1216014158_NPS_GROUP);sharepoint_utilities.set_field_value("QID1216014158_Value",custom_survey_results.QID1216014158);if(!custom_survey_results.QID1216014153){sharepoint_utilities.set_field_value("QID1216014153_Display","N/A")}if(!custom_survey_results.QID1216014161){sharepoint_utilities.set_field_value("QID1216014161_Display","N/A")}sharepoint_utilities.set_field_value("surveyResultsDropdown",parse_response.responseId+" - "+moment(custom_survey_results.recordedDate).format("DD/MM/YYYY HH:mm:ss"));$("div[sp-field-name='QID1216014150_TEXT_Value'] .field-component").html(sharepoint_utilities.check_for_null(custom_survey_results.QID1216014150_TEXT,"N/A"));$("div[sp-field-name='QID1216014149_TEXT_Value'] .field-component").html(sharepoint_utilities.check_for_null(custom_survey_results.QID1216014149_TEXT,"N/A"));let table_data_set=[{title:"Deadline Adherence",description:"How well we met the project deadlines.",survey_field:"QID1216014151_16"},{title:"Expertise",description:"Rating on our technical and professional expertise.",survey_field:"QID1216014151_15"},{title:"Project Management",description:"Feedback on the effectiveness of our project management approach.",survey_field:"QID1216014151_11"},{title:"Responsiveness",description:"How promptly our team responded to the client's needs.",survey_field:"QID1216014151_2"},{title:"Service Quality",description:"Feedback on the overall quality of our services.",survey_field:"QID1216014151_1"},{title:"Value Add",description:"Feedback on the additional value our service delivered.",survey_field:"QID1216014151_3"},{title:"Business Understanding",description:"Our grasp of the client's business requirements.",survey_field:"QID1216014151_5"},{title:"Industry Insight",description:"Rating on our industry-specific knowledge and insights.",survey_field:"QID1216014151_6"}];$("div[sp-field-name='feedback_ratings'] .field-component").html(clp_survey_results_page.render_feedback_and_ratings_table(table_data_set,parse_response.labels));$("div[sp-field-name='feedback_ratings'] .field-component").find("#feedback_ratings_table").dataTable({searching:false,paging:false,info:false})};clp_survey_results_page.render_selected_survey_record_from_options=function(selected_survey_identifier){let cached_surveys=clp_survey_results_page.cached_survey_responses;let selected_survey_data={};for(let s_index=0;s_index<cached_surveys.length;s_index++){const row_item=cached_surveys[s_index];extract_info=JSON.parse(row_item.ResponseJSON);cache_identifier=extract_info.responseId+" - "+moment(extract_info.values.recordedDate).format("DD/MM/YYYY HH:mm:ss");if(cache_identifier==selected_survey_identifier){selected_survey_data=row_item;break}}clp_survey_results_page.render_results(clp_survey_results_page["cached_original_requests_data"],selected_survey_data,clp_survey_results_page.cached_survey_responses)};clp_survey_results_page.render_feedback_and_ratings_table=function(table_data_set,survey_results){let table_html=`
        <table id="feedback_ratings_table" class="dataTable no-footer">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Description</th>
                    <th>Rating</th>
                </tr>
            </thead>
            <tbody>   
    `;for(let index=0;index<table_data_set.length;index++){const element=table_data_set[index];table_html+=`
            <tr data-index="5" class="odd">
                <td class="sorting_1">${element.title}</td>
                <td>${element.description}</td>
                <td>${sharepoint_utilities.check_for_null(survey_results[element.survey_field],"N/A")}</td>
            </tr>
        `}table_html+=`
             </tbody>
        </table>          
    `;return table_html};!function(t,e){"object"==typeof exports?module.exports=exports=e():"function"==typeof define&&define.amd?define([],e):t.CryptoJS=e()}(this,function(){var n,o,s,a,h,t,e,l,r,i,c,f,d,u,p,S,x,b,A,H,z,_,v,g,y,B,w,k,m,C,D,E,R,M,F,P,W,O,I,U=U||function(h){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),"undefined"!=typeof self&&self.crypto&&(i=self.crypto),!(i=!(i=!(i="undefined"!=typeof globalThis&&globalThis.crypto?globalThis.crypto:i)&&"undefined"!=typeof window&&window.msCrypto?window.msCrypto:i)&&"undefined"!=typeof global&&global.crypto?global.crypto:i)&&"function"==typeof require)try{i=require("crypto")}catch(t){}var r=Object.create||function(t){return e.prototype=t,t=new e,e.prototype=null,t};function e(){}var t={},n=t.lib={},o=n.Base={extend:function(t){var e=r(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),(e.init.prototype=e).$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},l=n.WordArray=o.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||c).stringify(this)},concat:function(t){var e=this.words,r=t.words,i=this.sigBytes,n=t.sigBytes;if(this.clamp(),i%4)for(var o=0;o<n;o++){var s=r[o>>>2]>>>24-o%4*8&255;e[i+o>>>2]|=s<<24-(i+o)%4*8}else for(var c=0;c<n;c+=4)e[i+c>>>2]=r[c>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,e=this.sigBytes;t[e>>>2]&=4294967295<<32-e%4*8,t.length=h.ceil(e/4)},clone:function(){var t=o.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],r=0;r<t;r+=4)e.push(function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")}());return new l.init(e,t)}}),s=t.enc={},c=s.Hex={stringify:function(t){for(var e=t.words,r=t.sigBytes,i=[],n=0;n<r;n++){var o=e[n>>>2]>>>24-n%4*8&255;i.push((o>>>4).toString(16)),i.push((15&o).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,r=[],i=0;i<e;i+=2)r[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new l.init(r,e/2)}},a=s.Latin1={stringify:function(t){for(var e=t.words,r=t.sigBytes,i=[],n=0;n<r;n++){var o=e[n>>>2]>>>24-n%4*8&255;i.push(String.fromCharCode(o))}return i.join("")},parse:function(t){for(var e=t.length,r=[],i=0;i<e;i++)r[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new l.init(r,e)}},f=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(a.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return a.parse(unescape(encodeURIComponent(t)))}},d=n.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new l.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=f.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var e,r=this._data,i=r.words,n=r.sigBytes,o=this.blockSize,s=n/(4*o),c=(s=t?h.ceil(s):h.max((0|s)-this._minBufferSize,0))*o,n=h.min(4*c,n);if(c){for(var a=0;a<c;a+=o)this._doProcessBlock(i,a);e=i.splice(0,c),r.sigBytes-=n}return new l.init(e,n)},clone:function(){var t=o.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),u=(n.Hasher=d.extend({cfg:o.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(r){return function(t,e){return new r.init(e).finalize(t)}},_createHmacHelper:function(r){return function(t,e){return new u.HMAC.init(r,e).finalize(t)}}}),t.algo={});return t}(Math);function K(t,e,r){return t&e|~t&r}function X(t,e,r){return t&r|e&~r}function L(t,e){return t<<e|t>>>32-e}function j(t,e,r,i){var n,o=this._iv;o?(n=o.slice(0),this._iv=void 0):n=this._prevBlock,i.encryptBlock(n,0);for(var s=0;s<r;s++)t[e+s]^=n[s]}function T(t){var e,r,i;return 255==(t>>24&255)?(r=t>>8&255,i=255&t,255===(e=t>>16&255)?(e=0,255===r?(r=0,255===i?i=0:++i):++r):++e,t=0,t+=e<<16,t+=r<<8,t+=i):t+=1<<24,t}function N(){for(var t=this._X,e=this._C,r=0;r<8;r++)E[r]=e[r];e[0]=e[0]+1295307597+this._b|0,e[1]=e[1]+3545052371+(e[0]>>>0<E[0]>>>0?1:0)|0,e[2]=e[2]+886263092+(e[1]>>>0<E[1]>>>0?1:0)|0,e[3]=e[3]+1295307597+(e[2]>>>0<E[2]>>>0?1:0)|0,e[4]=e[4]+3545052371+(e[3]>>>0<E[3]>>>0?1:0)|0,e[5]=e[5]+886263092+(e[4]>>>0<E[4]>>>0?1:0)|0,e[6]=e[6]+1295307597+(e[5]>>>0<E[5]>>>0?1:0)|0,e[7]=e[7]+3545052371+(e[6]>>>0<E[6]>>>0?1:0)|0,this._b=e[7]>>>0<E[7]>>>0?1:0;for(r=0;r<8;r++){var i=t[r]+e[r],n=65535&i,o=i>>>16;R[r]=((n*n>>>17)+n*o>>>15)+o*o^((4294901760&i)*i|0)+((65535&i)*i|0)}t[0]=R[0]+(R[7]<<16|R[7]>>>16)+(R[6]<<16|R[6]>>>16)|0,t[1]=R[1]+(R[0]<<8|R[0]>>>24)+R[7]|0,t[2]=R[2]+(R[1]<<16|R[1]>>>16)+(R[0]<<16|R[0]>>>16)|0,t[3]=R[3]+(R[2]<<8|R[2]>>>24)+R[1]|0,t[4]=R[4]+(R[3]<<16|R[3]>>>16)+(R[2]<<16|R[2]>>>16)|0,t[5]=R[5]+(R[4]<<8|R[4]>>>24)+R[3]|0,t[6]=R[6]+(R[5]<<16|R[5]>>>16)+(R[4]<<16|R[4]>>>16)|0,t[7]=R[7]+(R[6]<<8|R[6]>>>24)+R[5]|0}function q(){for(var t=this._X,e=this._C,r=0;r<8;r++)O[r]=e[r];e[0]=e[0]+1295307597+this._b|0,e[1]=e[1]+3545052371+(e[0]>>>0<O[0]>>>0?1:0)|0,e[2]=e[2]+886263092+(e[1]>>>0<O[1]>>>0?1:0)|0,e[3]=e[3]+1295307597+(e[2]>>>0<O[2]>>>0?1:0)|0,e[4]=e[4]+3545052371+(e[3]>>>0<O[3]>>>0?1:0)|0,e[5]=e[5]+886263092+(e[4]>>>0<O[4]>>>0?1:0)|0,e[6]=e[6]+1295307597+(e[5]>>>0<O[5]>>>0?1:0)|0,e[7]=e[7]+3545052371+(e[6]>>>0<O[6]>>>0?1:0)|0,this._b=e[7]>>>0<O[7]>>>0?1:0;for(r=0;r<8;r++){var i=t[r]+e[r],n=65535&i,o=i>>>16;I[r]=((n*n>>>17)+n*o>>>15)+o*o^((4294901760&i)*i|0)+((65535&i)*i|0)}t[0]=I[0]+(I[7]<<16|I[7]>>>16)+(I[6]<<16|I[6]>>>16)|0,t[1]=I[1]+(I[0]<<8|I[0]>>>24)+I[7]|0,t[2]=I[2]+(I[1]<<16|I[1]>>>16)+(I[0]<<16|I[0]>>>16)|0,t[3]=I[3]+(I[2]<<8|I[2]>>>24)+I[1]|0,t[4]=I[4]+(I[3]<<16|I[3]>>>16)+(I[2]<<16|I[2]>>>16)|0,t[5]=I[5]+(I[4]<<8|I[4]>>>24)+I[3]|0,t[6]=I[6]+(I[5]<<16|I[5]>>>16)+(I[4]<<16|I[4]>>>16)|0,t[7]=I[7]+(I[6]<<8|I[6]>>>24)+I[5]|0}return F=(M=U).lib,n=F.Base,o=F.WordArray,(M=M.x64={}).Word=n.extend({init:function(t,e){this.high=t,this.low=e}}),M.WordArray=n.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:8*t.length},toX32:function(){for(var t=this.words,e=t.length,r=[],i=0;i<e;i++){var n=t[i];r.push(n.high),r.push(n.low)}return o.create(r,this.sigBytes)},clone:function(){for(var t=n.clone.call(this),e=t.words=this.words.slice(0),r=e.length,i=0;i<r;i++)e[i]=e[i].clone();return t}}),"function"==typeof ArrayBuffer&&(P=U.lib.WordArray,s=P.init,(P.init=function(t){if((t=(t=t instanceof ArrayBuffer?new Uint8Array(t):t)instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t)instanceof Uint8Array){for(var e=t.byteLength,r=[],i=0;i<e;i++)r[i>>>2]|=t[i]<<24-i%4*8;s.call(this,r,e)}else s.apply(this,arguments)}).prototype=P),function(){var t=U,n=t.lib.WordArray,t=t.enc;t.Utf16=t.Utf16BE={stringify:function(t){for(var e=t.words,r=t.sigBytes,i=[],n=0;n<r;n+=2){var o=e[n>>>2]>>>16-n%4*8&65535;i.push(String.fromCharCode(o))}return i.join("")},parse:function(t){for(var e=t.length,r=[],i=0;i<e;i++)r[i>>>1]|=t.charCodeAt(i)<<16-i%2*16;return n.create(r,2*e)}};function s(t){return t<<8&4278255360|t>>>8&16711935}t.Utf16LE={stringify:function(t){for(var e=t.words,r=t.sigBytes,i=[],n=0;n<r;n+=2){var o=s(e[n>>>2]>>>16-n%4*8&65535);i.push(String.fromCharCode(o))}return i.join("")},parse:function(t){for(var e=t.length,r=[],i=0;i<e;i++)r[i>>>1]|=s(t.charCodeAt(i)<<16-i%2*16);return n.create(r,2*e)}}}(),a=(w=U).lib.WordArray,w.enc.Base64={stringify:function(t){var e=t.words,r=t.sigBytes,i=this._map;t.clamp();for(var n=[],o=0;o<r;o+=3)for(var s=(e[o>>>2]>>>24-o%4*8&255)<<16|(e[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|e[o+2>>>2]>>>24-(o+2)%4*8&255,c=0;c<4&&o+.75*c<r;c++)n.push(i.charAt(s>>>6*(3-c)&63));var a=i.charAt(64);if(a)for(;n.length%4;)n.push(a);return n.join("")},parse:function(t){var e=t.length,r=this._map;if(!(i=this._reverseMap))for(var i=this._reverseMap=[],n=0;n<r.length;n++)i[r.charCodeAt(n)]=n;var o=r.charAt(64);return!o||-1!==(o=t.indexOf(o))&&(e=o),function(t,e,r){for(var i=[],n=0,o=0;o<e;o++){var s,c;o%4&&(s=r[t.charCodeAt(o-1)]<<o%4*2,c=r[t.charCodeAt(o)]>>>6-o%4*2,c=s|c,i[n>>>2]|=c<<24-n%4*8,n++)}return a.create(i,n)}(t,e,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},h=(F=U).lib.WordArray,F.enc.Base64url={stringify:function(t,e=!0){var r=t.words,i=t.sigBytes,n=e?this._safe_map:this._map;t.clamp();for(var o=[],s=0;s<i;s+=3)for(var c=(r[s>>>2]>>>24-s%4*8&255)<<16|(r[s+1>>>2]>>>24-(s+1)%4*8&255)<<8|r[s+2>>>2]>>>24-(s+2)%4*8&255,a=0;a<4&&s+.75*a<i;a++)o.push(n.charAt(c>>>6*(3-a)&63));var h=n.charAt(64);if(h)for(;o.length%4;)o.push(h);return o.join("")},parse:function(t,e=!0){var r=t.length,i=e?this._safe_map:this._map;if(!(n=this._reverseMap))for(var n=this._reverseMap=[],o=0;o<i.length;o++)n[i.charCodeAt(o)]=o;e=i.charAt(64);return!e||-1!==(e=t.indexOf(e))&&(r=e),function(t,e,r){for(var i=[],n=0,o=0;o<e;o++){var s,c;o%4&&(s=r[t.charCodeAt(o-1)]<<o%4*2,c=r[t.charCodeAt(o)]>>>6-o%4*2,c=s|c,i[n>>>2]|=c<<24-n%4*8,n++)}return h.create(i,n)}(t,r,n)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_safe_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"},function(a){var t=U,e=t.lib,r=e.WordArray,i=e.Hasher,e=t.algo,A=[];!function(){for(var t=0;t<64;t++)A[t]=4294967296*a.abs(a.sin(t+1))|0}();e=e.MD5=i.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,e){for(var r=0;r<16;r++){var i=e+r,n=t[i];t[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var o=this._hash.words,s=t[e+0],c=t[e+1],a=t[e+2],h=t[e+3],l=t[e+4],f=t[e+5],d=t[e+6],u=t[e+7],p=t[e+8],_=t[e+9],y=t[e+10],v=t[e+11],g=t[e+12],B=t[e+13],w=t[e+14],k=t[e+15],m=H(m=o[0],b=o[1],x=o[2],S=o[3],s,7,A[0]),S=H(S,m,b,x,c,12,A[1]),x=H(x,S,m,b,a,17,A[2]),b=H(b,x,S,m,h,22,A[3]);m=H(m,b,x,S,l,7,A[4]),S=H(S,m,b,x,f,12,A[5]),x=H(x,S,m,b,d,17,A[6]),b=H(b,x,S,m,u,22,A[7]),m=H(m,b,x,S,p,7,A[8]),S=H(S,m,b,x,_,12,A[9]),x=H(x,S,m,b,y,17,A[10]),b=H(b,x,S,m,v,22,A[11]),m=H(m,b,x,S,g,7,A[12]),S=H(S,m,b,x,B,12,A[13]),x=H(x,S,m,b,w,17,A[14]),m=z(m,b=H(b,x,S,m,k,22,A[15]),x,S,c,5,A[16]),S=z(S,m,b,x,d,9,A[17]),x=z(x,S,m,b,v,14,A[18]),b=z(b,x,S,m,s,20,A[19]),m=z(m,b,x,S,f,5,A[20]),S=z(S,m,b,x,y,9,A[21]),x=z(x,S,m,b,k,14,A[22]),b=z(b,x,S,m,l,20,A[23]),m=z(m,b,x,S,_,5,A[24]),S=z(S,m,b,x,w,9,A[25]),x=z(x,S,m,b,h,14,A[26]),b=z(b,x,S,m,p,20,A[27]),m=z(m,b,x,S,B,5,A[28]),S=z(S,m,b,x,a,9,A[29]),x=z(x,S,m,b,u,14,A[30]),m=C(m,b=z(b,x,S,m,g,20,A[31]),x,S,f,4,A[32]),S=C(S,m,b,x,p,11,A[33]),x=C(x,S,m,b,v,16,A[34]),b=C(b,x,S,m,w,23,A[35]),m=C(m,b,x,S,c,4,A[36]),S=C(S,m,b,x,l,11,A[37]),x=C(x,S,m,b,u,16,A[38]),b=C(b,x,S,m,y,23,A[39]),m=C(m,b,x,S,B,4,A[40]),S=C(S,m,b,x,s,11,A[41]),x=C(x,S,m,b,h,16,A[42]),b=C(b,x,S,m,d,23,A[43]),m=C(m,b,x,S,_,4,A[44]),S=C(S,m,b,x,g,11,A[45]),x=C(x,S,m,b,k,16,A[46]),m=D(m,b=C(b,x,S,m,a,23,A[47]),x,S,s,6,A[48]),S=D(S,m,b,x,u,10,A[49]),x=D(x,S,m,b,w,15,A[50]),b=D(b,x,S,m,f,21,A[51]),m=D(m,b,x,S,g,6,A[52]),S=D(S,m,b,x,h,10,A[53]),x=D(x,S,m,b,y,15,A[54]),b=D(b,x,S,m,c,21,A[55]),m=D(m,b,x,S,p,6,A[56]),S=D(S,m,b,x,k,10,A[57]),x=D(x,S,m,b,d,15,A[58]),b=D(b,x,S,m,B,21,A[59]),m=D(m,b,x,S,l,6,A[60]),S=D(S,m,b,x,v,10,A[61]),x=D(x,S,m,b,a,15,A[62]),b=D(b,x,S,m,_,21,A[63]),o[0]=o[0]+m|0,o[1]=o[1]+b|0,o[2]=o[2]+x|0,o[3]=o[3]+S|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;e[i>>>5]|=128<<24-i%32;var n=a.floor(r/4294967296),r=r;e[15+(64+i>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e[14+(64+i>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(e.length+1),this._process();for(var e=this._hash,o=e.words,s=0;s<4;s++){var c=o[s];o[s]=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8)}return e},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});function H(t,e,r,i,n,o,s){s=t+(e&r|~e&i)+n+s;return(s<<o|s>>>32-o)+e}function z(t,e,r,i,n,o,s){s=t+(e&i|r&~i)+n+s;return(s<<o|s>>>32-o)+e}function C(t,e,r,i,n,o,s){s=t+(e^r^i)+n+s;return(s<<o|s>>>32-o)+e}function D(t,e,r,i,n,o,s){s=t+(r^(e|~i))+n+s;return(s<<o|s>>>32-o)+e}t.MD5=i._createHelper(e),t.HmacMD5=i._createHmacHelper(e)}(Math),P=(M=U).lib,t=P.WordArray,e=P.Hasher,P=M.algo,l=[],P=P.SHA1=e.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],s=r[3],c=r[4],a=0;a<80;a++){a<16?l[a]=0|t[e+a]:(h=l[a-3]^l[a-8]^l[a-14]^l[a-16],l[a]=h<<1|h>>>31);var h=(i<<5|i>>>27)+c+l[a];h+=a<20?1518500249+(n&o|~n&s):a<40?1859775393+(n^o^s):a<60?(n&o|n&s|o&s)-1894007588:(n^o^s)-899497514,c=s,s=o,o=n<<30|n>>>2,n=i,i=h}r[0]=r[0]+i|0,r[1]=r[1]+n|0,r[2]=r[2]+o|0,r[3]=r[3]+s|0,r[4]=r[4]+c|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=Math.floor(r/4294967296),e[15+(64+i>>>9<<4)]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=e.clone.call(this);return t._hash=this._hash.clone(),t}}),M.SHA1=e._createHelper(P),M.HmacSHA1=e._createHmacHelper(P),function(n){var t=U,e=t.lib,r=e.WordArray,i=e.Hasher,e=t.algo,o=[],p=[];!function(){function t(t){return 4294967296*(t-(0|t))|0}for(var e=2,r=0;r<64;)!function(t){for(var e=n.sqrt(t),r=2;r<=e;r++)if(!(t%r))return;return 1}(e)||(r<8&&(o[r]=t(n.pow(e,.5))),p[r]=t(n.pow(e,1/3)),r++),e++}();var _=[],e=e.SHA256=i.extend({_doReset:function(){this._hash=new r.init(o.slice(0))},_doProcessBlock:function(t,e){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],s=r[3],c=r[4],a=r[5],h=r[6],l=r[7],f=0;f<64;f++){f<16?_[f]=0|t[e+f]:(d=_[f-15],u=_[f-2],_[f]=((d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3)+_[f-7]+((u<<15|u>>>17)^(u<<13|u>>>19)^u>>>10)+_[f-16]);var d=i&n^i&o^n&o,u=l+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&a^~c&h)+p[f]+_[f],l=h,h=a,a=c,c=s+u|0,s=o,o=n,n=i,i=u+(((i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22))+d)|0}r[0]=r[0]+i|0,r[1]=r[1]+n|0,r[2]=r[2]+o|0,r[3]=r[3]+s|0,r[4]=r[4]+c|0,r[5]=r[5]+a|0,r[6]=r[6]+h|0,r[7]=r[7]+l|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=n.floor(r/4294967296),e[15+(64+i>>>9<<4)]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA256=i._createHelper(e),t.HmacSHA256=i._createHmacHelper(e)}(Math),r=(w=U).lib.WordArray,F=w.algo,i=F.SHA256,F=F.SHA224=i.extend({_doReset:function(){this._hash=new r.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var t=i._doFinalize.call(this);return t.sigBytes-=4,t}}),w.SHA224=i._createHelper(F),w.HmacSHA224=i._createHmacHelper(F),function(){var t=U,e=t.lib.Hasher,r=t.x64,i=r.Word,n=r.WordArray,r=t.algo;function o(){return i.create.apply(i,arguments)}var t1=[o(1116352408,3609767458),o(1899447441,602891725),o(3049323471,3964484399),o(3921009573,2173295548),o(961987163,4081628472),o(1508970993,3053834265),o(2453635748,2937671579),o(2870763221,3664609560),o(3624381080,2734883394),o(310598401,1164996542),o(607225278,1323610764),o(1426881987,3590304994),o(1925078388,4068182383),o(2162078206,991336113),o(2614888103,633803317),o(3248222580,3479774868),o(3835390401,2666613458),o(4022224774,944711139),o(264347078,2341262773),o(604807628,2007800933),o(770255983,1495990901),o(1249150122,1856431235),o(1555081692,3175218132),o(1996064986,2198950837),o(2554220882,3999719339),o(2821834349,766784016),o(2952996808,2566594879),o(3210313671,3203337956),o(3336571891,1034457026),o(3584528711,2466948901),o(113926993,3758326383),o(338241895,168717936),o(666307205,1188179964),o(773529912,1546045734),o(1294757372,1522805485),o(1396182291,2643833823),o(1695183700,2343527390),o(1986661051,1014477480),o(2177026350,1206759142),o(2456956037,344077627),o(2730485921,1290863460),o(2820302411,3158454273),o(3259730800,3505952657),o(3345764771,106217008),o(3516065817,3606008344),o(3600352804,1432725776),o(4094571909,1467031594),o(275423344,851169720),o(430227734,3100823752),o(506948616,1363258195),o(659060556,3750685593),o(883997877,3785050280),o(958139571,3318307427),o(1322822218,3812723403),o(1537002063,2003034995),o(1747873779,3602036899),o(1955562222,1575990012),o(2024104815,1125592928),o(2227730452,2716904306),o(2361852424,442776044),o(2428436474,593698344),o(2756734187,3733110249),o(3204031479,2999351573),o(3329325298,3815920427),o(3391569614,3928383900),o(3515267271,566280711),o(3940187606,3454069534),o(4118630271,4000239992),o(116418474,1914138554),o(174292421,2731055270),o(289380356,3203993006),o(460393269,320620315),o(685471733,587496836),o(852142971,1086792851),o(1017036298,365543100),o(1126000580,2618297676),o(1288033470,3409855158),o(1501505948,4234509866),o(1607167915,987167468),o(1816402316,1246189591)],e1=[];!function(){for(var t=0;t<80;t++)e1[t]=o()}();r=r.SHA512=e.extend({_doReset:function(){this._hash=new n.init([new i.init(1779033703,4089235720),new i.init(3144134277,2227873595),new i.init(1013904242,4271175723),new i.init(2773480762,1595750129),new i.init(1359893119,2917565137),new i.init(2600822924,725511199),new i.init(528734635,4215389547),new i.init(1541459225,327033209)])},_doProcessBlock:function(t,e){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],s=r[3],c=r[4],a=r[5],h=r[6],l=r[7],f=i.high,d=i.low,u=n.high,p=n.low,_=o.high,y=o.low,v=s.high,g=s.low,B=c.high,w=c.low,k=a.high,m=a.low,S=h.high,x=h.low,b=l.high,r=l.low,A=f,H=d,z=u,C=p,D=_,E=y,R=v,M=g,F=B,P=w,W=k,O=m,I=S,U=x,K=b,X=r,L=0;L<80;L++){var j,T,N=e1[L];L<16?(T=N.high=0|t[e+2*L],j=N.low=0|t[e+2*L+1]):($=(q=e1[L-15]).high,J=q.low,G=(Q=e1[L-2]).high,V=Q.low,Z=(Y=e1[L-7]).high,q=Y.low,Y=(Q=e1[L-16]).high,T=(T=(($>>>1|J<<31)^($>>>8|J<<24)^$>>>7)+Z+((j=(Z=(J>>>1|$<<31)^(J>>>8|$<<24)^(J>>>7|$<<25))+q)>>>0<Z>>>0?1:0))+((G>>>19|V<<13)^(G<<3|V>>>29)^G>>>6)+((j+=J=(V>>>19|G<<13)^(V<<3|G>>>29)^(V>>>6|G<<26))>>>0<J>>>0?1:0),j+=$=Q.low,N.high=T=T+Y+(j>>>0<$>>>0?1:0),N.low=j);var q=F&W^~F&I,Z=P&O^~P&U,V=A&z^A&D^z&D,G=(H>>>28|A<<4)^(H<<30|A>>>2)^(H<<25|A>>>7),J=t1[L],Q=J.high,Y=J.low,$=X+((P>>>14|F<<18)^(P>>>18|F<<14)^(P<<23|F>>>9)),N=K+((F>>>14|P<<18)^(F>>>18|P<<14)^(F<<23|P>>>9))+($>>>0<X>>>0?1:0),J=G+(H&C^H&E^C&E),K=I,X=U,I=W,U=O,W=F,O=P,F=R+(N=(N=(N=N+q+(($=$+Z)>>>0<Z>>>0?1:0))+Q+(($=$+Y)>>>0<Y>>>0?1:0))+T+(($=$+j)>>>0<j>>>0?1:0))+((P=M+$|0)>>>0<M>>>0?1:0)|0,R=D,M=E,D=z,E=C,z=A,C=H,A=N+(((A>>>28|H<<4)^(A<<30|H>>>2)^(A<<25|H>>>7))+V+(J>>>0<G>>>0?1:0))+((H=$+J|0)>>>0<$>>>0?1:0)|0}d=i.low=d+H,i.high=f+A+(d>>>0<H>>>0?1:0),p=n.low=p+C,n.high=u+z+(p>>>0<C>>>0?1:0),y=o.low=y+E,o.high=_+D+(y>>>0<E>>>0?1:0),g=s.low=g+M,s.high=v+R+(g>>>0<M>>>0?1:0),w=c.low=w+P,c.high=B+F+(w>>>0<P>>>0?1:0),m=a.low=m+O,a.high=k+W+(m>>>0<O>>>0?1:0),x=h.low=x+U,h.high=S+I+(x>>>0<U>>>0?1:0),r=l.low=r+X,l.high=b+K+(r>>>0<X>>>0?1:0)},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[30+(128+i>>>10<<5)]=Math.floor(r/4294967296),e[31+(128+i>>>10<<5)]=r,t.sigBytes=4*e.length,this._process(),this._hash.toX32()},clone:function(){var t=e.clone.call(this);return t._hash=this._hash.clone(),t},blockSize:32});t.SHA512=e._createHelper(r),t.HmacSHA512=e._createHmacHelper(r)}(),P=(M=U).x64,c=P.Word,f=P.WordArray,P=M.algo,d=P.SHA512,P=P.SHA384=d.extend({_doReset:function(){this._hash=new f.init([new c.init(3418070365,3238371032),new c.init(1654270250,914150663),new c.init(2438529370,812702999),new c.init(355462360,4144912697),new c.init(1731405415,4290775857),new c.init(2394180231,1750603025),new c.init(3675008525,1694076839),new c.init(1203062813,3204075428)])},_doFinalize:function(){var t=d._doFinalize.call(this);return t.sigBytes-=16,t}}),M.SHA384=d._createHelper(P),M.HmacSHA384=d._createHmacHelper(P),function(l){var t=U,e=t.lib,f=e.WordArray,i=e.Hasher,d=t.x64.Word,e=t.algo,A=[],H=[],z=[];!function(){for(var t=1,e=0,r=0;r<24;r++){A[t+5*e]=(r+1)*(r+2)/2%64;var i=(2*t+3*e)%5;t=e%5,e=i}for(t=0;t<5;t++)for(e=0;e<5;e++)H[t+5*e]=e+(2*t+3*e)%5*5;for(var n=1,o=0;o<24;o++){for(var s,c=0,a=0,h=0;h<7;h++)1&n&&((s=(1<<h)-1)<32?a^=1<<s:c^=1<<s-32),128&n?n=n<<1^113:n<<=1;z[o]=d.create(c,a)}}();var C=[];!function(){for(var t=0;t<25;t++)C[t]=d.create()}();e=e.SHA3=i.extend({cfg:i.cfg.extend({outputLength:512}),_doReset:function(){for(var t=this._state=[],e=0;e<25;e++)t[e]=new d.init;this.blockSize=(1600-2*this.cfg.outputLength)/32},_doProcessBlock:function(t,e){for(var r=this._state,i=this.blockSize/2,n=0;n<i;n++){var o=t[e+2*n],s=t[e+2*n+1],o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8);(m=r[n]).high^=s=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),m.low^=o}for(var c=0;c<24;c++){for(var a=0;a<5;a++){for(var h=0,l=0,f=0;f<5;f++)h^=(m=r[a+5*f]).high,l^=m.low;var d=C[a];d.high=h,d.low=l}for(a=0;a<5;a++)for(var u=C[(a+4)%5],p=C[(a+1)%5],_=p.high,p=p.low,h=u.high^(_<<1|p>>>31),l=u.low^(p<<1|_>>>31),f=0;f<5;f++)(m=r[a+5*f]).high^=h,m.low^=l;for(var y=1;y<25;y++){var v=(m=r[y]).high,g=m.low,B=A[y];l=B<32?(h=v<<B|g>>>32-B,g<<B|v>>>32-B):(h=g<<B-32|v>>>64-B,v<<B-32|g>>>64-B);B=C[H[y]];B.high=h,B.low=l}var w=C[0],k=r[0];w.high=k.high,w.low=k.low;for(a=0;a<5;a++)for(f=0;f<5;f++){var m=r[y=a+5*f],S=C[y],x=C[(a+1)%5+5*f],b=C[(a+2)%5+5*f];m.high=S.high^~x.high&b.high,m.low=S.low^~x.low&b.low}m=r[0],k=z[c];m.high^=k.high,m.low^=k.low}},_doFinalize:function(){var t=this._data,e=t.words,r=(this._nDataBytes,8*t.sigBytes),i=32*this.blockSize;e[r>>>5]|=1<<24-r%32,e[(l.ceil((1+r)/i)*i>>>5)-1]|=128,t.sigBytes=4*e.length,this._process();for(var n=this._state,e=this.cfg.outputLength/8,o=e/8,s=[],c=0;c<o;c++){var a=n[c],h=a.high,a=a.low,h=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8);s.push(a=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)),s.push(h)}return new f.init(s,e)},clone:function(){for(var t=i.clone.call(this),e=t._state=this._state.slice(0),r=0;r<25;r++)e[r]=e[r].clone();return t}});t.SHA3=i._createHelper(e),t.HmacSHA3=i._createHmacHelper(e)}(Math),Math,F=(w=U).lib,u=F.WordArray,p=F.Hasher,F=w.algo,S=u.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),x=u.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),b=u.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),A=u.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),H=u.create([0,1518500249,1859775393,2400959708,2840853838]),z=u.create([1352829926,1548603684,1836072691,2053994217,0]),F=F.RIPEMD160=p.extend({_doReset:function(){this._hash=u.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var r=0;r<16;r++){var i=e+r,n=t[i];t[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}for(var o,s,c,a,h,l,f=this._hash.words,d=H.words,u=z.words,p=S.words,_=x.words,y=b.words,v=A.words,g=o=f[0],B=s=f[1],w=c=f[2],k=a=f[3],m=h=f[4],r=0;r<80;r+=1)l=o+t[e+p[r]]|0,l+=r<16?(s^c^a)+d[0]:r<32?K(s,c,a)+d[1]:r<48?((s|~c)^a)+d[2]:r<64?X(s,c,a)+d[3]:(s^(c|~a))+d[4],l=(l=L(l|=0,y[r]))+h|0,o=h,h=a,a=L(c,10),c=s,s=l,l=g+t[e+_[r]]|0,l+=r<16?(B^(w|~k))+u[0]:r<32?X(B,w,k)+u[1]:r<48?((B|~w)^k)+u[2]:r<64?K(B,w,k)+u[3]:(B^w^k)+u[4],l=(l=L(l|=0,v[r]))+m|0,g=m,m=k,k=L(w,10),w=B,B=l;l=f[1]+c+k|0,f[1]=f[2]+a+m|0,f[2]=f[3]+h+g|0,f[3]=f[4]+o+B|0,f[4]=f[0]+s+w|0,f[0]=l},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(e.length+1),this._process();for(var e=this._hash,n=e.words,o=0;o<5;o++){var s=n[o];n[o]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8)}return e},clone:function(){var t=p.clone.call(this);return t._hash=this._hash.clone(),t}}),w.RIPEMD160=p._createHelper(F),w.HmacRIPEMD160=p._createHmacHelper(F),P=(M=U).lib.Base,_=M.enc.Utf8,M.algo.HMAC=P.extend({init:function(t,e){t=this._hasher=new t.init,"string"==typeof e&&(e=_.parse(e));var r=t.blockSize,i=4*r;(e=e.sigBytes>i?t.finalize(e):e).clamp();for(var t=this._oKey=e.clone(),e=this._iKey=e.clone(),n=t.words,o=e.words,s=0;s<r;s++)n[s]^=1549556828,o[s]^=909522486;t.sigBytes=e.sigBytes=i,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var e=this._hasher,t=e.finalize(t);return e.reset(),e.finalize(this._oKey.clone().concat(t))}}),F=(w=U).lib,M=F.Base,v=F.WordArray,P=w.algo,F=P.SHA1,g=P.HMAC,y=P.PBKDF2=M.extend({cfg:M.extend({keySize:4,hasher:F,iterations:1}),init:function(t){this.cfg=this.cfg.extend(t)},compute:function(t,e){for(var r=this.cfg,i=g.create(r.hasher,t),n=v.create(),o=v.create([1]),s=n.words,c=o.words,a=r.keySize,h=r.iterations;s.length<a;){var l=i.update(e).finalize(o);i.reset();for(var f=l.words,d=f.length,u=l,p=1;p<h;p++){u=i.finalize(u),i.reset();for(var _=u.words,y=0;y<d;y++)f[y]^=_[y]}n.concat(l),c[0]++}return n.sigBytes=4*a,n}}),w.PBKDF2=function(t,e,r){return y.create(r).compute(t,e)},M=(P=U).lib,F=M.Base,B=M.WordArray,w=P.algo,M=w.MD5,k=w.EvpKDF=F.extend({cfg:F.extend({keySize:4,hasher:M,iterations:1}),init:function(t){this.cfg=this.cfg.extend(t)},compute:function(t,e){for(var r,i=this.cfg,n=i.hasher.create(),o=B.create(),s=o.words,c=i.keySize,a=i.iterations;s.length<c;){r&&n.update(r),r=n.update(t).finalize(e),n.reset();for(var h=1;h<a;h++)r=n.finalize(r),n.reset();o.concat(r)}return o.sigBytes=4*c,o}}),P.EvpKDF=function(t,e,r){return k.create(r).compute(t,e)},U.lib.Cipher||function(){var t=U,e=t.lib,r=e.Base,s=e.WordArray,i=e.BufferedBlockAlgorithm,n=t.enc,o=(n.Utf8,n.Base64),c=t.algo.EvpKDF,a=e.Cipher=i.extend({cfg:r.extend(),createEncryptor:function(t,e){return this.create(this._ENC_XFORM_MODE,t,e)},createDecryptor:function(t,e){return this.create(this._DEC_XFORM_MODE,t,e)},init:function(t,e,r){this.cfg=this.cfg.extend(r),this._xformMode=t,this._key=e,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(t){return this._append(t),this._process()},finalize:function(t){return t&&this._append(t),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(i){return{encrypt:function(t,e,r){return h(e).encrypt(i,t,e,r)},decrypt:function(t,e,r){return h(e).decrypt(i,t,e,r)}}}});function h(t){return"string"==typeof t?p:u}e.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var l=t.mode={},n=e.BlockCipherMode=r.extend({createEncryptor:function(t,e){return this.Encryptor.create(t,e)},createDecryptor:function(t,e){return this.Decryptor.create(t,e)},init:function(t,e){this._cipher=t,this._iv=e}}),n=l.CBC=((l=n.extend()).Encryptor=l.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize;f.call(this,t,e,i),r.encryptBlock(t,e),this._prevBlock=t.slice(e,e+i)}}),l.Decryptor=l.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize,n=t.slice(e,e+i);r.decryptBlock(t,e),f.call(this,t,e,i),this._prevBlock=n}}),l);function f(t,e,r){var i,n=this._iv;n?(i=n,this._iv=void 0):i=this._prevBlock;for(var o=0;o<r;o++)t[e+o]^=i[o]}var l=(t.pad={}).Pkcs7={pad:function(t,e){for(var e=4*e,r=e-t.sigBytes%e,i=r<<24|r<<16|r<<8|r,n=[],o=0;o<r;o+=4)n.push(i);e=s.create(n,r);t.concat(e)},unpad:function(t){var e=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=e}},d=(e.BlockCipher=a.extend({cfg:a.cfg.extend({mode:n,padding:l}),reset:function(){var t;a.reset.call(this);var e=this.cfg,r=e.iv,e=e.mode;this._xformMode==this._ENC_XFORM_MODE?t=e.createEncryptor:(t=e.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==t?this._mode.init(this,r&&r.words):(this._mode=t.call(e,this,r&&r.words),this._mode.__creator=t)},_doProcessBlock:function(t,e){this._mode.processBlock(t,e)},_doFinalize:function(){var t,e=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(e.pad(this._data,this.blockSize),t=this._process(!0)):(t=this._process(!0),e.unpad(t)),t},blockSize:4}),e.CipherParams=r.extend({init:function(t){this.mixIn(t)},toString:function(t){return(t||this.formatter).stringify(this)}})),l=(t.format={}).OpenSSL={stringify:function(t){var e=t.ciphertext,t=t.salt,e=t?s.create([1398893684,1701076831]).concat(t).concat(e):e;return e.toString(o)},parse:function(t){var e,r=o.parse(t),t=r.words;return 1398893684==t[0]&&1701076831==t[1]&&(e=s.create(t.slice(2,4)),t.splice(0,4),r.sigBytes-=16),d.create({ciphertext:r,salt:e})}},u=e.SerializableCipher=r.extend({cfg:r.extend({format:l}),encrypt:function(t,e,r,i){i=this.cfg.extend(i);var n=t.createEncryptor(r,i),e=n.finalize(e),n=n.cfg;return d.create({ciphertext:e,key:r,iv:n.iv,algorithm:t,mode:n.mode,padding:n.padding,blockSize:t.blockSize,formatter:i.format})},decrypt:function(t,e,r,i){return i=this.cfg.extend(i),e=this._parse(e,i.format),t.createDecryptor(r,i).finalize(e.ciphertext)},_parse:function(t,e){return"string"==typeof t?e.parse(t,this):t}}),t=(t.kdf={}).OpenSSL={execute:function(t,e,r,i){i=i||s.random(8);t=c.create({keySize:e+r}).compute(t,i),r=s.create(t.words.slice(e),4*r);return t.sigBytes=4*e,d.create({key:t,iv:r,salt:i})}},p=e.PasswordBasedCipher=u.extend({cfg:u.cfg.extend({kdf:t}),encrypt:function(t,e,r,i){r=(i=this.cfg.extend(i)).kdf.execute(r,t.keySize,t.ivSize);i.iv=r.iv;i=u.encrypt.call(this,t,e,r.key,i);return i.mixIn(r),i},decrypt:function(t,e,r,i){i=this.cfg.extend(i),e=this._parse(e,i.format);r=i.kdf.execute(r,t.keySize,t.ivSize,e.salt);return i.iv=r.iv,u.decrypt.call(this,t,e,r.key,i)}})}(),U.mode.CFB=((F=U.lib.BlockCipherMode.extend()).Encryptor=F.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize;j.call(this,t,e,i,r),this._prevBlock=t.slice(e,e+i)}}),F.Decryptor=F.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize,n=t.slice(e,e+i);j.call(this,t,e,i,r),this._prevBlock=n}}),F),U.mode.CTR=(M=U.lib.BlockCipherMode.extend(),P=M.Encryptor=M.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize,n=this._iv,o=this._counter;n&&(o=this._counter=n.slice(0),this._iv=void 0);var s=o.slice(0);r.encryptBlock(s,0),o[i-1]=o[i-1]+1|0;for(var c=0;c<i;c++)t[e+c]^=s[c]}}),M.Decryptor=P,M),U.mode.CTRGladman=(F=U.lib.BlockCipherMode.extend(),P=F.Encryptor=F.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize,n=this._iv,o=this._counter;n&&(o=this._counter=n.slice(0),this._iv=void 0),0===((n=o)[0]=T(n[0]))&&(n[1]=T(n[1]));var s=o.slice(0);r.encryptBlock(s,0);for(var c=0;c<i;c++)t[e+c]^=s[c]}}),F.Decryptor=P,F),U.mode.OFB=(M=U.lib.BlockCipherMode.extend(),P=M.Encryptor=M.extend({processBlock:function(t,e){var r=this._cipher,i=r.blockSize,n=this._iv,o=this._keystream;n&&(o=this._keystream=n.slice(0),this._iv=void 0),r.encryptBlock(o,0);for(var s=0;s<i;s++)t[e+s]^=o[s]}}),M.Decryptor=P,M),U.mode.ECB=((F=U.lib.BlockCipherMode.extend()).Encryptor=F.extend({processBlock:function(t,e){this._cipher.encryptBlock(t,e)}}),F.Decryptor=F.extend({processBlock:function(t,e){this._cipher.decryptBlock(t,e)}}),F),U.pad.AnsiX923={pad:function(t,e){var r=t.sigBytes,e=4*e,e=e-r%e,r=r+e-1;t.clamp(),t.words[r>>>2]|=e<<24-r%4*8,t.sigBytes+=e},unpad:function(t){var e=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=e}},U.pad.Iso10126={pad:function(t,e){e*=4,e-=t.sigBytes%e;t.concat(U.lib.WordArray.random(e-1)).concat(U.lib.WordArray.create([e<<24],1))},unpad:function(t){var e=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=e}},U.pad.Iso97971={pad:function(t,e){t.concat(U.lib.WordArray.create([2147483648],1)),U.pad.ZeroPadding.pad(t,e)},unpad:function(t){U.pad.ZeroPadding.unpad(t),t.sigBytes--}},U.pad.ZeroPadding={pad:function(t,e){e*=4;t.clamp(),t.sigBytes+=e-(t.sigBytes%e||e)},unpad:function(t){for(var e=t.words,r=t.sigBytes-1,r=t.sigBytes-1;0<=r;r--)if(e[r>>>2]>>>24-r%4*8&255){t.sigBytes=r+1;break}}},U.pad.NoPadding={pad:function(){},unpad:function(){}},m=(P=U).lib.CipherParams,C=P.enc.Hex,P.format.Hex={stringify:function(t){return t.ciphertext.toString(C)},parse:function(t){t=C.parse(t);return m.create({ciphertext:t})}},function(){var t=U,e=t.lib.BlockCipher,r=t.algo,h=[],l=[],f=[],d=[],u=[],p=[],_=[],y=[],v=[],g=[];!function(){for(var t=[],e=0;e<256;e++)t[e]=e<128?e<<1:e<<1^283;for(var r=0,i=0,e=0;e<256;e++){var n=i^i<<1^i<<2^i<<3^i<<4;h[r]=n=n>>>8^255&n^99;var o=t[l[n]=r],s=t[o],c=t[s],a=257*t[n]^16843008*n;f[r]=a<<24|a>>>8,d[r]=a<<16|a>>>16,u[r]=a<<8|a>>>24,p[r]=a,_[n]=(a=16843009*c^65537*s^257*o^16843008*r)<<24|a>>>8,y[n]=a<<16|a>>>16,v[n]=a<<8|a>>>24,g[n]=a,r?(r=o^t[t[t[c^o]]],i^=t[t[i]]):r=i=1}}();var B=[0,1,2,4,8,16,32,64,128,27,54],r=r.AES=e.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var t=this._keyPriorReset=this._key,e=t.words,r=t.sigBytes/4,i=4*(1+(this._nRounds=6+r)),n=this._keySchedule=[],o=0;o<i;o++)o<r?n[o]=e[o]:(a=n[o-1],o%r?6<r&&o%r==4&&(a=h[a>>>24]<<24|h[a>>>16&255]<<16|h[a>>>8&255]<<8|h[255&a]):(a=h[(a=a<<8|a>>>24)>>>24]<<24|h[a>>>16&255]<<16|h[a>>>8&255]<<8|h[255&a],a^=B[o/r|0]<<24),n[o]=n[o-r]^a);for(var s=this._invKeySchedule=[],c=0;c<i;c++){var a,o=i-c;a=c%4?n[o]:n[o-4],s[c]=c<4||o<=4?a:_[h[a>>>24]]^y[h[a>>>16&255]]^v[h[a>>>8&255]]^g[h[255&a]]}}},encryptBlock:function(t,e){this._doCryptBlock(t,e,this._keySchedule,f,d,u,p,h)},decryptBlock:function(t,e){var r=t[e+1];t[e+1]=t[e+3],t[e+3]=r,this._doCryptBlock(t,e,this._invKeySchedule,_,y,v,g,l);r=t[e+1];t[e+1]=t[e+3],t[e+3]=r},_doCryptBlock:function(t,e,r,i,n,o,s,c){for(var a=this._nRounds,h=t[e]^r[0],l=t[e+1]^r[1],f=t[e+2]^r[2],d=t[e+3]^r[3],u=4,p=1;p<a;p++)var _=i[h>>>24]^n[l>>>16&255]^o[f>>>8&255]^s[255&d]^r[u++],y=i[l>>>24]^n[f>>>16&255]^o[d>>>8&255]^s[255&h]^r[u++],v=i[f>>>24]^n[d>>>16&255]^o[h>>>8&255]^s[255&l]^r[u++],g=i[d>>>24]^n[h>>>16&255]^o[l>>>8&255]^s[255&f]^r[u++],h=_,l=y,f=v,d=g;_=(c[h>>>24]<<24|c[l>>>16&255]<<16|c[f>>>8&255]<<8|c[255&d])^r[u++],y=(c[l>>>24]<<24|c[f>>>16&255]<<16|c[d>>>8&255]<<8|c[255&h])^r[u++],v=(c[f>>>24]<<24|c[d>>>16&255]<<16|c[h>>>8&255]<<8|c[255&l])^r[u++],g=(c[d>>>24]<<24|c[h>>>16&255]<<16|c[l>>>8&255]<<8|c[255&f])^r[u++];t[e]=_,t[e+1]=y,t[e+2]=v,t[e+3]=g},keySize:8});t.AES=e._createHelper(r)}(),function(){var t=U,e=t.lib,i=e.WordArray,r=e.BlockCipher,e=t.algo,h=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],l=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],f=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],u=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],n=e.DES=r.extend({_doReset:function(){for(var t=this._key.words,e=[],r=0;r<56;r++){var i=h[r]-1;e[r]=t[i>>>5]>>>31-i%32&1}for(var n=this._subKeys=[],o=0;o<16;o++){for(var s=n[o]=[],c=f[o],r=0;r<24;r++)s[r/6|0]|=e[(l[r]-1+c)%28]<<31-r%6,s[4+(r/6|0)]|=e[28+(l[r+24]-1+c)%28]<<31-r%6;s[0]=s[0]<<1|s[0]>>>31;for(r=1;r<7;r++)s[r]=s[r]>>>4*(r-1)+3;s[7]=s[7]<<5|s[7]>>>27}for(var a=this._invSubKeys=[],r=0;r<16;r++)a[r]=n[15-r]},encryptBlock:function(t,e){this._doCryptBlock(t,e,this._subKeys)},decryptBlock:function(t,e){this._doCryptBlock(t,e,this._invSubKeys)},_doCryptBlock:function(t,e,r){this._lBlock=t[e],this._rBlock=t[e+1],p.call(this,4,252645135),p.call(this,16,65535),_.call(this,2,858993459),_.call(this,8,16711935),p.call(this,1,1431655765);for(var i=0;i<16;i++){for(var n=r[i],o=this._lBlock,s=this._rBlock,c=0,a=0;a<8;a++)c|=d[a][((s^n[a])&u[a])>>>0];this._lBlock=s,this._rBlock=o^c}var h=this._lBlock;this._lBlock=this._rBlock,this._rBlock=h,p.call(this,1,1431655765),_.call(this,8,16711935),_.call(this,2,858993459),p.call(this,16,65535),p.call(this,4,252645135),t[e]=this._lBlock,t[e+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});function p(t,e){e=(this._lBlock>>>t^this._rBlock)&e;this._rBlock^=e,this._lBlock^=e<<t}function _(t,e){e=(this._rBlock>>>t^this._lBlock)&e;this._lBlock^=e,this._rBlock^=e<<t}t.DES=r._createHelper(n);e=e.TripleDES=r.extend({_doReset:function(){var t=this._key.words;if(2!==t.length&&4!==t.length&&t.length<6)throw new Error("Invalid key length - 3DES requires the key length to be 64, 128, 192 or >192.");var e=t.slice(0,2),r=t.length<4?t.slice(0,2):t.slice(2,4),t=t.length<6?t.slice(0,2):t.slice(4,6);this._des1=n.createEncryptor(i.create(e)),this._des2=n.createEncryptor(i.create(r)),this._des3=n.createEncryptor(i.create(t))},encryptBlock:function(t,e){this._des1.encryptBlock(t,e),this._des2.decryptBlock(t,e),this._des3.encryptBlock(t,e)},decryptBlock:function(t,e){this._des3.decryptBlock(t,e),this._des2.encryptBlock(t,e),this._des1.decryptBlock(t,e)},keySize:6,ivSize:2,blockSize:2});t.TripleDES=r._createHelper(e)}(),function(){var t=U,e=t.lib.StreamCipher,r=t.algo,i=r.RC4=e.extend({_doReset:function(){for(var t=this._key,e=t.words,r=t.sigBytes,i=this._S=[],n=0;n<256;n++)i[n]=n;for(var n=0,o=0;n<256;n++){var s=n%r,s=e[s>>>2]>>>24-s%4*8&255,o=(o+i[n]+s)%256,s=i[n];i[n]=i[o],i[o]=s}this._i=this._j=0},_doProcessBlock:function(t,e){t[e]^=n.call(this)},keySize:8,ivSize:0});function n(){for(var t=this._S,e=this._i,r=this._j,i=0,n=0;n<4;n++){var r=(r+t[e=(e+1)%256])%256,o=t[e];t[e]=t[r],t[r]=o,i|=t[(t[e]+t[r])%256]<<24-8*n}return this._i=e,this._j=r,i}t.RC4=e._createHelper(i);r=r.RC4Drop=i.extend({cfg:i.cfg.extend({drop:192}),_doReset:function(){i._doReset.call(this);for(var t=this.cfg.drop;0<t;t--)n.call(this)}});t.RC4Drop=e._createHelper(r)}(),F=(M=U).lib.StreamCipher,P=M.algo,D=[],E=[],R=[],P=P.Rabbit=F.extend({_doReset:function(){for(var t=this._key.words,e=this.cfg.iv,r=0;r<4;r++)t[r]=16711935&(t[r]<<8|t[r]>>>24)|4278255360&(t[r]<<24|t[r]>>>8);for(var i=this._X=[t[0],t[3]<<16|t[2]>>>16,t[1],t[0]<<16|t[3]>>>16,t[2],t[1]<<16|t[0]>>>16,t[3],t[2]<<16|t[1]>>>16],n=this._C=[t[2]<<16|t[2]>>>16,4294901760&t[0]|65535&t[1],t[3]<<16|t[3]>>>16,4294901760&t[1]|65535&t[2],t[0]<<16|t[0]>>>16,4294901760&t[2]|65535&t[3],t[1]<<16|t[1]>>>16,4294901760&t[3]|65535&t[0]],r=this._b=0;r<4;r++)N.call(this);for(r=0;r<8;r++)n[r]^=i[r+4&7];if(e){var o=e.words,s=o[0],c=o[1],e=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),o=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8),s=e>>>16|4294901760&o,c=o<<16|65535&e;n[0]^=e,n[1]^=s,n[2]^=o,n[3]^=c,n[4]^=e,n[5]^=s,n[6]^=o,n[7]^=c;for(r=0;r<4;r++)N.call(this)}},_doProcessBlock:function(t,e){var r=this._X;N.call(this),D[0]=r[0]^r[5]>>>16^r[3]<<16,D[1]=r[2]^r[7]>>>16^r[5]<<16,D[2]=r[4]^r[1]>>>16^r[7]<<16,D[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;i<4;i++)D[i]=16711935&(D[i]<<8|D[i]>>>24)|4278255360&(D[i]<<24|D[i]>>>8),t[e+i]^=D[i]},blockSize:4,ivSize:2}),M.Rabbit=F._createHelper(P),F=(M=U).lib.StreamCipher,P=M.algo,W=[],O=[],I=[],P=P.RabbitLegacy=F.extend({_doReset:function(){for(var t=this._key.words,e=this.cfg.iv,r=this._X=[t[0],t[3]<<16|t[2]>>>16,t[1],t[0]<<16|t[3]>>>16,t[2],t[1]<<16|t[0]>>>16,t[3],t[2]<<16|t[1]>>>16],i=this._C=[t[2]<<16|t[2]>>>16,4294901760&t[0]|65535&t[1],t[3]<<16|t[3]>>>16,4294901760&t[1]|65535&t[2],t[0]<<16|t[0]>>>16,4294901760&t[2]|65535&t[3],t[1]<<16|t[1]>>>16,4294901760&t[3]|65535&t[0]],n=this._b=0;n<4;n++)q.call(this);for(n=0;n<8;n++)i[n]^=r[n+4&7];if(e){var o=e.words,s=o[0],t=o[1],e=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),o=16711935&(t<<8|t>>>24)|4278255360&(t<<24|t>>>8),s=e>>>16|4294901760&o,t=o<<16|65535&e;i[0]^=e,i[1]^=s,i[2]^=o,i[3]^=t,i[4]^=e,i[5]^=s,i[6]^=o,i[7]^=t;for(n=0;n<4;n++)q.call(this)}},_doProcessBlock:function(t,e){var r=this._X;q.call(this),W[0]=r[0]^r[5]>>>16^r[3]<<16,W[1]=r[2]^r[7]>>>16^r[5]<<16,W[2]=r[4]^r[1]>>>16^r[7]<<16,W[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;i<4;i++)W[i]=16711935&(W[i]<<8|W[i]>>>24)|4278255360&(W[i]<<24|W[i]>>>8),t[e+i]^=W[i]},blockSize:4,ivSize:2}),M.RabbitLegacy=F._createHelper(P),U});