name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_NAME: mappertaxregistry
  IMAGE_NAME: mapper-tax-app
  RESOURCE_GROUP: walter_sandbox
  CONTAINER_APP_NAME: mapper-tax-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Log in to Azure
        uses: azure/login@8c334a195cbb38e46038007b304988d888bf676a # v1.6.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@15c4aadf093404726ab2ff205b2cdd33fa6d054c # v1.0.2
        with:
          login-server: ${{ env.REGISTRY_NAME }}.azurecr.io
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npx prisma migrate deploy

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@58b1b88b570600a4a8b78691402df67aa6c57c23 # v1.0.0
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          imageToDeploy: ${{ env.IMAGE_TAG }}
          environmentVariables: |
            DATABASE_URL=secretref:database-url
            OPENAI_API_KEY=secretref:openai-api-key
            NEXTAUTH_SECRET=secretref:nextauth-secret
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            AZURE_AD_CLIENT_ID=secretref:azure-ad-client-id
            AZURE_AD_CLIENT_SECRET=secretref:azure-ad-client-secret
            AZURE_AD_TENANT_ID=${{ secrets.AZURE_AD_TENANT_ID }}
            AZURE_STORAGE_CONNECTION_STRING=secretref:azure-storage-connection-string
            AZURE_STORAGE_CONTAINER_NAME=adjustment-documents
            AZURE_SEARCH_ENDPOINT=secretref:azure-search-endpoint
            AZURE_SEARCH_API_KEY=secretref:azure-search-api-key
            AZURE_SEARCH_INDEX_NAME=opinion-documents
            NODE_ENV=production
            MAX_FILE_UPLOAD_SIZE=10485760
            RATE_LIMIT_MAX_REQUESTS=10
            RATE_LIMIT_WINDOW_MS=60000

      # Configure security headers via Azure CLI
      - name: Configure Security Headers
        run: |
          echo "Configuring security headers for Container App..."
          az containerapp ingress cors update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --allowed-origins "*" \
            --allowed-methods "GET,POST,PUT,DELETE,OPTIONS" \
            --allowed-headers "*" \
            --expose-headers "X-Content-Type-Options,X-Frame-Options,X-XSS-Protection"
          
          # Note: X-Content-Type-Options and other security headers are set in next.config.js
          # The Next.js application handles these headers for all responses
          echo "✓ Security headers configured (enforced by Next.js)"

      - name: Health check
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          
          # Get the container app URL
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          # Perform health check
          HEALTH_URL="https://${APP_URL}/api/health"
          echo "Checking health at: $HEALTH_URL"
          
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
            if [ "$STATUS" -eq 200 ]; then
              echo "✓ Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS - retrying in 10s..."
            sleep 10
          done
          
          echo "✗ Health check failed after 10 attempts"
          exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ Deployment successful!"
          else
            echo "✗ Deployment failed!"
          fi



